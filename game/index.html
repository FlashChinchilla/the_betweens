<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Betweens | Premium Edition</title>
    
    <!-- External Libraries (Icons & Map) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
    
    <style>
        /* ==========================================================================
           1. DESIGN SYSTEM & VARIABLES Section
           ========================================================================== */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@200;300;400;500;600&family=Noto+Sans+Myanmar:wght@200;300;400;500;600&display=swap');

        :root {
            /* Colors */
            --bg-base: #000000;
            --bg-surface: rgba(15, 15, 15, 0.6);
            --bg-surface-hover: rgba(30, 30, 30, 0.8);
            --bg-surface-light: rgba(255, 255, 255, 0.05);
            
            --text-primary: #f5f5f7;
            --text-secondary: #86868b;
            --text-tertiary: #515154;
            --text-inverse: #1d1d1f;
            
            --border-subtle: rgba(255, 255, 255, 0.08);
            --border-strong: rgba(255, 255, 255, 0.15);
            
            /* Effects */
            --glass-blur: blur(50px) saturate(250%);
            --shadow-soft: 0 10px 40px rgba(0, 0, 0, 0.5);
            --shadow-deep: 0 30px 60px rgba(0, 0, 0, 0.8);
            
            /* Animations */
            --ease-apple: cubic-bezier(0.16, 1, 0.3, 1);
            --transition-fast: 0.3s var(--ease-apple);
            --transition-slow: 0.8s var(--ease-apple);
        }

        /* ==========================================================================
           2. GLOBAL RESETS & BASE Section
           ========================================================================== */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: 'Inter', 'Noto Sans Myanmar', sans-serif;
            background-color: var(--bg-base);
            color: var(--text-primary);
            overflow: hidden;
            width: 100vw;
            height: 100vh;
            user-select: none;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            transition: background-color var(--transition-slow), color var(--transition-slow);
        }

        button { 
            background: none; border: none; outline: none; cursor: pointer; 
            font-family: inherit; color: inherit;
        }
        
        input { font-family: inherit; }

        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: var(--border-strong); border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.3); }

        /* JS State Utility Classes */
        .hidden { display: none !important; }
        .flex { display: flex !important; }
        .opacity-0 { opacity: 0 !important; pointer-events: none; }
        
        /* ==========================================================================
           3. PRELOADER Section
           ========================================================================== */
        .preloader-screen {
            position: fixed; inset: 0; z-index: 200;
            background-color: #030303;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 1s var(--ease-apple);
        }
        
        .ambient-glow {
            position: absolute; inset: 0; pointer-events: none;
            background: radial-gradient(circle at center, rgba(255,255,255,0.03) 0%, transparent 70%);
        }

        .loader-ring {
            position: absolute; border-radius: 50%;
            top: 50%; left: 50%; transform: translate(-50%, -50%);
            border: 1px solid var(--border-subtle);
        }
        
        
        @keyframes spin-ring { 
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); } 
        }
        @keyframes spin-ring-reverse { 
            0% { transform: translate(-50%, -50%) rotate(360deg); }
            100% { transform: translate(-50%, -50%) rotate(0deg); } 
        }

        .ring-lg { width: 70vw; height: 70vw; max-width: 800px; max-height: 800px; animation: spin-ring 120s linear infinite; }
        .ring-md { width: 50vw; height: 50vw; max-width: 600px; max-height: 600px; animation: spin-ring-reverse 80s linear infinite; }
        .ring-sm { width: 30vw; height: 30vw; max-width: 400px; max-height: 400px; border-top-color: rgba(255,255,255,0.2); animation: spin-ring 40s linear infinite; }

        .loader-content {
            position: relative; z-index: 10;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            width: 100%; max-width: 400px;
        }

        .loader-emblem {
            width: 64px; height: 64px; position: relative; margin-bottom: 40px;
            display: flex; align-items: center; justify-content: center;
        }
        .emblem-circle { position: absolute; inset: 0; border-radius: 50%; }
        .emblem-outer { border: 1px solid rgba(255,255,255,0.2); }
        
        
        @keyframes spin-emblem { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        @keyframes spin-emblem-reverse { 
            0% { transform: rotate(360deg); } 
            100% { transform: rotate(0deg); } 
        }

        .emblem-spin { border-top: 1px solid #fff; animation: spin-emblem 1s linear infinite; }
        .emblem-inner { inset: 8px; border: 1px solid rgba(255,255,255,0.1); }
        .emblem-inner-spin { inset: 8px; border-bottom: 1px solid rgba(255,255,255,0.6); animation: spin-emblem-reverse 2s linear infinite; }
        .emblem-dot { width: 4px; height: 4px; background: #fff; border-radius: 50%; box-shadow: 0 0 10px #fff; animation: pulse 2s infinite; }

        .brand-title-small {
            font-size: 14px; font-weight: 200; letter-spacing: 0.6em; text-transform: uppercase; margin-bottom: 8px; text-align: center;
        }
        .brand-subtitle-small {
            font-size: 9px; font-weight: 500; letter-spacing: 0.4em; text-transform: uppercase; color: var(--text-tertiary); margin-bottom: 48px; text-align: center;
        }

        .loading-bar-container {
            width: 100%; max-width: 280px; height: 1px; background: var(--border-strong); position: relative; margin-bottom: 24px;
        }
        .loading-bar-fill {
            height: 100%; width: 0%; background: #fff; position: absolute; left: 0; top: 0; transition: width 0.4s var(--ease-apple);
        }
        .loading-bar-fill::after {
            content: ''; position: absolute; right: 0; top: 50%; transform: translateY(-50%);
            width: 8px; height: 2px; background: #fff; box-shadow: 0 0 12px 2px #fff; border-radius: 50%;
        }
        
        .loading-text { 
            font-size: 10px; font-family: monospace; color: var(--text-secondary); 
            letter-spacing: 0.3em; text-transform: uppercase; 
            text-align: center; line-height: 1.6; padding: 0 16px;
        }

        /* Container designed to prevent layout jumping when button appears */
        .loader-btn-container {
            position: absolute; top: 100%; left: 0; right: 0;
            display: flex; justify-content: center; padding-top: 40px;
        }

        .btn-primary {
            padding: 12px 40px; background: #fff; color: #000; font-size: 10px; font-weight: 600;
            letter-spacing: 0.2em; text-transform: uppercase; border-radius: 100px;
            box-shadow: 0 0 20px rgba(255,255,255,0.1); transition: all 0.5s var(--ease-apple);
        }
        .btn-primary:hover {
            transform: scale(1.05); background: #f5f5f7; box-shadow: 0 0 30px rgba(255,255,255,0.4);
        }

        /* ==========================================================================
           4. VISUAL FX & BACKGROUND SYSTEM Section
           ========================================================================== */
        .game-container { position: relative; width: 100%; height: 100%; overflow: hidden; }
        .background-wrapper { position: absolute; inset: 0; overflow: hidden; background: #000; transition: background-color 1s; }
        
        .camera-rig { position: absolute; inset: 0; width: 100%; height: 100%; filter: brightness(1); transition: filter 1.5s ease; }
        .bg-layer { position: absolute; inset: 0; width: 100%; height: 100%; background-size: cover; background-position: center; transition: opacity 2s ease-in-out; opacity: 0; z-index: 0; }

        /* Effects adjusted to let the original background shine fully */
        .scanlines {
            position: absolute; inset: 0; pointer-events: none; z-index: 50; opacity: 0.05;
            background: linear-gradient(to bottom, transparent, transparent 50%, rgba(0,0,0,0.05) 50%, rgba(0,0,0,0.05));
            background-size: 100% 4px;
        }
        .vignette {
            position: absolute; inset: 0; pointer-events: none; z-index: 45;
            background: radial-gradient(circle at center, transparent 60%, rgba(0,0,0,0.5) 100%);
        }
        
        .scene-transition { position: absolute; inset: 0; background: #000; z-index: 90; pointer-events: none; transition: opacity 0.7s; }

        /* FX Classes - Cleaner representation of worlds */
        .world-real { filter: brightness(1) saturate(1.05); transition: filter 3s ease-in-out; }
        .world-parallel { filter: hue-rotate(210deg) saturate(0.5) contrast(1.1) brightness(0.85); transition: filter 3s ease-in-out; }
        .camera-move { animation: panZoom 80s infinite ease-in-out alternate; }
        .static-cam { animation: none !important; transform: scale(1.0) translate(0, 0) !important; transition: transform 0.8s ease-out; }

        @keyframes panZoom {
            0% { transform: scale(1.0) translate(0, 0); }
            50% { transform: scale(1.03) translate(-0.5%, 0.5%); }
            100% { transform: scale(1.0) translate(0, 0); }
        }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        @keyframes slideUpFade { from { opacity: 0; transform: translateY(40px); } to { opacity: 1; transform: translateY(0); } }

        /* ==========================================================================
           5. START SCREEN (MAIN MENU) Section
           ========================================================================== */
        .start-screen {
            position: absolute; inset: 0; z-index: 80; background: #000; overflow: hidden;
            display: flex; transition: background-color 1s;
        }
        .start-video { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; opacity: 0.6; z-index: 0; }
        .start-gradient { position: absolute; inset: 0; background: linear-gradient(to right, #000, rgba(0,0,0,0.9), transparent); z-index: 10; }
        
        .start-content {
            position: relative; z-index: 20; width: 100%; height: 100%;
            display: flex; flex-direction: column; padding: 40px; align-items: center;
        }
        @media(min-width: 768px) {
            .start-content { flex-direction: row; padding: 80px 120px; align-items: stretch; }
        }

        .start-left { flex: 1; display: flex; flex-direction: column; justify-content: center; max-width: 700px; gap: 40px; }
        .start-right { width: 100%; display: flex; flex-direction: column; justify-content: center; margin-top: 60px; }
        @media(min-width: 768px) { .start-right { width: 400px; margin-top: 0; padding-left: 80px; } }

        .version-badge {
            display: inline-flex; align-items: center; gap: 12px; border: 1px solid var(--border-subtle);
            padding: 6px 20px; border-radius: 100px; background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); width: fit-content;
        }
        .version-dot { width: 6px; height: 6px; background: #fff; border-radius: 50%; animation: pulse 2s infinite; }
        .version-text { font-size: 9px; font-weight: 500; letter-spacing: 0.3em; text-transform: uppercase; }

        .main-title { font-size: 60px; font-weight: 200; letter-spacing: -0.05em; line-height: 1.1; color: #fff; }
        .main-title strong { font-weight: 600; }
        @media(min-width: 768px) { .main-title { font-size: 100px; } }

        .subtitle { font-size: 18px; font-weight: 300; letter-spacing: 0.05em; color: var(--text-secondary); line-height: 1.6; }
        .description { font-size: 14px; font-weight: 300; color: var(--text-tertiary); line-height: 2; max-width: 500px; }

        .menu-list { display: flex; flex-direction: column; gap: 4px; width: 100%; }
        .menu-item {
            position: relative; padding: 12px 0; font-family: inherit; font-size: 14px; font-weight: 400;
            letter-spacing: 0.2em; color: var(--text-tertiary); text-transform: uppercase; text-align: left;
            transition: var(--transition-fast); width: 100%;
        }
        .menu-item::after {
            content: ''; position: absolute; left: 0; bottom: 6px; width: 0; height: 1px; background: #fff;
            transition: width 0.6s var(--ease-apple);
        }
        .menu-item:hover { color: #fff; padding-left: 10px; }
        .menu-item:hover::after { width: 24px; }
        .menu-item.primary { font-size: 16px; color: #fff; font-weight: 500; margin-bottom: 8px; }
        .menu-item.primary::after { width: 24px; background: rgba(255,255,255,0.3); }
        .menu-item.primary:hover::after { width: 48px; background: #fff; }
        .menu-item.danger { color: #ff3b30; margin-top: 32px; }

        /* Start Screen Mobile Overrides */
        @media (max-width: 768px) {
            .main-title { font-size: 52px; }
            .subtitle { font-size: 16px; }
            .description { font-size: 13px; }
            .start-left { gap: 24px; }
            .start-content { padding: 32px; overflow-y: auto; display: block; }
            .start-right { margin-top: 40px; padding-left: 0; }
            .menu-item { font-size: 13px; padding: 10px 0; }
            .menu-item.primary { font-size: 15px; }
        }

        /* ==========================================================================
           6. MAIN UI, GLASSMORPHISM & HUD Section
           ========================================================================== */
        .ui-layer {
            position: absolute; inset: 0; z-index: 50; display: flex; flex-direction: column; justify-content: space-between; padding: 24px; pointer-events: none;
        }
        @media(min-width: 768px) { .ui-layer { padding: 40px; } }
        
        .hud-top, .interaction-area {
            transition: opacity 0.5s var(--ease-apple), transform 0.5s var(--ease-apple);
            pointer-events: auto;
        }

        .hud-top { display: flex; justify-content: space-between; align-items: flex-start; width: 100%; }
        .hud-left { display: flex; flex-direction: column; gap: 16px; max-width: 50%; position: relative; }
        .hud-right { display: flex; flex-direction: column; align-items: flex-end; gap: 12px; }

        /* Enhanced High-End Liquid Glass */
        .glass-panel {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08) 0%, rgba(255, 255, 255, 0.01) 100%);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            border-left: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3), inset 0 1px 1px rgba(255, 255, 255, 0.15);
            border-radius: 20px;
        }

        .location-pill {
            padding: 12px 20px; display: flex; align-items: center; gap: 16px; position: relative; overflow: hidden;
        }
        .location-pill::before {
            content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 3px; background: #fff;
            box-shadow: 0 0 10px rgba(255,255,255,0.8);
        }
        
        .location-text { display: block; font-size: 14px; font-weight: 500; letter-spacing: 0.2em; text-transform: uppercase; }
        .time-text { display: block; font-size: 10px; font-family: monospace; color: var(--text-secondary); letter-spacing: 0.1em; margin-top: 4px; }

        .action-bar { padding: 8px; border-radius: 20px; display: flex; flex-wrap: wrap; justify-content: flex-end; gap: 8px; }
        
        .hud-btn {
            position: relative; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center;
            background: linear-gradient(145deg, rgba(255,255,255,0.1), rgba(255,255,255,0.02));
            backdrop-filter: blur(25px) saturate(180%);
            -webkit-backdrop-filter: blur(25px) saturate(180%);
            border: 1px solid rgba(255,255,255,0.15);
            box-shadow: inset 0 1px 1px rgba(255,255,255,0.2), 0 4px 12px rgba(0,0,0,0.1);
            color: rgba(255,255,255,0.8);
            border-radius: 14px;
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .hud-btn:hover {
            background: linear-gradient(145deg, rgba(255,255,255,0.2), rgba(255,255,255,0.05));
            color: #fff;
            border-color: rgba(255,255,255,0.3);
            box-shadow: inset 0 1px 2px rgba(255,255,255,0.4), 0 8px 24px rgba(0,0,0,0.2);
            transform: translateY(-2px);
        }
        .hud-btn:active { transform: translateY(1px) scale(0.95); }
        .hud-btn.active-mode { background: #fff; color: #000; box-shadow: 0 0 20px rgba(255,255,255,0.4); }
        .hud-btn.w-wide { width: 56px; }
        
        
        .hud-btn-danger {
            background: linear-gradient(135deg, rgba(255, 59, 48, 0.2), rgba(255, 59, 48, 0.02)) !important;
            border-color: rgba(255, 59, 48, 0.3) !important;
            color: #ff453a !important;
        }
        .hud-btn-danger:hover {
            background: linear-gradient(135deg, rgba(255, 59, 48, 0.4), rgba(255, 59, 48, 0.1)) !important;
            border-color: rgba(255, 59, 48, 0.5) !important;
            color: #fff !important;
            box-shadow: 0 0 20px rgba(255, 59, 48, 0.4), inset 0 1px 2px rgba(255, 255, 255, 0.4) !important;
        }

        .hud-divider { width: 1px; height: 24px; background: rgba(255,255,255,0.15); margin: 0 8px; align-self: center; }

        .tooltip {
            position: absolute; top: 120%; left: 50%; transform: translateX(-50%) translateY(-5px);
            background: #fff; color: #000; padding: 6px 12px; font-size: 11px; font-weight: 600; letter-spacing: 0.05em;
            border-radius: 8px; opacity: 0; pointer-events: none; transition: var(--transition-fast);
            white-space: nowrap; box-shadow: 0 8px 24px rgba(0,0,0,0.3);
        }
        .hud-btn:hover .tooltip { opacity: 1; transform: translateX(-50%) translateY(0); }

        /* Notifications */
        .notif-container { position: absolute; top: 100px; left: 0; display: flex; flex-direction: column; gap: 8px; width: 260px; pointer-events: none; z-index: 60; }
        .notification-toast {
            background: linear-gradient(145deg, rgba(20,20,20,0.8), rgba(5,5,5,0.9));
            backdrop-filter: var(--glass-blur); border: 1px solid rgba(255,255,255,0.1); border-left: 1px solid rgba(255,255,255,0.2);
            border-radius: 16px; padding: 12px; display: flex; align-items: center; gap: 12px; color: #fff;
            opacity: 0; transform: translateX(-20px); transition: var(--transition-slow); box-shadow: var(--shadow-deep);
        }
        .notification-show { opacity: 1 !important; transform: translateX(0) !important; }
        .notif-icon-wrap { padding: 8px; border-radius: 50%; background: rgba(255,255,255,0.08); flex-shrink: 0; box-shadow: inset 0 1px 1px rgba(255,255,255,0.2); }
        .notif-meta { font-size: 9px; text-transform: uppercase; color: var(--text-secondary); font-weight: 600; letter-spacing: 0.2em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .notif-val { font-size: 14px; font-weight: 500; margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* HUD Mobile Overrides */
        @media (max-width: 600px) {
            .ui-layer { padding: 16px; }
            .hud-top { flex-direction: column; gap: 12px; align-items: flex-end; }
            .hud-left { max-width: 100%; width: 100%; flex-direction: row; justify-content: space-between; align-items: center; }
            .hud-right { width: 100%; }
            .action-bar { justify-content: center; width: 100%; padding: 6px; gap: 6px; border-radius: 16px; }
            
            .location-pill { padding: 8px 12px; gap: 10px; }
            .location-text { font-size: 11px; letter-spacing: 0.1em; }
            .time-text { font-size: 9px; }
            
            .hud-btn { width: 36px; height: 36px; border-radius: 10px; }
            .hud-btn.w-wide { width: 44px; }
            .hud-divider { margin: 0 4px; height: 20px; }
            
            .notif-container { top: 70px; width: 220px; }
            .notification-toast { padding: 8px; gap: 8px; border-radius: 12px; }
            .notif-icon-wrap { padding: 6px; }
            .notif-meta { font-size: 8px; }
            .notif-val { font-size: 12px; }
            .tooltip { display: none !important; } /* Tooltips off on mobile touch */
        }

        /* ==========================================================================
           7. DIALOGUE & INTERACTION SYSTEM Section
           ========================================================================== */
        .interaction-area { margin-top: auto; width: 100%; max-width: 900px; margin-inline: auto; pointer-events: auto; }
        
        .choices-container { display: flex; flex-direction: column; align-items: center; gap: 8px; margin-bottom: 16px; max-height: 35vh; overflow-y: auto; padding-right: 8px; }
        .choice-btn {
            width: 100%; padding: 16px 24px; text-align: left; 
            background: linear-gradient(145deg, rgba(255,255,255,0.1), rgba(255,255,255,0.02));
            backdrop-filter: blur(30px) saturate(200%); -webkit-backdrop-filter: blur(30px) saturate(200%);
            border: 1px solid rgba(255,255,255,0.15); border-radius: 16px; color: rgba(255,255,255,0.8);
            box-shadow: inset 0 1px 1px rgba(255,255,255,0.2), 0 8px 24px rgba(0,0,0,0.15);
            transition: all 0.4s var(--ease-apple); font-size: 15px; position: relative; overflow: hidden;
        }
        .choice-btn:hover { 
            background: linear-gradient(145deg, rgba(255,255,255,0.25), rgba(255,255,255,0.1));
            color: #fff; transform: scale(0.99) translateY(-1px);
            box-shadow: inset 0 1px 2px rgba(255,255,255,0.4), 0 12px 32px rgba(0,0,0,0.2); 
        }
        .choice-flex { display: flex; justify-content: space-between; align-items: center; position: relative; z-index: 10; font-weight: 400; }
        .choice-arrow { opacity: 0; transition: opacity 0.3s, transform 0.3s; width: 16px; height: 16px; transform: translateX(-10px); }
        .choice-btn:hover .choice-arrow { opacity: 1; transform: translateX(0); }

        
        .dialogue-box {
            background: linear-gradient(145deg, rgba(30, 30, 30, 0.4), rgba(5, 5, 5, 0.6));
            backdrop-filter: blur(50px) saturate(250%);
            -webkit-backdrop-filter: blur(50px) saturate(250%);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-top: 1px solid rgba(255, 255, 255, 0.35);
            border-left: 1px solid rgba(255, 255, 255, 0.25);
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.4), inset 0 1px 2px rgba(255,255,255,0.2);
            border-radius: 32px;
            padding: 36px 48px; position: relative; min-height: 160px; cursor: pointer;
        }
        
        .speaker-box {
            position: absolute; top: -18px; left: 36px; background: #fff; color: #000; padding: 8px 24px;
            font-size: 11px; font-weight: 600; letter-spacing: 0.2em; text-transform: uppercase; border-radius: 100px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); transition: opacity 0.3s;
        }

        .dialogue-text {
            font-size: 18px; line-height: 1.8; color: #f5f5f7; font-weight: 300; letter-spacing: 0.02em; transition: opacity 0.3s;
            text-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }
        .cursor::after {
            content: ''; display: inline-block; width: 6px; height: 1em; background: #fff;
            animation: pulse 1s step-end infinite; vertical-align: text-bottom; margin-left: 6px; opacity: 0.8;
            box-shadow: 0 0 10px rgba(255,255,255,0.8);
        }
        
        .next-indicator { position: absolute; bottom: 24px; right: 36px; color: rgba(255,255,255,0.5); opacity: 0; transition: opacity 0.3s; }
        .next-indicator i { width: 24px; height: 24px; animation: pulse 2s infinite; }

        /* Interaction Mobile Overrides */
        @media (max-width: 600px) {
            .interaction-area { width: 100%; }
            .choices-container { max-height: 45vh; }
            .choice-btn { padding: 12px 16px; font-size: 13px; border-radius: 14px; }
            
            .dialogue-box { padding: 24px 20px; min-height: 110px; border-radius: 24px; }
            .dialogue-text { font-size: 15px; line-height: 1.6; }
            .speaker-box { left: 24px; top: -14px; padding: 6px 16px; font-size: 10px; }
            .next-indicator { bottom: 16px; right: 20px; }
            .next-indicator i { width: 18px; height: 18px; }
        }

        /* ==========================================================================
           8. MODALS (Premium Glass Design) Section
           ========================================================================== */
        .modal-overlay {
            position: absolute; inset: 0; z-index: 100; background: rgba(0,0,0,0.6); backdrop-filter: blur(24px);
            display: flex; align-items: center; justify-content: center; padding: 24px; transition: opacity 0.5s var(--ease-apple);
        }
        .modal-glass {
            background: linear-gradient(145deg, rgba(20, 20, 20, 0.7), rgba(5, 5, 5, 0.8)); 
            backdrop-filter: blur(50px) saturate(200%); -webkit-backdrop-filter: blur(50px) saturate(200%);
            border: 1px solid rgba(255, 255, 255, 0.15); border-top: 1px solid rgba(255, 255, 255, 0.25);
            box-shadow: 0 40px 100px rgba(0, 0, 0, 0.8), inset 0 1px 1px rgba(255,255,255,0.15); 
            color: #fff; border-radius: 32px; position: relative;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 20px; margin-bottom: 24px; }
        .modal-title { font-size: 20px; font-weight: 600; letter-spacing: 0.1em; text-transform: uppercase; }
        .btn-close { background: rgba(255,255,255,0.05); color: var(--text-secondary); border-radius: 50%; padding: 8px; transition: all 0.4s var(--ease-apple); border: 1px solid transparent; }
        .btn-close:hover { background: rgba(255,255,255,0.15); color: #fff; border-color: rgba(255,255,255,0.2); transform: scale(1.05); }

        /* Specific Modals */
        .map-window { width: 100%; max-width: 1200px; height: 85vh; display: flex; flex-direction: column; overflow: hidden; padding: 0; }
        .settings-window { width: 100%; max-width: 700px; padding: 40px; }
        .gallery-window { width: 100%; max-width: 1000px; height: 85vh; display: flex; flex-direction: column; padding: 40px; }

        /* Map UI */
        .map-viewport { position: relative; width: 100%; height: 100%; flex: 1; overflow: hidden; background: #0a0a0a; border-radius: inherit; }
        .maplibregl-ctrl-attrib, .maplibregl-ctrl-logo { display: none !important; }
        
        .map-search-bar {
            position: absolute; top: 24px; left: 24px; width: calc(100% - 100px); max-width: 400px; z-index: 60;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(24px); height: 48px; border-radius: 100px; border: 1px solid rgba(255,255,255,0.15);
            display: flex; align-items: center; padding: 0 16px; gap: 12px; transition: var(--transition-fast);
        }
        .map-search-bar:focus-within { border-color: rgba(255,255,255,0.4); }
        .map-search-input { flex: 1; background: transparent; border: none; outline: none; color: #fff; font-size: 14px; font-weight: 500; }
        
        .map-search-results {
            position: absolute; top: 80px; left: 24px; width: calc(100% - 100px); max-width: 400px; z-index: 50;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(24px); border-radius: 16px; border: 1px solid rgba(255,255,255,0.15);
            max-height: 240px; overflow-y: auto; display: flex; flex-direction: column;
        }
        .map-menu-dropdown {
            position: absolute; top: 80px; left: 24px; width: 220px; z-index: 50;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(24px); border-radius: 16px; border: 1px solid rgba(255,255,255,0.15);
            display: flex; flex-direction: column; transform-origin: top left;
        }
        .map-list-btn { display: flex; align-items: center; gap: 12px; padding: 12px 16px; text-align: left; font-size: 13px; font-weight: 500; border-bottom: 1px solid rgba(255,255,255,0.1); transition: var(--transition-fast); color: var(--text-primary); }
        .map-list-btn:hover { background: rgba(255,255,255,0.1); }
        .map-list-btn.danger { color: #ff453a; }

        .map-controls { position: absolute; bottom: 24px; right: 24px; display: flex; flex-direction: column; gap: 8px; z-index: 50; }
        .map-control-btn { background: rgba(0,0,0,0.6); backdrop-filter: blur(24px); padding: 12px; border-radius: 50%; color: #fff; border: 1px solid rgba(255,255,255,0.15); transition: var(--transition-fast); }
        .map-control-btn:hover { background: #fff; color: #000; }
        .map-control-group { display: flex; flex-direction: column; background: rgba(0,0,0,0.6); backdrop-filter: blur(24px); border-radius: 100px; border: 1px solid rgba(255,255,255,0.15); overflow: hidden; margin-top: 4px; }
        .map-control-group button { padding: 12px; color: #fff; transition: var(--transition-fast); }
        .map-control-group button:hover { background: #fff; color: #000; }
        .map-control-group button:first-child { border-bottom: 1px solid rgba(255,255,255,0.15); }
        
        .map-close { position: absolute; top: 24px; right: 24px; z-index: 50; }

        /* Map Pins */
        .map-pin-wrapper { display: flex; flex-direction: column; align-items: center; pointer-events: auto; }
        .map-pin-unlocked { z-index: 20; cursor: pointer; transition: transform 0.4s var(--ease-apple); }
        .map-pin-unlocked:hover { transform: scale(1.1); z-index: 100; }
        .map-pin-locked { z-index: 10; cursor: not-allowed; opacity: 0.5; filter: grayscale(1); }
        .map-player-indicator { position: absolute; top: -40px; z-index: 50; animation: bounce 3s ease-in-out infinite; }
        .map-player-dot { width: 12px; height: 12px; background: #fff; border-radius: 50%; box-shadow: 0 0 15px #fff; }
        .map-pin-icon-wrapper { position: relative; padding-bottom: 6px; }
        .map-pin-img { width: 40px; height: 40px; object-fit: contain; filter: drop-shadow(0 4px 10px rgba(0,0,0,0.5)); }
        .map-pin-label {
            position: absolute; top: 100%; left: 50%; transform: translateX(-50%) translateY(4px);
            background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); color: #fff; font-size: 12px; padding: 6px 12px;
            font-weight: 500; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); opacity: 0; transition: var(--transition-fast);
            white-space: nowrap; z-index: 50; pointer-events: none;
        }
        .map-pin-wrapper:hover .map-pin-label { opacity: 1; transform: translateX(-50%) translateY(8px); }
        .map-pin-locked-label { opacity: 1; color: var(--text-secondary); }

        /* Settings UI */
        .settings-scroll { display: flex; flex-direction: column; gap: 24px; overflow-y: auto; max-height: 65vh; padding-right: 16px; font-weight: 300; }
        .st-row { display: flex; flex-direction: column; gap: 16px; position: relative; z-index: 10; }
        @media(min-width: 768px) { .st-row { flex-direction: row; align-items: center; justify-content: space-between; } }
        .st-label { display: flex; align-items: center; gap: 12px; width: fit-content; }
        .st-label i { opacity: 0.5; width: 20px; height: 20px; }
        .st-label span { font-size: 14px; letter-spacing: 0.05em; }
        
        .ios-slider { -webkit-appearance: none; width: 100%; height: 4px; background: rgba(255,255,255,0.1); border-radius: 4px; outline: none; }
        @media(min-width: 768px) { .ios-slider { width: 250px; } }
        .ios-slider::-webkit-slider-thumb {
            -webkit-appearance: none; width: 20px; height: 20px; border-radius: 50%; background: #fff;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5); cursor: pointer; transition: transform 0.2s;
        }
        .ios-slider::-webkit-slider-thumb:hover { transform: scale(1.1); }

        .segmented-control { display: flex; background: rgba(0,0,0,0.3); border-radius: 12px; padding: 4px; border: 1px solid rgba(255,255,255,0.1); width: 100%; box-shadow: inset 0 2px 8px rgba(0,0,0,0.2); }
        @media(min-width: 768px) { .segmented-control { width: auto; min-width: 200px; } }
        .segment-btn { flex: 1; padding: 8px 20px; border-radius: 8px; color: var(--text-secondary); font-weight: 500; font-size: 13px; transition: var(--transition-fast); text-align: center; }
        .segment-btn.st-btn-active { background: linear-gradient(145deg, #fff, #f0f0f0); color: #000; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }

        /* Gallery UI */
        .gallery-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; overflow-y: auto; padding-right: 8px; flex: 1; }
        @media(min-width: 768px) { .gallery-grid { grid-template-columns: repeat(3, 1fr); } }
        @media(min-width: 1024px) { .gallery-grid { grid-template-columns: repeat(5, 1fr); } }
        .gallery-item {
            aspect-ratio: 3/4; border-radius: 16px; overflow: hidden; position: relative; cursor: pointer;
            border: 1px solid rgba(255,255,255,0.15); transition: transform 0.4s var(--ease-apple), box-shadow 0.4s; background: rgba(0,0,0,0.5);
        }
        .gallery-item:hover { transform: scale(1.05); box-shadow: 0 15px 30px rgba(0,0,0,0.5); }
        .gallery-img { width: 100%; height: 100%; object-fit: cover; opacity: 0.8; transition: opacity 0.3s; }
        .gallery-item:hover .gallery-img { opacity: 1; }
        .gallery-caption { position: absolute; bottom: 0; left: 0; right: 0; padding: 16px; background: linear-gradient(to top, #000, transparent); text-align: center; font-size: 12px; font-weight: 600; letter-spacing: 0.1em; color: #fff; }
        .gallery-locked { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 12px; background: #0a0a0a; }
        .gallery-locked i { color: rgba(255,255,255,0.2); width: 24px; height: 24px; }
        .gallery-locked span { color: rgba(255,255,255,0.2); font-size: 10px; text-transform: uppercase; letter-spacing: 0.2em; }

        /* Image Viewer */
        .viewer-modal { z-index: 120; background: rgba(0,0,0,0.95); backdrop-filter: blur(40px); }
        .viewer-nav { position: absolute; top: 0; left: 0; right: 0; padding: 24px; display: flex; justify-content: space-between; align-items: center; z-index: 20; background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent); }
        .viewer-btn { padding: 12px; background: rgba(255,255,255,0.1); border-radius: 50%; color: #fff; border: 1px solid rgba(255,255,255,0.2); transition: var(--transition-fast); display: flex; }
        .viewer-btn:hover { background: rgba(255,255,255,0.3); transform: scale(1.05); }
        .viewer-container { width: 100%; height: 100%; padding: 24px; display: flex; align-items: center; justify-content: center; z-index: 10; transition: var(--transition-slow); }
        @media(min-width: 768px) { .viewer-container { padding: 48px; } }
        .viewer-img { max-width: 100%; max-height: 100%; object-fit: contain; transition: var(--transition-slow); border-radius: 16px; box-shadow: var(--shadow-deep); }
        .viewer-img.fill { object-fit: cover; width: 100%; height: 100%; border-radius: 0; }
        .viewer-caption-box { position: absolute; bottom: 0; left: 0; right: 0; padding: 32px; text-align: center; background: linear-gradient(to top, rgba(0,0,0,0.9), transparent); z-index: 20; pointer-events: none; }
        .viewer-caption-text { color: #fff; font-size: 18px; font-weight: 500; letter-spacing: 0.1em; text-transform: uppercase; text-shadow: 0 2px 10px #000; }

        /* General Modal Mobile Overrides */
        @media (max-width: 600px) {
            .modal-glass { width: calc(100% - 32px); padding: 20px; border-radius: 24px; }
            .settings-window { padding: 24px; max-height: 90vh; }
            .modal-header { margin-bottom: 16px; padding-bottom: 12px; }
            .modal-title { font-size: 16px; }
            
            .st-row { gap: 8px; flex-direction: column; align-items: flex-start; }
            .st-label span { font-size: 12px; }
            .segment-btn { padding: 8px 12px; font-size: 11px; }
            .settings-scroll { gap: 20px; max-height: 75vh; }
            
            .map-window { height: 95vh; padding: 0; }
            .map-search-bar { top: 12px; left: 12px; width: calc(100% - 68px); height: 40px; padding: 0 12px; gap: 8px; }
            .map-search-input { font-size: 12px; }
            .map-close { top: 12px; right: 12px; padding: 8px; }
            .map-controls { bottom: 12px; right: 12px; gap: 6px; }
            .map-control-btn, .map-control-group button { padding: 10px; }
            .map-search-results, .map-menu-dropdown { top: 60px; left: 12px; width: calc(100% - 24px); max-width: none; }
            
            .gallery-window { padding: 20px; height: 95vh; }
            .gallery-grid { grid-template-columns: repeat(2, 1fr); gap: 12px; }
            .gallery-caption { padding: 12px; font-size: 10px; }
            .viewer-container { padding: 16px; }
        }

        /* ==========================================================================
           9. PHONE SYSTEM (Fully Scalable for Mobile) Section
           ========================================================================== */
        .phone-container { perspective: 1200px; display: flex; align-items: center; justify-content: center; }
        .phone-hardware { 
            position: relative; 
            /* Magic mathematical clamp ensures hardware scales down to fit any mobile viewport perfectly without breaking layout */
            transform: scale(calc(min(1, 100vw / 380, 100vh / 720))); 
            transform-origin: center center; 
        }
        .phone-btn-power { position: absolute; top: 96px; right: -10px; width: 4px; height: 64px; background: #555; border-radius: 0 4px 4px 0; cursor: pointer; transition: background 0.3s; z-index: 0; }
        .phone-btn-power:hover { background: #fff; }
        .phone-btn-vol-up { position: absolute; top: 96px; left: -10px; width: 4px; height: 40px; background: #555; border-radius: 4px 0 0 4px; z-index: 0; }
        .phone-btn-vol-down { position: absolute; top: 144px; left: -10px; width: 4px; height: 40px; background: #555; border-radius: 4px 0 0 4px; z-index: 0; }

        .phone-screen-hardware {
            width: 320px; height: 640px; background: #000; border: 6px solid #111; border-radius: 40px;
            box-shadow: 0 0 0 2px #333, 0 0 0 8px #000, 0 30px 60px rgba(0,0,0,0.8);
            overflow: hidden; display: flex; flex-direction: column; z-index: 10; position: relative;
        }
        .phone-notch { position: absolute; top: 8px; left: 50%; transform: translateX(-50%); width: 96px; height: 24px; background: #000; border-radius: 12px; z-index: 60; display: flex; align-items: center; justify-content: flex-end; padding: 0 8px; }
        .phone-cam-dot { width: 8px; height: 8px; border-radius: 50%; background: rgba(255,255,255,0.1); }
        .phone-status-bar { height: 40px; width: 100%; display: flex; justify-content: space-between; align-items: center; padding: 0 24px; font-size: 11px; font-weight: 500; color: #fff; position: absolute; top: 0; left: 0; z-index: 50; }
        .phone-status-icons { display: flex; gap: 6px; }
        .phone-status-icons i { width: 14px; height: 14px; }

        .phone-display { flex: 1; background: #000; position: relative; overflow: hidden; }
        
        .phone-home { position: absolute; inset: 0; background: #050505; padding: 64px 24px 24px; z-index: 10; }
        .phone-wallpaper { position: absolute; inset: 0; background: linear-gradient(to bottom, #111, #000); z-index: 0; background-image: url(../images/items/wallpaper2.jpg); background-size: 100%; background-repeat: no-repeat; background-position: center; }
        .phone-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px 12px; position: relative; z-index: 10; margin-top: 16px; }
        
        .app-icon-wrapper { display: flex; flex-direction: column; align-items: center; gap: 6px; cursor: pointer; transition: transform 0.2s; }
        .app-icon-wrapper:active { transform: scale(0.9); filter: brightness(0.8); }
        .app-icon-box { width: 56px; height: 56px; border-radius: 14px; display: flex; align-items: center; justify-content: center; border: 1px solid rgba(255,255,255,0.05); }
        .app-icon-label { font-size: 10px; color: #a1a1aa; font-weight: 500; letter-spacing: 0.05em; }

        /* Specific App Icons */
        .icon-phone { background: #1c1c1e; color: #4ade80; }
        .icon-msg { background: #1c1c1e; color: #60a5fa; }
        .icon-photo { background: #1c1c1e; color: #c084fc; }
        .icon-cam { background: #1c1c1e; color: #9ca3af; opacity: 0.5; }
        .icon-fb { background: #1877f2; color: #fff; }
        .icon-yt { background: #dc2626; color: #fff; }
        .icon-spotify { background: #1DB954; color: #fff; }
        .icon-kbz { background: #1a4a8d; color: #fff; font-weight: 900; font-size: 12px; letter-spacing: 0.1em; }

        .phone-home-indicator-wrap { position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%); width: 100%; height: 24px; z-index: 50; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .phone-home-indicator { width: 128px; height: 4px; background: rgba(255,255,255,0.4); border-radius: 4px; transition: background 0.3s; }
        .phone-home-indicator-wrap:hover .phone-home-indicator { background: #fff; }

        /* App Screen States */
        .app-screen-container { position: absolute; inset: 0; background: #000; z-index: 20; display: flex; flex-direction: column; transition: transform 0.4s var(--ease-apple); }
        .translate-x-full { transform: translateX(100%); }
        .app-screen-active { transform: translateX(0); }
        
        .app-header { height: 56px; display: flex; align-items: center; padding: 16px 16px 0; font-weight: 600; color: #fff; z-index: 30; position: relative; }
        .app-header.glass { background: rgba(0,0,0,0.8); backdrop-filter: blur(12px); border-bottom: 1px solid var(--border-subtle); }
        .app-back-btn { padding: 4px; margin-left: -8px; border-radius: 50%; transition: background 0.3s; color: #fff; display: flex; }
        .app-back-btn:hover { background: rgba(255,255,255,0.1); }
        .app-title { margin-left: 8px; font-size: 14px; letter-spacing: 0.05em; }
        .app-content { flex: 1; overflow-y: auto; position: relative; background: #000; color: #fff; }

        /* General App Styles for JS Injection */
        .phone-app-inner { display: flex; flex-direction: column; height: 100%; }
        /* Phone App */
        .dialer-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; font-size: 24px; font-weight: 300; padding: 0 40px; }
        .dial-btn { width: 64px; height: 64px; border-radius: 50%; background: #222; display: flex; align-items: center; justify-content: center; transition: background 0.2s; }
        .dial-btn:hover { background: #333; }
        .call-btn-wrap { margin-top: 32px; display: flex; justify-content: center; }
        .call-btn { width: 80px; height: 80px; border-radius: 50%; background: #22c55e; color: #fff; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 20px rgba(34,197,94,0.3); }
        
        /* Message App */
        .msg-list { padding: 16px; }
        .msg-item { display: flex; gap: 16px; align-items: center; padding-bottom: 16px; margin-bottom: 16px; border-bottom: 1px solid #222; }
        .msg-avatar { width: 48px; height: 48px; border-radius: 50%; background: #27272a; display: flex; align-items: center; justify-content: center; color: #d4d4d8; font-weight: 500; flex-shrink: 0; }
        .msg-content { flex: 1; overflow: hidden; }
        .msg-top { display: flex; justify-content: space-between; align-items: baseline; }
        .msg-name { font-weight: 500; font-size: 14px; color: #e4e4e7; }
        .msg-time { font-size: 10px; color: #71717a; }
        .msg-text { font-size: 14px; color: #a1a1aa; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 4px; }
        
        /* Photos App */
        .photo-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 2px; padding: 2px; }
        .photo-item { aspect-ratio: 1; background: #18181b; background-size: cover; background-position: center; }
        
        /* Facebook App */
        .fb-app { background: #000; min-height: 100%; }
        .fb-compose { background: #111; padding: 16px; margin-bottom: 8px; display: flex; gap: 12px; }
        .fb-compose-av { width: 40px; height: 40px; border-radius: 50%; background: #374151; }
        .fb-compose-input { flex: 1; background: #222; border-radius: 100px; padding: 0 16px; display: flex; align-items: center; font-size: 14px; color: #9ca3af; }
        .fb-post { background: #111; padding: 16px; margin-bottom: 8px; border-top: 1px solid rgba(255,255,255,0.05); border-bottom: 1px solid rgba(255,255,255,0.05); }
        .fb-post-header { display: flex; gap: 12px; align-items: center; margin-bottom: 12px; }
        .fb-post-av { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .fb-post-name { font-size: 14px; font-weight: 600; }
        .fb-post-time { font-size: 12px; color: #6b7280; }
        .fb-post-text { font-size: 14px; color: #d1d5db; margin-bottom: 12px; line-height: 1.5; }
        .fb-post-img { width: 100%; height: 160px; border-radius: 8px; background: #1f2937; margin-bottom: 12px; background-size: cover; background-position: center; }
        .fb-post-actions { border-top: 1px solid rgba(255,255,255,0.1); padding-top: 12px; display: flex; justify-content: space-between; color: #9ca3af; font-size: 14px; font-weight: 500; }
        .fb-action-btn { display: flex; align-items: center; gap: 6px; }

        /* YouTube App */
        .yt-app { background: #000; min-height: 100%; }
        .yt-video { padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 16px; }
        .yt-thumb { width: 100%; height: 176px; border-radius: 12px; background: #1f2937; margin-bottom: 12px; background-size: cover; background-position: center; position: relative; overflow: hidden; }
        .yt-duration { position: absolute; bottom: 8px; right: 8px; background: rgba(0,0,0,0.8); font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: 500; }
        .yt-info { display: flex; gap: 12px; }
        .yt-av { width: 36px; height: 36px; border-radius: 50%; flex-shrink: 0; }
        .yt-title { font-size: 14px; font-weight: 600; line-height: 1.2; margin-bottom: 4px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .yt-meta { font-size: 12px; color: #9ca3af; }

        /* Spotify App */
        .spotify-app { display: flex; flex-direction: column; height: 100%; background: linear-gradient(to bottom, #1a1a1a, #000); position: relative; }
        .spotify-nav { display: flex; justify-content: space-between; align-items: center; padding: 40px 16px 16px; z-index: 10; }
        .spotify-nav-title { font-size: 10px; font-weight: 700; letter-spacing: 0.2em; text-transform: uppercase; color: #d1d5db; }
        .spotify-art-wrap { flex: 1; display: flex; align-items: center; justify-content: center; padding: 32px; z-index: 10; }
        .spotify-art { width: 100%; aspect-ratio: 1; background: #1f2937; border-radius: 12px; overflow: hidden; box-shadow: var(--shadow-deep); border: 1px solid rgba(255,255,255,0.05); }
        .spotify-controls { padding: 0 32px 40px; z-index: 10; background: linear-gradient(to top, #000, rgba(0,0,0,0.8), transparent); }
        .sp-info-row { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 24px; }
        .sp-song { font-size: 24px; font-weight: 700; letter-spacing: -0.02em; margin-bottom: 4px; }
        .sp-artist { color: #9ca3af; font-size: 14px; font-weight: 500; }
        .sp-heart { color: #1DB954; transition: transform 0.2s; }
        .sp-heart:hover { transform: scale(1.1); }
        .sp-progress-bar { width: 100%; height: 6px; background: #1f2937; border-radius: 100px; position: relative; cursor: pointer; margin-bottom: 12px; }
        .sp-progress-fill { position: absolute; left: 0; top: 0; height: 100%; background: #fff; border-radius: 100px; transition: width 0.3s; }
        .sp-progress-thumb { position: absolute; top: -3px; margin-left: -6px; width: 12px; height: 12px; background: #fff; border-radius: 50%; opacity: 0; transition: opacity 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }
        .sp-progress-bar:hover .sp-progress-thumb { opacity: 1; }
        .sp-time-row { display: flex; justify-content: space-between; font-size: 11px; color: #9ca3af; font-weight: 500; margin-bottom: 32px; }
        .sp-btn-row { display: flex; justify-content: space-between; align-items: center; padding: 0 8px; }
        .sp-btn-secondary { color: #9ca3af; transition: color 0.2s; }
        .sp-btn-secondary:hover { color: #fff; }
        .sp-btn-primary { color: #fff; transition: transform 0.2s; }
        .sp-btn-primary:hover { transform: scale(1.1); }
        .sp-btn-play { width: 64px; height: 64px; background: #1DB954; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #000; transition: transform 0.2s; box-shadow: 0 8px 20px rgba(29,185,84,0.3); }
        .sp-btn-play:hover { transform: scale(1.05); }

        /* KBZPay App */
        .kbz-app { flex: 1; background: #f5f5f7; display: flex; flex-direction: column; align-items: center; padding-top: 24px; min-height: 100%; }
        .kbz-card { width: 92%; margin: 0 auto 24px; background: linear-gradient(to bottom right, #1a4a8d, #0d2a52); border-radius: 20px; padding: 24px; box-shadow: 0 15px 30px rgba(26,74,141,0.2); color: #fff; position: relative; overflow: hidden; }
        .kbz-card-glow { position: absolute; background: rgba(255,255,255,0.05); border-radius: 50%; filter: blur(20px); }
        .kbz-card-glow.top { right: -40px; top: -40px; width: 160px; height: 160px; }
        .kbz-card-glow.bottom { left: -40px; bottom: -40px; width: 128px; height: 128px; }
        .kbz-card-content { position: relative; z-index: 10; }
        .kbz-row-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .kbz-label { font-size: 10px; color: #bfdbfe; text-transform: uppercase; letter-spacing: 0.1em; font-weight: 600; }
        .kbz-balance-row { display: flex; align-items: baseline; gap: 6px; margin-top: 4px; }
        .kbz-amount { font-size: 36px; font-weight: 700; letter-spacing: -0.02em; }
        .kbz-currency { font-size: 14px; font-weight: 500; color: #bfdbfe; }
        .kbz-actions { display: flex; justify-content: space-between; margin-top: 32px; }
        .kbz-action-btn { display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer; }
        .kbz-action-icon { width: 40px; height: 40px; background: rgba(255,255,255,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px); transition: background 0.2s; }
        .kbz-action-btn:hover .kbz-action-icon { background: rgba(255,255,255,0.2); }
        .kbz-action-label { font-size: 10px; font-weight: 500; letter-spacing: 0.05em; color: #dbeafe; }
        .kbz-history-wrap { width: 92%; margin: 0 auto; }
        .kbz-history-title { font-size: 11px; color: #6b7280; margin-bottom: 12px; text-transform: uppercase; font-weight: 700; letter-spacing: 0.1em; padding: 0 4px; }
        .kbz-history-list { display: flex; flex-direction: column; gap: 12px; padding-bottom: 32px; }
        .kbz-tx-card { background: #fff; padding: 16px; border-radius: 16px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.02); border: 1px solid #f3f4f6; transition: box-shadow 0.2s; color: #111; }
        .kbz-tx-card:hover { box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .kbz-tx-left { display: flex; align-items: center; gap: 12px; }
        .kbz-tx-icon { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .kbz-tx-icon.positive { background: #f0fdf4; color: #16a34a; }
        .kbz-tx-icon.negative { background: #fef2f2; color: #dc2626; }
        .kbz-tx-type { font-size: 14px; font-weight: 700; }
        .kbz-tx-date { font-size: 11px; color: #6b7280; font-weight: 500; }
        .kbz-tx-amt { font-size: 14px; font-family: monospace; font-weight: 700; }
        .kbz-tx-amt.positive { color: #16a34a; }
        .kbz-tx-amt.negative { color: #dc2626; }
        .kbz-empty { text-align: center; font-size: 12px; color: #9ca3af; padding: 32px 0; background: #fff; border-radius: 16px; border: 1px solid #f3f4f6; }

        /* ==========================================================================
           10. SETTINGS & DYNAMIC OVERRIDES Section
           ========================================================================== */
        body.font-sm .dialogue-text { font-size: 15px !important; line-height: 1.6 !important; }
        body.font-sm .choice-btn { font-size: 13px !important; }
        body.font-lg .dialogue-text { font-size: 22px !important; line-height: 1.8 !important; }
        body.font-lg .choice-btn { font-size: 18px !important; }
        
        /* Render Quality Specifics: Letting the original background shine */
        body.gfx-low .bg-layer { filter: blur(1px) saturate(0.8) brightness(0.9) !important; }
        body.gfx-low .glass-panel, body.gfx-low .dialogue-box, body.gfx-low .modal-glass { backdrop-filter: none !important; -webkit-backdrop-filter: none !important; background-color: rgba(10,10,10,0.98) !important; box-shadow: none !important; border: none !important; }
        body.gfx-low .scanlines, body.gfx-low .vignette { display: none !important; }
        body.gfx-low .camera-move { animation: none !important; transform: scale(1.0) !important; }
        
        body.gfx-med .bg-layer { filter: blur(0px) saturate(1.0) brightness(1.0) !important; }
        body.gfx-med .glass-panel, body.gfx-med .dialogue-box { backdrop-filter: blur(15px) !important; -webkit-backdrop-filter: blur(15px) !important; }
        body.gfx-med .camera-move { animation-duration: 120s !important; }

        body.gfx-high .bg-layer { filter: blur(0px) saturate(1.02) brightness(1.02) !important; }

        
        body.theme-light { background-color: #f5f5f7; color: #1d1d1f; }
        body.theme-light .start-screen { background-color: #fff; }
        body.theme-light .start-gradient { background: linear-gradient(to right, #fff, rgba(255,255,255,0.9), transparent); }
        body.theme-light .main-title { color: #1d1d1f; }
        body.theme-light .menu-item { color: #86868b; }
        body.theme-light .menu-item::after { background: #1d1d1f; }
        body.theme-light .menu-item:hover, body.theme-light .menu-item.primary { color: #1d1d1f; }
        
        body.theme-light .glass-panel, body.theme-light .dialogue-box, body.theme-light .modal-glass { 
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.65) 0%, rgba(255, 255, 255, 0.4) 100%) !important; 
            border: 1px solid rgba(255, 255, 255, 0.8) !important; 
            border-top: 1px solid #ffffff !important; 
            border-left: 1px solid rgba(255, 255, 255, 0.9) !important; 
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.1), inset 0 1px 2px rgba(255, 255, 255, 0.8) !important; 
            color: #1d1d1f !important;
        }
        
        body.theme-light .dialogue-text { color: #1d1d1f !important; text-shadow: none !important; }
        body.theme-light .choice-btn { background: rgba(255,255,255,0.4); color: #1d1d1f; border-color: rgba(255,255,255,0.6); }
        body.theme-light .choice-btn:hover { background: #1d1d1f; color: #fff; }
        body.theme-light .hud-btn { background: rgba(255,255,255,0.5); color: #515154; border-color: rgba(255,255,255,0.8); }
        body.theme-light .hud-btn:hover { background: #fff; color: #1d1d1f; }
        body.theme-light .hud-btn.active-mode { background: #1d1d1f; color: #fff; }
        body.theme-light .speaker-box { background-color: #1d1d1f; color: #fff; border-color: transparent; }
        
        body.theme-light .modal-header { border-bottom: 1px solid rgba(0, 0, 0, 0.05); }
        body.theme-light .segmented-control { background: rgba(0, 0, 0, 0.04); border: 1px solid transparent; box-shadow: inset 0 1px 4px rgba(0,0,0,0.1); }
        body.theme-light .segment-btn { color: rgba(0, 0, 0, 0.5); }
        body.theme-light .segment-btn.st-btn-active { color: #1d1d1f; background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        body.theme-light .ios-slider { background: rgba(0,0,0,0.1); }
        body.theme-light .ios-slider::-webkit-slider-thumb { box-shadow: 0 2px 8px rgba(0,0,0,0.15), 0 0 0 1px rgba(0,0,0,0.02); background: #1d1d1f;}
        body.theme-light .btn-close { background: rgba(0,0,0,0.04); color: rgba(0,0,0,0.5); }
        body.theme-light .btn-close:hover { background: rgba(0,0,0,0.08); color: #000; }
        
    </style>
</head>
<body>

    <!-- Preloader Screen -->
    <div id="preloader-screen" class="preloader-screen">
        <div class="ambient-glow"></div>
        <div class="loader-ring ring-lg"></div>
        <div class="loader-ring ring-md"></div>
        <div class="loader-ring ring-sm"></div>

        <div class="loader-content">
            <div class="loader-emblem">
                <div class="emblem-circle emblem-outer"></div>
                <div class="emblem-circle emblem-spin"></div>
                <div class="emblem-circle emblem-inner"></div>
                <div class="emblem-circle emblem-inner-spin"></div>
                <div class="emblem-dot"></div>
            </div>

            <h2 class="brand-title-small">The Betweens</h2>
            <p class="brand-subtitle-small">Find your in-between.</p>

            <div class="loading-bar-container">
                <div id="loading-bar-fill" class="loading-bar-fill"></div>
            </div>
            
            <div id="loading-text" class="loading-text">System Boot... 0%</div>
            
            
            <div class="loader-btn-container">
                <button id="start-btn" class="hidden btn-primary" onclick="game.startFromPreloader()">BEGIN</button>
            </div>
        </div>
    </div>

    <!-- Main Game Container -->
    <div id="game-container" class="game-container">
        
        <!-- Background System -->
        <div id="background-wrapper" class="background-wrapper">
            <div id="camera-rig" class="camera-rig camera-move">
                <div id="bg-layer-1" class="bg-layer"></div>
                <div id="bg-layer-2" class="bg-layer"></div>
            </div>
        </div>

        <!-- Overlays -->
        <div class="scanlines"></div>
        <div class="vignette"></div>
        <div id="scene-transition-overlay" class="scene-transition opacity-0"></div>

        <!-- Map Modal -->
        <div id="map-modal" class="modal-overlay hidden opacity-0">
            <div class="modal-glass map-window">
                
                <!-- Search & Menu -->
                <div class="map-search-bar">
                    <button onclick="game.toggleMapMenu()" class="btn-close"><i data-lucide="menu" style="width:16px; height:16px;"></i></button>
                    <input type="text" id="map-search-input" placeholder="Search locations..." class="map-search-input" oninput="game.handleMapSearch(event)">
                    <i data-lucide="search" style="width:16px; height:16px; color:var(--text-secondary);"></i>
                </div>
                
                <div id="map-search-results" class="map-search-results hidden"></div>

                <div id="map-side-menu" class="map-menu-dropdown hidden">
                    <button onclick="game.resetZoom(); game.toggleMapMenu();" class="map-list-btn">
                        <i data-lucide="compass" style="width:16px;height:16px;opacity:0.6;"></i> Center Map
                    </button>
                    <button onclick="game.toggleMapStyle(); game.toggleMapMenu();" class="map-list-btn">
                        <i data-lucide="layers" style="width:16px;height:16px;opacity:0.6;"></i> Toggle Style
                    </button>
                    <button onclick="game.toggleMap(); game.toggleMapMenu();" class="map-list-btn danger">
                        <i data-lucide="x-circle" style="width:16px;height:16px;"></i> Close
                    </button>
                </div>

                <div class="map-controls">
                     <button class="map-control-btn" onclick="game.toggleMapStyle()" title="Toggle View"><i data-lucide="layers" style="width:20px;height:20px;"></i></button>
                     <button class="map-control-btn" onclick="game.resetZoom()" title="Reset View"><i data-lucide="compass" style="width:20px;height:20px;"></i></button>
                     <div class="map-control-group">
                         <button onclick="game.zoomMap(1)"><i data-lucide="plus" style="width:20px;height:20px;"></i></button>
                         <button onclick="game.zoomMap(-1)"><i data-lucide="minus" style="width:20px;height:20px;"></i></button>
                     </div>
                </div>

                <div id="map-container" class="map-viewport"></div>

                <button onclick="game.toggleMap()" class="map-close map-control-btn">
                    <i data-lucide="x" style="width:20px;height:20px;"></i>
                </button>
            </div>
        </div>

        <!-- Phone Modal -->
        <div id="phone-modal" class="modal-overlay hidden opacity-0 phone-container">
            <div class="phone-hardware">
                <div class="phone-btn-power" onclick="game.togglePhone()" title="Power/Lock"></div>
                <div class="phone-btn-vol-up"></div>
                <div class="phone-btn-vol-down"></div>

                <div class="phone-screen-hardware">
                    <div class="phone-notch"><div class="phone-cam-dot"></div></div>

                    <div class="phone-status-bar">
                        <span>09:41</span>
                        <div class="phone-status-icons">
                            <i data-lucide="signal"></i><i data-lucide="wifi"></i><i data-lucide="battery"></i>
                        </div>
                    </div>
                    
                    <div id="phone-display" class="phone-display">
                        <!-- Home Screen -->
                        <div id="phone-home" class="phone-home">
                            <div class="phone-wallpaper"></div>
                            <div class="phone-grid">
                                <div onclick="game.openApp('phone')" class="app-icon-wrapper">
                                    <div class="app-icon-box icon-phone"><i data-lucide="phone" style="width:24px;height:24px;"></i></div>
                                    <span class="app-icon-label">Phone</span>
                                </div>
                                <div onclick="game.openApp('messages')" class="app-icon-wrapper">
                                    <div class="app-icon-box icon-msg"><i data-lucide="message-square" style="width:24px;height:24px;"></i></div>
                                    <span class="app-icon-label">Messages</span>
                                </div>
                                <div onclick="game.openApp('photos')" class="app-icon-wrapper">
                                    <div class="app-icon-box icon-photo"><i data-lucide="image" style="width:24px;height:24px;"></i></div>
                                    <span class="app-icon-label">Photos</span>
                                </div>
                                <div class="app-icon-wrapper" style="opacity:0.5;">
                                    <div class="app-icon-box icon-cam"><i data-lucide="camera" style="width:24px;height:24px;"></i></div>
                                    <span class="app-icon-label">Camera</span>
                                </div>
                                <div onclick="game.openApp('facebook')" class="app-icon-wrapper">
                                    <div class="app-icon-box icon-fb"><i data-lucide="facebook" style="width:24px;height:24px;"></i></div>
                                    <span class="app-icon-label">Facebook</span>
                                </div>
                                <div onclick="game.openApp('youtube')" class="app-icon-wrapper">
                                    <div class="app-icon-box icon-yt"><i data-lucide="youtube" style="width:24px;height:24px;"></i></div>
                                    <span class="app-icon-label">YouTube</span>
                                </div>
                                <div onclick="game.openApp('music')" class="app-icon-wrapper">
                                    <div class="app-icon-box icon-spotify">
                                        <svg viewBox="0 0 24 24" style="width:28px;height:28px;fill:currentColor;"><path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141 4.32-1.38 9.841-.719 13.44 1.5.42.24.6.841.301 1.321zm.12-3.36C15.54 8.46 9.06 8.22 5.34 9.36c-.6.18-1.2-.18-1.38-.72-.18-.6.18-1.2.72-1.38 4.26-1.26 11.4-1.02 15.96 1.68.6.359.84 1.14.479 1.74-.359.6-1.14.84-1.74.48z"/></svg>
                                    </div>
                                    <span class="app-icon-label">Spotify</span>
                                </div>
                                <div onclick="game.openApp('kbzpay')" class="app-icon-wrapper">
                                    <div class="app-icon-box icon-kbz"><span>KBZ</span></div>
                                    <span class="app-icon-label">KBZPay</span>
                                </div>
                            </div>
                        </div>

                        <div id="active-app-container" class="app-screen-container translate-x-full">
                            <div id="app-header-bar" class="app-header glass">
                                <button onclick="game.phoneHome()" class="app-back-btn"><i data-lucide="chevron-left" style="width:24px;height:24px;"></i></button>
                                <span id="app-title-text" class="app-title">App Name</span>
                            </div>
                            <div id="app-content-area" class="app-content custom-scroll"></div>
                        </div>
                    </div>

                    <div class="phone-home-indicator-wrap" onclick="game.phoneHome()">
                        <div class="phone-home-indicator"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Modal -->
        <div id="settings-modal" class="modal-overlay hidden opacity-0">
            <div class="modal-glass settings-window">
                <div class="modal-header">
                    <h2 id="st-title" class="modal-title">Settings</h2>
                    <button onclick="game.closeSettings()" class="btn-close"><i data-lucide="x" style="width:20px;height:20px;"></i></button>
                </div>
                
                <div class="settings-scroll custom-scroll">
                    <div class="st-row">
                        <div class="st-label"><i data-lucide="volume-2"></i><span id="st-ga-vol">Master Volume</span></div>
                        <input type="range" id="ga-vol-slider" min="0" max="1" step="0.1" value="1" oninput="game.setVolume(this.value)" class="ios-slider">
                    </div>

                    <div class="st-row">
                        <div class="st-label"><i data-lucide="music"></i><span id="st-tm-vol">Theme Music</span></div>
                        <input type="range" id="tm-vol-slider" min="0" max="1" step="0.1" value="0.4" oninput="game.setThemeVolume(this.value)" class="ios-slider">
                    </div>

                    <div class="st-row">
                        <div class="st-label"><i data-lucide="speaker"></i><span id="st-ga-state">Scene Audio</span></div>
                        <div class="segmented-control">
                            <button onclick="game.setGameAudio('on')" data-val="on" class="segment-btn st-btn-ga st-btn-active"><span id="st-ga-on">On</span></button>
                            <button onclick="game.setGameAudio('off')" data-val="off" class="segment-btn st-btn-ga"><span id="st-ga-off">Off</span></button>
                        </div>
                    </div>

                    <div class="st-row">
                        <div class="st-label"><i data-lucide="type"></i><span id="st-font">Typography Size</span></div>
                        <div class="segmented-control">
                            <button onclick="game.setFontSize('small')" data-val="small" class="segment-btn st-btn-font"><span id="st-font-sm">Small</span></button>
                            <button onclick="game.setFontSize('medium')" data-val="medium" class="segment-btn st-btn-font st-btn-active"><span id="st-font-md">Medium</span></button>
                            <button onclick="game.setFontSize('large')" data-val="large" class="segment-btn st-btn-font"><span id="st-font-lg">Large</span></button>
                        </div>
                    </div>

                    <div class="st-row">
                        <div class="st-label"><i data-lucide="monitor"></i><span id="st-gfx">Render Quality</span></div>
                        <div class="segmented-control">
                            <button onclick="game.setGraphics('low')" data-val="low" class="segment-btn st-btn-gfx"><span id="st-gfx-low">Low</span></button>
                            <button onclick="game.setGraphics('medium')" data-val="medium" class="segment-btn st-btn-gfx"><span id="st-gfx-med">Medium</span></button>
                            <button onclick="game.setGraphics('high')" data-val="high" class="segment-btn st-btn-gfx st-btn-active"><span id="st-gfx-high">High</span></button>
                        </div>
                    </div>

                    <div class="st-row">
                        <div class="st-label"><i data-lucide="globe"></i><span id="st-lang">System Language</span></div>
                        <div class="segmented-control">
                            <button onclick="game.setLanguage('en')" data-val="en" class="segment-btn st-btn-lang">English</button>
                            <button onclick="game.setLanguage('mm')" data-val="mm" class="segment-btn st-btn-lang st-btn-active"></button>
                        </div>
                    </div>

                    <div class="st-row">
                        <div class="st-label"><i data-lucide="sun-moon"></i><span id="st-theme">Environment Mode</span></div>
                        <div class="segmented-control">
                            <button onclick="game.setTheme('dark')" data-val="dark" class="segment-btn st-btn-theme st-btn-active"><span id="st-theme-dark">Dark</span></button>
                            <button onclick="game.setTheme('light')" data-val="light" class="segment-btn st-btn-theme"><span id="st-theme-light">Light</span></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gallery Modal -->
        <div id="gallery-modal" class="modal-overlay hidden opacity-0">
            <div class="modal-glass gallery-window">
                <div class="modal-header">
                    <h2 class="modal-title">Memory Records</h2>
                    <button onclick="game.closeGallery()" class="btn-close"><i data-lucide="x" style="width:20px;height:20px;"></i></button>
                </div>
                <div id="gallery-grid" class="gallery-grid custom-scroll"></div>
            </div>
        </div>

        <!-- Image Viewer Modal -->
        <div id="image-viewer-modal" class="modal-overlay viewer-modal hidden opacity-0">
            <div class="viewer-nav">
                <button onclick="game.closeImageViewer()" class="viewer-btn"><i data-lucide="arrow-left" style="width:20px;height:20px;"></i></button>
                <div style="display:flex;gap:16px;">
                    <button onclick="game.toggleImageViewerSize()" class="viewer-btn" title="Toggle Size"><i data-lucide="maximize" id="iv-size-icon" style="width:20px;height:20px;"></i></button>
                    <button onclick="game.downloadCurrentImage()" class="viewer-btn" title="Download"><i data-lucide="download" style="width:20px;height:20px;"></i></button>
                </div>
            </div>
            <div id="viewer-img-container" class="viewer-container">
                <img id="viewer-image" src="" class="viewer-img" alt="Memory Viewer">
            </div>
            <div class="viewer-caption-box">
                <h3 id="viewer-caption" class="viewer-caption-text"></h3>
            </div>
        </div>

        <!-- Main UI Layer -->
        <div id="ui-layer" class="ui-layer hidden">
            
            <div class="hud-top">
                <div class="hud-left">
                    <div id="location-tag" class="glass-panel location-pill">
                        <i data-lucide="map-pin" style="width:16px;height:16px;opacity:0.8;"></i>
                        <div>
                            <span id="location-text" class="location-text">YANGON</span>
                            <span id="time-text" class="time-text">DAY 1 - 08:00 AM</span>
                        </div>
                    </div>
                    
                    <div id="notif-container" class="notif-container">
                        <!-- Unlock Notif -->
                        <div id="unlock-notification" class="notification-toast hidden">
                            <div class="notif-icon-wrap"><i data-lucide="unlock" style="width:16px;height:16px;"></i></div>
                            <div style="overflow:hidden;">
                                <div class="notif-meta">Access Granted</div>
                                <div id="unlock-text" class="notif-val">Home</div>
                            </div>
                        </div>
                        
                        <!-- Currency Notif -->
                        <div id="currency-notification" class="notification-toast hidden">
                            <div class="notif-icon-wrap"><i data-lucide="credit-card" style="width:16px;height:16px;"></i></div>
                            <div style="overflow:hidden;">
                                <div class="notif-meta">Transaction</div>
                                <div id="currency-text" class="notif-val" style="font-family:monospace;">0 MMK</div>
                            </div>
                        </div>
                        
                        <!-- Audio Notif -->
                        <div id="audio-notification" class="notification-toast hidden">
                            <div class="notif-icon-wrap"><i id="audio-toast-icon" data-lucide="volume-2" style="width:16px;height:16px;"></i></div>
                            <div style="overflow:hidden;">
                                <div class="notif-meta">System Audio</div>
                                <div id="audio-toast-text" class="notif-val" style="font-family:monospace;">Unmuted</div>
                            </div>
                        </div>

                        <!-- Memory Notif -->
                        <div id="memo-notification" class="notification-toast hidden">
                            <div class="notif-icon-wrap"><i data-lucide="image" style="width:16px;height:16px;"></i></div>
                            <div style="overflow:hidden;">
                                <div class="notif-meta">Memory Unlocked</div>
                                <div id="memo-text" class="notif-val">Memory Name</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="hud-right">
                    <div class="glass-panel action-bar">
                        <button onclick="game.togglePhone()" class="hud-btn"><i data-lucide="smartphone" style="width:16px;height:16px;"></i><span class="tooltip">Device</span></button>
                        <button onclick="game.toggleMap()" class="hud-btn"><i data-lucide="map" style="width:16px;height:16px;"></i><span class="tooltip">Map</span></button>
                        <button onclick="game.saveGameManual()" class="hud-btn"><i data-lucide="hard-drive" style="width:16px;height:16px;"></i><span class="tooltip">Save</span></button>
                        <button onclick="game.openSettings()" class="hud-btn"><i data-lucide="sliders" style="width:16px;height:16px;"></i><span class="tooltip" id="hud-st-tip">Settings</span></button>

                        <div class="hud-divider"></div>

                        <button onclick="game.toggleLang()" class="hud-btn w-wide"><span id="lang-btn" style="font-weight:600;font-size:11px;letter-spacing:0.1em;">MM</span></button>
                        <button onclick="game.toggleAuto()" id="auto-btn" class="hud-btn"><i data-lucide="play" style="width:16px;height:16px;"></i><span class="tooltip">Auto</span></button>
                        <button onclick="game.toggleMuteShortcut()" class="hud-btn"><i id="audio-icon" data-lucide="volume-2" style="width:16px;height:16px;"></i><span class="tooltip">Audio</span></button>

                        <div class="hud-divider"></div>

                        <button onclick="game.toggleImmersive()" class="hud-btn"><i data-lucide="focus" style="width:16px;height:16px;"></i><span class="tooltip">Immersive</span></button>
                        <button onclick="game.takeScreenshot()" class="hud-btn"><i data-lucide="camera" style="width:16px;height:16px;"></i><span class="tooltip">Capture</span></button>
                        <button onclick="game.toggleFullscreen()" id="fs-btn" class="hud-btn"><i data-lucide="maximize" style="width:16px;height:16px;"></i><span class="tooltip">Expand</span></button>

                        <div class="hud-divider"></div>

                        <button onclick="game.quitToMenu()" class="hud-btn hud-btn-danger"><i data-lucide="log-out" style="width:16px;height:16px;"></i><span class="tooltip" id="hud-quit-tip">Exit</span></button>
                    </div>
                </div>
            </div>

            <div class="interaction-area">
                <div id="choices-container" class="choices-container custom-scroll"></div>
                
                <div id="dialogue-box" class="dialogue-box" onclick="game.next()">
                    <div id="speaker-box" class="speaker-box hidden"><span id="speaker-name">NAME</span></div>
                    <p id="dialogue-text" class="dialogue-text"></p>
                    <div id="next-indicator" class="next-indicator"><i data-lucide="chevron-down"></i></div>
                </div>
            </div>
        </div>

        <!-- Start Screen -->
        <div id="start-screen" class="start-screen">
            <video id="main-menu-video" loop muted playsinline class="start-video">
                <source src="../videos/hero-video4.mp4" type="video/mp4">
            </video>
            
            <div class="start-gradient"></div>
            
            <div class="start-content">
                <div class="start-left">
                    <div class="anim-slide-up" style="animation-delay: 0.1s;">
                        <div class="version-badge">
                            <div class="version-dot"></div>
                            <span class="version-text">Initial Release - Block 1.0.0</span>
                        </div>
                    </div>

                    <div class="anim-slide-up" style="animation-delay: 0.2s;">
                        <h1 class="main-title">The<br><strong>Betweens</strong></h1>
                    </div>

                    <div class="anim-slide-up" style="animation-delay: 0.3s; display:flex; flex-direction:column; gap:16px;">
                        <p class="subtitle">Two worlds. One reality.</p>
                        <p class="description">Navigate the fractured timelines of Yangon. Uncover the truth hidden in the echoes of the city. Your choices define the reality you wake up in.</p>
                    </div>
                </div>

                <div class="start-right anim-slide-up" style="animation-delay: 0.5s;">
                    <div class="menu-list">
                        <button onclick="game.init()" class="menu-item primary"><span id="st-menu-new">New Journey</span></button>
                        <button onclick="game.loadGame()" id="load-btn" class="menu-item hidden"><span id="st-menu-load">Continue Journey</span></button>
                        <button onclick="game.openGallery()" class="menu-item"><span id="st-menu-gallery">Memory Records</span></button>
                        <button onclick="game.openSettings()" class="menu-item"><span id="st-menu-set">System Settings</span></button>
                        <button onclick="alert('Feature coming in next update')" class="menu-item"><span id="st-menu-terms">User Agreement</span></button>
                        <button onclick="alert('Feature coming in next update')" class="menu-item"><span id="st-menu-credits">Project Credits</span></button>
                        <button onclick="location.href='../index.html'" class="menu-item danger"><span id="st-menu-quit">Leave Session</span></button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC (Untouched Core, Refactored HTML injections) -->
    <script>
    // --- DICTIONARY FOR SETTINGS ---
    const SETTINGS_DICT = {
        title: { en: "System Parameters", mm: "" },
        ga_vol: { en: "Master Volume", mm: "" },
        ga_vol_tip: { en: "Adjusts the volume of game sound effects.", mm: "  " },
        tm_vol: { en: "Theme Audio", mm: "" },
        tm_vol_tip: { en: "Adjusts the volume of the main theme song.", mm: "  " },
        ga_state: { en: "Scene Ambience", mm: "" },
        ga_state_tip: { en: "Toggle the scene specific sound effects.", mm: "   " },
        ga_on: { en: "Enabled", mm: "" },
        ga_off: { en: "Disabled", mm: "" },
        font_size: { en: "Typography Scale", mm: "" },
        font_tip: { en: "Changes the size of the reading text.", mm: "   " },
        font_sm: { en: "Compact", mm: "" },
        font_md: { en: "Standard", mm: "" },
        font_lg: { en: "Expanded", mm: "" },
        graphics: { en: "Render Quality", mm: "" },
        gfx_tip: { en: "Lowers visual effects for better performance.", mm: "  " },
        gfx_low: { en: "Performance", mm: "" },
        gfx_med: { en: "Balanced", mm: "" },
        gfx_high: { en: "Quality", mm: "" },
        language: { en: "Localization", mm: "" },
        lang_tip: { en: "Switch between English and Burmese.", mm: "  " },
        theme: { en: "Environment", mm: "" },
        theme_tip: { en: "Toggle between Dark and Light mode.", mm: "  " },
        theme_dark: { en: "Dark", mm: "" },
        theme_light: { en: "Light", mm: "" },
        menu_new: { en: "New Journey", mm: "" },
        menu_load: { en: "Continue Journey", mm: "" },
        menu_gallery: { en: "Memories", mm: "" },
        menu_set: { en: "Settings", mm: "" },
        menu_terms: { en: "Legal", mm: ""},
        menu_credits: { en: "Credits", mm: ""},
        menu_quit: { en: "Leave", mm: "" },
        hud_quit: { en: "Exit", mm: "" }
    };

    // --- LOCATION DATABASE ---
    const LOCATIONS = [
        { id: 'imc', type: 'school', lat: 16.823366, lng: 96.130645, name: { en: "Info Myanmar College", mm: "Info Myanmar College" }, scene: 'school_imc' },
        { id: 'naung_gyi', type: 'home', lat: 16.849836, lng: 96.157178, name: { en: "Naung Gyi's House", mm: " " }, scene: 'home_naunggyi' },
        { id: 'home', type: 'home', lat: 16.880386, lng: 96.156378, name: { en: "Tayza's House", mm: " " }, scene: 'intro-tayza' },
        { id: 'shwedagon', type: 'shwedagon_pagoda', lat: 16.7984, lng: 96.1496, name: { en: "Shwedagon Pagoda", mm: "" }, scene: 'shwedagon_arrival' },
        { id: 'kantawgyi', type: 'park', lat: 16.795, lng: 96.166, name: { en: "Kandawgyi Lake", mm: "" }, scene: 'place_kantawgyi' },
        { id: 'inyalake', type: 'park', lat: 16.837, lng: 96.143, name: { en: "Inya Lake", mm: "" }, scene: 'place_inya' },
        { id: 'mmplaza', type: 'mmplaza', lat: 16.827439, lng: 96.154957, name: { en: "Myanmar Plaza", mm: "" }, scene: 'place_mmplaza' },
        { id: 'junction_city', type: 'mall', lat: 16.7792557, lng: 96.1544072, name: { en: "Junction City", mm: "Junction City" }, scene: 'mall_jc' },
        { id: 'hmone_gyi', type: 'tea_shop', lat: 16.785, lng: 96.145, name: { en: "Hmone Gyi Tea Shop", mm: "" }, scene: 'tea_hmonegyi' },
        { id: 'sule', type: 'sule_pagoda', lat: 16.7744, lng: 96.1586, name: { en: "Sule Pagoda", mm: "" }, scene: 'place_sule' },
        { id: 'downtown', type: 'city', lat: 16.775327, lng: 96.151123, name: { en: "Downtown", mm: "" }, scene: 'place_downtown' },
        { id: 'alwan_cafe', type: 'cafe_shop', lat: 16.780, lng: 96.150, name: { en: "A Lwan Caf", mm: "" }, scene: 'cafe_alwan' },
    ];

    // --- MEMORIES DATABASE ---
    const MEMORIES = [
        { id: 'memo_downtown', name: { en: "Downtown Echoes", mm: " " }, url: "../images/places/downtown.png" },
        { id: 'memo_sule', name: { en: "Golden Sule", mm: "" }, url: "https://images.unsplash.com/photo-1627993436034-71f496738923?q=80&w=600&auto=format&fit=crop" },
        { id: 'memo_shwedagon', name: { en: "Timeless Shwedagon", mm: "" }, url: "https://images.unsplash.com/photo-1550684848-fac1c5b4e853?q=80&w=600&auto=format&fit=crop" },
        { id: 'memo_rain', name: { en: "Rainy Streets", mm: "" }, url: "https://images.unsplash.com/photo-1515694346937-94d85e41e6f0?q=80&w=600&auto=format&fit=crop" },
        { id: 'memo_cafe', name: { en: "A Lwan Cafe", mm: "" }, url: "https://images.unsplash.com/photo-1509042239860-f550ce710b93?q=80&w=600&auto=format&fit=crop" },
        { id: 'memo_train', name: { en: "Circular Train", mm: "" }, url: "https://images.unsplash.com/photo-1541427468627-a89a96e5ca1d?q=80&w=600&auto=format&fit=crop" },
        { id: 'memo_sunset', name: { en: "Kandawgyi Sunset", mm: "" }, url: "https://images.unsplash.com/photo-1504198458649-3128b932f49e?q=80&w=600&auto=format&fit=crop" },
        { id: 'memo_night', name: { en: "Neon Nights", mm: "" }, url: "https://images.unsplash.com/photo-1555662100-3051bc7d2a5d?q=80&w=600&auto=format&fit=crop" },
        { id: 'memo_tea', name: { en: "Hmone Gyi Tea", mm: "" }, url: "https://images.unsplash.com/photo-1556740738-b6a63e27c4df?q=80&w=600&auto=format&fit=crop" },
        { id: 'memo_books', name: { en: "Old Bookshop", mm: "" }, url: "https://images.unsplash.com/photo-1507842217343-583bb7270b66?q=80&w=600&auto=format&fit=crop" },
        { id: 'memo_market', name: { en: "Bogyoke Market", mm: "" }, url: "https://images.unsplash.com/photo-1533900298318-6b8da08a523e?q=80&w=600&auto=format&fit=crop" },
        { id: 'memo_bridge', name: { en: "Inya Bridge", mm: "" }, url: "https://images.unsplash.com/photo-1544473244-f6895e69da8e?q=80&w=600&auto=format&fit=crop" },
        { id: 'memo_alley', name: { en: "Secret Alleys", mm: "" }, url: "https://images.unsplash.com/photo-1514539079130-25950c84af65?q=80&w=600&auto=format&fit=crop" },
        { id: 'memo_parallel', name: { en: "The Other Side", mm: "" }, url: "https://images.unsplash.com/photo-1518002171953-a080ee817e1f?q=80&w=600&auto=format&fit=crop" },
        { id: 'memo_ring', name: { en: "The Ring", mm: "" }, url: "https://images.unsplash.com/photo-1605100804763-247f679f18a2?q=80&w=600&auto=format&fit=crop" }
    ];
    
    // --- ASSETS DATABASE ---
    const ASSETS = {
        bg: {
            downtown: "../images/places/downtown.png",
            sule: "../images/places/sule.png",
            shwedagon: "../images/places/shwedagon.png",
            shwedagon_stairs: "../images/places/shwedagon_stairs.png",
            shwedagon_night: "../images/places/shwedagon_night.png",
            kantawgyi: "../images/places/kantawg.png",
            home_tayza: "../images/places/home_tayza.png",
            alarm: "../images/items/alarm.png",
            sleep_tayza: "../images/person/sleep-tayza.png",
            wakeup_tayza: "../images/person/wakeup-tayza.png",
            oldfan: "../images/items/oldfan.png",
            missedcall: "../images/items/missedcall.png",
            stair: "../images/places/stair.png",
            kitchen: "../images/places/kitchen.png",
            livingroom: "../images/places/livingroom.png",
            bathroom: "../images/places/bathroom.png",
            dining_room: "../images/places/dining_room.png",
            bedroom_night: "../images/places/bedroom_night.png",
            parallel_sule: "../images/places/parallel_sule.png",
            parallel_street: "../images/places/parallel_street.png",
            ring_item: "../images/items/ring.png",
            faceless_mom: "../images/person/faceless_mom.png"
        },
        audio: {
            click: "../audios/click.mp3",
            notif: "../audios/notification.mp3",
            main_theme: "../audios/main_theme.mp3",
            morning_chant: "../audios/morning_bird.mp3",
            alarm: "../audios/alarm.mp3",
            yawn: "../audios/yawn.mp3",
            oldfan: "../audios/oldfan.mp3",
            stair: "../audios/footstep.mp3",
            kitchen: "../audios/kitchen.mp3",
            water_splash: "../audios/water_splash.mp3",
            pagoda_bells: "../audios/pagoda_bells.mp3",
            city_ambience: "../audios/city_ambience.mp3",
            creepy_drone: "../audios/creepy_drone.mp3"
        },
        icons: {
            home: "../images/places/home.gif",
            shwedagon_pagoda: "../images/places/pagoda.gif",
            sule_pagoda: "../images/places/pagoda.gif",
            tea_shop: "../images/places/cafe-tea.gif",
            cafe_shop: "../images/places/cafe-tea.gif",
            school: "../images/places/school.gif",
            mall: "../images/places/mall.gif",
            park: "../images/places/lake.gif",
            city: "../images/places/city.gif",
            player: "../images/places/current.gif", 
            tree: "../images/places/tree.gif",
            inyalake: "../images/places/lake.gif",
            mmplaza: "../images/places/mall.gif",
        }
    };

    // --- GAME ENGINE ---
    class GameEngine {
        constructor() {
            this.state = {
                stats: { sanity: 100, trust: 0, life: 50, knowledge: 0 },
                flags: {},
                currency: 0, 
                day: 1,
                sceneId: 'start',
                lang: 'en',
                settings: { volume: 1.0, themeVolume: 0.4, gameAudio: 'on', fontSize: 'medium', graphics: 'high', theme: 'dark' }
            };
            this.typingSpeed = 20;
            this.isTyping = false;
            this.typingTimer = null; 
            this.autoPlayTimer = null; 
            this.audioNotifTimer = null;
            this.autoPlay = false; 
            this.isTransitioning = false;
            this.sceneData = null;
            this.dialogueIndex = 0;
            this.audio = new AudioController();
            this.activeLayer = 1; 
            this.currentBgKey = null; 
            this.immersiveMode = false;
            this.mapOpen = false;
            this.phoneOpen = false;
            this.settingsOpen = false;
            this.phoneApp = null;
            this.currentViewMemo = null;
            
            // MapLibre properties
            this.map = null;
            this.markers = [];
            this.currentMapStyle = 'normal';
            this.mapStyles = {
                normal: 'https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json',
                satellite: {
                    "version": 8,
                    "sources": {
                        "esri-satellite": {
                            "type": "raster",
                            "tiles": ["https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}"],
                            "tileSize": 256,
                            "attribution": ""
                        }
                    },
                    "layers": [{
                        "id": "satellite",
                        "type": "raster",
                        "source": "esri-satellite",
                        "minzoom": 0,
                        "maxzoom": 19
                    }]
                }
            };

            if(localStorage.getItem('ringGameSave_V5')) {
                const btn = document.getElementById('load-btn');
                btn.classList.remove('hidden');
                btn.classList.add('flex');
            }
            
            const saveStr = localStorage.getItem('ringGameSave_V5');
            if(saveStr) {
                const parsed = JSON.parse(saveStr);
                if(parsed.settings) this.state.settings = parsed.settings;
            }
            if (this.state.settings.themeVolume === undefined) this.state.settings.themeVolume = 0.4;
            if (this.state.settings.gameAudio === undefined) this.state.settings.gameAudio = 'on';
            
            this.applySettings();
            this.renderSettingsText();
            this.initPreloader();
        }

        initPreloader() {
            const allAssets = [];
            if (ASSETS.bg) Object.values(ASSETS.bg).forEach(url => allAssets.push({type: 'image', url}));
            if (ASSETS.icons) Object.values(ASSETS.icons).forEach(url => allAssets.push({type: 'image', url}));
            if (ASSETS.audio) Object.values(ASSETS.audio).forEach(url => allAssets.push({type: 'audio', url}));
            allAssets.push({type: 'video', url: 'https://www.pexels.com/download/video/6205145/'});

            let loadedCount = 0;
            const totalAssets = allAssets.length;
            const barFill = document.getElementById('loading-bar-fill');
            const loadText = document.getElementById('loading-text');
            const startBtn = document.getElementById('start-btn');

            const playPreloaderAudio = () => {
                if (this.audio && this.audio.themeMusic && this.audio.themeMusic.paused) {
                    this.audio.themeMusic.volume = this.state.settings.themeVolume !== undefined ? this.state.settings.themeVolume : 0.4;
                    this.audio.themeMusic.play().catch(e => console.log("Autoplay blocked."));
                }
            };
            playPreloaderAudio();
            document.addEventListener('click', playPreloaderAudio, { once: true });

            const updateProgress = () => {
                loadedCount++;
                let percent = Math.floor((loadedCount / totalAssets) * 100);
                if(barFill) barFill.style.width = percent + '%';
                if(loadText) loadText.innerText = `System Boot... ${percent}%`;
                if (loadedCount >= totalAssets && loadText && loadText.innerText !== "Initialization Complete - Click 'Begin' to proceed.") {
                    if(loadText) loadText.innerText = "Initialization Complete - Click 'Begin' to proceed.";
                    if(startBtn) startBtn.classList.remove('hidden');
                }
            };

            if (totalAssets === 0) { updateProgress(); return; }

            allAssets.forEach(asset => {
                if (asset.type === 'image') { const img = new Image(); img.onload = updateProgress; img.onerror = updateProgress; img.src = asset.url; }
                else if (asset.type === 'audio') { const aud = new Audio(); aud.addEventListener('canplaythrough', updateProgress, { once: true }); aud.addEventListener('error', updateProgress, { once: true }); aud.src = asset.url; aud.load(); }
                else if (asset.type === 'video') { const vid = document.createElement('video'); vid.addEventListener('canplaythrough', updateProgress, { once: true }); vid.addEventListener('error', updateProgress, { once: true }); vid.src = asset.url; vid.load(); }
            });

            setTimeout(() => {
                if (loadedCount < totalAssets) { loadedCount = totalAssets - 1; updateProgress(); }
            }, 6000); 
        }

        startFromPreloader() {
            const preloader = document.getElementById('preloader-screen');
            if (preloader) {
                preloader.classList.add('opacity-0');
                const bgVideo = document.getElementById('main-menu-video');
                if(bgVideo) bgVideo.play().catch(e => console.log(e));
                setTimeout(() => { preloader.classList.add('hidden'); }, 1000);
            }
        }

        init() {
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('ui-layer').classList.remove('hidden');
            document.getElementById('ui-layer').classList.add('flex');
            lucide.createIcons();
            this.loadScene('yangon_intro');
            this.setupMapInteractions();
            this.updateCurrency(0);
        }

        quitToMenu() {
            document.getElementById('ui-layer').classList.add('hidden');
            document.getElementById('ui-layer').classList.remove('flex');
            const startScreen = document.getElementById('start-screen');
            startScreen.classList.remove('hidden');
            startScreen.classList.remove('opacity-0');
            const loadBtn = document.getElementById('load-btn');
            loadBtn.classList.remove('hidden');
            loadBtn.classList.add('flex');
            
            this.isTyping = false;
            if(this.typingTimer) clearTimeout(this.typingTimer);
            if(this.autoPlayTimer) clearTimeout(this.autoPlayTimer);
            if (this.audio && this.audio.bgMusic) this.audio.bgMusic.pause();
            this.saveGameManual();
        }
        
        setupMapInteractions() {}

        toggleMap() {
            const modal = document.getElementById('map-modal');
            if (this.mapOpen) {
                modal.classList.add('opacity-0');
                setTimeout(() => modal.classList.add('hidden'), 500);
            } else {
                modal.classList.remove('hidden');
                void modal.offsetWidth; 
                modal.classList.remove('opacity-0');
                
                this.renderMap();
                
                setTimeout(() => { if (this.map) this.map.resize(); }, 50);
                setTimeout(() => { if (this.map) this.map.resize(); }, 500); 
            }
            this.mapOpen = !this.mapOpen;
        }

        toggleMapMenu() {
            const menu = document.getElementById('map-side-menu');
            if (menu.classList.contains('hidden')) {
                menu.classList.remove('hidden');
                menu.classList.add('flex');
                document.getElementById('map-search-results').classList.add('hidden');
            } else {
                menu.classList.add('hidden');
                menu.classList.remove('flex');
            }
        }

        handleMapSearch(e) {
            const query = e.target.value.toLowerCase();
            const resultsContainer = document.getElementById('map-search-results');
            document.getElementById('map-side-menu').classList.add('hidden'); 
            
            if (!query) {
                resultsContainer.classList.add('hidden');
                resultsContainer.classList.remove('flex');
                return;
            }
            
            const matches = LOCATIONS.filter(loc => {
                const nameEn = (loc.name.en || '').toLowerCase();
                const nameMm = (loc.name.mm || '').toLowerCase();
                return nameEn.includes(query) || nameMm.includes(query);
            });
            
            if (matches.length > 0) {
                resultsContainer.innerHTML = '';
                matches.forEach(loc => {
                    const btn = document.createElement('button');
                    btn.className = "map-list-btn";
                    const dispName = loc.name[this.state.lang] || loc.name.en;
                    btn.innerHTML = `
                        <i data-lucide="map-pin" style="width:16px;height:16px;opacity:0.6;"></i>
                        <span>${dispName}</span>
                    `;
                    btn.onclick = () => {
                        if(this.map) this.map.flyTo({ center: [loc.lng, loc.lat], zoom: 16 });
                        resultsContainer.classList.add('hidden');
                        resultsContainer.classList.remove('flex');
                        document.getElementById('map-search-input').value = dispName;
                    };
                    resultsContainer.appendChild(btn);
                });
                resultsContainer.classList.remove('hidden');
                resultsContainer.classList.add('flex');
                lucide.createIcons();
            } else {
                resultsContainer.innerHTML = '<div style="padding:16px; text-align:center; font-size:12px; color:var(--text-secondary);">No coordinates found.</div>';
                resultsContainer.classList.remove('hidden');
                resultsContainer.classList.add('flex');
            }
        }

        toggleMapStyle() {
            if (!this.map) return;
            this.currentMapStyle = this.currentMapStyle === 'normal' ? 'satellite' : 'normal';
            this.map.setStyle(this.mapStyles[this.currentMapStyle]);
        }

        togglePhone() {
            const modal = document.getElementById('phone-modal');
            if (this.phoneOpen) {
                modal.classList.add('opacity-0');
                setTimeout(() => { modal.classList.add('hidden'); this.phoneHome(); }, 500);
            } else {
                modal.classList.remove('hidden');
                void modal.offsetWidth; 
                modal.classList.remove('opacity-0');
            }
            this.phoneOpen = !this.phoneOpen;
        }

        phoneHome() {
            const activeApp = document.getElementById('active-app-container');
            activeApp.classList.remove('app-screen-active');
            activeApp.classList.add('translate-x-full');
            this.phoneApp = null;
        }

        toggleMusic() {
            const audio = document.getElementById('music-player-audio');
            const icon = document.getElementById('music-play-icon');
            if (!audio) return;
            if (audio.paused) { audio.play(); icon.parentElement.innerHTML = '<i id="music-play-icon" data-lucide="pause" style="width:28px;height:28px;fill:#000;"></i>'; lucide.createIcons(); } 
            else { audio.pause(); icon.parentElement.innerHTML = '<i id="music-play-icon" data-lucide="play" style="width:28px;height:28px;fill:#000;margin-left:4px;"></i>'; lucide.createIcons(); }
        }

        updateMusicProgress() {
            const audio = document.getElementById('music-player-audio');
            const progress = document.getElementById('music-progress');
            const thumb = document.getElementById('music-thumb');
            const current = document.getElementById('music-current-time');
            if (audio && progress) {
                const percent = (audio.currentTime / audio.duration) * 100;
                progress.style.width = `${percent}%`;
                if(thumb) thumb.style.left = `${percent}%`;
                const mins = Math.floor(audio.currentTime / 60); const secs = Math.floor(audio.currentTime % 60);
                current.innerText = `${mins}:${secs < 10 ? '0' : ''}${secs}`;
            }
        }

        initMusicDuration() {
            const audio = document.getElementById('music-player-audio');
            const total = document.getElementById('music-duration');
            if (audio && total) {
                const mins = Math.floor(audio.duration / 60); const secs = Math.floor(audio.duration % 60);
                total.innerText = `${mins}:${secs < 10 ? '0' : ''}${secs}`;
            }
        }

        openApp(appName) {
            this.phoneApp = appName;
            const activeApp = document.getElementById('active-app-container');
            const contentArea = document.getElementById('app-content-area');
            const title = document.getElementById('app-title-text');
            const header = document.getElementById('app-header-bar');

            let html = '';
            
            if (appName === 'phone') {
                title.innerText = "Phone";
                header.className = "app-header glass";
                html = `
                    <div class="phone-app-inner">
                        <div style="flex:1; display:flex; flex-direction:column; justify-content:center;">
                             <div class="dialer-grid">
                                 <button class="dial-btn">1</button><button class="dial-btn">2</button><button class="dial-btn">3</button>
                                 <button class="dial-btn">4</button><button class="dial-btn">5</button><button class="dial-btn">6</button>
                                 <button class="dial-btn">7</button><button class="dial-btn">8</button><button class="dial-btn">9</button>
                                 <button class="dial-btn">*</button><button class="dial-btn">0</button><button class="dial-btn">#</button>
                             </div>
                             <div class="call-btn-wrap">
                                 <button class="call-btn"><i data-lucide="phone" style="width:32px;height:32px;fill:currentColor;"></i></button>
                             </div>
                        </div>
                    </div>
                `;
            } else if (appName === 'messages') {
                title.innerText = "Messages";
                header.className = "app-header glass";
                html = `
                    <div class="msg-list">
                        <div class="msg-item">
                            <div class="msg-avatar">M</div>
                            <div class="msg-content">
                                <div class="msg-top"><span class="msg-name">Mom</span> <span class="msg-time">14m</span></div>
                                <div class="msg-text">Please come home early today...</div>
                            </div>
                        </div>
                        <div class="msg-item">
                            <div class="msg-avatar">N</div>
                            <div class="msg-content">
                                <div class="msg-top"><span class="msg-name">Nay Chi</span> <span class="msg-time">Yesterday</span></div>
                                <div class="msg-text">Are you free this weekend?</div>
                            </div>
                        </div>
                    </div>
                `;
            } else if (appName === 'photos') {
                title.innerText = "Photos";
                header.className = "app-header glass";
                html = `
                    <div class="photo-grid">
                        <div class="photo-item" style="background-image:url('https://images.pexels.com/photos/36134594/pexels-photo-36134594.jpeg');"></div>
                        <div class="photo-item" style="background-image:url('https://images.pexels.com/photos/36134593/pexels-photo-36134593.jpeg');"></div>
                        <div class="photo-item" style="background-image:url('https://images.pexels.com/photos/34848148/pexels-photo-34848148.jpeg');"></div>
                        <div class="photo-item" style="background-image:url('https://images.pexels.com/photos/34607842/pexels-photo-34607842.jpeg');"></div>
                    </div>
                `;
            } else if (appName === 'facebook') {
                title.innerText = "Facebook";
                header.className = "app-header";
                header.style.background = "#1877f2";
                header.style.borderBottom = "none";
                html = `
                    <div class="fb-app">
                        <div class="fb-compose">
                             <div class="fb-compose-av"></div>
                             <div class="fb-compose-input">What's on your mind?</div>
                        </div>
                        <div class="fb-post">
                            <div class="fb-post-header">
                                <div class="fb-post-av" style="background:rgba(220,38,38,0.2);color:#ef4444;"><i data-lucide="newspaper" style="width:20px;height:20px;"></i></div>
                                <div><div class="fb-post-name">Yangon News</div><div class="fb-post-time">2 hrs ago</div></div>
                            </div>
                            <div class="fb-post-text">Heavy rain expected in downtown Yangon this evening. Please drive safely.</div>
                            <div class="fb-post-img" style="background-image:url('https://images.unsplash.com/photo-1515347619252-60a6bf4fffce?q=80&w=600&auto=format&fit=crop');"></div>
                            <div class="fb-post-actions">
                                <span class="fb-action-btn"><i data-lucide="thumbs-up" style="width:16px;height:16px;"></i> Like</span>
                                <span class="fb-action-btn"><i data-lucide="message-circle" style="width:16px;height:16px;"></i> Comment</span>
                                <span class="fb-action-btn"><i data-lucide="share" style="width:16px;height:16px;"></i> Share</span>
                            </div>
                        </div>
                        <div class="fb-post">
                            <div class="fb-post-header">
                                <div class="fb-post-av" style="background:rgba(168,85,247,0.2);color:#c084fc;">N</div>
                                <div><div class="fb-post-name">Nay Chi updated her profile picture.</div><div class="fb-post-time">5 hrs ago</div></div>
                            </div>
                            <div class="fb-post-img" style="background-image:url('https://images.unsplash.com/photo-1534528741775-53994a69daeb?q=80&w=600&auto=format&fit=crop');"></div>
                             <div class="fb-post-actions">
                                <span class="fb-action-btn"><i data-lucide="thumbs-up" style="width:16px;height:16px;"></i> 142</span>
                                <span class="fb-action-btn"><i data-lucide="message-circle" style="width:16px;height:16px;"></i> 12</span>
                            </div>
                        </div>
                    </div>
                `;
            } else if (appName === 'youtube') {
                title.innerText = "YouTube";
                header.className = "app-header";
                header.style.background = "#111";
                html = `
                    <div class="yt-app">
                        <div class="yt-video">
                             <div class="yt-thumb" style="background-image:url('https://images.unsplash.com/photo-1492684223066-81342ee5ff30?q=80&w=600&auto=format&fit=crop');">
                                 <div class="yt-duration">10:24</div>
                             </div>
                             <div class="yt-info">
                                 <div class="yt-av" style="background:#3b82f6;"></div>
                                 <div>
                                     <div class="yt-title">Walking in Yangon 4K - Downtown Rain</div>
                                     <div class="yt-meta">Myanmar Walks  24K views  1 day ago</div>
                                 </div>
                             </div>
                        </div>
                        <div class="yt-video">
                             <div class="yt-thumb" style="background-image:url('https://images.unsplash.com/photo-1511671782779-c97d3d27a1d4?q=80&w=600&auto=format&fit=crop');">
                                  <div class="yt-duration">3:45</div>
                             </div>
                             <div class="yt-info">
                                 <div class="yt-av" style="background:#ef4444;"></div>
                                 <div>
                                     <div class="yt-title">Lofi Myanmar Beats to Study To</div>
                                     <div class="yt-meta">Lofi Girl  1.2M views  1 month ago</div>
                                 </div>
                             </div>
                        </div>
                    </div>
                `;
            } else if (appName === 'music') {
                title.innerText = "Spotify"; 
                header.style.display = 'none';
                html = `
                    <div class="spotify-app">
                         <div class="spotify-nav">
                            <button onclick="game.phoneHome()" class="viewer-btn" style="border:none;"><i data-lucide="chevron-down" style="width:24px;height:24px;"></i></button>
                            <span class="spotify-nav-title">Now Playing</span>
                            <button class="viewer-btn" style="border:none;"><i data-lucide="more-horizontal" style="width:24px;height:24px;"></i></button>
                         </div>
                         <div class="spotify-art-wrap">
                            <div class="spotify-art">
                                <img src="../images/items/song.png" onerror="this.src='https://images.unsplash.com/photo-1614613535308-eb5fbd3d2c17?q=80&w=600&auto=format&fit=crop'" style="width:100%;height:100%;object-fit:cover;">
                            </div>
                         </div>
                         <div class="spotify-controls">
                             <div class="sp-info-row">
                                 <div>
                                     <div class="sp-song">Tejano Blue</div>
                                     <div class="sp-artist">Cigarettes After Sex</div>
                                 </div>
                                 <button class="sp-heart"><i data-lucide="heart" style="width:24px;height:24px;fill:currentColor;"></i></button>
                             </div>
                             
                             <div class="sp-progress-bar">
                                 <div id="music-progress" class="sp-progress-fill" style="width:0%;"></div>
                                 <div id="music-thumb" class="sp-progress-thumb" style="left:0%;"></div>
                             </div>
                             <div class="sp-time-row">
                                 <span id="music-current-time">0:00</span>
                                 <span id="music-duration">0:00</span>
                             </div>

                             <div class="sp-btn-row">
                                 <button class="sp-btn-secondary"><i data-lucide="shuffle" style="width:20px;height:20px;"></i></button>
                                 <button class="sp-btn-primary"><i data-lucide="skip-back" style="width:32px;height:32px;fill:currentColor;"></i></button>
                                 <button onclick="game.toggleMusic()" class="sp-btn-play">
                                     <i id="music-play-icon" data-lucide="play" style="width:28px;height:28px;fill:#000;margin-left:4px;"></i>
                                 </button>
                                 <button class="sp-btn-primary"><i data-lucide="skip-forward" style="width:32px;height:32px;fill:currentColor;"></i></button>
                                 <button class="sp-btn-secondary"><i data-lucide="repeat" style="width:20px;height:20px;"></i></button>
                             </div>
                         </div>
                         <audio id="music-player-audio" src="../audios/tejano-blue.mp3" ontimeupdate="game.updateMusicProgress()" onloadedmetadata="game.initMusicDuration()"></audio>
                    </div>
                `;
            } else if (appName === 'kbzpay') {
                title.innerText = "KBZPay";
                header.className = "app-header";
                header.style.background = "#1a4a8d";
                html = `
                    <div class="kbz-app">
                        <div class="kbz-card">
                            <div class="kbz-card-glow top"></div>
                            <div class="kbz-card-glow bottom"></div>
                            
                            <div class="kbz-card-content">
                                <div class="kbz-row-top">
                                    <span class="kbz-label">Total Balance</span>
                                    <i data-lucide="shield-check" style="width:16px;height:16px;color:#93c5fd;"></i>
                                </div>
                                <div class="kbz-balance-row">
                                    <span class="kbz-amount" id="kbz-balance">${this.state.currency.toLocaleString()}</span>
                                    <span class="kbz-currency">MMK</span>
                                </div>
                                <div class="kbz-actions">
                                    <div class="kbz-action-btn">
                                        <div class="kbz-action-icon"><i data-lucide="arrow-up" style="width:16px;height:16px;"></i></div>
                                        <span class="kbz-action-label">Transfer</span>
                                    </div>
                                    <div class="kbz-action-btn">
                                        <div class="kbz-action-icon"><i data-lucide="arrow-down" style="width:16px;height:16px;"></i></div>
                                        <span class="kbz-action-label">Cash In</span>
                                    </div>
                                    <div class="kbz-action-btn">
                                        <div class="kbz-action-icon"><i data-lucide="qr-code" style="width:16px;height:16px;"></i></div>
                                        <span class="kbz-action-label">Scan</span>
                                    </div>
                                    <div class="kbz-action-btn">
                                        <div class="kbz-action-icon"><i data-lucide="clock" style="width:16px;height:16px;"></i></div>
                                        <span class="kbz-action-label">History</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="kbz-history-wrap">
                            <div class="kbz-history-title">Recent Activity</div>
                            <div class="kbz-history-list" id="kbz-history"></div>
                        </div>
                    </div>
                `;
            }

            contentArea.innerHTML = html;
            activeApp.classList.remove('translate-x-full');
            activeApp.classList.add('app-screen-active');
            
            if (appName === 'kbzpay') {
                this.renderKBZHistory();
            }
            
            if (appName !== 'music') {
                header.style.display = 'flex';
            }
            
            lucide.createIcons();
        }

        renderKBZHistory() {
            const historyContainer = document.getElementById('kbz-history');
            if (!historyContainer) return;
            
            if (!this.state.history || this.state.history.length === 0) {
                 historyContainer.innerHTML = '<div class="kbz-empty">No transactions yet</div>';
                 return;
            }

            historyContainer.innerHTML = '';
            this.state.history.forEach(item => {
                const div = document.createElement('div');
                div.className = "kbz-tx-card";
                const isPos = item.amount > 0;
                div.innerHTML = `
                    <div class="kbz-tx-left">
                        <div class="kbz-tx-icon ${isPos ? 'positive' : 'negative'}">
                            <i data-lucide="${isPos ? 'arrow-down-left' : 'arrow-up-right'}" style="width:20px;height:20px;"></i>
                        </div>
                        <div>
                            <div class="kbz-tx-type">${isPos ? 'Received' : 'Payment'}</div>
                            <div class="kbz-tx-date">${item.date}</div>
                        </div>
                    </div>
                    <span class="kbz-tx-amt ${isPos ? 'positive' : 'negative'}">${isPos ? '+' : ''}${item.amount.toLocaleString()} MMK</span>
                `;
                historyContainer.appendChild(div);
            });
            lucide.createIcons();
        }

        updateCurrency(amount, transactionId = null) {
            if (amount === 0 && this.state.currency === 0) return;

            if (transactionId) {
                if (this.state.flags[`tx_${transactionId}`]) return;
                this.state.flags[`tx_${transactionId}`] = true;
            }

            this.state.currency += amount;

            if (amount !== 0) {
                const notif = document.getElementById('currency-notification');
                const text = document.getElementById('currency-text');
                const sign = amount > 0 ? '+' : '';
                
                text.innerText = `${sign}${amount.toLocaleString()} MMK`;
                text.style.color = amount > 0 ? '#fff' : 'var(--text-secondary)';
                
                notif.classList.remove('hidden');
                void notif.offsetWidth;
                notif.classList.add('notification-show');
                this.audio.playNotif();
                
                setTimeout(() => { 
                    notif.classList.remove('notification-show'); 
                    setTimeout(() => notif.classList.add('hidden'), 500);
                }, 3000);

                if (!this.state.history) this.state.history = [];
                this.state.history.unshift({ amount: amount, date: 'Today' });
                if (this.state.history.length > 5) this.state.history.pop();

                if (this.phoneApp === 'kbzpay') {
                    this.renderKBZHistory();
                }
            }
        }

        zoomMap(delta) { 
            if (this.map) {
                const currentZoom = this.map.getZoom();
                this.map.zoomTo(Math.max(10, Math.min(18, currentZoom + (delta > 0 ? 1 : -1))));
            }
        }

        resetZoom() { 
            if (this.map) { this.map.flyTo({ center: [96.146480,16.830225], zoom: 12.2 }); }
        }

        async renderMap() {
            if(!this.map) {
                this.map = new maplibregl.Map({
                    container: 'map-container',
                    style: this.mapStyles[this.currentMapStyle], 
                    center: [96.1496, 16.7984],
                    zoom: 13,
                    attributionControl: false
                });
            }

            if (this.markers) { this.markers.forEach(m => m.remove()); }
            this.markers = [];

            const currentLoc = LOCATIONS.find(l => l.scene === this.state.sceneId);

            LOCATIONS.forEach(loc => {
                if (!loc.lat || !loc.lng) return;
                
                const isUnlocked = this.state.flags[`${loc.id}_unlocked`];
                const isCurrent = currentLoc && currentLoc.id === loc.id;
                
                const pin = document.createElement('div');
                pin.className = `map-pin-wrapper ${isUnlocked ? 'map-pin-unlocked' : 'map-pin-locked'}`;

                const playerHtml = isCurrent ? `
                    <div class="map-player-indicator">
                        <div class="map-player-dot"></div>
                    </div>
                ` : '';

                if (isUnlocked) {
                    pin.onclick = (e) => { e.stopPropagation(); this.travelTo(loc); };
                    pin.innerHTML = `
                        ${playerHtml}
                        <div class="map-pin-icon-wrapper">
                            <img src="${ASSETS.icons[loc.type] || '../images/places/city.gif'}" class="map-pin-img" alt="${loc.type}">
                            <div class="map-pin-label">
                                ${loc.name[this.state.lang] || loc.name.en}
                            </div>
                        </div>
                    `;
                } else {
                    pin.innerHTML = `
                        <div class="map-pin-icon-wrapper">
                            <img src="${ASSETS.icons[loc.type] || '../images/places/city.gif'}" class="map-pin-img" style="opacity:0.5;" alt="${loc.type}">
                            <div class="map-pin-label map-pin-locked-label">
                                ${loc.name[this.state.lang] || loc.name.en}
                            </div>
                        </div>
                    `;
                }

                const marker = new maplibregl.Marker({ element: pin, anchor: 'center' })
                    .setLngLat([loc.lng, loc.lat])
                    .addTo(this.map);
                
                this.markers.push(marker);
            });
            
            lucide.createIcons();
        }

        travelTo(loc) {
            this.toggleMap();
            if (SCENES[loc.scene]) { this.loadScene(loc.scene); } else { alert(`Coordinate unavailable.`); }
        }

        showUnlockNotification(locId) {
            const loc = LOCATIONS.find(l => l.id === locId);
            if (!loc) return;
            const notif = document.getElementById('unlock-notification');
            const text = document.getElementById('unlock-text');
            text.innerText = loc.name[this.state.lang] || loc.name.en;
            
            notif.classList.remove('hidden');
            void notif.offsetWidth;
            notif.classList.add('notification-show');
            this.audio.playNotif();
            
            setTimeout(() => { 
                notif.classList.remove('notification-show'); 
                setTimeout(() => notif.classList.add('hidden'), 500);
            }, 4000);
        }
        
        showMemoNotification(memoId) {
            const memo = MEMORIES.find(m => m.id === memoId);
            if (!memo) return;
            const notif = document.getElementById('memo-notification');
            const text = document.getElementById('memo-text');
            text.innerText = memo.name[this.state.lang] || memo.name.en;
            
            notif.classList.remove('hidden');
            void notif.offsetWidth;
            notif.classList.add('notification-show');
            this.audio.playNotif();
            
            setTimeout(() => { 
                notif.classList.remove('notification-show'); 
                setTimeout(() => notif.classList.add('hidden'), 500);
            }, 4000);
        }

        toggleFullscreen() {
            if (!document.fullscreenElement) { document.documentElement.requestFullscreen().catch(err => { console.log(`Error: ${err.message}`); }); } 
            else { if (document.exitFullscreen) { document.exitFullscreen(); } }
        }
        
        toggleImmersive() {
            this.immersiveMode = !this.immersiveMode;
            const uiTop = document.querySelector('.hud-top');
            const uiBot = document.querySelector('.interaction-area');
            const cam = document.getElementById('camera-rig');
            
            if (this.immersiveMode) {
                if (document.documentElement.requestFullscreen && !document.fullscreenElement) { 
                    document.documentElement.requestFullscreen().catch(err => console.log(err)); 
                }
                uiTop.style.opacity = '0';
                uiTop.style.pointerEvents = 'none';
                uiTop.style.transform = 'translateY(-20px)';
                
                uiBot.style.opacity = '0';
                uiBot.style.pointerEvents = 'none';
                uiBot.style.transform = 'translateY(20px)';
                
                cam.classList.add('static-cam');
                
                const exitHandler = (e) => { 
                    e.stopPropagation(); 
                    this.toggleImmersive(); 
                    document.removeEventListener('click', exitHandler, true); 
                };
                setTimeout(() => { document.addEventListener('click', exitHandler, true); }, 50);
            } else {
                if (document.exitFullscreen && document.fullscreenElement) { 
                    document.exitFullscreen().catch(err => console.log(err)); 
                }
                uiTop.style.opacity = '1';
                uiTop.style.pointerEvents = 'auto';
                uiTop.style.transform = 'translateY(0)';
                
                uiBot.style.opacity = '1';
                uiBot.style.pointerEvents = 'auto';
                uiBot.style.transform = 'translateY(0)';
                
                cam.classList.remove('static-cam');
            }
        }

        takeScreenshot() {
            const uiTop = document.querySelector('.hud-top');
            const uiBot = document.querySelector('.interaction-area');
            const cam = document.getElementById('camera-rig');
            const container = document.getElementById('game-container');
            
            uiTop.style.opacity = '0';
            uiBot.style.opacity = '0';
            cam.classList.add('static-cam');
            
            setTimeout(async () => {
                try {
                    const canvas = await html2canvas(container, { 
                        scale: window.devicePixelRatio || 2, 
                        useCORS: true, 
                        allowTaint: true,
                        backgroundColor: '#000' 
                    });
                    const link = document.createElement('a'); 
                    link.download = `Memories_${Date.now()}.png`; 
                    link.href = canvas.toDataURL('image/png'); 
                    link.click();
                } catch (err) {
                    console.error("Capture failed:", err);
                    alert("Capture failed due to strict cross-origin image block.");
                } finally {
                    if (!this.immersiveMode) {
                        uiTop.style.opacity = '1';
                        uiBot.style.opacity = '1';
                        cam.classList.remove('static-cam');
                    }
                }
            }, 300);
        }

        saveGameManual() {
            localStorage.setItem('ringGameSave_V5', JSON.stringify(this.state));
            const btn = document.querySelector('button[onclick="game.saveGameManual()"]');
            if (btn) {
                const originalHTML = btn.innerHTML;
                btn.innerHTML = '<i data-lucide="check" style="width:16px;height:16px;"></i>';
                lucide.createIcons();
                setTimeout(() => { btn.innerHTML = originalHTML; lucide.createIcons(); }, 1000);
            }
        }

        loadGame() {
            const save = localStorage.getItem('ringGameSave_V5');
            if (save) {
                this.state = JSON.parse(save);
                if (this.state.currency === undefined) this.state.currency = 0;
                if (!this.state.settings) this.state.settings = { volume: 1.0, themeVolume: 0.4, gameAudio: 'on', fontSize: 'medium', graphics: 'high', theme: 'dark' };
                this.applySettings();
                document.getElementById('start-screen').classList.add('hidden');
                document.getElementById('ui-layer').classList.remove('hidden');
                document.getElementById('ui-layer').classList.add('flex');
                this.loadScene(this.state.sceneId);
                this.updateCurrency(0); 
            }
        }

        toggleLang() { this.setLanguage(this.state.lang === 'mm' ? 'en' : 'mm'); }
        
        toggleAuto() {
            this.autoPlay = !this.autoPlay;
            const btn = document.getElementById('auto-btn');
            if (this.autoPlay) {
                btn.classList.add('active-mode');
                if (!this.isTyping && !this.isLastStep()) { this.next(); }
            } else {
                btn.classList.remove('active-mode');
                if (this.autoPlayTimer) clearTimeout(this.autoPlayTimer);
            }
            lucide.createIcons();
        }

        toggleMuteShortcut() {
            this.audio.toggle();
            this.showAudioNotification();
        }

        showAudioNotification() {
            const notif = document.getElementById('audio-notification');
            const text = document.getElementById('audio-toast-text');
            const icon = document.getElementById('audio-toast-icon');
            
            if (this.audio.active) {
                text.innerText = "Unmuted";
                text.style.color = '#fff';
                icon.setAttribute('data-lucide', 'volume-2');
            } else {
                text.innerText = "Muted";
                text.style.color = 'var(--text-secondary)';
                icon.setAttribute('data-lucide', 'volume-x');
            }
            lucide.createIcons();
            
            notif.classList.remove('hidden');
            void notif.offsetWidth;
            notif.classList.add('notification-show');
            this.audio.playNotif();
            
            if (this.audioNotifTimer) clearTimeout(this.audioNotifTimer);
            this.audioNotifTimer = setTimeout(() => { 
                notif.classList.remove('notification-show'); 
                setTimeout(() => notif.classList.add('hidden'), 500);
            }, 3000);
        }

        openSettings() {
            const modal = document.getElementById('settings-modal');
            this.renderSettingsText();
            this.syncSettingsUI();
            modal.classList.remove('hidden');
            void modal.offsetWidth; 
            modal.classList.remove('opacity-0');
            this.settingsOpen = true;
            lucide.createIcons();
        }

        closeSettings() {
            const modal = document.getElementById('settings-modal');
            modal.classList.add('opacity-0');
            setTimeout(() => { modal.classList.add('hidden'); }, 500);
            this.settingsOpen = false;
            this.saveGameManual(); 
        }

        openGallery() {
            const modal = document.getElementById('gallery-modal');
            this.renderGallery();
            modal.classList.remove('hidden');
            void modal.offsetWidth;
            modal.classList.remove('opacity-0');
            lucide.createIcons();
        }

        closeGallery() {
            const modal = document.getElementById('gallery-modal');
            modal.classList.add('opacity-0');
            setTimeout(() => { modal.classList.add('hidden'); }, 500);
        }

        renderGallery() {
            const grid = document.getElementById('gallery-grid');
            grid.innerHTML = '';
            MEMORIES.forEach((memo) => {
                const unlocked = this.state.flags[`${memo.id}_unlocked`];
                const item = document.createElement('div');
                item.className = "gallery-item";
                
                if (unlocked) {
                    item.onclick = () => this.openImageViewer(memo.id);
                    item.innerHTML = `
                        <img src="${memo.url}" class="gallery-img" alt="Memory">
                        <div class="gallery-caption">${memo.name[this.state.lang] || memo.name.en}</div>
                    `;
                } else {
                    item.innerHTML = `
                        <div class="gallery-locked">
                            <i data-lucide="lock"></i>
                            <span>Locked</span>
                        </div>
                    `;
                }
                grid.appendChild(item);
            });
            lucide.createIcons();
        }

        openImageViewer(memoId) {
            const memo = MEMORIES.find(m => m.id === memoId);
            if (!memo) return;
            this.currentViewMemo = memo;
            const modal = document.getElementById('image-viewer-modal');
            const img = document.getElementById('viewer-image');
            const caption = document.getElementById('viewer-caption');
            const icon = document.getElementById('iv-size-icon');

            img.src = memo.url;
            img.className = "viewer-img";
            icon.setAttribute('data-lucide', 'maximize');
            caption.innerText = memo.name[this.state.lang] || memo.name.en;

            modal.classList.remove('hidden');
            void modal.offsetWidth;
            modal.classList.remove('opacity-0');
            lucide.createIcons();
        }

        closeImageViewer() {
            const modal = document.getElementById('image-viewer-modal');
            modal.classList.add('opacity-0');
            setTimeout(() => { modal.classList.add('hidden'); }, 500);
        }

        toggleImageViewerSize() {
            const img = document.getElementById('viewer-image');
            const icon = document.getElementById('iv-size-icon');

            if (!img.classList.contains('fill')) {
                img.classList.add('fill');
                icon.setAttribute('data-lucide', 'minimize');
            } else {
                img.classList.remove('fill');
                icon.setAttribute('data-lucide', 'maximize');
            }
            lucide.createIcons();
        }

        async downloadCurrentImage() {
            if (!this.currentViewMemo) return;
            try {
                const response = await fetch(this.currentViewMemo.url);
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `Memory_${this.currentViewMemo.name.en.replace(/\s+/g, '_')}.jpg`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);
            } catch (error) {
                const link = document.createElement('a');
                link.href = this.currentViewMemo.url;
                link.download = `Memory_${this.currentViewMemo.name.en.replace(/\s+/g, '_')}.jpg`;
                link.target = "_blank";
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        applySettings() {
            this.setVolume(this.state.settings.volume, false);
            this.setThemeVolume(this.state.settings.themeVolume !== undefined ? this.state.settings.themeVolume : 0.4, false);
            this.setGameAudio(this.state.settings.gameAudio || 'on', false);
            this.setFontSize(this.state.settings.fontSize, false);
            this.setGraphics(this.state.settings.graphics, false);
            this.setTheme(this.state.settings.theme, false);
            this.syncSettingsUI();
        }

        syncSettingsUI() {
            document.getElementById('ga-vol-slider').value = this.state.settings.volume;
            document.getElementById('tm-vol-slider').value = this.state.settings.themeVolume !== undefined ? this.state.settings.themeVolume : 0.4;
            this.updateBtnGroup('ga', this.state.settings.gameAudio || 'on');
            this.updateBtnGroup('font', this.state.settings.fontSize);
            this.updateBtnGroup('gfx', this.state.settings.graphics);
            this.updateBtnGroup('lang', this.state.lang);
            this.updateBtnGroup('theme', this.state.settings.theme);
        }

        updateBtnGroup(group, val) {
            const btns = document.querySelectorAll(`.st-btn-${group}`);
            btns.forEach(btn => {
                if (btn.dataset.val === val) { btn.classList.add('st-btn-active'); } 
                else { btn.classList.remove('st-btn-active'); }
            });
        }

        renderSettingsText() {
            const lang = this.state.lang;
            document.getElementById('lang-btn').innerText = lang === 'mm' ? "" : "EN";
            const updateText = (id, key) => { const el = document.getElementById(id); if (el && SETTINGS_DICT[key]) el.innerText = SETTINGS_DICT[key][lang]; };
            updateText('st-menu-new', 'menu_new'); updateText('st-menu-load', 'menu_load'); updateText('st-menu-gallery', 'menu_gallery');
            updateText('st-menu-set', 'menu_set'); updateText('st-menu-quit', 'menu_quit'); updateText('st-menu-credits', 'menu_credits');
            updateText('st-menu-terms', 'menu_terms'); updateText('hud-st-tip', 'menu_set'); updateText('hud-quit-tip', 'hud_quit');
            updateText('st-title', 'title'); updateText('st-ga-vol', 'ga_vol');
            updateText('st-tm-vol', 'tm_vol'); updateText('st-ga-state', 'ga_state');
            updateText('st-ga-on', 'ga_on'); updateText('st-ga-off', 'ga_off');
            updateText('st-font', 'font_size'); updateText('st-font-sm', 'font_sm');
            updateText('st-font-md', 'font_md'); updateText('st-font-lg', 'font_lg'); updateText('st-gfx', 'graphics');
            updateText('st-gfx-low', 'gfx_low'); updateText('st-gfx-med', 'gfx_med');
            updateText('st-gfx-high', 'gfx_high'); updateText('st-lang', 'language');
            updateText('st-theme', 'theme'); updateText('st-theme-dark', 'theme_dark');
            updateText('st-theme-light', 'theme_light');
        }

        setVolume(val, sync = true) { this.state.settings.volume = parseFloat(val); this.audio.setVolume(this.state.settings.volume); if(sync) this.syncSettingsUI(); }
        setThemeVolume(val, sync = true) { this.state.settings.themeVolume = parseFloat(val); this.audio.setThemeVolume(this.state.settings.themeVolume); if(sync) this.syncSettingsUI(); }
        setGameAudio(state, sync = true) { this.state.settings.gameAudio = state; this.audio.setGameAudio(state); if(sync) this.syncSettingsUI(); }
        setFontSize(size, sync = true) {
            this.state.settings.fontSize = size;
            document.body.classList.remove('font-sm', 'font-lg');
            if (size === 'small') document.body.classList.add('font-sm');
            if (size === 'large') document.body.classList.add('font-lg');
            if(sync) this.syncSettingsUI();
        }
        setGraphics(level, sync = true) {
            this.state.settings.graphics = level;
            document.body.classList.remove('gfx-low', 'gfx-med', 'gfx-high');
            if (level === 'low') document.body.classList.add('gfx-low');
            if (level === 'medium') document.body.classList.add('gfx-med');
            if (level === 'high') document.body.classList.add('gfx-high');
            if(sync) this.syncSettingsUI();
        }
        setTheme(mode, sync = true) {
            this.state.settings.theme = mode;
            document.body.classList.remove('theme-light');
            if (mode === 'light') { document.body.classList.add('theme-light'); }
            if(sync) this.syncSettingsUI();
        }
        setLanguage(lang) { this.state.lang = lang; this.renderSettingsText(); this.syncSettingsUI(); if (!this.isTyping && this.sceneData) this.renderStep(true); }

        changeBackground(bgKey, darken) {
            const url = ASSETS.bg[bgKey];
            if (!url) return;
            if (this.currentBgKey === bgKey) return;
            if (!this.activeLayer) this.activeLayer = 1;
            const nextLayerIdx = this.activeLayer === 1 ? 2 : 1;
            const currentEl = document.getElementById(`bg-layer-${this.activeLayer}`);
            const nextEl = document.getElementById(`bg-layer-${nextLayerIdx}`);
            
            // Substantially increased the opacity to make the background extremely visible
            const targetOpacity = darken ? '0.4' : '1.0'; 
            
            nextEl.style.backgroundImage = `url('${url}')`;
            nextEl.style.opacity = targetOpacity;
            currentEl.style.opacity = '0';
            this.activeLayer = nextLayerIdx;
            this.currentBgKey = bgKey; 
        }

        handleAudio(audioData) {
            if (!audioData) return;
            const id = typeof audioData === 'string' ? audioData : audioData.id;
            const loop = typeof audioData === 'string' ? true : (audioData.loop !== undefined ? audioData.loop : true);
            this.audio.play(id, loop);
        }

        async loadScene(id) {
            if (this.isTransitioning) return;
            this.isTransitioning = true;
            
            const overlay = document.getElementById('scene-transition-overlay');
            if (overlay && this.state.sceneId !== 'start') {
                overlay.classList.remove('opacity-0');
                await new Promise(r => setTimeout(r, 700)); // wait for fade to black
            }

            this.state.sceneId = id;
            this.sceneData = SCENES[id];
            this.dialogueIndex = 0;

            this.changeBackground(this.sceneData.bg, this.sceneData.darken);
            this.handleAudio(this.sceneData.audio);

            const baseClasses = "";
            const settingsClasses = [];
            if(this.state.settings.fontSize === 'small') settingsClasses.push('font-sm');
            if(this.state.settings.fontSize === 'large') settingsClasses.push('font-lg');
            if(this.state.settings.graphics === 'low') settingsClasses.push('gfx-low');
            if(this.state.settings.graphics === 'medium') settingsClasses.push('gfx-med');
            if(this.state.settings.graphics === 'high') settingsClasses.push('gfx-high');
            if(this.state.settings.theme === 'light') settingsClasses.push('theme-light');
            
            document.body.className = `${baseClasses} ${settingsClasses.join(' ')}`;
            if (this.sceneData.world) document.body.classList.add(`world-${this.sceneData.world}`);
            if (this.sceneData.location) {
                document.getElementById('location-text').innerText = this.sceneData.location.en; 
                document.getElementById('time-text').innerText = `DAY ${this.state.day} - ${this.sceneData.time || 'UNKNOWN'}`;
            }

            this.renderStep();
            this.saveGameManual();

            if (overlay) {
                setTimeout(() => {
                    overlay.classList.add('opacity-0');
                    this.isTransitioning = false;
                }, 150);
            } else {
                this.isTransitioning = false;
            }
        }

        renderStep(instant = false) {
            if (this.typingTimer) clearTimeout(this.typingTimer);
            if (this.autoPlayTimer) clearTimeout(this.autoPlayTimer);

            const step = this.sceneData.steps[this.dialogueIndex];
            if (!step) return;

            if (step.unlock) {
                const locationsToUnlock = Array.isArray(step.unlock) ? step.unlock : [step.unlock];
                locationsToUnlock.forEach(locId => {
                    if (!this.state.flags[`${locId}_unlocked`]) {
                        this.state.flags[`${locId}_unlocked`] = true;
                        this.showUnlockNotification(locId);
                    }
                });
            }

            if (step.memo_unlock) {
                const memosToUnlock = Array.isArray(step.memo_unlock) ? step.memo_unlock : [step.memo_unlock];
                memosToUnlock.forEach(memoId => {
                    if (!this.state.flags[`${memoId}_unlocked`]) {
                        this.state.flags[`${memoId}_unlocked`] = true;
                        this.showMemoNotification(memoId);
                    }
                });
            }

            if (step.currency) {
                const txId = `currency_${this.state.sceneId}_step_${this.dialogueIndex}`;
                this.updateCurrency(step.currency, txId);
            }
            
            if (step.bg) { this.changeBackground(step.bg, this.sceneData.darken); }
            if (step.audio) { this.handleAudio(step.audio); }

            const speakerBox = document.getElementById('speaker-box');
            const speakerName = document.getElementById('speaker-name');
            const spk = step.speaker ? (step.speaker[this.state.lang] || step.speaker.en) : null;
            
            if (spk) {
                speakerBox.classList.remove('hidden');
                speakerName.innerText = spk;
                const spkColorClass = step.speaker.color || 'border: 1px solid rgba(255,255,255,0.2)';
                speakerBox.style.cssText = spkColorClass;
            } else {
                speakerBox.classList.add('hidden');
            }

            const textBox = document.getElementById('dialogue-text');
            const text = step.text[this.state.lang] || step.text.en;
            const choicesDiv = document.getElementById('choices-container');
            const nextInd = document.getElementById('next-indicator');

            choicesDiv.innerHTML = '';
            nextInd.style.opacity = '0';

            if (instant) {
                textBox.innerText = text;
                this.isTyping = false;
                textBox.classList.remove('cursor');
                if (this.isLastStep()) {
                    this.renderChoices();
                    if(this.autoPlayTimer) clearTimeout(this.autoPlayTimer); 
                } else {
                    nextInd.style.opacity = '1';
                    if (this.autoPlay) {
                        const delay = 1500 + (text.length * 50);
                        this.autoPlayTimer = setTimeout(() => this.next(), delay);
                    }
                }
                return;
            }

            textBox.innerText = '';
            textBox.classList.add('cursor');
            this.isTyping = true;
            let i = 0;

            const tick = () => {
                if (!this.isTyping) return; 
                if (i < text.length) {
                    textBox.innerText += text.charAt(i);
                    i++;
                    this.typingTimer = setTimeout(tick, this.typingSpeed);
                } else {
                    this.isTyping = false;
                    textBox.classList.remove('cursor');
                    if (this.isLastStep()) {
                        this.renderChoices();
                        if(this.autoPlayTimer) clearTimeout(this.autoPlayTimer); 
                    } else {
                        nextInd.style.opacity = '1';
                        if (this.autoPlay) {
                            const delay = 1500 + (text.length * 50);
                            this.autoPlayTimer = setTimeout(() => this.next(), delay);
                        }
                    }
                }
            };
            tick();
        }

        isLastStep() { return this.dialogueIndex === this.sceneData.steps.length - 1 && this.sceneData.choices; }

        renderChoices() {
            const container = document.getElementById('choices-container');
            container.innerHTML = '';

            this.sceneData.choices.forEach(c => {
                if (c.req && !c.req(this.state)) return; 
                const btn = document.createElement('button');
                btn.className = "choice-btn";
                const txt = c.text[this.state.lang] || c.text.en;
                btn.innerHTML = `
                    <div class="choice-flex">
                        <span>${txt}</span>
                        ${c.type === 'danger' ? '<i data-lucide="alert-triangle" style="color:#ffffff; width:16px; height:16px;"></i>' : '<i data-lucide="arrow-right" class="choice-arrow"></i>'}
                    </div>
                `;
                
                btn.onclick = (e) => { e.stopPropagation(); this.makeChoice(c); };
                container.appendChild(btn);
            });
            lucide.createIcons();
        }

        async next() {
            if (this.isTransitioning) return;
            if (this.isTyping) { this.renderStep(true); return; }
            if (document.getElementById('choices-container').children.length > 0) return;
            
            if (this.dialogueIndex < this.sceneData.steps.length - 1) { 
                // Smooth Step Transition Effect
                this.isTransitioning = true;
                const dialogText = document.getElementById('dialogue-text');
                const speakerBox = document.getElementById('speaker-box');
                
                if (dialogText) dialogText.style.opacity = '0';
                if (speakerBox) speakerBox.style.opacity = '0';
                
                await new Promise(r => setTimeout(r, 200));

                this.dialogueIndex++; 
                this.renderStep(); 

                setTimeout(() => {
                    if (dialogText) dialogText.style.opacity = '1';
                    if (speakerBox) speakerBox.style.opacity = '1';
                    this.isTransitioning = false;
                }, 50);
            } 
            else if (this.sceneData.nextScene) { 
                this.loadScene(this.sceneData.nextScene); 
            }
        }

        makeChoice(choice) {
            if (choice.unlock) {
                const locationsToUnlock = Array.isArray(choice.unlock) ? choice.unlock : [choice.unlock];
                locationsToUnlock.forEach(locId => {
                    if (!this.state.flags[`${locId}_unlocked`]) { this.state.flags[`${locId}_unlocked`] = true; this.showUnlockNotification(locId); }
                });
            }
            if (choice.memo_unlock) {
                const memosToUnlock = Array.isArray(choice.memo_unlock) ? choice.memo_unlock : [choice.memo_unlock];
                memosToUnlock.forEach(memoId => {
                    if (!this.state.flags[`${memoId}_unlocked`]) { this.state.flags[`${memoId}_unlocked`] = true; this.showMemoNotification(memoId); }
                });
            }
            if (choice.currency) {
                const txId = `currency_${this.state.sceneId}_choice_${this.sceneData.choices.indexOf(choice)}`;
                this.updateCurrency(choice.currency, txId);
            }
            if (choice.effect) { for (const [k, v] of Object.entries(choice.effect)) { this.state.stats[k] = Math.max(0, Math.min(100, this.state.stats[k] + v)); } }
            if (choice.flag) this.state.flags[choice.flag] = true;
            if (choice.next) this.loadScene(choice.next);
        }
    }

    class AudioController {
        constructor() { 
            this.active = true; this.current = null; this.volume = 1.0; this.themeVolume = 0.4; this.gameAudioActive = true;
            this.themeMusic = new Audio(ASSETS.audio.main_theme || "../audios/theme.mp3"); this.themeMusic.loop = true;
            this.clickAudio = new Audio(ASSETS.audio.click);
            this.notifAudio = new Audio(ASSETS.audio.notif);
        } 
        setVolume(v) { this.volume = v; if(this.bgMusic) this.bgMusic.volume = this.volume; this.clickAudio.volume = this.volume; this.notifAudio.volume = this.volume; }
        setThemeVolume(v) {
            this.themeVolume = v; if(this.themeMusic) this.themeMusic.volume = this.themeVolume;
            if (this.themeVolume > 0 && this.themeMusic.paused && this.active) { this.themeMusic.play().catch(e => console.log("Audio autoplay blocked by browser")); } 
            else if (this.themeVolume == 0 && !this.themeMusic.paused) { this.themeMusic.pause(); }
        }
        setGameAudio(state) {
            this.gameAudioActive = (state === 'on');
            if (this.gameAudioActive && this.active && this.bgMusic && this.bgMusic.paused) { this.bgMusic.play().catch(e => console.log("Audio autoplay blocked by browser")); } 
            else if (!this.gameAudioActive && this.bgMusic) { this.bgMusic.pause(); }
        }
        toggle() {
            this.active = !this.active;
            const icon = document.getElementById('audio-icon');
            if (this.active) {
                icon.setAttribute('data-lucide', 'volume-2');
                if(this.current && this.bgMusic && this.gameAudioActive) this.bgMusic.play().catch(e => console.log("Audio autoplay blocked"));
                if(this.themeMusic && this.themeVolume > 0) this.themeMusic.play().catch(e => console.log("Audio autoplay blocked"));
            } else {
                icon.setAttribute('data-lucide', 'volume-x');
                if(this.bgMusic) this.bgMusic.pause(); if(this.themeMusic) this.themeMusic.pause();
            }
            lucide.createIcons();
        }
        play(id, loop = true) {
            if (!this.bgMusic) { this.bgMusic = new Audio(); }
            this.bgMusic.loop = loop; this.bgMusic.volume = this.volume;
            if (this.current !== id) {
                 this.bgMusic.src = ASSETS.audio[id]; this.current = id;
                 if (this.active && this.gameAudioActive) this.bgMusic.play().catch(e => console.log("Audio autoplay blocked"));
            } else {
                 if (this.active && this.gameAudioActive && this.bgMusic.paused) {
                     this.bgMusic.currentTime = 0; this.bgMusic.play().catch(e => console.log("Audio autoplay blocked"));
                 }
            }
        }
        playClick() {
            if (!this.active) return;
            this.clickAudio.currentTime = 0;
            this.clickAudio.play().catch(e => {});
        }
        playNotif() {
            if (!this.active) return;
            this.notifAudio.currentTime = 0;
            this.notifAudio.play().catch(e => {});
        }
    }

    const SPEAKERS = {
        unknown: { en: "???", mm: "???", color: "background: #4a3028;" },
        tayza: { en: "Tayza", mm: "", color: "background: #1e3a8a;" },
        nay: { en: "Nay Chi", mm: "", color: "background: #581c87;" },
        mom: { en: "Mother", mm: "", color: "background: #9a3412;" },
        dad: { en: "Father", mm: "", color: "background: #7c2d12;" },
        bro: { en: "Ko Thiha", mm: "", color: "background: #14532d;" },
        kyaw: { en: "Kyaw Gyi", mm: "", color: "background: #115e59;" },
        nurse: { en: "Nurse", mm: "", color: "background: #831843;" },
        guard: { en: "The Guardian", mm: "", color: "background: #7f1d1d;" },
        driver: { en: "YBS Driver", mm: "", color: "background: #1f2937;" },
        monk: { en: "Sayadaw", mm: "", color: "background: #7c2d12;" },
        librarian: { en: "Librarian", mm: "", color: "background: #312e81;" }
    };
    
    const SCENES = {
        'yangon_intro': {
            bg: 'downtown',
            world: 'real',
            audio: 'morning_chant',
            location: { en: 'Yangon - CityView', mm: ' - ' },
            time: '07:00 AM',
            steps: [
            {
                bg: 'downtown',
                memo_unlock: 'memo_downtown',
                text: {
                    en: "Morning light spills over Yangon Downtown, brushing colonial buildings and narrow streets with gold. Shops awaken, tea scents drift, and buses begin their slow dance along waking roads. The city hums with quiet stories beneath the sun.",
                    mm: "                     "
                }
            },
            {
                bg: 'sule',
                text: {
                    en: "At the heart of the city, Sule Pagoda stands serene amid flowing traffic. Monks walk with calm steps, office workers hurry by. Its golden spire catches sunlight, quietly witnessing the passing day.",
                    mm: "                   "
                }
            },
            {
                bg: 'shwedagon',
                text: {
                    en: "On the hill, Shwedagon Pagoda glimmers under the sun. Incense drifts, prayers float, and the city below seems to pause, held in a gentle, timeless moment.",
                    mm: "                     "
                }
            },
            {
                bg: 'kantawgyi',
                text: {
                    en: "By Kandawgyi Lake, water mirrors clouds and rooftops. The Karaweik floats gently, footsteps fade along the wooden path, and a soft breeze carries distant city sounds. Peace lingers quietly beneath the open sky.",
                    mm: "                    "
                }
            }
        ],
        choices: [
            { text: { en: "Continue", mm: "" }, next: 'alarm' },
        ]
        },

        'alarm': {
            bg: 'home_tayza',
            world: 'real',
            location: { en: 'Home - Bedroom', mm: ' - ' },
            time: '07:01 AM',
            steps: [
            {
                bg: 'home_tayza',
                audio: 'morning_chant',
                text: {
                    en: "...",
                    mm: "..."
                }
            },
            {
                bg: 'alarm',
                audio: { id: 'alarm', loop: true },
                text: {
                    en: "*The alarm is ringing*",
                    mm: "**"
                }
            },
                        
        ],
        choices: [
            { text: { en: "Close the Alarm", mm: "" }, next: 'intro-tayza' },
        ]
        },

        'intro-tayza': {
            bg: 'sleep_tayza',
            world: 'real',
            location: { en: 'Home - Bedroom', mm: ' - ' },
            time: '07:01 AM',
            steps: [
            {
                bg: 'sleep_tayza',
                audio: { id: 'yawn', loop: false },
                unlock: ['home'],
                text: {
                    en: "Wahhhhh...",
                    mm: ""
                }
            },
                        
        ],
        choices: [
            { text: { en: "Sleep for a while", mm: " " }, next: 'alarm' },
            { text: { en: "Wake up", mm: "" }, next: 'wakeup-tayza' },
        ]
        },

        'wakeup-tayza': {
            bg: 'wakeup_tayza',
            world: 'real',
            location: { en: 'Home - Bedroom', mm: ' - ' },
            time: '07:05 AM',
            steps: [
            {
                bg: 'wakeup_tayza',
                audio: { id: 'oldfan', loop: true },
                speaker: SPEAKERS.unknown, text: {en: "Another morning.", mm: " ..."}
            },
            {
                bg: 'oldfan',
                speaker: SPEAKERS.unknown, text: {en: "The fan spins lazily overhead, counting seconds I don't have.", mm: "      "}
            },
            {
                speaker: SPEAKERS.unknown, text: {en: "The sun is already burning through the curtains. I hate the heat.", mm: "     "},
            },
                        
        ],
        choices: [
            { text: { en: "Check the phone", mm: "" }, next: 'missedcall' },
        ]
        },

        'missedcall': {
            bg: 'missedcall',
            world: 'real',
            location: { en: 'Home - Bedroom', mm: ' - ' },
            time: '07:05 AM',
            steps: [
            {
                bg: 'missedcall',
                currency: 5000,
                speaker: SPEAKERS.unknown, text: {en: "I check my phone. 14 missed calls from 'Mom'. She is in the kitchen downstairs. This is how our house works.", mm: "   Missed Call       "},
            },
            {
                speaker: SPEAKERS.unknown, text: {en: "The pressure starts before I even leave the bed.", mm: "  "},
            },
            {
                speaker: SPEAKERS.tayza, text: {en: "My name is Tayza, I am 21 years old and an IT student at Info Myanmar University in Yangon, currently preparing for my upcoming final exam while trying my best to make my family proud.", mm: " ''       Info Myanmar University  IT      "},
            },
                        
        ],
        choices: [
            { text: { en: "Rush downstairs", mm: " " }, next: 'kitchen' },
            { text: { en: "Stay in bed for 5 more minutes.", mm: "  " }, next: 'alarm' },
        ]
        },

        'kitchen': {
            bg: 'stair',
            world: 'real',
            location: { en: 'Home - Living Room', mm: ' - '},
            time: '07:15 AM',
            steps: [
            {
                bg: 'stair',
                audio: 'stair',
                text: {en: "*foot steps*", mm: "**"},
            },
            {
                bg: 'livingroom',
                audio: 'kitchen',
                speaker: SPEAKERS.tayza, text: {en: "Mom, I'm awake.", mm: ".."},
            },
            {
                bg: 'livingroom',
                speaker: SPEAKERS.unknown, text: {en: "Tayza! Why are you late? Do you want to be late for school?", mm: ".. ..   "},
            },
            {
                speaker: SPEAKERS.tayza, text: {en: "I was studying late last night, Mom.", mm: "   "},
            },
            {

                bg: 'kitchen',
                speaker: SPEAKERS.tayza, text: {en: "So this is my mother, Daw Mya Thandar. Shes 55, works at an office, and somehow still finds the energy to take care of all of us. She doesnt say much about her worries but I know she prays for me every single day. Even when I act like I dont notice.", mm: "                    "},
            },
            {
                speaker: SPEAKERS.mom, text: {en: "After taking care of your skin, face, and teeth, have breakfast, Tayza. You're ready to eat.", mm: ".. ..  .. "},
            },
                        
        ],
        choices: [
            { text: { en: "Wash Up & Eat Breakfast", mm: " " }, next: 'washup' },
            { text: { en: "Sit at Table for a Bit", mm: "" }, next: 'sit_livingroom' },
        ]
        },

        'washup': {
            bg: 'bathroom',
            world: 'real',
            location: { en: 'Home - Bathroom', mm: ' - ' },
            time: '07:20 AM',
            audio: 'water_splash',
            steps: [
                {
                    bg: 'bathroom',
                    speaker: SPEAKERS.tayza,
                    text: { en: "Cold water hits my face. I look at the mirror. Dark circles. Tired eyes.", mm: "     " }
                },
                {
                    speaker: SPEAKERS.bro,
                    text: { en: "Yo, Tayza. Not done yet?", mm: "  " }
                },
                {
                    speaker: SPEAKERS.tayza,
                    text: { en: "This is my older brother, Ko Thiha. He's a pilot. Or at least, he's training to be one. He's the golden child.", mm: "        " }
                },
                {
                    speaker: SPEAKERS.bro,
                    text: { en: "Whoa, look at you. You look like a panda, bro. What have you been doing? Gaming all night?", mm: "...      " }
                },
                {
                    speaker: SPEAKERS.tayza,
                    text: { en: "No, Ko Gyi. I'm preparing for the final exam. The pressure is real.", mm: "     " }
                },
                {
                    speaker: SPEAKERS.tayza,
                    text: { en: "Ko Gyi, how did you get through your pilot training exams? Any tips?", mm: "...    " }
                },
                {
                    speaker: SPEAKERS.bro,
                    text: { en: "Ah, exams. Just focus on the process, not the result. And sleep, kid. You can't fly if you're asleep at the wheel.", mm: "       " }
                },
                {
                    speaker: SPEAKERS.bro,
                    text: { en: "Here, take this. Buy some snacks or coffee. Good luck.", mm: "...     " },
                    currency: 5000
                },
                {
                    speaker: SPEAKERS.tayza,
                    text: { en: "Thanks, Ko Gyi.", mm: " " }
                }
            ],
            choices: [
                { text: { en: "Go to breakfast", mm: "" }, next: 'breakfast_table' }
            ]
        },

        'sit_livingroom': {
            bg: 'livingroom',
            world: 'real',
            location: { en: 'Home - Living Room', mm: ' - ' },
            time: '07:20 AM',
            steps: [
                {
                    bg: 'livingroom',
                    speaker: SPEAKERS.tayza,
                    text: { en: "I sit on the sofa for a moment, letting the fan cool me down.", mm: "   " }
                },
                {
                    speaker: SPEAKERS.bro,
                    text: { en: "Hey, Lazy-za. What are you doing? I'm done cleaning up. Gonna grab breakfast.", mm: "     " }
                },
                {
                    speaker: SPEAKERS.bro,
                    text: { en: "Mom's gonna yell if you're late for school.", mm: " " }
                },
                {
                    speaker: SPEAKERS.tayza,
                    text: { en: "Yeah, yeah. I'm coming.", mm: "... " }
                }
            ],
            choices: [
                { text: { en: "Go to kitchen", mm: "" }, next: 'breakfast_table' }
            ]
        },

        'breakfast_table': {
            bg: 'dining_room',
            world: 'real',
            location: { en: 'Home - Dining Room', mm: ' - ' },
            time: '07:30 AM',
            steps: [
                {
                    bg: 'dining_room',
                    audio: 'kitchen',
                    speaker: SPEAKERS.mom,
                    text: { en: "Eat quickly. Mohinga is getting cold.", mm: "  " }
                },
                {
                    speaker: SPEAKERS.tayza,
                    text: { en: "I eat quickly. The taste of fish soup wakes me up better than coffee.", mm: "    " }
                },
                {
                    speaker: SPEAKERS.tayza,
                    text: { en: "I'm leaving for school now, Mom!", mm: "... " }
                }
            ],
            choices: [
                { text: { en: "Go to School / Shwedagon", mm: "/ " }, next: 'street_monk' }
            ]
        },

        'street_monk': {
            bg: 'downtown',
            world: 'real',
            location: { en: 'Yangon - Streets', mm: ' - ' },
            time: '08:00 AM',
            steps: [
                {
                    bg: 'downtown',
                    audio: 'city_ambience',
                    speaker: SPEAKERS.tayza,
                    text: { en: "I decide to stop by Shwedagon Pagoda before class. I need some peace of mind for the exam.", mm: "      " }
                },
                {
                    speaker: SPEAKERS.monk,
                    text: { en: "Young man...", mm: "..." }
                },
                {
                    bg: 'downtown', 
                    char: 'monk',
                    speaker: SPEAKERS.monk,
                    text: { en: "The shadow follows the object, but sometimes... the shadow moves on its own.", mm: " ...     " }
                },
                {
                    speaker: SPEAKERS.tayza,
                    text: { en: "Uh... sure, Sayadaw. (What was that about?)", mm: "... (...)" }
                }
            ],
            choices: [
                { text: { en: "Go to Shwedagon Pagoda", mm: "" }, next: 'shwedagon_arrival' }
            ]
        },

        'shwedagon_arrival': {
            bg: 'shwedagon_stairs',
            world: 'real',
            location: { en: 'Shwedagon Pagoda', mm: '' },
            time: '08:30 AM',
            audio: 'pagoda_bells',
            unlock: ['shwedagon'],
            steps: [
                {
                    bg: 'shwedagon_stairs',
                    clearChar: true,
                    text: { en: "The southern stairway. Cool tiles under my feet. The smell of flowers and incense.", mm: "     " }
                },
                {
                    bg: 'shwedagon',
                    text: { en: "The Great Pagoda towers above, a mountain of gold against the blue sky.", mm: "   " }
                }
            ],
            choices: [
                { text: { en: "Find a corner to pray", mm: "" }, next: 'shwedagon_pray' }
            ]
        },

        'shwedagon_pray': {
            bg: 'shwedagon',
            world: 'real',
            location: { en: 'Tuesday Corner', mm: '' },
            time: '08:45 AM',
            steps: [
                {
                    text: { en: "I kneel at the Tuesday corner. 'Please let me pass the exam. Please let me make my parents proud.'", mm: "  '   '" }
                },
                {
                    text: { en: "I close my eyes, chanting silently.", mm: "   " }
                },
                {
                    audio: { id: 'ring_drop', loop: false }, /* Assuming audio fallback works */
                    text: { en: "*CLINK*", mm: "**" }
                },
                {
                    text: { en: "Ouch! Something hit my head!", mm: "!   " }
                },
                {
                    text: { en: "I look around. Did it fall from the roof?", mm: "   " }
                }
            ],
            choices: [
                { text: { en: "Look at the object", mm: " " }, next: 'ring_incident' }
            ]
        },

        'ring_incident': {
            bg: 'ring_item',
            world: 'real',
            location: { en: 'Tuesday Corner', mm: '' },
            time: '08:46 AM',
            steps: [
                {
                    bg: 'ring_item',
                    text: { en: "It's a ring. An old, silver ring with strange engravings. It doesn't look like jewelry someone would just drop.", mm: "       " }
                },
                {
                    speaker: SPEAKERS.tayza,
                    text: { en: "Weird. Should I leave it here?", mm: "  " }
                },
                {
                    speaker: SPEAKERS.tayza,
                    text: { en: "But... it feels warm.", mm: "...  " }
                }
            ],
            choices: [
                { text: { en: "Keep it in backpack", mm: " " }, next: 'keep_ring' },
                { text: { en: "Leave it (Force Pick up)", mm: " ()" }, next: 'keep_ring' } // Forcing narrative for now
            ]
        },

        'keep_ring': {
            bg: 'shwedagon',
            world: 'real',
            location: { en: 'Shwedagon Pagoda', mm: '' },
            time: '09:00 AM',
            steps: [
                {
                    text: { en: "I decided to keep it safe for now. Maybe I can find the owner later.", mm: "    " }
                },
                {
                    text: { en: "I leave the pagoda. The city is waiting.", mm: "   " }
                }
            ],
            choices: [
                { text: { en: "Go to Downtown", mm: " " }, next: 'downtown_walk' }
            ]
        },

        'downtown_walk': {
            bg: 'downtown',
            world: 'real',
            location: { en: 'Yangon - Downtown', mm: ' - ' },
            time: '05:00 PM',
            unlock: ['downtown', 'sule'],
            steps: [
                {
                    bg: 'downtown',
                    audio: 'city_ambience',
                    text: { en: "Time flies. Evening falls on Yangon.", mm: "   " }
                },
                {
                    text: { en: "The streets are packed. People rushing home, buses honking, the smell of street food frying.", mm: "     " }
                },
                {
                    text: { en: "The Yangon River glitters in the distance. This chaos... it's beautiful in its own way.", mm: "   ...  " }
                }
            ],
            choices: [
                { text: { en: "Go Home for Dinner", mm: " " }, next: 'dinner_scene' }
            ]
        },

        'dinner_scene': {
            bg: 'dining_room',
            world: 'real',
            location: { en: 'Home - Dining Room', mm: ' - ' },
            time: '07:00 PM',
            steps: [
                {
                    bg: 'dining_room',
                    speaker: SPEAKERS.mom,
                    text: { en: "Welcome back, son. Wash your hands. Dinner is ready.", mm: "   " }
                },
                {
                    speaker: SPEAKERS.dad,
                    text: { en: "Tayza. How is the exam preparation?", mm: "  " }
                },
                {
                    speaker: SPEAKERS.tayza,
                    text: { en: "This is my father. Strict. Traditional. He loves us, but his expectations are heavy.", mm: "        " }
                },
                {
                    speaker: SPEAKERS.tayza,
                    text: { en: "It's going well, Dad.", mm: " " }
                },
                {
                    speaker: SPEAKERS.dad,
                    text: { en: "Good. Your future depends on you. Don't disappoint us.", mm: "     " }
                },
                {
                    speaker: SPEAKERS.bro,
                    text: { en: "Yeah, he's been trying really hard... at sleeping.", mm: "   ... " }
                },
                {
                    speaker: SPEAKERS.mom,
                    text: { en: "*Taps brother's shoulder* Ko Thiha! Don't tease your little brother. Just eat.", mm: "** !   " }
                },
                {
                    speaker: SPEAKERS.tayza,
                    text: { en: "I smile faintly. This is normal. This is home.", mm: "      " }
                }
            ],
            choices: [
                { text: { en: "Go to room to study", mm: " " }, next: 'room_night' }
            ]
        },

        'room_night': {
            bg: 'bedroom_night',
            world: 'real',
            location: { en: 'Home - Bedroom', mm: ' - ' },
            time: '11:00 PM',
            audio: 'creepy_drone', /* subtle foreshadowing */
            steps: [
                {
                    bg: 'bedroom_night',
                    text: { en: "I study for hours. My eyes are heavy.", mm: "    " }
                },
                {
                    text: { en: "Then I remember the ring.", mm: "  " }
                },
                {
                    bg: 'ring_item',
                    text: { en: "I take it out of my bag. Under the desk lamp, it glows softly.", mm: "     " }
                },
                {
                    speaker: SPEAKERS.tayza,
                    text: { en: "Just for a second...", mm: "..." }
                },
                {
                    text: { en: "I slide it onto my finger. It fits perfectly.", mm: "  " }
                },
                {
                    bg: 'bedroom_night',
                    text: { en: "A sudden wave of exhaustion hits me. I put my head on the desk.", mm: "    " }
                }
            ],
            choices: [
                { text: { en: "Fall asleep", mm: "" }, next: 'wakeup_parallel' }
            ]
        },

        'wakeup_parallel': {
            bg: 'parallel_sule',
            world: 'parallel',
            location: { en: '???', mm: '???' },
            time: 'UNKNOWN',
            audio: 'creepy_drone',
            steps: [
                {
                    bg: 'parallel_sule',
                    text: { en: "...", mm: "..." }
                },
                {
                    speaker: SPEAKERS.tayza,
                    text: { en: "Huh? Where...?", mm: "... ...?" }
                },
                {
                    text: { en: "I wake up. But not at my desk. I am standing in the middle of the road. Near Sule Pagoda.", mm: "       " }
                },
                {
                    text: { en: "The sky is a wrong shade of blue. The air smells like... rust.", mm: "    " }
                }
            ],
            choices: [
                { text: { en: "Look around", mm: " " }, next: 'parallel_home_journey' },
                { text: { en: "Go Home immediately", mm: "" }, next: 'parallel_home_journey' }
            ]
        },

        'parallel_home_journey': {
            bg: 'parallel_street',
            world: 'parallel',
            location: { en: 'Downtown', mm: '' },
            time: 'UNKNOWN',
            steps: [
                {
                    bg: 'parallel_street',
                    text: { en: "I rush towards home. People are walking on the street, but...", mm: "    ..." }
                },
                {
                    text: { en: "Their faces. They are blurry. Distorted. Not Burmese. Not human.", mm: "    " }
                },
                {
                    speaker: SPEAKERS.tayza,
                    text: { en: "What is happening? Am I dreaming?", mm: " " }
                },
                {
                    text: { en: "I reach my house door. I knock desperately.", mm: "  " }
                },
                {
                    speaker: SPEAKERS.tayza,
                    text: { en: "Mom! Dad! Open the door!", mm: "! ! !" }
                }
            ],
            choices: [
                { text: { en: "Wait for answer", mm: " " }, next: 'parallel_home_door' }
            ]
        },

        'parallel_home_door': {
            bg: 'home_tayza',
            world: 'parallel',
            location: { en: 'Home', mm: 'Home' },
            time: 'UNKNOWN',
            steps: [
                {
                    audio: 'kitchen',
                    text: { en: "The door creaks open.", mm: "  " }
                },
                {
                    speaker: SPEAKERS.mom,
                    text: { en: "You're late, Tayza. Where have you been?", mm: "  " }
                },
                {
                    text: { en: "The voice is my mother's. The clothes are hers.", mm: "   " }
                },
                {
                    bg: 'faceless_mom',
                    char: 'faceless_mom',
                    text: { en: "But when I look up... there is no face. Just smooth skin.", mm: " ...    " }
                },
                {
                    speaker: SPEAKERS.tayza,
                    text: { en: "AHHHHHH!", mm: "!" }
                }
            ],
            choices: [
                { text: { en: "RUN AWAY", mm: "" }, type: "danger", next: 'run_away_meet_naychi' }
            ]
        },

        'run_away_meet_naychi': {
            bg: 'parallel_street',
            world: 'parallel',
            location: { en: 'Alleyway', mm: '' },
            time: 'UNKNOWN',
            steps: [
                {
                    clearChar: true,
                    text: { en: "I run blindly into the dark alleyway. My heart is pounding out of my chest.", mm: "     " }
                },
                {
                    text: { en: "I bump into someone.", mm: " " }
                },
                {
                    speaker: SPEAKERS.unknown,
                    text: { en: "Shhh! Keep it down if you want to live.", mm: "...  " }
                },
                {
                    bg: 'parallel_street',
                    char: 'naychi',
                    speaker: SPEAKERS.nay,
                    text: { en: "Welcome to the Echo Yangon. I'm Nay Chi.", mm: "   " }
                }
            ],
            choices: [
                { text: { en: "To Be Continued...", mm: "..." }, next: 'start' }
            ]
        },
    };
    
    // --- BOOTSTRAP ---
    const game = new GameEngine();
    
    document.addEventListener('DOMContentLoaded', () => {
        lucide.createIcons();
    });

    // Global click sound listener
    document.addEventListener('click', (e) => {
        if (e.target && e.target.tagName === 'INPUT') return;
        if (game && game.audio) {
            game.audio.playClick();
        }
    });

    // Keyboard Shortcuts Listener
    document.addEventListener('keydown', (e) => {
        if (e.repeat) return;
        if (game.mapOpen || game.phoneOpen || game.settingsOpen || (e.target && e.target.tagName === 'INPUT')) return;
        
        if (e.code === 'Space') {
            e.preventDefault();
            game.next();
        } else if (e.key.toLowerCase() === 'm') {
            e.preventDefault();
            game.toggleMuteShortcut();
        }
    });
    
    document.addEventListener('contextmenu', event => event.preventDefault());

    </script>
</body>
</html>