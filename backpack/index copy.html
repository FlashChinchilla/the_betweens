<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport"
            content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <title>The Betweens | The Ring Between Two Yangons</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://unpkg.com/lucide@latest"></script>
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
        
        <!-- MapLibre GL -->
        <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
        <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
        
        <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@200;300;400;500;600&family=Noto+Sans+Myanmar:wght@300;400;500;600&display=swap');

        :root {
            --bg-real: #000000;
            --bg-parallel: #050505;
            --accent-primary: #ffffff;
            --accent-muted: #888888;
            --glass-bg: rgba(10, 10, 10, 0.4);
            --glass-border: rgba(255, 255, 255, 0.08);
            --transition-smooth: all 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }

        body {
            font-family: 'Inter', 'Noto Sans Myanmar', sans-serif;
            overflow: hidden;
            background-color: #000000;
            color: #ffffff;
            touch-action: manipulation;
            transition: background-color 0.8s ease, color 0.8s ease;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* --- VISUAL FX ENGINE V5 --- */
        .world-real { filter: sepia(0.05) saturate(1.05) brightness(1); transition: filter 3s ease-in-out; }
        .world-parallel { filter: hue-rotate(210deg) saturate(0.2) contrast(1.2) brightness(0.8); transition: filter 3s ease-in-out; }
        .world-collapse { animation: glitch-anim 0.2s infinite; filter: contrast(1.5) grayscale(1); }
        .world-dream { filter: blur(2px) brightness(1.1) saturate(1.2); transition: filter 3s ease; }
        .world-flash { animation: flash-anim 0.8s cubic-bezier(0.16, 1, 0.3, 1); }

        @keyframes panZoom {
            0% { transform: scale(1.0) translate(0, 0); }
            50% { transform: scale(1.03) translate(-0.5%, 0.5%); }
            100% { transform: scale(1.0) translate(0, 0); }
        }
        .camera-move { animation: panZoom 80s infinite ease-in-out alternate; }
        .static-cam { animation: none !important; transform: scale(1.0) translate(0, 0) !important; transition: transform 0.8s ease-out; }
        #camera-rig { filter: brightness(1); transition: filter 1.5s ease; }

        @keyframes glitch-anim {
            0% { transform: translate(0) }
            20% { transform: translate(-1px, 1px) }
            40% { transform: translate(-1px, -1px) }
            60% { transform: translate(1px, 1px) }
            80% { transform: translate(1px, -1px) }
            100% { transform: translate(0) }
        }

        @keyframes flash-anim {
            0% { background-color: white; opacity: 1; }
            100% { background-color: transparent; opacity: 0; }
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .fade-in { animation: fadeIn 1.2s ease-in-out; }

        /* --- MODERN UI SYSTEM --- */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            box-shadow: 0 4px 40px rgba(0, 0, 0, 0.4);
            transition: var(--transition-smooth);
        }

        .scanlines {
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.05) 50%, rgba(0,0,0,0.05));
            background-size: 100% 4px;
            position: absolute; inset: 0; pointer-events: none; z-index: 50; opacity: 0.15;
        }

        .vignette {
            position: absolute; inset: 0; pointer-events: none; z-index: 45;
            background: radial-gradient(circle at center, transparent 40%, rgba(0,0,0,0.8) 100%);
        }

        .dialogue-box {
            background-color: rgba(5, 5, 5, 0.6);
            backdrop-filter: blur(30px) saturate(1.2);
            -webkit-backdrop-filter: blur(30px) saturate(1.2);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.05);
            transition: var(--transition-smooth);
        }

        .choice-btn {
            transition: var(--transition-smooth);
            background: rgba(255, 255, 255, 0.02);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            color: rgba(255, 255, 255, 0.8);
        }
        .choice-btn:active, .choice-btn:hover {
            background: rgba(255, 255, 255, 0.95);
            color: #000000;
            border-color: #ffffff;
            transform: scale(0.99);
        }

        /* Modern HUD Buttons */
        .hud-btn {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
            border-radius: 12px;
            background: rgba(15, 15, 15, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.08);
            color: #a1a1aa;
            transition: var(--transition-smooth);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }
        
        .hud-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            border-color: rgba(255, 255, 255, 0.2);
        }
        
        .hud-btn:active { transform: scale(0.92); }
        
        .hud-btn.active-mode {
            background: #ffffff;
            color: #000000;
        }

        /* Tooltip */
        .hud-btn .tooltip {
            position: absolute;
            top: 120%;
            left: 50%;
            transform: translateX(-50%) translateY(-5px);
            background: rgba(255, 255, 255, 0.95);
            color: #000;
            padding: 6px 12px;
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.05em;
            border-radius: 8px;
            opacity: 0;
            pointer-events: none;
            transition: var(--transition-smooth);
            white-space: nowrap;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .hud-btn:hover .tooltip {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .cursor::after { content: ' '; display: inline-block; width: 6px; height: 1em; background-color: #ffffff; animation: blink 1s step-end infinite; vertical-align: text-bottom; margin-left: 4px; opacity: 0.8;}
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
        
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.4); }

        /* --- MAP STYLES ENHANCED --- */
        .map-viewport { position: relative; width: 100%; height: 100%; flex: 1; overflow: hidden; background-color: #0a0a0a; }
        .map-pin { transition: var(--transition-smooth); }
        
        /* Hide Mapbox/MapLibre Watermarks */
        .maplibregl-ctrl-attrib, .maplibregl-ctrl-logo, .mapboxgl-ctrl-attrib, .mapboxgl-ctrl-logo { display: none !important; }

        .notification-toast { transform: translateX(120%); transition: transform 0.6s cubic-bezier(0.16, 1, 0.3, 1); }
        .notification-show { transform: translateX(0%) !important; }
        
        /* Dynamic Map Pins */
        .map-pin-wrapper { display: flex; flex-direction: column; align-items: center; pointer-events: auto; }
        .map-pin-unlocked { z-index: 20; cursor: pointer; transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .map-pin-unlocked:hover { transform: scale(1.1); z-index: 100; }
        .map-pin-locked { z-index: 10; cursor: not-allowed; opacity: 0.5; filter: grayscale(1); }
        
        .map-player-indicator { position: absolute; top: -3rem; z-index: 50; animation: float 3s ease-in-out infinite; }
        .map-player-avatar { width: 2.5rem; height: 2.5rem; border-radius: 50%; border: 2px solid #ffffff; box-shadow: 0 0 20px rgba(255,255,255,0.3); background-color: #000; padding: 2px; object-fit: cover; }
        
        .map-pin-icon-wrapper { position: relative; padding-bottom: 6px; }
        .map-pin-img { width: 2.5rem; height: 2.5rem; object-fit: contain; filter: drop-shadow(0 4px 10px rgba(0,0,0,0.5)); transition: var(--transition-smooth); }
        
        .map-pin-label { position: absolute; top: 100%; left: 50%; transform: translateX(-50%) translateY(4px); background-color: rgba(0,0,0,0.8); backdrop-filter: blur(8px); color: #fff; font-size: 0.75rem; padding: 0.4rem 0.8rem; font-weight: 500; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); opacity: 0; transition: var(--transition-smooth); white-space: nowrap; z-index: 50; pointer-events: none; }
        .map-pin-wrapper:hover .map-pin-label { opacity: 1; transform: translateX(-50%) translateY(8px); }
        
        .map-pin-locked-wrap { position: relative; transition: var(--transition-smooth); padding-bottom: 6px; }
        .map-pin-locked-img { width: 2.5rem; height: 2.5rem; object-fit: contain; opacity: 0.5; }
        .map-pin-locked-label { position: absolute; top: 100%; left: 50%; transform: translateX(-50%) translateY(4px); background-color: rgba(0,0,0,0.8); color: #888; font-size: 0.75rem; padding: 0.4rem 0.8rem; font-weight: 500; border-radius: 8px; border: 1px solid rgba(255,255,255,0.05); white-space: nowrap; z-index: 50; pointer-events: none; opacity: 1; }

        /* Phone Styles */
        .phone-modal-container { perspective: 1200px; }
        .phone-screen { box-shadow: 0 0 0 2px #333, 0 0 0 8px #000, 0 30px 60px rgba(0,0,0,0.8); border-radius: 40px; }
        .app-icon { transition: transform 0.2s cubic-bezier(0.16, 1, 0.3, 1); }
        .app-icon:active { transform: scale(0.9); filter: brightness(0.8); }
        .currency-positive { color: #ffffff; }
        .currency-negative { color: #888888; }
        
        .app-screen-enter { transform: translateX(100%); }
        .app-screen-active { transform: translateX(0%); }
        .app-screen-exit { transform: translateX(100%); }

        /* --- MAIN MENU STYLES --- */
        .menu-item {
            position: relative;
            padding: 12px 0;
            font-family: 'Inter', sans-serif;
            font-size: 0.95rem;
            font-weight: 400;
            letter-spacing: 0.2em;
            color: rgba(255, 255, 255, 0.5);
            transition: var(--transition-smooth);
            cursor: pointer;
            width: 100%;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 16px;
            text-transform: uppercase;
        }

        .menu-item::after {
            content: '';
            position: absolute;
            left: 0;
            bottom: 6px;
            width: 0;
            height: 1px;
            background: #ffffff;
            transition: width 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .menu-item:hover { color: #ffffff; padding-left: 8px; }
        .menu-item:hover::after { width: 24px; }
        .menu-item .icon-box { opacity: 0; transform: translateX(-10px); transition: var(--transition-smooth); color: #ffffff; }
        .menu-item:hover .icon-box { opacity: 1; transform: translateX(0); }
        
        .menu-item.primary { font-size: 1.1rem; color: #ffffff; font-weight: 500; margin-bottom: 8px; }
        .menu-item.primary::after { width: 24px; background: rgba(255,255,255,0.3); }
        .menu-item.primary:hover::after { width: 48px; background: #ffffff; }

        .animate-slide-up { animation: slideUpFade 1s cubic-bezier(0.16, 1, 0.3, 1) backwards; }
        
        @keyframes slideUpFade {
            from { opacity: 0; transform: translateY(40px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .menu-grain {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; opacity: 0.03;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
        }

        /* --- DYNAMIC SETTINGS STYLES --- */
        /* Font Size System */
        body.font-sm #dialogue-text { font-size: 0.95rem !important; line-height: 1.6 !important; font-weight: 300; }
        body.font-sm .choice-btn { font-size: 0.85rem !important; }
        body.font-lg #dialogue-text { font-size: 1.4rem !important; line-height: 1.8 !important; font-weight: 300; }
        body.font-lg .choice-btn { font-size: 1.1rem !important; }
        
        /* Graphics System Expansion (High vs Low Saturation differences) */
        body.gfx-low #bg-layer-1, body.gfx-low #bg-layer-2 { filter: blur(1px) saturate(0.9) contrast(0.9) brightness(0.9) !important; transition: filter 0.8s ease; }
        body.gfx-low .glass-panel, body.gfx-low .dialogue-box { backdrop-filter: none !important; -webkit-backdrop-filter: none !important; background-color: rgba(10,10,10,0.98) !important; box-shadow: none !important;}
        body.gfx-low .scanlines, body.gfx-low #rain-layer, body.gfx-low .menu-grain, body.gfx-low .vignette { display: none !important; }
        body.gfx-low .camera-move { animation: none !important; transform: scale(1.0) !important; }
        
        body.gfx-med #bg-layer-1, body.gfx-med #bg-layer-2 { filter: saturate(1) contrast(1) brightness(1) !important; transition: filter 0.8s ease; }
        body.gfx-med .glass-panel, body.gfx-med .dialogue-box { backdrop-filter: blur(8px) !important; -webkit-backdrop-filter: blur(8px) !important; }
        body.gfx-med .camera-move { animation-duration: 120s !important; }

        body.gfx-high #bg-layer-1, body.gfx-high #bg-layer-2 { filter: saturate(1.05) contrast(1.05) brightness(1.1) !important; transition: filter 0.8s ease; }
        body.gfx-high .glass-panel, body.gfx-high .dialogue-box { backdrop-filter: blur(24px) saturate(1.5) !important; }

        /* Light Theme Overrides (Minimalist White) */
        body.theme-light { background-color: #f5f5f7; color: #1d1d1f; }
        body.theme-light #start-screen .bg-black { background-color: #ffffff; }
        body.theme-light #start-screen .bg-gradient-to-r { background: linear-gradient(to right, rgba(255,255,255,1) 0%, rgba(255,255,255,0.9) 40%, rgba(255,255,255,0.3) 100%); }
        body.theme-light #start-screen h1 { background: none; color: #1d1d1f; -webkit-text-fill-color: #1d1d1f; text-shadow: none; }
        body.theme-light #start-screen .text-gray-300 { color: #515154 !important; }
        body.theme-light #start-screen .text-gray-500 { color: #86868b !important; }
        body.theme-light .menu-item { color: #86868b; }
        body.theme-light .menu-item::after { background: #1d1d1f; }
        body.theme-light .menu-item:hover { color: #1d1d1f; }
        body.theme-light .menu-item.primary { color: #1d1d1f; }
        body.theme-light .menu-item .icon-box { color: #1d1d1f; }
        
        body.theme-light .glass-panel, body.theme-light .dialogue-box { 
            background: rgba(255, 255, 255, 0.7) !important; 
            border-color: rgba(0, 0, 0, 0.05) !important; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.05) !important;
        }
        body.theme-light #dialogue-text { color: #1d1d1f !important; }
        body.theme-light .choice-btn { background: rgba(0,0,0,0.02); color: #1d1d1f; border-color: rgba(0,0,0,0.05); }
        body.theme-light .choice-btn:hover { background: #1d1d1f; color: #ffffff; }
        body.theme-light .hud-btn { background: rgba(255,255,255,0.5); color: #515154; border-color: rgba(0,0,0,0.05); }
        body.theme-light .hud-btn:hover { background: #ffffff; color: #1d1d1f; border-color: rgba(0,0,0,0.1); }
        body.theme-light .hud-btn.active-mode { background: #1d1d1f; color: #ffffff; }
        body.theme-light #speaker-box { background-color: #ffffff; color: #1d1d1f; border-color: rgba(0,0,0,0.1); }
        
        /* --- PREMIUM SETTINGS (Apple/xAI Minimalist) --- */
        .ios-glass {
            background: rgba(15, 15, 15, 0.7);
            backdrop-filter: blur(40px) saturate(1.5);
            -webkit-backdrop-filter: blur(40px) saturate(1.5);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 40px 100px rgba(0,0,0,0.8), inset 0 1px 0 rgba(255,255,255,0.05);
            color: rgba(255, 255, 255, 0.95);
            border-radius: 24px;
        }
        body.theme-light .ios-glass {
            background: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(0, 0, 0, 0.05);
            box-shadow: 0 40px 100px rgba(0,0,0,0.1), inset 0 1px 0 rgba(255,255,255,1);
            color: #1d1d1f;
        }

        .ios-glass-header { border-bottom: 1px solid rgba(255, 255, 255, 0.05); }
        body.theme-light .ios-glass-header { border-bottom: 1px solid rgba(0, 0, 0, 0.05); }

        .ios-segmented-control {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 3px;
            border: 1px solid rgba(255,255,255,0.05);
        }
        body.theme-light .ios-segmented-control {
            background: rgba(0, 0, 0, 0.04);
            border: 1px solid transparent;
        }

        .ios-segment-btn {
            position: relative;
            z-index: 1;
            transition: var(--transition-smooth);
            border-radius: 9px;
            color: rgba(255, 255, 255, 0.5);
            font-weight: 500;
            font-size: 0.85rem;
        }
        body.theme-light .ios-segment-btn { color: rgba(0, 0, 0, 0.5); }

        .ios-segment-btn.st-btn-active {
            color: #000000;
            background: #ffffff;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        body.theme-light .ios-segment-btn.st-btn-active {
            color: #1d1d1f;
            background: #ffffff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        /* iOS Slider */
        .ios-slider {
            -webkit-appearance: none;
            width: 100%;
            height: 4px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            outline: none;
        }
        body.theme-light .ios-slider { background: rgba(0,0,0,0.1); }
        
        .ios-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #ffffff;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            cursor: pointer;
            transition: transform 0.2s;
        }
        body.theme-light .ios-slider::-webkit-slider-thumb {
            box-shadow: 0 2px 8px rgba(0,0,0,0.15), 0 0 0 1px rgba(0,0,0,0.02);
        }
        .ios-slider::-webkit-slider-thumb:hover { transform: scale(1.1); }

        .tooltip-content {
            background: rgba(20, 20, 20, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            color: rgba(255,255,255,0.9);
            border-radius: 12px;
        }
        body.theme-light .tooltip-content {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(0,0,0,0.05);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            color: #1d1d1f;
        }

        .ios-close-btn {
            background: rgba(255,255,255,0.05);
            color: rgba(255,255,255,0.6);
            border-radius: 50%;
            transition: var(--transition-smooth);
        }
        body.theme-light .ios-close-btn { background: rgba(0,0,0,0.04); color: rgba(0,0,0,0.5); }
        .ios-close-btn:hover { background: rgba(255,255,255,0.1); color: #fff; }
        body.theme-light .ios-close-btn:hover { background: rgba(0,0,0,0.08); color: #000; }

        /* Loading Screen Premium Elements */
        .premium-loader-ring {
            position: absolute; border: 1px solid rgba(255,255,255,0.05); border-radius: 50%;
            top: 50%; left: 50%; transform: translate(-50%, -50%);
        }
        .loading-bar-container {
            width: 100%; max-w: 280px; height: 1px; background: rgba(255,255,255,0.1); position: relative; overflow: visible;
        }
        #loading-bar-fill {
            height: 100%; width: 0%; background: #ffffff; position: relative; transition: width 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        #loading-bar-fill::after {
            content: ''; position: absolute; right: 0; top: 50%; transform: translateY(-50%);
            width: 8px; height: 3px; background: #ffffff; box-shadow: 0 0 12px 2px #ffffff, 0 0 20px 4px rgba(255,255,255,0.5); border-radius: 50%;
        }
        </style>
    </head>
    <body class="text-gray-100 h-screen w-screen relative select-none bg-black transition-colors duration-1000 font-inter">

        <!-- Preloader Screen -->
        <div id="preloader-screen" class="fixed inset-0 z-[200] bg-[#030303] flex flex-col items-center justify-center text-center p-6 transition-opacity duration-1000 overflow-hidden">
            <!-- Ambient Background -->
            <div class="absolute inset-0 bg-[radial-gradient(circle_at_center,rgba(255,255,255,0.03)_0%,transparent_70%)] pointer-events-none"></div>
            
            <!-- Rotating Rings -->
            <div class="premium-loader-ring w-[70vw] h-[70vw] max-w-[800px] max-h-[800px] animate-[spin_120s_linear_infinite]"></div>
            <div class="premium-loader-ring w-[50vw] h-[50vw] max-w-[600px] max-h-[600px] border-white/10 animate-[spin_80s_linear_infinite_reverse]"></div>
            <div class="premium-loader-ring w-[30vw] h-[30vw] max-w-[400px] max-h-[400px] border-t-white/20 border-r-white/5 animate-[spin_40s_linear_infinite]"></div>

            <div class="relative z-10 max-w-md w-full flex flex-col items-center">
                <!-- Center Emblem -->
                <div class="w-16 h-16 mb-10 relative flex items-center justify-center">
                    <div class="absolute inset-0 border border-white/20 rounded-full"></div>
                    <div class="absolute inset-0 border-t border-white rounded-full animate-spin"></div>
                    <div class="absolute inset-2 border border-white/10 rounded-full"></div>
                    <div class="absolute inset-2 border-b border-white/60 rounded-full animate-[spin_2s_linear_infinite_reverse]"></div>
                    <div class="w-1 h-1 bg-white rounded-full shadow-[0_0_10px_rgba(255,255,255,1)] animate-pulse"></div>
                </div>

                <h2 class="text-sm md:text-base font-light text-white tracking-[0.6em] mb-2 uppercase">The Betweens</h2>
                <p class="text-gray-500 text-[9px] tracking-[0.4em] uppercase mb-12 font-medium">Find your in-between.</p>

                <!-- Premium Loading Bar -->
                <div class="loading-bar-container mb-6">
                    <div id="loading-bar-fill"></div>
                </div>
                
                <div class="flex items-center gap-3">
                    <div id="loading-text" class="text-[10px] font-mono text-gray-400 tracking-[0.3em] uppercase">System Boot... 0%</div>
                </div>
                
                <button id="start-btn" class="hidden mt-12 px-10 py-3 bg-white text-black font-semibold tracking-[0.2em] uppercase text-[10px] rounded-full hover:scale-105 hover:bg-gray-100 shadow-[0_0_20px_rgba(255,255,255,0.1)] hover:shadow-[0_0_30px_rgba(255,255,255,0.4)] transition-all duration-500" onclick="game.startFromPreloader()">BEGIN</button>
            </div>
        </div>

        <div id="game-container" class="relative w-full h-full overflow-hidden">
            
            <!-- Background System -->
            <div id="background-wrapper" class="absolute inset-0 overflow-hidden bg-black transition-colors duration-1000">
                <div id="camera-rig" class="absolute inset-0 w-full h-full camera-move">
                    <div id="bg-layer-1" class="absolute inset-0 w-full h-full bg-cover bg-center transition-opacity duration-[2000ms] ease-in-out opacity-0 z-0"></div>
                    <div id="bg-layer-2" class="absolute inset-0 w-full h-full bg-cover bg-center transition-opacity duration-[2000ms] ease-in-out opacity-0 z-0"></div>
                </div>
                <div id="mood-layer" class="absolute inset-0 bg-black/10 mix-blend-overlay transition-colors duration-1000 z-10"></div>
            </div>

            <!-- Overlays -->
            <div class="scanlines"></div>
            <div class="vignette"></div>
            <div id="rain-layer" class="absolute inset-0 pointer-events-none hidden bg-[url('https://i.gifer.com/7scx.gif')] opacity-10 bg-cover mix-blend-screen z-30"></div>
            <div id="flash-layer" class="absolute inset-0 bg-white opacity-0 pointer-events-none z-50"></div>
            
            <!-- Scene Transition Overlay -->
            <div id="scene-transition-overlay" class="absolute inset-0 bg-black z-[90] pointer-events-none opacity-0 transition-opacity duration-700"></div>

            <!-- Step Transition Overlay -->
            <div id="step-transition-overlay" class="absolute inset-0 bg-black z-[85] pointer-events-none opacity-0 transition-opacity duration-[250ms] ease-in-out"></div>

            <!-- Character -->
            <div id="character-layer" class="absolute inset-0 flex items-end justify-center pointer-events-none z-20 pb-0 transition-transform duration-700 translate-y-10 opacity-0"></div>
            
            <!-- Map Modal Overlay -->
            <div id="map-modal" class="hidden absolute inset-0 z-[100] bg-black/80 flex items-center justify-center p-4 md:p-6 backdrop-blur-2xl transition-all duration-500 opacity-0">
                <div class="relative w-full max-w-6xl h-[85vh] bg-[#0a0a0a] rounded-3xl overflow-hidden shadow-2xl ring-1 ring-white/10 group font-inter flex flex-col">
                    
                    <!-- Search Bar & Menu -->
                    <div class="absolute top-6 left-6 right-20 md:right-auto md:w-96 z-[60] flex flex-col">
                        <div class="bg-black/60 backdrop-blur-2xl h-12 rounded-full border border-white/10 flex items-center px-4 gap-3 relative z-20 transition-all focus-within:ring-1 focus-within:ring-white/30">
                            <button onclick="game.toggleMapMenu()" class="focus:outline-none hover:bg-white/10 p-1.5 rounded-full transition-colors text-white">
                                <i data-lucide="menu" class="w-4 h-4"></i>
                            </button>
                            <input type="text" id="map-search-input" placeholder="Search locations..." class="flex-1 bg-transparent border-none focus:outline-none text-sm text-white font-medium w-full placeholder-gray-500" oninput="game.handleMapSearch(event)">
                            <div class="p-1.5 text-gray-400 pointer-events-none">
                                <i data-lucide="search" class="w-4 h-4"></i>
                            </div>
                        </div>
                        
                        <!-- Search Results -->
                        <div id="map-search-results" class="bg-black/80 backdrop-blur-2xl w-full mt-2 rounded-2xl overflow-hidden max-h-60 overflow-y-auto hidden absolute top-12 z-10 flex-col border border-white/10"></div>

                        <!-- Map Menu Dropdown -->
                        <div id="map-side-menu" class="bg-black/80 backdrop-blur-2xl w-56 mt-2 rounded-2xl overflow-hidden hidden absolute top-12 left-0 z-10 flex-col border border-white/10 transition-all origin-top-left">
                            <button onclick="game.resetZoom(); game.toggleMapMenu();" class="flex items-center gap-3 px-4 py-3 hover:bg-white/5 text-left text-xs font-medium text-white border-b border-white/5 transition-colors">
                                <i data-lucide="compass" class="w-4 h-4 text-gray-400"></i> Center Map
                            </button>
                            <button onclick="game.toggleMapStyle(); game.toggleMapMenu();" class="flex items-center gap-3 px-4 py-3 hover:bg-white/5 text-left text-xs font-medium text-white border-b border-white/5 transition-colors">
                                <i data-lucide="layers" class="w-4 h-4 text-gray-400"></i> Toggle Style
                            </button>
                            <button onclick="game.toggleMap(); game.toggleMapMenu();" class="flex items-center gap-3 px-4 py-3 hover:bg-red-500/10 text-left text-xs font-medium text-red-400 transition-colors">
                                <i data-lucide="x-circle" class="w-4 h-4"></i> Close
                            </button>
                        </div>
                    </div>

                    <!-- Map Controls -->
                    <div class="absolute bottom-6 right-6 flex flex-col gap-2 z-50">
                         <button class="bg-black/60 backdrop-blur-xl p-3 rounded-full text-white hover:bg-white hover:text-black transition-all border border-white/10" onclick="game.toggleMapStyle()" title="Toggle View"><i data-lucide="layers" class="w-5 h-5"></i></button>
                         <button class="bg-black/60 backdrop-blur-xl p-3 rounded-full text-white hover:bg-white hover:text-black transition-all border border-white/10" onclick="game.resetZoom()" title="Reset View"><i data-lucide="compass" class="w-5 h-5"></i></button>
                         <div class="flex flex-col bg-black/60 backdrop-blur-xl rounded-full overflow-hidden border border-white/10 mt-1">
                             <button class="p-3 text-white hover:bg-white hover:text-black transition-all border-b border-white/10" onclick="game.zoomMap(1)"><i data-lucide="plus" class="w-5 h-5"></i></button>
                             <button class="p-3 text-white hover:bg-white hover:text-black transition-all" onclick="game.zoomMap(-1)"><i data-lucide="minus" class="w-5 h-5"></i></button>
                         </div>
                    </div>

                    <!-- Map Container -->
                    <div id="map-container" class="map-viewport"></div>

                    <!-- Close Button -->
                    <button onclick="game.toggleMap()" class="absolute top-6 right-6 bg-black/60 backdrop-blur-xl hover:bg-white hover:text-black text-white p-3 rounded-full border border-white/10 z-50 transition-all">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>

            <!-- Phone Modal Overlay -->
            <div id="phone-modal" class="hidden absolute inset-0 z-[100] bg-black/60 flex items-center justify-center p-4 backdrop-blur-2xl transition-all duration-500 opacity-0 phone-modal-container">
                <div class="relative group">
                    <!-- Physical Buttons - Made visible with wider width and lighter color -->
                    <div class="absolute top-24 -right-[10px] w-3 h-16 bg-[#555] rounded-r-lg cursor-pointer hover:bg-white transition-colors z-0 shadow-[2px_0_5px_rgba(0,0,0,0.5)] border-y border-r border-[#333]" onclick="game.togglePhone()" title="Power/Lock (Close Phone)"></div>
                    <div class="absolute top-24 -left-[10px] w-3 h-10 bg-[#555] rounded-l-lg z-0 shadow-[-2px_0_5px_rgba(0,0,0,0.5)] border-y border-l border-[#333]" title="Volume Up"></div>
                    <div class="absolute top-36 -left-[10px] w-3 h-10 bg-[#555] rounded-l-lg z-0 shadow-[-2px_0_5px_rgba(0,0,0,0.5)] border-y border-l border-[#333]" title="Volume Down"></div>

                    <div class="relative w-[320px] h-[640px] bg-black rounded-[40px] border-[6px] border-[#111] phone-screen overflow-hidden flex flex-col z-10">
                        <!-- Dynamic Island / Notch area simulated by styling -->
                        <div class="absolute top-2 left-1/2 -translate-x-1/2 w-24 h-6 bg-black rounded-full z-[60] flex items-center justify-end px-2"><div class="w-2 h-2 rounded-full bg-white/10"></div></div>

                        <div class="h-10 bg-transparent w-full flex justify-between items-center px-6 text-[11px] font-medium text-white z-50 absolute top-0 left-0">
                            <span class="mt-1">09:41</span>
                            <div class="flex gap-1.5 mt-1">
                                <i data-lucide="signal" class="w-3.5 h-3.5"></i>
                                <i data-lucide="wifi" class="w-3.5 h-3.5"></i>
                                <i data-lucide="battery" class="w-3.5 h-3.5"></i>
                            </div>
                        </div>
                        
                        <div id="phone-display" class="flex-1 bg-black overflow-hidden relative">
                            <!-- Home Screen -->
                            <div id="phone-home" class="w-full h-full absolute inset-0 bg-[#050505] p-6 pt-16 relative">
                                <!-- Abstract subtle gradient instead of loud wallpaper -->
                                <div class="absolute inset-0 bg-gradient-to-b from-[#111] to-[#000] z-0"></div>
                                
                                <div class="grid grid-cols-4 gap-x-4 gap-y-6 content-start relative z-10 mt-4">
                                    <!-- Apps -->
                                    <div onclick="game.openApp('phone')" class="flex flex-col items-center gap-1.5 app-icon cursor-pointer">
                                        <div class="w-14 h-14 bg-[#1c1c1e] rounded-[14px] flex items-center justify-center border border-white/5"><i data-lucide="phone" class="text-green-400 w-6 h-6"></i></div>
                                        <span class="text-[10px] text-gray-400 font-medium tracking-wide">Phone</span>
                                    </div>
                                    <div onclick="game.openApp('messages')" class="flex flex-col items-center gap-1.5 app-icon cursor-pointer">
                                        <div class="w-14 h-14 bg-[#1c1c1e] rounded-[14px] flex items-center justify-center border border-white/5"><i data-lucide="message-square" class="text-blue-400 w-6 h-6"></i></div>
                                        <span class="text-[10px] text-gray-400 font-medium tracking-wide">Messages</span>
                                    </div>
                                    <div onclick="game.openApp('photos')" class="flex flex-col items-center gap-1.5 app-icon cursor-pointer">
                                        <div class="w-14 h-14 bg-[#1c1c1e] rounded-[14px] flex items-center justify-center border border-white/5"><i data-lucide="image" class="text-purple-400 w-6 h-6"></i></div>
                                        <span class="text-[10px] text-gray-400 font-medium tracking-wide">Photos</span>
                                    </div>
                                    <div class="flex flex-col items-center gap-1.5 app-icon cursor-pointer opacity-50">
                                        <div class="w-14 h-14 bg-[#1c1c1e] rounded-[14px] flex items-center justify-center border border-white/5"><i data-lucide="camera" class="text-gray-400 w-6 h-6"></i></div>
                                        <span class="text-[10px] text-gray-400 font-medium tracking-wide">Camera</span>
                                    </div>
                                    <!-- Facebook -->
                                    <div onclick="game.openApp('facebook')" class="flex flex-col items-center gap-1.5 app-icon cursor-pointer">
                                        <div class="w-14 h-14 bg-blue-600 rounded-[14px] flex items-center justify-center border border-white/5"><i data-lucide="facebook" class="text-white w-6 h-6"></i></div>
                                        <span class="text-[10px] text-gray-400 font-medium tracking-wide">Facebook</span>
                                    </div>
                                    <!-- YouTube -->
                                    <div onclick="game.openApp('youtube')" class="flex flex-col items-center gap-1.5 app-icon cursor-pointer">
                                        <div class="w-14 h-14 bg-red-600 rounded-[14px] flex items-center justify-center border border-white/5"><i data-lucide="youtube" class="text-white w-6 h-6"></i></div>
                                        <span class="text-[10px] text-gray-400 font-medium tracking-wide">YouTube</span>
                                    </div>
                                    <!-- Spotify -->
                                    <div onclick="game.openApp('music')" class="flex flex-col items-center gap-1.5 app-icon cursor-pointer">
                                        <div class="w-14 h-14 bg-[#1DB954] rounded-[14px] flex items-center justify-center border border-white/5">
                                            <svg viewBox="0 0 24 24" class="w-7 h-7 fill-current text-white"><path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141 4.32-1.38 9.841-.719 13.44 1.5.42.24.6.841.301 1.321zm.12-3.36C15.54 8.46 9.06 8.22 5.34 9.36c-.6.18-1.2-.18-1.38-.72-.18-.6.18-1.2.72-1.38 4.26-1.26 11.4-1.02 15.96 1.68.6.359.84 1.14.479 1.74-.359.6-1.14.84-1.74.48z"/></svg>
                                        </div>
                                        <span class="text-[10px] text-gray-400 font-medium tracking-wide">Spotify</span>
                                    </div>
                                    <!-- KBZPay -->
                                    <div onclick="game.openApp('kbzpay')" class="flex flex-col items-center gap-1.5 app-icon cursor-pointer">
                                        <div class="w-14 h-14 bg-[#1a4a8d] rounded-[14px] flex items-center justify-center border border-white/5"><span class="text-white font-black text-xs tracking-wider">KBZ</span></div>
                                        <span class="text-[10px] text-gray-400 font-medium tracking-wide">KBZPay</span>
                                    </div>
                                </div>
                            </div>

                            <div id="active-app-container" class="absolute inset-0 bg-black translate-x-full transition-transform duration-400 z-20 flex flex-col">
                                <div id="app-header-bar" class="h-14 bg-black/80 backdrop-blur-md border-b border-white/10 flex items-center px-4 font-semibold text-white z-30 relative pt-4">
                                    <button onclick="game.phoneHome()" class="p-1 -ml-2 rounded-full hover:bg-white/10 transition-colors text-white"><i data-lucide="chevron-left" class="w-6 h-6"></i></button>
                                    <span id="app-title-text" class="ml-2 text-sm tracking-wide">App Name</span>
                                </div>
                                <div id="app-content-area" class="flex-1 overflow-y-auto custom-scroll relative bg-black"></div>
                            </div>
                        </div>

                        <!-- Home Indicator -->
                        <div class="absolute bottom-2 left-1/2 transform -translate-x-1/2 w-full h-6 z-50 flex items-center justify-center cursor-pointer" onclick="game.phoneHome()">
                            <div class="w-32 h-1 bg-white/40 rounded-full hover:bg-white transition-colors"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Modal Overlay -->
            <div id="settings-modal" class="hidden absolute inset-0 z-[110] bg-black/60 flex items-center justify-center p-4 backdrop-blur-2xl transition-all duration-500 opacity-0">
                <div class="relative w-full max-w-2xl ios-glass p-8 md:p-10 flex flex-col gap-8 transition-colors">
                    
                    <!-- Header -->
                    <div class="flex justify-between items-center ios-glass-header pb-5">
                        <h2 id="st-title" class="text-xl font-semibold tracking-widest uppercase">Settings</h2>
                        <button onclick="game.closeSettings()" class="p-2 ios-close-btn flex items-center justify-center">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    </div>
                    
                    <!-- Settings Content -->
                    <div class="flex flex-col gap-6 overflow-y-auto custom-scroll max-h-[65vh] pr-4 font-light">

                        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 relative z-10 group">
                            <div class="flex items-center gap-3 w-fit">
                                <i data-lucide="volume-2" class="w-5 h-5 opacity-50"></i>
                                <span id="st-ga-vol" class="text-sm tracking-wide">Master Volume</span>
                            </div>
                            <input type="range" id="ga-vol-slider" min="0" max="1" step="0.1" value="1" oninput="game.setVolume(this.value)" class="w-full md:w-64 ios-slider">
                        </div>

                        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 relative z-10 group">
                            <div class="flex items-center gap-3 w-fit">
                                <i data-lucide="music" class="w-5 h-5 opacity-50"></i>
                                <span id="st-tm-vol" class="text-sm tracking-wide">Theme Music</span>
                            </div>
                            <input type="range" id="tm-vol-slider" min="0" max="1" step="0.1" value="0.4" oninput="game.setThemeVolume(this.value)" class="w-full md:w-64 ios-slider">
                        </div>

                        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 relative z-10 group">
                            <div class="flex items-center gap-3 w-fit">
                                <i data-lucide="speaker" class="w-5 h-5 opacity-50"></i>
                                <span id="st-ga-state" class="text-sm tracking-wide">Scene Audio</span>
                            </div>
                            <div class="flex ios-segmented-control w-full md:w-auto min-w-[200px]">
                                <button onclick="game.setGameAudio('on')" data-val="on" class="flex-1 px-6 py-2 transition st-btn ios-segment-btn st-btn-ga st-btn-active">
                                    <span id="st-ga-on">On</span>
                                </button>
                                <button onclick="game.setGameAudio('off')" data-val="off" class="flex-1 px-6 py-2 transition st-btn ios-segment-btn st-btn-ga">
                                    <span id="st-ga-off">Off</span>
                                </button>
                            </div>
                        </div>

                        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 relative z-10 group">
                            <div class="flex items-center gap-3 w-fit">
                                <i data-lucide="type" class="w-5 h-5 opacity-50"></i>
                                <span id="st-font" class="text-sm tracking-wide">Typography Size</span>
                            </div>
                            <div class="flex ios-segmented-control w-full md:w-auto">
                                <button onclick="game.setFontSize('small')" data-val="small" class="flex-1 px-5 py-2 transition st-btn ios-segment-btn st-btn-font">
                                    <span id="st-font-sm">Small</span>
                                </button>
                                <button onclick="game.setFontSize('medium')" data-val="medium" class="flex-1 px-5 py-2 transition st-btn ios-segment-btn st-btn-font st-btn-active">
                                    <span id="st-font-md">Medium</span>
                                </button>
                                <button onclick="game.setFontSize('large')" data-val="large" class="flex-1 px-5 py-2 transition st-btn ios-segment-btn st-btn-font">
                                    <span id="st-font-lg">Large</span>
                                </button>
                            </div>
                        </div>

                        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 relative z-10 group">
                            <div class="flex items-center gap-3 w-fit">
                                <i data-lucide="monitor" class="w-5 h-5 opacity-50"></i>
                                <span id="st-gfx" class="text-sm tracking-wide">Render Quality</span>
                            </div>
                            <div class="flex ios-segmented-control w-full md:w-auto">
                                <button onclick="game.setGraphics('low')" data-val="low" class="flex-1 px-5 py-2 transition st-btn ios-segment-btn st-btn-gfx">
                                    <span id="st-gfx-low">Low</span>
                                </button>
                                <button onclick="game.setGraphics('medium')" data-val="medium" class="flex-1 px-5 py-2 transition st-btn ios-segment-btn st-btn-gfx">
                                    <span id="st-gfx-med">Medium</span>
                                </button>
                                <button onclick="game.setGraphics('high')" data-val="high" class="flex-1 px-5 py-2 transition st-btn ios-segment-btn st-btn-gfx st-btn-active">
                                    <span id="st-gfx-high">High</span>
                                </button>
                            </div>
                        </div>

                        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 relative z-10 group">
                            <div class="flex items-center gap-3 w-fit">
                                <i data-lucide="globe" class="w-5 h-5 opacity-50"></i>
                                <span id="st-lang" class="text-sm tracking-wide">System Language</span>
                            </div>
                            <div class="flex ios-segmented-control w-full md:w-auto min-w-[200px]">
                                <button onclick="game.setLanguage('en')" data-val="en" class="flex-1 px-6 py-2 transition st-btn ios-segment-btn st-btn-lang">
                                    English
                                </button>
                                <button onclick="game.setLanguage('mm')" data-val="mm" class="flex-1 px-6 py-2 transition st-btn ios-segment-btn st-btn-lang st-btn-active">
                                    မြန်မာ
                                </button>
                            </div>
                        </div>

                        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 relative z-10 group">
                            <div class="flex items-center gap-3 w-fit">
                                <i data-lucide="sun-moon" class="w-5 h-5 opacity-50"></i>
                                <span id="st-theme" class="text-sm tracking-wide">Environment Mode</span>
                            </div>
                            <div class="flex ios-segmented-control w-full md:w-auto min-w-[200px]">
                                <button onclick="game.setTheme('dark')" data-val="dark" class="flex-1 px-6 py-2 transition st-btn ios-segment-btn st-btn-theme st-btn-active">
                                    <span id="st-theme-dark">Dark</span>
                                </button>
                                <button onclick="game.setTheme('light')" data-val="light" class="flex-1 px-6 py-2 transition st-btn ios-segment-btn st-btn-theme">
                                    <span id="st-theme-light">Light</span>
                                </button>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            <!-- UI Layer -->
            <div id="ui-layer" class="absolute inset-0 z-50 flex flex-col justify-between p-6 md:p-10 hidden">

                <!-- Top HUD -->
                <div class="flex justify-between items-start w-full">
                    <!-- Left: Location Information -->
                    <div class="flex flex-col gap-4 max-w-[50%]">
                        <div id="location-tag" class="glass-panel px-5 py-3 border-l-2 border-white flex items-center gap-4 rounded-xl">
                            <i data-lucide="map-pin" class="w-4 h-4 text-white opacity-80"></i>
                            <div class="overflow-hidden">
                                <span id="location-text" class="block font-medium text-sm tracking-widest uppercase truncate text-white">YANGON</span>
                                <span id="time-text" class="text-[10px] text-gray-400 font-mono tracking-wider block truncate mt-0.5">DAY 1 - 08:00 AM</span>
                            </div>
                        </div>

                        <div class="flex items-center gap-2">
                            <button onclick="game.toggleMuteShortcut()" class="hud-btn w-10 h-10 rounded-xl">
                                <i id="audio-icon" data-lucide="volume-2" class="w-4 h-4 text-white"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Right: Modern Tool Menu -->
                    <div class="flex flex-col items-end gap-3 pointer-events-auto relative">
                        
                        <div id="unlock-notification" class="absolute top-12 right-0 notification-toast bg-gray-200 text-black shadow-2xl rounded-xl p-3 flex items-center gap-3 w-64 pointer-events-none z-[60] mb-2 border border-black/5">
                            <div class="p-2 rounded-full bg-black/5">
                                <i data-lucide="unlock" class="w-4 h-4 text-black"></i>
                            </div>
                            <div>
                                <div class="text-[9px] uppercase text-gray-500 font-semibold tracking-widest">Access Granted</div>
                                <div id="unlock-text" class="text-sm font-medium text-black leading-tight mt-0.5">Home</div>
                            </div>
                        </div>
                        
                        <div id="currency-notification" class="absolute top-28 right-0 notification-toast bg-[#111] border border-white/10 shadow-2xl rounded-xl p-3 flex items-center gap-3 w-64 pointer-events-none z-[60] mb-2">
                            <div class="p-2 rounded-full bg-white/10">
                                <i data-lucide="credit-card" class="w-4 h-4 text-white"></i>
                            </div>
                            <div>
                                <div class="text-[9px] uppercase text-gray-400 font-semibold tracking-widest">Transaction</div>
                                <div id="currency-text" class="text-sm font-mono text-white leading-tight mt-0.5">0 MMK</div>
                            </div>
                        </div>
                        
                        <div id="audio-notification" class="absolute top-44 right-0 notification-toast bg-[#111] border border-white/10 shadow-2xl rounded-xl p-3 flex items-center gap-3 w-64 pointer-events-none z-[60]">
                            <div class="p-2 rounded-full bg-white/10">
                                <i id="audio-toast-icon" data-lucide="volume-2" class="w-4 h-4 text-white"></i>
                            </div>
                            <div>
                                <div class="text-[9px] uppercase text-gray-400 font-semibold tracking-widest">System Audio</div>
                                <div id="audio-toast-text" class="text-sm font-mono text-white leading-tight mt-0.5">Unmuted</div>
                            </div>
                        </div>

                        <!-- Action Bar Container -->
                        <div class="glass-panel p-2 rounded-2xl flex flex-row flex-wrap justify-end gap-2 border-white/10">
                            <button onclick="game.togglePhone()" class="hud-btn" aria-label="Terminal">
                                <i data-lucide="smartphone" class="w-4 h-4"></i>
                                <span class="tooltip">Device</span>
                            </button>
                            <button onclick="game.toggleMap()" class="hud-btn" aria-label="Map">
                                <i data-lucide="map" class="w-4 h-4"></i>
                                <span class="tooltip">Map</span>
                            </button>
                            <button onclick="game.saveGameManual()" class="hud-btn" aria-label="Save">
                                <i data-lucide="hard-drive" class="w-4 h-4"></i>
                                <span class="tooltip">Save</span>
                            </button>
                            <button onclick="game.openSettings()" class="hud-btn" aria-label="Settings">
                                <i data-lucide="sliders" class="w-4 h-4"></i>
                                <span class="tooltip" id="hud-st-tip">Settings</span>
                            </button>

                            <div class="w-[1px] h-6 bg-white/10 mx-2 self-center"></div>

                            <button onclick="game.toggleLang()" class="hud-btn w-14" aria-label="Language">
                                <span id="lang-btn" class="font-medium text-[11px] tracking-wider">MM</span>
                            </button>
                            <button onclick="game.toggleAuto()" id="auto-btn" class="hud-btn" aria-label="Auto Play">
                                <i data-lucide="play" class="w-4 h-4"></i>
                                <span class="tooltip">Auto</span>
                            </button>

                            <div class="w-[1px] h-6 bg-white/10 mx-2 self-center"></div>

                            <button onclick="game.toggleImmersive()" class="hud-btn" aria-label="Immersive Mode">
                                <i data-lucide="focus" class="w-4 h-4"></i>
                                <span class="tooltip">Immersive</span>
                            </button>
                            <button onclick="game.takeScreenshot()" class="hud-btn" aria-label="Screenshot">
                                <i data-lucide="camera" class="w-4 h-4"></i>
                                <span class="tooltip">Capture</span>
                            </button>
                            <button onclick="game.toggleFullscreen()" id="fs-btn" class="hud-btn" aria-label="Fullscreen">
                                <i data-lucide="maximize" class="w-4 h-4"></i>
                                <span class="tooltip">Expand</span>
                            </button>

                            <div class="w-[1px] h-6 bg-white/10 mx-2 self-center"></div>

                            <button onclick="game.quitToMenu()" class="hud-btn" aria-label="Menu">
                                <i data-lucide="log-out" class="w-4 h-4"></i>
                                <span class="tooltip" id="hud-quit-tip">Exit</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Interaction Area -->
                <div class="mt-auto w-full max-w-4xl mx-auto space-y-4">
                    <div id="choices-container" class="flex flex-col gap-2 items-center mb-4 transition-all duration-500 min-h-[40px] max-h-[35vh] overflow-y-auto pr-2 custom-scroll pointer-events-auto">
                    </div>
                    
                    <div id="dialogue-box" class="dialogue-box p-8 md:p-10 relative min-h-[160px] cursor-pointer group pointer-events-auto" onclick="game.next()">
                        <div class="absolute -top-4 left-8 z-10">
                            <div id="speaker-box" class="bg-white px-5 py-1.5 text-[10px] md:text-xs font-semibold tracking-[0.2em] text-black uppercase rounded-full shadow-lg border border-white/20 hidden transition-colors">
                                <span id="speaker-name" class="inline-block font-inter">NAME</span>
                            </div>
                        </div>
                        <p id="dialogue-text" class="text-base md:text-lg leading-relaxed md:leading-loose text-gray-200 font-light tracking-wide cursor relative z-0 mt-2 md:mt-0 transition-all"></p>
                        <div class="absolute bottom-6 right-8 text-white/50 opacity-0 transition-opacity duration-300" id="next-indicator">
                            <i data-lucide="chevron-down" class="w-5 h-5 animate-pulse"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Start Screen (Main Menu) -->
            <div id="start-screen" class="absolute inset-0 z-[80] flex bg-black overflow-hidden transition-colors">
                
                <!-- Background Video -->
                <video id="main-menu-video" loop muted playsinline class="absolute inset-0 w-full h-full object-cover opacity-60 z-0">
                    <source src="../videos/hero-video4.mp4" type="video/mp4">
                </video>
                
                <div class="menu-grain z-10 transition-opacity"></div>
                <div class="absolute inset-0 bg-gradient-to-r from-black via-black/90 to-transparent z-10 transition-colors"></div>
                
                <div class="relative z-20 w-full h-full flex flex-col md:flex-row p-10 md:p-20 lg:p-32 items-center md:items-stretch">
                    
                    <!-- Left Column -->
                    <div class="flex-1 flex flex-col justify-center items-start space-y-10 max-w-2xl">
                        
                        <div class="animate-slide-up" style="animation-delay: 0.1s;">
                            <div class="inline-flex items-center gap-3 border border-white/10 px-5 py-1.5 rounded-full bg-white/5 backdrop-blur-xl">
                                <div class="w-1.5 h-1.5 rounded-full bg-white animate-pulse"></div>
                                <div class="text-white tracking-[0.3em] text-[9px] uppercase font-medium">Initial Release - Block 1.0.0 </div>
                            </div>
                        </div>

                        <div class="animate-slide-up" style="animation-delay: 0.2s;">
                            <h1 class="text-5xl md:text-7xl lg:text-[7rem] font-light text-white tracking-tighter leading-[1.1]">
                                The<br>
                                <span class="font-semibold">Betweens</span>
                            </h1>
                        </div>

                        <div class="animate-slide-up space-y-5" style="animation-delay: 0.3s;">
                            <p class="text-gray-400 text-lg md:text-xl font-light tracking-wide max-w-lg transition-colors leading-relaxed">
                                Two worlds. One reality.
                            </p>
                            <p class="text-gray-500 text-sm max-w-lg leading-loose font-light opacity-80 transition-colors">
                                Navigate the fractured timelines of Yangon. Uncover the truth hidden in the echoes of the city. Your choices define the reality you wake up in.
                            </p>
                        </div>
                    </div>

                    <!-- Right Column -->
                    <div class="w-full md:w-[400px] flex flex-col justify-center items-start pl-0 md:pl-20 mt-16 md:mt-0 relative animate-slide-up" style="animation-delay: 0.5s;">
                         
                         <div class="flex flex-col w-full space-y-1">
                            <button onclick="game.init()" class="menu-item primary">
                                <span id="st-menu-new">New Journey</span>
                            </button>
                            
                            <button onclick="game.loadGame()" id="load-btn" class="menu-item hidden">
                                <span id="st-menu-load">Continue Journey</span>
                            </button>
                            
                            <button onclick="alert('Feature coming in next update')" class="menu-item">
                                <span id="st-menu-gallery">Memory Records</span>
                            </button>
                            
                            <button onclick="game.openSettings()" class="menu-item">
                                <span id="st-menu-set">System Settings</span>
                            </button>
                            
                            <button onclick="alert('Feature coming in next update')" class="menu-item">
                                <span id="st-menu-terms">User Agreement</span>
                            </button>
                            
                            <button onclick="alert('Feature coming in next update')" class="menu-item">
                                <span id="st-menu-credits">Project Credits</span>
                            </button>
                            
                            <button onclick="location.href='../index.html'" class="menu-item mt-8" style="color: rgb(255, 39, 39);">
                                <span id="st-menu-quit">Leave Session</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
    // --- DICTIONARY FOR SETTINGS ---
    const SETTINGS_DICT = {
        title: { en: "System Parameters", mm: "စနစ်ဆက်တင်များ" },
        ga_vol: { en: "Master Volume", mm: "ပင်မအသံ" },
        ga_vol_tip: { en: "Adjusts the volume of game sound effects.", mm: "ဂိမ်းအတွင်းအသံများ၏ အတိုးအကျယ်ကို ချိန်ညှိရန်။" },
        tm_vol: { en: "Theme Audio", mm: "နောက်ခံတေးဂီတ" },
        tm_vol_tip: { en: "Adjusts the volume of the main theme song.", mm: "ပင်မနောက်ခံတေးဂီတ၏ အတိုးအကျယ်ကို ချိန်ညှိရန်။" },
        ga_state: { en: "Scene Ambience", mm: "နောက်ခံပတ်ဝန်းကျင်အသံ" },
        ga_state_tip: { en: "Toggle the scene specific sound effects.", mm: "ဂိမ်းအတွင်းနောက်ခံအသံများကို ဖွင့်ရန် သို့မဟုတ် ပိတ်ရန်။" },
        ga_on: { en: "Enabled", mm: "ဖွင့်" },
        ga_off: { en: "Disabled", mm: "ပိတ်" },
        font_size: { en: "Typography Scale", mm: "စာလုံးအရွယ်အစား" },
        font_tip: { en: "Changes the size of the reading text.", mm: "စာဖတ်ရမည့် စာလုံးများ၏ အရွယ်အစားကို ပြောင်းလဲရန်။" },
        font_sm: { en: "Compact", mm: "အသေးစား" },
        font_md: { en: "Standard", mm: "အလတ်စား" },
        font_lg: { en: "Expanded", mm: "အကြီးစား" },
        graphics: { en: "Render Quality", mm: "ရုပ်ထွက်အရည်အသွေး" },
        gfx_tip: { en: "Lowers visual effects for better performance.", mm: "စက်အလေးမခံရစေရန် ရုပ်ထွက်အထူးပြုလုပ်ချက်များကို လျှော့ချရန်။" },
        gfx_low: { en: "Performance", mm: "အနိမ့်" },
        gfx_med: { en: "Balanced", mm: "အလတ်" },
        gfx_high: { en: "Quality", mm: "အမြင့်" },
        language: { en: "Localization", mm: "ဘာသာစကား" },
        lang_tip: { en: "Switch between English and Burmese.", mm: "အင်္ဂလိပ်နှင့် မြန်မာဘာသာစကား ပြောင်းလဲရန်။" },
        theme: { en: "Environment", mm: "အသွင်အပြင်" },
        theme_tip: { en: "Toggle between Dark and Light mode.", mm: "အလင်းနှင့် အမှောင်ပုံစံ ပြောင်းလဲရန်။" },
        theme_dark: { en: "Dark", mm: "အမှောင်" },
        theme_light: { en: "Light", mm: "အလင်း" },
        menu_new: { en: "New Journey", mm: "ဂိမ်းအသစ်စရန်" },
        menu_load: { en: "Continue Journey", mm: "ဆက်လက်ကစားရန်" },
        menu_gallery: { en: "Memories", mm: "မှတ်တမ်းများ" },
        menu_set: { en: "Settings", mm: "ဆက်တင်များ" },
        menu_terms: { en: "Legal", mm: "စည်းမျဥ်းများ"},
        menu_credits: { en: "Credits", mm: "ခရက်ဒစ်"},
        menu_quit: { en: "Leave", mm: "ထွက်မည်" },
        hud_quit: { en: "Exit", mm: "အစသို့" }
    };

    // --- LOCATION DATABASE ---
    const LOCATIONS = [
        { id: 'imc', type: 'school', lat: 16.823366, lng: 96.130645, name: { en: "Info Myanmar College", mm: "Info Myanmar College" }, scene: 'school_imc' },
        { id: 'naung_gyi', type: 'home', lat: 16.849836, lng: 96.157178, name: { en: "Naung Gyi's House", mm: "နောင်ကြီး အိမ်" }, scene: 'home_naunggyi' },
        { id: 'home', type: 'home', lat: 16.880386, lng: 96.156378, name: { en: "Tayza's House", mm: "တေဇ အိမ်" }, scene: 'intro-tayza' },
        { id: 'shwedagon', type: 'shwedagon_pagoda', lat: 16.7984, lng: 96.1496, name: { en: "Shwedagon Pagoda", mm: "ရွှေတိဂုံဘုရား" }, scene: 'shwedagon_arrival' },
        { id: 'kantawgyi', type: 'park', lat: 16.795, lng: 96.166, name: { en: "Kandawgyi Lake", mm: "ကန်တော်ကြီး" }, scene: 'place_kantawgyi' },
        { id: 'inyalake', type: 'park', lat: 16.837, lng: 96.143, name: { en: "Inya Lake", mm: "အင်းယားကန်" }, scene: 'place_inya' },
        { id: 'mmplaza', type: 'mmplaza', lat: 16.827439, lng: 96.154957, name: { en: "Myanmar Plaza", mm: "မြန်မာပလာဇာ" }, scene: 'place_mmplaza' },
        { id: 'junction_city', type: 'mall', lat: 16.7792557, lng: 96.1544072, name: { en: "Junction City", mm: "Junction City" }, scene: 'mall_jc' },
        { id: 'hmone_gyi', type: 'tea_shop', lat: 16.785, lng: 96.145, name: { en: "Hmone Gyi Tea Shop", mm: "မှုန်ကြီးလက်ဖက်ရည်ဆိုင်" }, scene: 'tea_hmonegyi' },
        { id: 'sule', type: 'sule_pagoda', lat: 16.7744, lng: 96.1586, name: { en: "Sule Pagoda", mm: "ဆူးလေဘုရား" }, scene: 'place_sule' },
        { id: 'downtown', type: 'city', lat: 16.775327, lng: 96.151123, name: { en: "Downtown", mm: "မြို့လယ်ခေါင်" }, scene: 'place_downtown' },
        { id: 'alwan_cafe', type: 'cafe_shop', lat: 16.780, lng: 96.150, name: { en: "A Lwan Café", mm: "အလွမ်းကဖေး" }, scene: 'cafe_alwan' },
    ];
    
    // --- ASSETS DATABASE ---
    const ASSETS = {
        bg: {
            downtown: "../images/places/downtown.png",
            sule: "../images/places/sule.png",
            shwedagon: "../images/places/shwedagon.png",
            shwedagon_stairs: "../images/places/shwedagon_stairs.png",
            shwedagon_night: "../images/places/shwedagon_night.png",
            kantawgyi: "../images/places/kantawg.png",
            home_tayza: "../images/places/home_tayza.png",
            alarm: "../images/items/alarm.png",
            sleep_tayza: "../images/person/sleep-tayza.png",
            wakeup_tayza: "../images/person/wakeup-tayza.png",
            oldfan: "../images/items/oldfan.png",
            missedcall: "../images/items/missedcall.png",
            stair: "../images/places/stair.png",
            kitchen: "../images/places/kitchen.png",
            livingroom: "../images/places/livingroom.png",
            bathroom: "../images/places/bathroom.png",
            dining_room: "../images/places/dining_room.png",
            bedroom_night: "../images/places/bedroom_night.png",
            parallel_sule: "../images/places/parallel_sule.png",
            parallel_street: "../images/places/parallel_street.png",
            ring_item: "../images/items/ring.png",
            faceless_mom: "../images/person/faceless_mom.png"
        },
        audio: {
            main_theme: "../audios/main_theme.mp3",
            morning_chant: "../audios/morning_bird.mp3",
            alarm: "../audios/alarm.mp3",
            yawn: "../audios/yawn.mp3",
            oldfan: "../audios/oldfan.mp3",
            stair: "../audios/footstep.mp3",
            kitchen: "../audios/kitchen.mp3",
            water_splash: "../audios/water_splash.mp3",
            pagoda_bells: "../audios/pagoda_bells.mp3",
            city_ambience: "../audios/city_ambience.mp3",
            creepy_drone: "../audios/creepy_drone.mp3"
        },
        icons: {
            home: "../images/places/home.gif",
            shwedagon_pagoda: "../images/places/pagoda.gif",
            sule_pagoda: "../images/places/pagoda.gif",
            tea_shop: "../images/places/cafe-tea.gif",
            cafe_shop: "../images/places/cafe-tea.gif",
            school: "../images/places/school.gif",
            mall: "../images/places/mall.gif",
            park: "../images/places/lake.gif",
            city: "../images/places/city.gif",
            player: "../images/places/current.gif", 
            tree: "../images/places/tree.gif",
            inyalake: "../images/places/lake.gif",
            mmplaza: "../images/places/mall.gif",
        }
    };

    // --- GAME ENGINE ---
    class GameEngine {
        constructor() {
            this.state = {
                stats: { sanity: 100, trust: 0, life: 50, knowledge: 0 },
                flags: {},
                currency: 0, 
                day: 1,
                sceneId: 'start',
                lang: 'en',
                settings: { volume: 1.0, themeVolume: 0.4, gameAudio: 'on', fontSize: 'medium', graphics: 'high', theme: 'dark' }
            };
            this.typingSpeed = 20;
            this.isTyping = false;
            this.typingTimer = null; 
            this.autoPlayTimer = null; 
            this.audioNotifTimer = null;
            this.autoPlay = false; 
            this.isTransitioning = false;
            this.sceneData = null;
            this.dialogueIndex = 0;
            this.audio = new AudioController();
            this.activeLayer = 1; 
            this.currentBgKey = null; 
            this.immersiveMode = false;
            this.mapOpen = false;
            this.phoneOpen = false;
            this.settingsOpen = false;
            this.phoneApp = null;
            
            // MapLibre properties
            this.map = null;
            this.markers = [];
            this.currentMapStyle = 'normal';
            this.mapStyles = {
                normal: 'https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json', // Sleeker default map
                satellite: {
                    "version": 8,
                    "sources": {
                        "esri-satellite": {
                            "type": "raster",
                            "tiles": ["https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}"],
                            "tileSize": 256,
                            "attribution": ""
                        }
                    },
                    "layers": [{
                        "id": "satellite",
                        "type": "raster",
                        "source": "esri-satellite",
                        "minzoom": 0,
                        "maxzoom": 19
                    }]
                }
            };

            if(localStorage.getItem('ringGameSave_V5')) {
                const btn = document.getElementById('load-btn');
                btn.classList.remove('hidden');
                btn.classList.add('flex');
            }
            
            const saveStr = localStorage.getItem('ringGameSave_V5');
            if(saveStr) {
                const parsed = JSON.parse(saveStr);
                if(parsed.settings) this.state.settings = parsed.settings;
            }
            if (this.state.settings.themeVolume === undefined) this.state.settings.themeVolume = 0.4;
            if (this.state.settings.gameAudio === undefined) this.state.settings.gameAudio = 'on';
            
            this.applySettings();
            this.renderSettingsText();
            this.initPreloader();
        }

        initPreloader() {
            const allAssets = [];
            if (ASSETS.bg) Object.values(ASSETS.bg).forEach(url => allAssets.push({type: 'image', url}));
            if (ASSETS.icons) Object.values(ASSETS.icons).forEach(url => allAssets.push({type: 'image', url}));
            if (ASSETS.audio) Object.values(ASSETS.audio).forEach(url => allAssets.push({type: 'audio', url}));
            allAssets.push({type: 'video', url: 'https://www.pexels.com/download/video/6205145/'});

            let loadedCount = 0;
            const totalAssets = allAssets.length;
            const barFill = document.getElementById('loading-bar-fill');
            const loadText = document.getElementById('loading-text');
            const startBtn = document.getElementById('start-btn');

            const playPreloaderAudio = () => {
                if (this.audio && this.audio.themeMusic && this.audio.themeMusic.paused) {
                    this.audio.themeMusic.volume = this.state.settings.themeVolume !== undefined ? this.state.settings.themeVolume : 0.4;
                    this.audio.themeMusic.play().catch(e => console.log("Autoplay blocked."));
                }
            };
            playPreloaderAudio();
            document.addEventListener('click', playPreloaderAudio, { once: true });

            const updateProgress = () => {
                loadedCount++;
                let percent = Math.floor((loadedCount / totalAssets) * 100);
                if(barFill) barFill.style.width = percent + '%';
                if(loadText) loadText.innerText = `System Boot... ${percent}%`;
                if (loadedCount >= totalAssets && loadText && loadText.innerText !== "Initialization Complete - Click 'Begin' to proceed.") {
                    if(loadText) loadText.innerText = "Initialization Complete - Click 'Begin' to proceed.";
                    if(startBtn) startBtn.classList.remove('hidden');
                }
            };

            if (totalAssets === 0) { updateProgress(); return; }

            allAssets.forEach(asset => {
                if (asset.type === 'image') { const img = new Image(); img.onload = updateProgress; img.onerror = updateProgress; img.src = asset.url; }
                else if (asset.type === 'audio') { const aud = new Audio(); aud.addEventListener('canplaythrough', updateProgress, { once: true }); aud.addEventListener('error', updateProgress, { once: true }); aud.src = asset.url; aud.load(); }
                else if (asset.type === 'video') { const vid = document.createElement('video'); vid.addEventListener('canplaythrough', updateProgress, { once: true }); vid.addEventListener('error', updateProgress, { once: true }); vid.src = asset.url; vid.load(); }
            });

            setTimeout(() => {
                if (loadedCount < totalAssets) { loadedCount = totalAssets - 1; updateProgress(); }
            }, 6000); 
        }

        startFromPreloader() {
            const preloader = document.getElementById('preloader-screen');
            if (preloader) {
                preloader.classList.add('opacity-0');
                const bgVideo = document.getElementById('main-menu-video');
                if(bgVideo) bgVideo.play().catch(e => console.log(e));
                setTimeout(() => { preloader.classList.add('hidden'); }, 1000);
            }
        }

        init() {
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('ui-layer').classList.remove('hidden');
            document.getElementById('ui-layer').classList.add('flex');
            lucide.createIcons();
            this.loadScene('yangon_intro');
            this.setupMapInteractions();
            this.updateCurrency(0);
        }

        quitToMenu() {
            document.getElementById('ui-layer').classList.add('hidden');
            document.getElementById('ui-layer').classList.remove('flex');
            const startScreen = document.getElementById('start-screen');
            startScreen.classList.remove('hidden');
            startScreen.classList.remove('opacity-0');
            const loadBtn = document.getElementById('load-btn');
            loadBtn.classList.remove('hidden');
            loadBtn.classList.add('flex');
            
            this.isTyping = false;
            if(this.typingTimer) clearTimeout(this.typingTimer);
            if(this.autoPlayTimer) clearTimeout(this.autoPlayTimer);
            if (this.audio && this.audio.bgMusic) this.audio.bgMusic.pause();
            this.saveGameManual();
        }
        
        setupMapInteractions() {}

        toggleMap() {
            const modal = document.getElementById('map-modal');
            if (this.mapOpen) {
                modal.classList.add('opacity-0');
                setTimeout(() => modal.classList.add('hidden'), 500);
            } else {
                modal.classList.remove('hidden');
                void modal.offsetWidth; 
                modal.classList.remove('opacity-0');
                
                this.renderMap();
                
                setTimeout(() => { if (this.map) this.map.resize(); }, 50);
                setTimeout(() => { if (this.map) this.map.resize(); }, 500); 
            }
            this.mapOpen = !this.mapOpen;
        }

        toggleMapMenu() {
            const menu = document.getElementById('map-side-menu');
            if (menu.classList.contains('hidden')) {
                menu.classList.remove('hidden');
                menu.classList.add('flex');
                document.getElementById('map-search-results').classList.add('hidden');
            } else {
                menu.classList.add('hidden');
                menu.classList.remove('flex');
            }
        }

        handleMapSearch(e) {
            const query = e.target.value.toLowerCase();
            const resultsContainer = document.getElementById('map-search-results');
            document.getElementById('map-side-menu').classList.add('hidden'); 
            
            if (!query) {
                resultsContainer.classList.add('hidden');
                resultsContainer.classList.remove('flex');
                return;
            }
            
            const matches = LOCATIONS.filter(loc => {
                const nameEn = (loc.name.en || '').toLowerCase();
                const nameMm = (loc.name.mm || '').toLowerCase();
                return nameEn.includes(query) || nameMm.includes(query);
            });
            
            if (matches.length > 0) {
                resultsContainer.innerHTML = '';
                matches.forEach(loc => {
                    const btn = document.createElement('button');
                    btn.className = "flex items-center gap-3 px-4 py-3 hover:bg-white/10 text-left w-full border-b border-white/5 transition-colors group";
                    const dispName = loc.name[this.state.lang] || loc.name.en;
                    btn.innerHTML = `
                        <div class="text-gray-400 group-hover:text-white transition-colors">
                            <i data-lucide="map-pin" class="w-4 h-4"></i>
                        </div>
                        <span class="text-sm font-medium text-gray-300 group-hover:text-white transition-colors">${dispName}</span>
                    `;
                    btn.onclick = () => {
                        if(this.map) this.map.flyTo({ center: [loc.lng, loc.lat], zoom: 16 });
                        resultsContainer.classList.add('hidden');
                        resultsContainer.classList.remove('flex');
                        document.getElementById('map-search-input').value = dispName;
                    };
                    resultsContainer.appendChild(btn);
                });
                resultsContainer.classList.remove('hidden');
                resultsContainer.classList.add('flex');
                lucide.createIcons();
            } else {
                resultsContainer.innerHTML = '<div class="p-4 text-xs text-gray-500 text-center font-medium">No coordinates found.</div>';
                resultsContainer.classList.remove('hidden');
                resultsContainer.classList.add('flex');
            }
        }

        toggleMapStyle() {
            if (!this.map) return;
            this.currentMapStyle = this.currentMapStyle === 'normal' ? 'satellite' : 'normal';
            this.map.setStyle(this.mapStyles[this.currentMapStyle]);
        }

        togglePhone() {
            const modal = document.getElementById('phone-modal');
            if (this.phoneOpen) {
                modal.classList.add('opacity-0');
                setTimeout(() => { modal.classList.add('hidden'); this.phoneHome(); }, 500);
            } else {
                modal.classList.remove('hidden');
                void modal.offsetWidth; 
                modal.classList.remove('opacity-0');
            }
            this.phoneOpen = !this.phoneOpen;
        }

        phoneHome() {
            const activeApp = document.getElementById('active-app-container');
            activeApp.classList.remove('app-screen-active');
            activeApp.classList.add('translate-x-full');
            this.phoneApp = null;
        }

        toggleMusic() {
            const audio = document.getElementById('music-player-audio');
            const icon = document.getElementById('music-play-icon');
            if (!audio) return;
            if (audio.paused) { audio.play(); icon.parentElement.innerHTML = '<i id="music-play-icon" data-lucide="pause" class="w-7 h-7 fill-black ml-1"></i>'; lucide.createIcons(); } 
            else { audio.pause(); icon.parentElement.innerHTML = '<i id="music-play-icon" data-lucide="play" class="w-7 h-7 fill-black ml-1"></i>'; lucide.createIcons(); }
        }

        updateMusicProgress() {
            const audio = document.getElementById('music-player-audio');
            const progress = document.getElementById('music-progress');
            const thumb = document.getElementById('music-thumb');
            const current = document.getElementById('music-current-time');
            if (audio && progress) {
                const percent = (audio.currentTime / audio.duration) * 100;
                progress.style.width = `${percent}%`;
                if(thumb) thumb.style.left = `${percent}%`;
                const mins = Math.floor(audio.currentTime / 60); const secs = Math.floor(audio.currentTime % 60);
                current.innerText = `${mins}:${secs < 10 ? '0' : ''}${secs}`;
            }
        }

        initMusicDuration() {
            const audio = document.getElementById('music-player-audio');
            const total = document.getElementById('music-duration');
            if (audio && total) {
                const mins = Math.floor(audio.duration / 60); const secs = Math.floor(audio.duration % 60);
                total.innerText = `${mins}:${secs < 10 ? '0' : ''}${secs}`;
            }
        }

        openApp(appName) {
            this.phoneApp = appName;
            const activeApp = document.getElementById('active-app-container');
            const contentArea = document.getElementById('app-content-area');
            const title = document.getElementById('app-title-text');
            const header = document.getElementById('app-header-bar');

            let html = '';
            
            if (appName === 'phone') {
                title.innerText = "Phone";
                header.className = "h-14 bg-black/80 backdrop-blur-md border-b border-white/10 flex items-center px-4 font-semibold text-white z-30 relative pt-4";
                html = `
                    <div class="h-full flex flex-col bg-black text-white font-inter">
                        <div class="flex-1 flex flex-col items-center justify-center p-6">
                             <div class="text-4xl text-white font-light mb-8"></div>
                             <div class="grid grid-cols-3 gap-6 text-2xl font-light text-white">
                                 <button class="w-16 h-16 rounded-full bg-[#222] hover:bg-[#333] flex items-center justify-center transition-colors">1</button>
                                 <button class="w-16 h-16 rounded-full bg-[#222] hover:bg-[#333] flex items-center justify-center transition-colors">2</button>
                                 <button class="w-16 h-16 rounded-full bg-[#222] hover:bg-[#333] flex items-center justify-center transition-colors">3</button>
                                 <button class="w-16 h-16 rounded-full bg-[#222] hover:bg-[#333] flex items-center justify-center transition-colors">4</button>
                                 <button class="w-16 h-16 rounded-full bg-[#222] hover:bg-[#333] flex items-center justify-center transition-colors">5</button>
                                 <button class="w-16 h-16 rounded-full bg-[#222] hover:bg-[#333] flex items-center justify-center transition-colors">6</button>
                                 <button class="w-16 h-16 rounded-full bg-[#222] hover:bg-[#333] flex items-center justify-center transition-colors">7</button>
                                 <button class="w-16 h-16 rounded-full bg-[#222] hover:bg-[#333] flex items-center justify-center transition-colors">8</button>
                                 <button class="w-16 h-16 rounded-full bg-[#222] hover:bg-[#333] flex items-center justify-center transition-colors">9</button>
                                 <button class="w-16 h-16 rounded-full bg-[#222] hover:bg-[#333] flex items-center justify-center text-3xl transition-colors">*</button>
                                 <button class="w-16 h-16 rounded-full bg-[#222] hover:bg-[#333] flex items-center justify-center transition-colors">0</button>
                                 <button class="w-16 h-16 rounded-full bg-[#222] hover:bg-[#333] flex items-center justify-center text-xl transition-colors">#</button>
                             </div>
                             <div class="mt-8">
                                 <button class="w-20 h-20 bg-green-500 rounded-full flex items-center justify-center shadow-lg text-white hover:bg-green-400 transition-colors"><i data-lucide="phone" class="w-8 h-8 fill-current"></i></button>
                             </div>
                        </div>
                    </div>
                `;
            } else if (appName === 'messages') {
                title.innerText = "Messages";
                header.className = "h-14 bg-black/80 backdrop-blur-md border-b border-white/10 flex items-center px-4 font-semibold text-white z-30 relative pt-4";
                html = `
                    <div class="p-4 space-y-4 text-white font-inter min-h-full bg-black">
                        <div class="flex gap-4 items-center border-b border-[#222] pb-4">
                            <div class="w-12 h-12 bg-zinc-800 rounded-full flex items-center justify-center text-gray-300 font-medium">M</div>
                            <div class="flex-1">
                                <div class="flex justify-between items-baseline"><span class="font-medium text-gray-200 text-sm">Mom</span> <span class="text-[10px] text-gray-500">14m</span></div>
                                <div class="text-sm text-gray-400 truncate mt-1">Please come home early today...</div>
                            </div>
                        </div>
                        <div class="flex gap-4 items-center border-b border-[#222] pb-4">
                            <div class="w-12 h-12 bg-zinc-800 rounded-full flex items-center justify-center text-gray-300 font-medium">N</div>
                            <div class="flex-1">
                                <div class="flex justify-between items-baseline"><span class="font-medium text-gray-200 text-sm">Nay Chi</span> <span class="text-[10px] text-gray-500">Yesterday</span></div>
                                <div class="text-sm text-gray-400 truncate mt-1">Are you free this weekend?</div>
                            </div>
                        </div>
                    </div>
                `;
            } else if (appName === 'photos') {
                title.innerText = "Photos";
                header.className = "h-14 bg-black/80 backdrop-blur-md border-b border-white/10 flex items-center px-4 font-semibold text-white z-30 relative pt-4";
                html = `
                    <div class="p-0.5 grid grid-cols-3 gap-0.5 min-h-full bg-black">
                        <div class="aspect-square bg-zinc-900 bg-[url('https://images.unsplash.com/photo-1572508589584-94d778209071?q=80&w=200&auto=format&fit=crop')] bg-cover"></div>
                        <div class="aspect-square bg-zinc-900 bg-[url('https://images.unsplash.com/photo-1627993436034-71f496738923?q=80&w=200&auto=format&fit=crop')] bg-cover"></div>
                        <div class="aspect-square bg-zinc-900 bg-[url('https://images.unsplash.com/photo-1605218427368-35b0185e33d0?q=80&w=200&auto=format&fit=crop')] bg-cover"></div>
                        <div class="aspect-square bg-zinc-900 bg-[url('https://images.unsplash.com/photo-1550684848-fac1c5b4e853?q=80&w=200&auto=format&fit=crop')] bg-cover"></div>
                    </div>
                `;
            } else if (appName === 'facebook') {
                title.innerText = "Facebook";
                header.className = "h-14 bg-[#1877f2] border-b border-white/10 flex items-center px-4 font-semibold text-white z-30 relative pt-4 transition-colors";
                html = `
                    <div class="bg-black min-h-full font-inter text-white">
                        <div class="bg-[#111] p-4 mb-2">
                             <div class="flex gap-3">
                                 <div class="w-10 h-10 bg-gray-700 rounded-full"></div>
                                 <div class="flex-1 bg-[#222] rounded-full px-4 flex items-center text-sm text-gray-400">What's on your mind?</div>
                             </div>
                        </div>
                        <!-- Post 1 -->
                        <div class="bg-[#111] p-4 mb-2 shadow-sm border-y border-white/5">
                            <div class="flex gap-3 items-center mb-3">
                                <div class="w-10 h-10 bg-red-900/30 rounded-full flex items-center justify-center"><i data-lucide="newspaper" class="w-5 h-5 text-red-500"></i></div>
                                <div>
                                    <div class="text-sm font-semibold">Yangon News</div>
                                    <div class="text-xs text-gray-500">2 hrs ago</div>
                                </div>
                            </div>
                            <div class="text-sm mb-3 text-gray-300">Heavy rain expected in downtown Yangon this evening. Please drive safely.</div>
                            <div class="w-full h-40 bg-gray-800 rounded-lg mb-3 bg-[url('https://images.unsplash.com/photo-1515347619252-60a6bf4fffce?q=80&w=600&auto=format&fit=crop')] bg-cover bg-center"></div>
                            <div class="border-t border-white/10 pt-3 flex justify-between text-gray-400 text-sm font-medium">
                                <span class="flex items-center gap-1.5"><i data-lucide="thumbs-up" class="w-4 h-4"></i> Like</span>
                                <span class="flex items-center gap-1.5"><i data-lucide="message-circle" class="w-4 h-4"></i> Comment</span>
                                <span class="flex items-center gap-1.5"><i data-lucide="share" class="w-4 h-4"></i> Share</span>
                            </div>
                        </div>
                         <!-- Post 2 -->
                        <div class="bg-[#111] p-4 mb-2 shadow-sm border-y border-white/5">
                            <div class="flex gap-3 items-center mb-3">
                                <div class="w-10 h-10 bg-purple-900/30 rounded-full flex items-center justify-center text-purple-400 font-bold">N</div>
                                <div>
                                    <div class="text-sm font-semibold">Nay Chi updated her profile picture.</div>
                                    <div class="text-xs text-gray-500">5 hrs ago</div>
                                </div>
                            </div>
                            <div class="w-full h-48 bg-gray-800 rounded-lg mb-3 bg-[url('https://images.unsplash.com/photo-1534528741775-53994a69daeb?q=80&w=600&auto=format&fit=crop')] bg-cover bg-center"></div>
                             <div class="border-t border-white/10 pt-3 flex justify-between text-gray-400 text-sm font-medium">
                                <span class="flex items-center gap-1.5"><i data-lucide="thumbs-up" class="w-4 h-4"></i> 142</span>
                                <span class="flex items-center gap-1.5"><i data-lucide="message-circle" class="w-4 h-4"></i> 12</span>
                            </div>
                        </div>
                    </div>
                `;
            } else if (appName === 'youtube') {
                title.innerText = "YouTube";
                header.className = "h-14 bg-[#111] border-b border-white/10 flex items-center px-4 font-semibold text-white z-30 relative pt-4 transition-colors";
                html = `
                    <div class="bg-black text-white min-h-full font-inter">
                        <div class="p-3 border-b border-white/10 pb-4">
                             <div class="w-full h-44 bg-gray-800 rounded-xl mb-3 bg-[url('https://images.unsplash.com/photo-1492684223066-81342ee5ff30?q=80&w=600&auto=format&fit=crop')] bg-cover bg-center relative overflow-hidden">
                                 <div class="absolute bottom-2 right-2 bg-black/80 text-[10px] px-1.5 py-0.5 rounded-md font-medium">10:24</div>
                             </div>
                             <div class="flex gap-3">
                                 <div class="w-9 h-9 rounded-full bg-blue-500 shrink-0"></div>
                                 <div class="flex-1">
                                     <div class="text-sm font-semibold leading-tight mb-1 line-clamp-2">Walking in Yangon 4K - Downtown Rain</div>
                                     <div class="text-xs text-gray-400">Myanmar Walks • 24K views • 1 day ago</div>
                                 </div>
                             </div>
                        </div>
                        <div class="p-3 border-b border-white/10 pb-4">
                             <div class="w-full h-44 bg-gray-800 rounded-xl mb-3 bg-[url('https://images.unsplash.com/photo-1511671782779-c97d3d27a1d4?q=80&w=600&auto=format&fit=crop')] bg-cover bg-center relative overflow-hidden">
                                  <div class="absolute bottom-2 right-2 bg-black/80 text-[10px] px-1.5 py-0.5 rounded-md font-medium">3:45</div>
                             </div>
                             <div class="flex gap-3">
                                 <div class="w-9 h-9 rounded-full bg-red-500 shrink-0"></div>
                                 <div class="flex-1">
                                     <div class="text-sm font-semibold leading-tight mb-1 line-clamp-2">Lofi Myanmar Beats to Study To</div>
                                     <div class="text-xs text-gray-400">Lofi Girl • 1.2M views • 1 month ago</div>
                                 </div>
                             </div>
                        </div>
                    </div>
                `;
            } else if (appName === 'music') {
                title.innerText = "Spotify"; 
                header.style.display = 'none';
                html = `
                    <div class="h-full flex flex-col bg-gradient-to-b from-[#1a1a1a] to-black text-white relative font-inter">
                         <div class="flex justify-between items-center p-4 pt-10 z-10">
                            <button onclick="game.phoneHome()" class="text-white hover:bg-white/10 p-2 rounded-full transition-colors"><i data-lucide="chevron-down" class="w-6 h-6"></i></button>
                            <span class="text-xs font-bold tracking-[0.2em] uppercase text-gray-300">Now Playing</span>
                            <button class="text-white p-2"><i data-lucide="more-horizontal" class="w-6 h-6"></i></button>
                         </div>
                         <div class="flex-1 flex items-center justify-center p-8 z-10">
                            <div class="w-full aspect-square bg-gray-800 shadow-2xl rounded-xl overflow-hidden relative border border-white/5">
                                <img src="../images/items/song.png" onerror="this.src='https://images.unsplash.com/photo-1614613535308-eb5fbd3d2c17?q=80&w=600&auto=format&fit=crop'" class="w-full h-full object-cover">
                            </div>
                         </div>
                         <div class="px-8 pb-10 z-10 bg-gradient-to-t from-black via-black/80 to-transparent">
                             <div class="flex justify-between items-end mb-6">
                                 <div>
                                     <div class="text-2xl font-bold mb-1 tracking-tight">Tejano Blue</div>
                                     <div class="text-gray-400 text-sm font-medium">Cigarettes After Sex</div>
                                 </div>
                                 <button class="text-[#1DB954] hover:scale-110 transition-transform"><i data-lucide="heart" class="w-6 h-6 fill-current"></i></button>
                             </div>
                             <div class="mb-3">
                                 <div class="w-full h-1.5 bg-gray-800 rounded-full relative cursor-pointer group">
                                     <div id="music-progress" class="absolute left-0 top-0 h-full bg-white rounded-full w-0 transition-all duration-300"></div>
                                     <div class="absolute -top-1.5 -ml-1.5 w-3 h-3 bg-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity shadow-lg" style="left: 0%" id="music-thumb"></div>
                                 </div>
                             </div>
                             <div class="flex justify-between text-xs text-gray-400 font-medium mb-8">
                                 <span id="music-current-time">0:00</span>
                                 <span id="music-duration">0:00</span>
                             </div>
                             <div class="flex justify-between items-center px-2">
                                 <button class="text-gray-400 hover:text-white transition-colors"><i data-lucide="shuffle" class="w-5 h-5"></i></button>
                                 <button class="text-white hover:scale-110 transition-transform"><i data-lucide="skip-back" class="w-8 h-8 fill-current"></i></button>
                                 <button onclick="game.toggleMusic()" class="w-16 h-16 bg-[#1DB954] rounded-full flex items-center justify-center text-black hover:scale-105 transition-transform shadow-[0_8px_20px_rgba(29,185,84,0.3)]">
                                     <i id="music-play-icon" data-lucide="play" class="w-7 h-7 fill-black ml-1"></i>
                                 </button>
                                 <button class="text-white hover:scale-110 transition-transform"><i data-lucide="skip-forward" class="w-8 h-8 fill-current"></i></button>
                                 <button class="text-gray-400 hover:text-white transition-colors"><i data-lucide="repeat" class="w-5 h-5"></i></button>
                             </div>
                         </div>
                         <audio id="music-player-audio" src="../audios/tejano-blue.mp3" ontimeupdate="game.updateMusicProgress()" onloadedmetadata="game.initMusicDuration()"></audio>
                    </div>
                `;
            } else if (appName === 'kbzpay') {
                title.innerText = "KBZPay";
                header.className = "h-14 bg-[#1a4a8d] border-b border-white/10 flex items-center px-4 font-semibold text-white z-30 relative pt-4 transition-colors";
                html = `
                    <div class="flex-1 bg-[#f8f9fa] flex flex-col items-center pt-6 relative min-h-full font-inter">
                        <div class="w-11/12 bg-gradient-to-br from-[#1a4a8d] to-[#0d2a52] rounded-2xl p-6 shadow-[0_15px_30px_rgba(26,74,141,0.2)] mb-6 text-white relative overflow-hidden">
                            <div class="absolute -right-10 -top-10 w-40 h-40 bg-white/5 rounded-full blur-2xl"></div>
                            <div class="absolute -left-10 -bottom-10 w-32 h-32 bg-white/5 rounded-full blur-xl"></div>
                            
                            <div class="flex justify-between items-center mb-1 relative z-10">
                                <span class="text-[10px] text-blue-200 uppercase tracking-widest font-semibold">Total Balance</span>
                                <i data-lucide="shield-check" class="w-4 h-4 text-blue-300"></i>
                            </div>
                            
                            <div class="flex items-baseline gap-1.5 mt-1 relative z-10">
                                <span class="text-4xl font-bold tracking-tight" id="kbz-balance">${this.state.currency.toLocaleString()}</span>
                                <span class="text-sm font-medium text-blue-200">MMK</span>
                            </div>
                            
                            <div class="flex justify-between mt-8 relative z-10">
                                <div class="flex flex-col items-center gap-2 cursor-pointer group">
                                    <div class="w-10 h-10 bg-white/10 rounded-full flex items-center justify-center group-hover:bg-white/20 transition-colors backdrop-blur-md"><i data-lucide="arrow-up" class="w-4 h-4"></i></div>
                                    <span class="text-[10px] font-medium tracking-wide text-blue-100">Transfer</span>
                                </div>
                                <div class="flex flex-col items-center gap-2 cursor-pointer group">
                                    <div class="w-10 h-10 bg-white/10 rounded-full flex items-center justify-center group-hover:bg-white/20 transition-colors backdrop-blur-md"><i data-lucide="arrow-down" class="w-4 h-4"></i></div>
                                    <span class="text-[10px] font-medium tracking-wide text-blue-100">Cash In</span>
                                </div>
                                <div class="flex flex-col items-center gap-2 cursor-pointer group">
                                    <div class="w-10 h-10 bg-white/10 rounded-full flex items-center justify-center group-hover:bg-white/20 transition-colors backdrop-blur-md"><i data-lucide="qr-code" class="w-4 h-4"></i></div>
                                    <span class="text-[10px] font-medium tracking-wide text-blue-100">Scan</span>
                                </div>
                                <div class="flex flex-col items-center gap-2 cursor-pointer group">
                                    <div class="w-10 h-10 bg-white/10 rounded-full flex items-center justify-center group-hover:bg-white/20 transition-colors backdrop-blur-md"><i data-lucide="clock" class="w-4 h-4"></i></div>
                                    <span class="text-[10px] font-medium tracking-wide text-blue-100">History</span>
                                </div>
                            </div>
                        </div>
                        <div class="w-11/12">
                            <div class="text-[11px] text-gray-500 mb-3 uppercase font-bold tracking-wider px-1">Recent Activity</div>
                            <div class="space-y-3 pb-8" id="kbz-history"></div>
                        </div>
                    </div>
                `;
            }

            contentArea.innerHTML = html;
            activeApp.classList.remove('translate-x-full');
            activeApp.classList.add('app-screen-active');
            
            if (appName === 'kbzpay') {
                this.renderKBZHistory();
            }
            
            if (appName !== 'music') {
                header.style.display = 'flex';
            }
            
            lucide.createIcons();
        }

        renderKBZHistory() {
            const historyContainer = document.getElementById('kbz-history');
            if (!historyContainer) return;
            
            if (!this.state.history || this.state.history.length === 0) {
                 historyContainer.innerHTML = '<div class="text-center text-xs text-gray-400 py-8 bg-white rounded-xl shadow-sm border border-gray-100">No transactions yet</div>';
                 return;
            }

            historyContainer.innerHTML = '';
            this.state.history.forEach(item => {
                const div = document.createElement('div');
                div.className = "bg-white p-4 rounded-xl flex justify-between items-center shadow-sm border border-gray-100 transition-all hover:shadow-md";
                div.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full ${item.amount > 0 ? 'bg-green-50' : 'bg-red-50'} flex items-center justify-center">
                            <i data-lucide="${item.amount > 0 ? 'arrow-down-left' : 'arrow-up-right'}" class="w-5 h-5 ${item.amount > 0 ? 'text-green-600' : 'text-red-600'}"></i>
                        </div>
                        <div>
                            <div class="text-sm text-gray-900 font-bold">${item.amount > 0 ? 'Received' : 'Payment'}</div>
                            <div class="text-[11px] text-gray-500 font-medium">${item.date}</div>
                        </div>
                    </div>
                    <span class="text-sm font-mono font-bold ${item.amount > 0 ? 'text-green-600' : 'text-red-600'}">${item.amount > 0 ? '+' : ''}${item.amount.toLocaleString()} MMK</span>
                `;
                historyContainer.appendChild(div);
            });
            lucide.createIcons();
        }

        updateCurrency(amount, transactionId = null) {
            if (amount === 0 && this.state.currency === 0) return;

            if (transactionId) {
                if (this.state.flags[`tx_${transactionId}`]) return;
                this.state.flags[`tx_${transactionId}`] = true;
            }

            this.state.currency += amount;

            if (amount !== 0) {
                const notif = document.getElementById('currency-notification');
                const text = document.getElementById('currency-text');
                const sign = amount > 0 ? '+' : '';
                
                text.innerText = `${sign}${amount.toLocaleString()} MMK`;
                text.className = `text-sm font-mono leading-tight mt-0.5 ${amount > 0 ? 'text-white' : 'text-gray-400'}`;
                
                notif.classList.add('notification-show');
                setTimeout(() => { notif.classList.remove('notification-show'); }, 3000);

                if (!this.state.history) this.state.history = [];
                this.state.history.unshift({ amount: amount, date: 'Today' });
                if (this.state.history.length > 5) this.state.history.pop();

                if (this.phoneApp === 'kbzpay') {
                    this.renderKBZHistory();
                }
            }
        }

        zoomMap(delta) { 
            if (this.map) {
                const currentZoom = this.map.getZoom();
                this.map.zoomTo(Math.max(10, Math.min(18, currentZoom + (delta > 0 ? 1 : -1))));
            }
        }

        resetZoom() { 
            if (this.map) { this.map.flyTo({ center: [96.146480,16.830225], zoom: 12.2 }); }
        }

        async renderMap() {
            if(!this.map) {
                this.map = new maplibregl.Map({
                    container: 'map-container',
                    style: this.mapStyles[this.currentMapStyle], 
                    center: [96.1496, 16.7984],
                    zoom: 13,
                    attributionControl: false
                });
            }

            if (this.markers) { this.markers.forEach(m => m.remove()); }
            this.markers = [];

            const currentLoc = LOCATIONS.find(l => l.scene === this.state.sceneId);

            LOCATIONS.forEach(loc => {
                if (!loc.lat || !loc.lng) return;
                
                const isUnlocked = this.state.flags[`${loc.id}_unlocked`];
                const isCurrent = currentLoc && currentLoc.id === loc.id;
                
                const pin = document.createElement('div');
                pin.className = `map-pin-wrapper map-pin ${isUnlocked ? 'map-pin-unlocked' : 'map-pin-locked'}`;

                const playerHtml = isCurrent ? `
                    <div class="map-player-indicator">
                        <div class="w-3 h-3 bg-white rounded-full shadow-[0_0_10px_white]"></div>
                    </div>
                ` : '';

                if (isUnlocked) {
                    pin.onclick = (e) => { e.stopPropagation(); this.travelTo(loc); };
                    pin.innerHTML = `
                        ${playerHtml}
                        <div class="map-pin-icon-wrapper">
                            <img src="${ASSETS.icons[loc.type] || '../images/places/city.gif'}" class="map-pin-img" alt="${loc.type}">
                            <div class="map-pin-label">
                                ${loc.name[this.state.lang] || loc.name.en}
                            </div>
                        </div>
                    `;
                } else {
                    pin.innerHTML = `
                        <div class="map-pin-locked-wrap">
                            <img src="${ASSETS.icons[loc.type] || '../images/places/city.gif'}" class="map-pin-locked-img" alt="${loc.type}">
                            <div class="map-pin-locked-label">
                                ${loc.name[this.state.lang] || loc.name.en}
                            </div>
                        </div>
                    `;
                }

                const marker = new maplibregl.Marker({ element: pin, anchor: 'center' })
                    .setLngLat([loc.lng, loc.lat])
                    .addTo(this.map);
                
                this.markers.push(marker);
            });
            
            lucide.createIcons();
        }

        travelTo(loc) {
            this.toggleMap();
            if (SCENES[loc.scene]) { this.loadScene(loc.scene); } else { alert(`Coordinate unavailable.`); }
        }

        showUnlockNotification(locId) {
            const loc = LOCATIONS.find(l => l.id === locId);
            if (!loc) return;
            const notif = document.getElementById('unlock-notification');
            const text = document.getElementById('unlock-text');
            text.innerText = loc.name[this.state.lang] || loc.name.en;
            notif.classList.add('notification-show');
            setTimeout(() => { notif.classList.remove('notification-show'); }, 4000);
        }

        toggleFullscreen() {
            if (!document.fullscreenElement) { document.documentElement.requestFullscreen().catch(err => { console.log(`Error: ${err.message}`); }); } 
            else { if (document.exitFullscreen) { document.exitFullscreen(); } }
        }
        
        toggleImmersive() {
            this.immersiveMode = !this.immersiveMode;
            const ui = document.getElementById('ui-layer');
            const cam = document.getElementById('camera-rig');
            
            if (this.immersiveMode) {
                if (document.documentElement.requestFullscreen) { document.documentElement.requestFullscreen().catch(err => console.log(err)); }
                ui.classList.add('hidden');
                cam.classList.add('static-cam');
                const exitHandler = (e) => { e.stopPropagation(); this.toggleImmersive(); document.removeEventListener('click', exitHandler, true); };
                setTimeout(() => { document.addEventListener('click', exitHandler, true); }, 50);
            } else {
                if (document.exitFullscreen && document.fullscreenElement) { document.exitFullscreen().catch(err => console.log(err)); }
                ui.classList.remove('hidden');
                cam.classList.remove('static-cam');
            }
        }

        takeScreenshot() {
            const ui = document.getElementById('ui-layer');
            const cam = document.getElementById('camera-rig');
            const container = document.getElementById('game-container');
            ui.classList.add('hidden');
            cam.classList.add('static-cam');
            setTimeout(() => {
                html2canvas(container, { scale: 2, useCORS: true, backgroundColor: null }).then(canvas => {
                    const link = document.createElement('a'); link.download = `archive_${Date.now()}.png`; link.href = canvas.toDataURL(); link.click();
                    ui.classList.remove('hidden');
                    if (!this.immersiveMode) { cam.classList.remove('static-cam'); }
                }).catch(err => {
                    console.error("Capture failed:", err);
                    ui.classList.remove('hidden');
                    if (!this.immersiveMode) cam.classList.remove('static-cam');
                });
            }, 100);
        }

        saveGameManual() {
            localStorage.setItem('ringGameSave_V5', JSON.stringify(this.state));
            const btn = document.querySelector('button[onclick="game.saveGameManual()"]');
            if (btn) {
                const originalHTML = btn.innerHTML;
                btn.innerHTML = '<i data-lucide="check" class="text-white w-4 h-4"></i>';
                lucide.createIcons();
                setTimeout(() => { btn.innerHTML = originalHTML; lucide.createIcons(); }, 1000);
            }
        }

        loadGame() {
            const save = localStorage.getItem('ringGameSave_V5');
            if (save) {
                this.state = JSON.parse(save);
                if (this.state.currency === undefined) this.state.currency = 0;
                if (!this.state.settings) this.state.settings = { volume: 1.0, themeVolume: 0.4, gameAudio: 'on', fontSize: 'medium', graphics: 'high', theme: 'dark' };
                this.applySettings();
                document.getElementById('start-screen').classList.add('hidden');
                document.getElementById('ui-layer').classList.remove('hidden');
                document.getElementById('ui-layer').classList.add('flex');
                this.loadScene(this.state.sceneId);
                this.updateCurrency(0); 
            }
        }

        toggleLang() { this.setLanguage(this.state.lang === 'mm' ? 'en' : 'mm'); }
        
        toggleAuto() {
            this.autoPlay = !this.autoPlay;
            const btn = document.getElementById('auto-btn');
            if (this.autoPlay) {
                btn.classList.add('active-mode');
                if (!this.isTyping && !this.isLastStep()) { this.next(); }
            } else {
                btn.classList.remove('active-mode');
                if (this.autoPlayTimer) clearTimeout(this.autoPlayTimer);
            }
            lucide.createIcons();
        }

        toggleMuteShortcut() {
            this.audio.toggle();
            this.showAudioNotification();
        }

        showAudioNotification() {
            const notif = document.getElementById('audio-notification');
            const text = document.getElementById('audio-toast-text');
            const icon = document.getElementById('audio-toast-icon');
            
            if (this.audio.active) {
                text.innerText = "Unmuted";
                text.className = "text-sm font-mono text-white leading-tight mt-0.5";
                icon.setAttribute('data-lucide', 'volume-2');
                icon.className = "w-4 h-4 text-white";
            } else {
                text.innerText = "Muted";
                text.className = "text-sm font-mono text-gray-400 leading-tight mt-0.5";
                icon.setAttribute('data-lucide', 'volume-x');
                icon.className = "w-4 h-4 text-gray-400";
            }
            lucide.createIcons();
            
            notif.classList.add('notification-show');
            if (this.audioNotifTimer) clearTimeout(this.audioNotifTimer);
            this.audioNotifTimer = setTimeout(() => { notif.classList.remove('notification-show'); }, 3000);
        }

        openSettings() {
            const modal = document.getElementById('settings-modal');
            this.renderSettingsText();
            this.syncSettingsUI();
            modal.classList.remove('hidden');
            void modal.offsetWidth; 
            modal.classList.remove('opacity-0');
            this.settingsOpen = true;
            lucide.createIcons();
        }

        closeSettings() {
            const modal = document.getElementById('settings-modal');
            modal.classList.add('opacity-0');
            setTimeout(() => { modal.classList.add('hidden'); }, 500);
            this.settingsOpen = false;
            this.saveGameManual(); 
        }

        applySettings() {
            this.setVolume(this.state.settings.volume, false);
            this.setThemeVolume(this.state.settings.themeVolume !== undefined ? this.state.settings.themeVolume : 0.4, false);
            this.setGameAudio(this.state.settings.gameAudio || 'on', false);
            this.setFontSize(this.state.settings.fontSize, false);
            this.setGraphics(this.state.settings.graphics, false);
            this.setTheme(this.state.settings.theme, false);
            this.syncSettingsUI();
        }

        syncSettingsUI() {
            document.getElementById('ga-vol-slider').value = this.state.settings.volume;
            document.getElementById('tm-vol-slider').value = this.state.settings.themeVolume !== undefined ? this.state.settings.themeVolume : 0.4;
            this.updateBtnGroup('ga', this.state.settings.gameAudio || 'on');
            this.updateBtnGroup('font', this.state.settings.fontSize);
            this.updateBtnGroup('gfx', this.state.settings.graphics);
            this.updateBtnGroup('lang', this.state.lang);
            this.updateBtnGroup('theme', this.state.settings.theme);
        }

        updateBtnGroup(group, val) {
            const btns = document.querySelectorAll(`.st-btn-${group}`);
            btns.forEach(btn => {
                if (btn.dataset.val === val) { btn.classList.add('st-btn-active'); } 
                else { btn.classList.remove('st-btn-active'); }
            });
        }

        renderSettingsText() {
            const lang = this.state.lang;
            document.getElementById('lang-btn').innerText = lang === 'mm' ? "မြန်မာ" : "EN";
            const updateText = (id, key) => { const el = document.getElementById(id); if (el && SETTINGS_DICT[key]) el.innerText = SETTINGS_DICT[key][lang]; };
            updateText('st-menu-new', 'menu_new'); updateText('st-menu-load', 'menu_load'); updateText('st-menu-gallery', 'menu_gallery');
            updateText('st-menu-set', 'menu_set'); updateText('st-menu-quit', 'menu_quit'); updateText('st-menu-credits', 'menu_credits');
            updateText('st-menu-terms', 'menu_terms'); updateText('hud-st-tip', 'menu_set'); updateText('hud-quit-tip', 'hud_quit');
            updateText('st-title', 'title'); updateText('st-ga-vol', 'ga_vol');
            updateText('st-tm-vol', 'tm_vol'); updateText('st-ga-state', 'ga_state');
            updateText('st-ga-on', 'ga_on'); updateText('st-ga-off', 'ga_off');
            updateText('st-font', 'font_size'); updateText('st-font-sm', 'font_sm');
            updateText('st-font-md', 'font_md'); updateText('st-font-lg', 'font_lg'); updateText('st-gfx', 'graphics');
            updateText('st-gfx-low', 'gfx_low'); updateText('st-gfx-med', 'gfx_med');
            updateText('st-gfx-high', 'gfx_high'); updateText('st-lang', 'language');
            updateText('st-theme', 'theme'); updateText('st-theme-dark', 'theme_dark');
            updateText('st-theme-light', 'theme_light');
        }

        setVolume(val, sync = true) { this.state.settings.volume = parseFloat(val); this.audio.setVolume(this.state.settings.volume); if(sync) this.syncSettingsUI(); }
        setThemeVolume(val, sync = true) { this.state.settings.themeVolume = parseFloat(val); this.audio.setThemeVolume(this.state.settings.themeVolume); if(sync) this.syncSettingsUI(); }
        setGameAudio(state, sync = true) { this.state.settings.gameAudio = state; this.audio.setGameAudio(state); if(sync) this.syncSettingsUI(); }
        setFontSize(size, sync = true) {
            this.state.settings.fontSize = size;
            document.body.classList.remove('font-sm', 'font-lg');
            if (size === 'small') document.body.classList.add('font-sm');
            if (size === 'large') document.body.classList.add('font-lg');
            if(sync) this.syncSettingsUI();
        }
        setGraphics(level, sync = true) {
            this.state.settings.graphics = level;
            document.body.classList.remove('gfx-low', 'gfx-med', 'gfx-high');
            if (level === 'low') document.body.classList.add('gfx-low');
            if (level === 'medium') document.body.classList.add('gfx-med');
            if (level === 'high') document.body.classList.add('gfx-high');
            if(sync) this.syncSettingsUI();
        }
        setTheme(mode, sync = true) {
            this.state.settings.theme = mode;
            document.body.classList.remove('theme-light');
            if (mode === 'light') { document.body.classList.add('theme-light'); }
            if(sync) this.syncSettingsUI();
        }
        setLanguage(lang) { this.state.lang = lang; this.renderSettingsText(); this.syncSettingsUI(); if (!this.isTyping && this.sceneData) this.renderStep(true); }

        changeBackground(bgKey, darken) {
            const url = ASSETS.bg[bgKey];
            if (!url) return;
            if (this.currentBgKey === bgKey) return;
            if (!this.activeLayer) this.activeLayer = 1;
            const nextLayerIdx = this.activeLayer === 1 ? 2 : 1;
            const currentEl = document.getElementById(`bg-layer-${this.activeLayer}`);
            const nextEl = document.getElementById(`bg-layer-${nextLayerIdx}`);
            const targetOpacity = darken ? '0.2' : '0.5';
            nextEl.style.backgroundImage = `url('${url}')`;
            nextEl.style.opacity = targetOpacity;
            currentEl.style.opacity = '0';
            this.activeLayer = nextLayerIdx;
            this.currentBgKey = bgKey; 
        }

        handleAudio(audioData) {
            if (!audioData) return;
            const id = typeof audioData === 'string' ? audioData : audioData.id;
            const loop = typeof audioData === 'string' ? true : (audioData.loop !== undefined ? audioData.loop : true);
            this.audio.play(id, loop);
        }

        async loadScene(id) {
            if (this.isTransitioning) return;
            this.isTransitioning = true;
            
            const overlay = document.getElementById('scene-transition-overlay');
            if (overlay && this.state.sceneId !== 'start') {
                overlay.classList.remove('opacity-0');
                await new Promise(r => setTimeout(r, 700)); // wait for fade to black
            }

            this.state.sceneId = id;
            this.sceneData = SCENES[id];
            this.dialogueIndex = 0;

            this.changeBackground(this.sceneData.bg, this.sceneData.darken);
            this.handleAudio(this.sceneData.audio);

            const baseClasses = "text-gray-100 h-screen w-screen relative select-none bg-black transition-colors duration-1000 font-inter";
            const settingsClasses = [];
            if(this.state.settings.fontSize === 'small') settingsClasses.push('font-sm');
            if(this.state.settings.fontSize === 'large') settingsClasses.push('font-lg');
            if(this.state.settings.graphics === 'low') settingsClasses.push('gfx-low');
            if(this.state.settings.graphics === 'medium') settingsClasses.push('gfx-med');
            if(this.state.settings.graphics === 'high') settingsClasses.push('gfx-high');
            if(this.state.settings.theme === 'light') settingsClasses.push('theme-light');
            
            document.body.className = `${baseClasses} ${settingsClasses.join(' ')}`;
            if (this.sceneData.world) document.body.classList.add(`world-${this.sceneData.world}`);
            if (this.sceneData.location) {
                document.getElementById('location-text').innerText = this.sceneData.location.en; 
                document.getElementById('time-text').innerText = `DAY ${this.state.day} - ${this.sceneData.time || 'UNKNOWN'}`;
            }

            this.renderStep();
            this.saveGameManual();

            if (overlay) {
                setTimeout(() => {
                    overlay.classList.add('opacity-0');
                    this.isTransitioning = false;
                }, 150);
            } else {
                this.isTransitioning = false;
            }
        }

        renderStep(instant = false) {
            if (this.typingTimer) clearTimeout(this.typingTimer);
            if (this.autoPlayTimer) clearTimeout(this.autoPlayTimer);

            const step = this.sceneData.steps[this.dialogueIndex];
            if (!step) return;

            if (step.unlock) {
                const locationsToUnlock = Array.isArray(step.unlock) ? step.unlock : [step.unlock];
                locationsToUnlock.forEach(locId => {
                    if (!this.state.flags[`${locId}_unlocked`]) {
                        this.state.flags[`${locId}_unlocked`] = true;
                        this.showUnlockNotification(locId);
                    }
                });
            }

            if (step.currency) {
                const txId = `currency_${this.state.sceneId}_step_${this.dialogueIndex}`;
                this.updateCurrency(step.currency, txId);
            }
            
            if (step.bg) { this.changeBackground(step.bg, this.sceneData.darken); }
            if (step.audio) { this.handleAudio(step.audio); }

            const speakerBox = document.getElementById('speaker-box');
            const speakerName = document.getElementById('speaker-name');
            const spk = step.speaker ? (step.speaker[this.state.lang] || step.speaker.en) : null;
            
            if (spk) {
                speakerBox.classList.remove('hidden');
                speakerName.innerText = spk;
                const spkColorClass = step.speaker.color || 'text-white border-white/20';
                speakerBox.className = `bg-black/60 backdrop-blur-xl px-5 py-1.5 text-[10px] md:text-xs font-semibold tracking-widest uppercase rounded-full shadow-lg border transition-colors ${spkColorClass}`;
            } else {
                speakerBox.classList.add('hidden');
            }

            const textBox = document.getElementById('dialogue-text');
            const text = step.text[this.state.lang] || step.text.en;
            const choicesDiv = document.getElementById('choices-container');
            const nextInd = document.getElementById('next-indicator');

            choicesDiv.innerHTML = '';
            nextInd.style.opacity = '0';

            if (instant) {
                textBox.innerText = text;
                this.isTyping = false;
                textBox.classList.remove('cursor');
                if (this.isLastStep()) {
                    this.renderChoices();
                    if(this.autoPlayTimer) clearTimeout(this.autoPlayTimer); 
                } else {
                    nextInd.style.opacity = '1';
                    if (this.autoPlay) {
                        const delay = 1500 + (text.length * 50);
                        this.autoPlayTimer = setTimeout(() => this.next(), delay);
                    }
                }
                return;
            }

            textBox.innerText = '';
            textBox.classList.add('cursor');
            this.isTyping = true;
            let i = 0;

            const tick = () => {
                if (!this.isTyping) return; 
                if (i < text.length) {
                    textBox.innerText += text.charAt(i);
                    i++;
                    this.typingTimer = setTimeout(tick, this.typingSpeed);
                } else {
                    this.isTyping = false;
                    textBox.classList.remove('cursor');
                    if (this.isLastStep()) {
                        this.renderChoices();
                        if(this.autoPlayTimer) clearTimeout(this.autoPlayTimer); 
                    } else {
                        nextInd.style.opacity = '1';
                        if (this.autoPlay) {
                            const delay = 1500 + (text.length * 50);
                            this.autoPlayTimer = setTimeout(() => this.next(), delay);
                        }
                    }
                }
            };
            tick();
        }

        isLastStep() { return this.dialogueIndex === this.sceneData.steps.length - 1 && this.sceneData.choices; }

        renderChoices() {
            const container = document.getElementById('choices-container');
            container.innerHTML = '';

            this.sceneData.choices.forEach(c => {
                if (c.req && !c.req(this.state)) return; 
                const btn = document.createElement('button');
                btn.className = "choice-btn w-full max-w-4xl p-4 text-left mb-2 relative overflow-hidden group transition-all duration-300";
                const txt = c.text[this.state.lang] || c.text.en;
                btn.innerHTML = `
                    <div style="position:relative; z-index:10; display:flex; justify-content:space-between; align-items:center;">
                        <span style="font-weight:400; letter-spacing:0.02em;">${txt}</span>
                        ${c.type === 'danger' ? '<i data-lucide="alert-triangle" style="color:#ffffff; width:1rem; height:1rem;"></i>' : '<i data-lucide="arrow-right" style="width:1rem; height:1rem; opacity:0; transition:opacity 0.3s;" class="choice-arrow"></i>'}
                    </div>
                `;
                
                btn.addEventListener('mouseenter', () => { const icon = btn.querySelector('.choice-arrow'); if(icon) icon.style.opacity = '1'; });
                btn.addEventListener('mouseleave', () => { const icon = btn.querySelector('.choice-arrow'); if(icon) icon.style.opacity = '0'; });

                btn.onclick = (e) => { e.stopPropagation(); this.makeChoice(c); };
                container.appendChild(btn);
            });
            lucide.createIcons();
        }

        async next() {
            if (this.isTransitioning) return;
            if (this.isTyping) { this.renderStep(true); return; }
            if (document.getElementById('choices-container').children.length > 0) return;
            
            if (this.dialogueIndex < this.sceneData.steps.length - 1) { 
                // Step Transition Effect
                this.isTransitioning = true;
                const overlay = document.getElementById('step-transition-overlay');
                const dialogText = document.getElementById('dialogue-text');
                const speakerBox = document.getElementById('speaker-box');
                
                if (overlay) {
                    overlay.classList.remove('opacity-0');
                    overlay.classList.add('opacity-60');
                    if (dialogText) dialogText.style.opacity = '0';
                    if (speakerBox) speakerBox.style.opacity = '0';
                    await new Promise(r => setTimeout(r, 250));
                }

                this.dialogueIndex++; 
                this.renderStep(); 

                if (overlay) {
                    setTimeout(() => {
                        overlay.classList.remove('opacity-60');
                        overlay.classList.add('opacity-0');
                        if (dialogText) dialogText.style.opacity = '1';
                        if (speakerBox) speakerBox.style.opacity = '1';
                        this.isTransitioning = false;
                    }, 100);
                } else {
                    this.isTransitioning = false;
                }
            } 
            else if (this.sceneData.nextScene) { 
                this.loadScene(this.sceneData.nextScene); 
            }
        }

        makeChoice(choice) {
            if (choice.unlock) {
                const locationsToUnlock = Array.isArray(choice.unlock) ? choice.unlock : [choice.unlock];
                locationsToUnlock.forEach(locId => {
                    if (!this.state.flags[`${locId}_unlocked`]) { this.state.flags[`${locId}_unlocked`] = true; this.showUnlockNotification(locId); }
                });
            }
            if (choice.currency) {
                const txId = `currency_${this.state.sceneId}_choice_${this.sceneData.choices.indexOf(choice)}`;
                this.updateCurrency(choice.currency, txId);
            }
            if (choice.effect) { for (const [k, v] of Object.entries(choice.effect)) { this.state.stats[k] = Math.max(0, Math.min(100, this.state.stats[k] + v)); } }
            if (choice.flag) this.state.flags[choice.flag] = true;
            if (choice.next) this.loadScene(choice.next);
        }
    }

    class AudioController {
        constructor() { 
            this.active = true; this.current = null; this.volume = 1.0; this.themeVolume = 0.4; this.gameAudioActive = true;
            this.themeMusic = new Audio(ASSETS.audio.main_theme || "../audios/theme.mp3"); this.themeMusic.loop = true;
        } 
        setVolume(v) { this.volume = v; if(this.bgMusic) this.bgMusic.volume = this.volume; }
        setThemeVolume(v) {
            this.themeVolume = v; if(this.themeMusic) this.themeMusic.volume = this.themeVolume;
            if (this.themeVolume > 0 && this.themeMusic.paused && this.active) { this.themeMusic.play().catch(e => console.log("Audio autoplay blocked by browser")); } 
            else if (this.themeVolume == 0 && !this.themeMusic.paused) { this.themeMusic.pause(); }
        }
        setGameAudio(state) {
            this.gameAudioActive = (state === 'on');
            if (this.gameAudioActive && this.active && this.bgMusic && this.bgMusic.paused) { this.bgMusic.play().catch(e => console.log("Audio autoplay blocked by browser")); } 
            else if (!this.gameAudioActive && this.bgMusic) { this.bgMusic.pause(); }
        }
        toggle() {
            this.active = !this.active;
            const icon = document.getElementById('audio-icon');
            if (this.active) {
                icon.setAttribute('data-lucide', 'volume-2'); icon.style.color = '#ffffff'; 
                if(this.current && this.bgMusic && this.gameAudioActive) this.bgMusic.play().catch(e => console.log("Audio autoplay blocked"));
                if(this.themeMusic && this.themeVolume > 0) this.themeMusic.play().catch(e => console.log("Audio autoplay blocked"));
            } else {
                icon.setAttribute('data-lucide', 'volume-x'); icon.style.color = '#888888';
                if(this.bgMusic) this.bgMusic.pause(); if(this.themeMusic) this.themeMusic.pause();
            }
            lucide.createIcons();
        }
        play(id, loop = true) {
            if (!this.bgMusic) { this.bgMusic = new Audio(); }
            this.bgMusic.loop = loop; this.bgMusic.volume = this.volume;
            if (this.current !== id) {
                 this.bgMusic.src = ASSETS.audio[id]; this.current = id;
                 if (this.active && this.gameAudioActive) this.bgMusic.play().catch(e => console.log("Audio autoplay blocked"));
            } else {
                 if (this.active && this.gameAudioActive && this.bgMusic.paused) {
                     this.bgMusic.currentTime = 0; this.bgMusic.play().catch(e => console.log("Audio autoplay blocked"));
                 }
            }
        }
    }

    const SPEAKERS = {
        unknown: { en: "???", mm: "???", color: "bg-brown-900 border-brown-500" },
        tayza: { en: "Tayza", mm: "တေဇ", color: "bg-blue-900 border-blue-500" },
        nay: { en: "Nay Chi", mm: "နေခြည်", color: "bg-purple-900 border-purple-500" },
        mom: { en: "Mother", mm: "အမေ", color: "bg-orange-800 border-orange-500" },
        dad: { en: "Father", mm: "အဖေ", color: "bg-orange-900 border-orange-500" },
        bro: { en: "Ko Thiha", mm: "ကိုသီဟ", color: "bg-green-900 border-green-500" },
        kyaw: { en: "Kyaw Gyi", mm: "ကျော်ကြီး", color: "bg-teal-800 border-teal-500" },
        nurse: { en: "Nurse", mm: "သူနာပြု", color: "bg-pink-900 border-pink-500" },
        guard: { en: "The Guardian", mm: "အစောင့်", color: "bg-red-900 border-red-500" },
        driver: { en: "YBS Driver", mm: "ကားဆရာ", color: "bg-gray-800 border-gray-500" },
        monk: { en: "Sayadaw", mm: "ဆရာတော်", color: "bg-orange-900 border-yellow-500" },
        librarian: { en: "Librarian", mm: "စာကြည့်တိုက်မှူး", color: "bg-indigo-900 border-indigo-500" }
    };
    const SCENES = {
        'yangon_intro': {
            bg: 'downtown',
            world: 'real',
            audio: 'morning_chant',
            location: { en: 'Yangon - CityView', mm: 'ရန်ကုန် - မြို့အလှ' },
            time: '07:00 AM',
            steps: [
            {
                bg: 'downtown',
                text: {
                    en: "Morning light spills over Yangon Downtown, brushing colonial buildings and narrow streets with gold. Shops awaken, tea scents drift, and buses begin their slow dance along waking roads. The city hums with quiet stories beneath the sun.",
                    mm: "မနက်ခင်းနေရောင်က ရန်ကုန်မြို့လယ်ပေါ်ကို တဖြည်းဖြည်း လင်းလာပြီး ဟောင်းနွမ်းနေသောကိုလိုနီအဆောက်အဦးတွေ၊ လမ်းကျဉ်းကျဉ်းလေးတွေကို ရောင်စုံအလင်းနဲ့ လင်းစေပါတယ်။ ဆိုင်တွေ တဖြည်းဖြည်းဖွင့်လာကြပြီး လက်ဖက်ရည်နံ့လေးတွေလည်း လေထဲမှာ ပျံ့နှံ့လာပါပြီ။ ဘတ်စ်ကားတွေကလည်း လမ်းမပေါ်မှာ တဖြည်းဖြည်း စတင်လှုပ်ရှားလာပြီး မြို့တော်ထဲ နေရောင်အောက်မှာ လူတိုင်းကိုယ်ပိုင်ဇာတ်လမ်းတွေနဲ့ တိတ်တဆိတ် စတင်လာပါပြီ။"
                }
            },
            {
                bg: 'sule',
                text: {
                    en: "At the heart of the city, Sule Pagoda stands serene amid flowing traffic. Monks walk with calm steps, office workers hurry by. Its golden spire catches sunlight, quietly witnessing the passing day.",
                    mm: "မြို့ရဲ့အလယ်ဗဟိုမှာ ဆူးလေဘုရားက လမ်းလှည့်ကားတွေကြားမှာပဲ တိတ်ဆိတ်အေးချမ်းစွာ တည်ရှိနေပြီး နေရောင်အောက်မှာ ရွှေရောင်တောက်ပလင်းလက်နေပါတယ်။ သံဃာတော်တွေက တည်ငြိမ်တဲ့ ခြေလှမ်းတွေနဲ့ လမ်းလျှောက်နေကြပြီး ရုံးသွားဝန်ထမ်းတွေကလည်း အလုပ်အတွက် အမြန်လှုပ်ရှားနေကြပါပြီ။ မြို့ရဲ့အသံလှိုင်းတွေကြားမှာပင် ဘုရားက တိတ်တဆိတ် နေ့သစ်တစ်နေ့ကို စောင့်ကြည့်နေသလို ဖြစ်နေပါတယ်။"
                }
            },
            {
                bg: 'shwedagon',
                text: {
                    en: "On the hill, Shwedagon Pagoda glimmers under the sun. Incense drifts, prayers float, and the city below seems to pause, held in a gentle, timeless moment.",
                    mm: "တောင်ပေါ်မှာ ရွှေတိဂုံဘုရားက နေရောင်အောက်မှာ တောက်ပလင်းလက်နေပြီး ရွှေရောင်တံတိုင်းတွေက မျက်စိထဲ ထင်ဟပ်စေပါတယ်။ အမွှေးနံ့သင်းသင်းလေးတွေ လေထဲမှာ ပျံ့နှံ့နေပြီး ဆုတောင်းသံတွေကလည်း တိတ်တဆိတ် လေပြေအေးနဲ့အတူ ပေါ်လွင်နေပါတယ်။ အောက်ဘက်မြို့တော်ကတော့ ခဏတာ ငြိမ်သက်သလို ဖြစ်နေပြီး အချိန်တစ်ခဏ ရပ်တန့်သွားသလို အေးချမ်းမှုတစ်ခုနဲ့ ဖုံးလွှမ်းနေပါတယ်။"
                }
            },
            {
                bg: 'kantawgyi',
                text: {
                    en: "By Kandawgyi Lake, water mirrors clouds and rooftops. The Karaweik floats gently, footsteps fade along the wooden path, and a soft breeze carries distant city sounds. Peace lingers quietly beneath the open sky.",
                    mm: "ကန်တော်ကြီးကန်ဘေးမှာ ရေပြင်က မိုးတိမ်တွေနဲ့ အဆောက်အဦးတွေကို ပြန်လည်ထင်ဟပ်စေပြီး လေပြေအေးလေးနဲ့အတူ တိတ်ဆိတ်စွာ လှုပ်ရှားနေပါတယ်။ ကရဝိက်ရေယာဉ်က ရေပြင်ပေါ်မှာ ငြိမ်သက်စွာ လွင့်မျောနေပြီး သစ်သားလမ်းလေးပေါ်မှာ လမ်းလျှောက်သံတွေ၊ မြို့ရဲ့အသံဝေးဝေးလေးတွေ လေပြေအေးနဲ့အတူ ကြားနေရပြီး အေးချမ်းမှုတစ်ခုကတော့ မိုးကောင်းကင်အောက်မှာ တိတ်တဆိတ် ဆက်လက်ရှိနေပါတယ်။"
                }
            }
            
                        
        ],
        choices: [
            { text: { en: "Continue", mm: "ရှေ့ဆက်မည်" }, next: 'alarm' },
        ]
        },
        
        'alarm': {
            bg: 'home_tayza',
            world: 'real',
            location: { en: 'Home - Bedroom', mm: 'အိမ် - အိပ်ခန်း' },
            time: '07:01 AM',
            steps: [
            {
                bg: 'home_tayza',
                audio: 'morning_chant',
                text: {
                    en: "...",
                    mm: "..."
                }
            },
            {
                bg: 'alarm',
                audio: { id: 'alarm', loop: true },
                text: {
                    en: "*The alarm is ringing*",
                    mm: "*နှိုးစက်အသံမြည်သည်*"
                }
            },
                        
        ],
        choices: [
            { text: { en: "Close the Alarm", mm: "နှိုးစက်ပိတ်မည်" }, next: 'intro-tayza' },
        ]
        },

        'intro-tayza': {
            bg: 'sleep_tayza',
            world: 'real',
            location: { en: 'Home - Bedroom', mm: 'အိမ် - အိပ်ခန်း' },
            time: '07:01 AM',
            steps: [
            {
                bg: 'sleep_tayza',
                audio: { id: 'yawn', loop: false },
                unlock: ['home'],
                text: {
                    en: "Wahhhhh...",
                    mm: "၀ါးးးးးးးး"
                }
            },
                        
        ],
        choices: [
            { text: { en: "Sleep for a while", mm: "ခဏလောက် ပြန်အိပ်လိုက်မယ်" }, next: 'alarm' },
            { text: { en: "Wake up", mm: "အိပ်ရာထမည်" }, next: 'wakeup-tayza' },
        ]
        },

        'wakeup-tayza': {
            bg: 'wakeup_tayza',
            world: 'real',
            location: { en: 'Home - Bedroom', mm: 'အိမ် - အိပ်ခန်း' },
            time: '07:05 AM',
            steps: [
            {
                bg: 'wakeup_tayza',
                audio: { id: 'oldfan', loop: true },
                speaker: SPEAKERS.unknown, text: {en: "Another morning.", mm: "နောက်ထပ် မနက်ခင်းတစ်ခု..."}
            },
            {
                bg: 'oldfan',
                speaker: SPEAKERS.unknown, text: {en: "The fan spins lazily overhead, counting seconds I don't have.", mm: "ပန်ကာက ခေါင်းပေါ်မှာဖြေးညှင်းစွာ လည်ပတ်ရင်း ကျွန်တော့်ကတော့ ကုန်ဆုံးသွားတဲ့ အချိန်တွေကို ရေတွက်နေမိတယ်။"}
            },
            {
                speaker: SPEAKERS.unknown, text: {en: "The sun is already burning through the curtains. I hate the heat.", mm: "နေရောင်က လိုက်ကာတွေကို ဖောက်ပြီး ပူလောင်နေပြီ။ ဒီအပူဒဏ်ကို ကျွန်တော်မုန်းတယ်။"},
            },
                        
        ],
        choices: [
            { text: { en: "Check the phone", mm: "ဖုန်းကြည့်မယ်" }, next: 'missedcall' },
        ]
        },

        'missedcall': {
            bg: 'missedcall',
            world: 'real',
            location: { en: 'Home - Bedroom', mm: 'အိမ် - အိပ်ခန်း' },
            time: '07:05 AM',
            steps: [
            {
                bg: 'missedcall',
                currency: 5000,
                speaker: SPEAKERS.unknown, text: {en: "I check my phone. 14 missed calls from 'Mom'. She is in the kitchen downstairs. This is how our house works.", mm: "ဖုန်းကို စစ်ကြည့်လိုက်တယ်။ အမေဆီက Missed Call ၁၄ ခု။ အမေက အိမ်အောက်ထပ် မီးဖိုချောင်မှာ ရှိနေတာကိုတောင် ဖုန်းဆက်နေတုန်းပဲ။"},
            },
            {
                speaker: SPEAKERS.unknown, text: {en: "The pressure starts before I even leave the bed.", mm: "အိပ်ရာမထခင်ကတည်းက ဖိအားတွေက စတင်နေပြီ။"},
            },
            {
                speaker: SPEAKERS.tayza, text: {en: "My name is Tayza, I am 21 years old and an IT student at Info Myanmar University in Yangon, currently preparing for my upcoming final exam while trying my best to make my family proud.", mm: "ကျွန်တော့်နာမည် 'တေဇ' ပါ၊ အသက်ကတော့ ၂၁ နှစ်ပြည့်ပြီး လက်ရှိမှာတော့ ရန်ကုန်မြို့ရှိ Info Myanmar University မှ IT ကျောင်းသားတစ်ယောက်ဖြစ်ကာ လာမည့် နောက်ဆုံးစာမေးပွဲအတွက် ကြိုးစားလေ့လာရင်း မိသားစုကို ဂုဏ်ယူစေချင်နေသူတစ်ယောက်ဖြစ်ပါတယ်။"},
            },
                        
        ],
        choices: [
            { text: { en: "Rush downstairs", mm: "အောက်ထပ်ကို အမြန်ဆင်းမယ်" }, next: 'kitchen' },
            { text: { en: "Stay in bed for 5 more minutes.", mm: "၅ မိနစ်လောက် ဆက်လှဲနေမယ်" }, next: 'alarm' },
        ]
        },

        'kitchen': {
            bg: 'stair',
            world: 'real',
            location: { en: 'Home - Living Room', mm: 'အိမ် - ဧည့်ခန်း'},
            time: '07:15 AM',
            steps: [
            {
                bg: 'stair',
                audio: 'stair',
                text: {en: "*foot steps*", mm: "*ခြေသံ*"},
            },
            {
                bg: 'livingroom',
                audio: 'kitchen',
                speaker: SPEAKERS.tayza, text: {en: "Mom, I'm awake.", mm: "အမေ..သားနိုးပါပြီ။"},
            },
            {
                bg: 'livingroom',
                speaker: SPEAKERS.unknown, text: {en: "Tayza! Why are you late? Do you want to be late for school?", mm: "တေဇ.. သားငယ်လေး.. ဘာလို့ နောက်ကျနေတာလဲ။ ကျောင်းနောက်ကျချင်နေတာလား။"},
            },
            {
                speaker: SPEAKERS.tayza, text: {en: "I was studying late last night, Mom.", mm: "ညက စာကြည့်တာ နောက်ကျသွားလို့ပါ အမေ။"},
            },
            {

                bg: 'kitchen',
                speaker: SPEAKERS.tayza, text: {en: "So… this is my mother, Daw Mya Thandar. She’s 55, works at an office, and somehow still finds the energy to take care of all of us. She doesn’t say much about her worries… but I know she prays for me every single day. Even when I act like I don’t notice.", mm: "ဒါကတော့ ကျွန်တော့်အမေ ဒေါ်မြသန္တာပါ။ အသက် ၅၅ နှစ်ရှိပြီး ရုံးမှာ အလုပ်လုပ်တယ်။ အလုပ်ပင်ပန်းပေမယ့် မိသားစုကို ဂုဏ်ယူစေချင်နေသူတစ်ယောက်ဖြစ်ပါတယ်။ သူမက စိုးရိမ်မှုတွေကို မပြောတတ်ဘူး… ဒါပေမယ့် နေ့တိုင်း ကျွန်တော်အတွက် ဆုတောင်းပေးနေတာကို ကျွန်တော် သိပါတယ်။ မသိသလိုလုပ်နေပေမယ့်လည်း…"},
            },
            {
                speaker: SPEAKERS.mom, text: {en: "After taking care of your skin, face, and teeth, have breakfast, Tayza. You're ready to eat.", mm: "သား..တေဇ ..မျက်နှာသစ်သွားတိုက်ပြီး မနက်စာ လာစားတော့.. စားလို့ရပြီ။"},
            },
                        
        ],
        choices: [
            { text: { en: "Wash Up & Eat Breakfast", mm: "မျက်နှာသစ်သွားတိုက်ပြီး မနက်စာစားမယ်" }, next: 'washup' },
            { text: { en: "Sit at Table for a Bit", mm: "ဧည့်ခန်းမှာခနထိုင်မယ်" }, next: 'sit_livingroom' },
        ]
        },

        'washup': {
            bg: 'bathroom',
            world: 'real',
            location: { en: 'Home - Bathroom', mm: 'အိမ် - ရေချိုးခန်း' },
            time: '07:20 AM',
            audio: 'water_splash',
            steps: [
                {
                    bg: 'bathroom',
                    speaker: SPEAKERS.tayza,
                    text: { en: "Cold water hits my face. I look at the mirror. Dark circles. Tired eyes.", mm: "ရေအေးအေးက မျက်နှာပေါ်ကျလာတယ်။ မှန်ထဲကြည့်လိုက်တော့ မျက်ကွင်းညိုတွေနဲ့ ပင်ပန်းနေတဲ့ မျက်လုံးတွေ။" }
                },
                {
                    speaker: SPEAKERS.bro,
                    text: { en: "Yo, Tayza. Not done yet?", mm: "ဟေ့ရောင် တေဇ။ မပြီးသေးဘူးလားကွာ။" }
                },
                {
                    speaker: SPEAKERS.tayza,
                    text: { en: "This is my older brother, Ko Thiha. He's a pilot. Or at least, he's training to be one. He's the golden child.", mm: "ဒါက ကျွန်တော့်အစ်ကို၊ ကိုသီဟ။ သူက လေယာဉ်မှူးတစ်ယောက်။ ဒါမှမဟုတ် လေယာဉ်မှူးသင်တန်းတက်နေတာပေါ့။ အိမ်ရဲ့ ရွှေသားလေးပေါ့။" }
                },
                {
                    speaker: SPEAKERS.bro,
                    text: { en: "Whoa, look at you. You look like a panda, bro. What have you been doing? Gaming all night?", mm: "ဟာ... မင်းပုံစံကြည့်ပါဦး။ ပန်ဒါရုပ်ပေါက်နေပြီ ညီလေးရာ။ ဘာတွေလုပ်နေတာလဲ။ တညလုံး ဂိမ်းဆော့နေတာလား။" }
                },
                {
                    speaker: SPEAKERS.tayza,
                    text: { en: "No, Ko Gyi. I'm preparing for the final exam. The pressure is real.", mm: "မဟုတ်ပါဘူး ကိုကြီးရာ။ စာမေးပွဲအတွက် စာကြည့်နေတာပါ။ ဖိအားတွေက တကယ်များတယ်။" }
                },
                {
                    speaker: SPEAKERS.tayza,
                    text: { en: "Ko Gyi, how did you get through your pilot training exams? Any tips?", mm: "ကိုကြီး... လေယာဉ်မှူးစာမေးပွဲတုန်းက ဘယ်လိုဖြေခဲ့လဲ။ အကြံဉာဏ်လေး ဘာလေးမရှိဘူးလား။" }
                },
                {
                    speaker: SPEAKERS.bro,
                    text: { en: "Ah, exams. Just focus on the process, not the result. And sleep, kid. You can't fly if you're asleep at the wheel.", mm: "အော် စာမေးပွဲလား။ ရလဒ်ကိုမကြည့်နဲ့ လုပ်ငန်းစဉ်ကိုအာရုံစိုက်။ ပြီးတော့ အိပ်ရေးဝဝအိပ်။ မင်းအိပ်ငိုက်နေရင် လေယာဉ်မောင်းလို့မရဘူး။" }
                },
                {
                    speaker: SPEAKERS.bro,
                    text: { en: "Here, take this. Buy some snacks or coffee. Good luck.", mm: "ရော့... ဒါယူသွား။ မုန့်ပဲဖြစ်ဖြစ် ကော်ဖီပဲဖြစ်ဖြစ် ဝယ်သောက်လိုက်။ ကံကောင်းပါစေကွာ။" },
                    currency: 5000
                },
                {
                    speaker: SPEAKERS.tayza,
                    text: { en: "Thanks, Ko Gyi.", mm: "ကျေးဇူးပါ ကိုကြီး။" }
                }
            ],
            choices: [
                { text: { en: "Go to breakfast", mm: "မနက်စာစားရန်သွားမည်" }, next: 'breakfast_table' }
            ]
        },

        'sit_livingroom': {
            bg: 'livingroom',
            world: 'real',
            location: { en: 'Home - Living Room', mm: 'အိမ် - ဧည့်ခန်း' },
            time: '07:20 AM',
            steps: [
                {
                    bg: 'livingroom',
                    speaker: SPEAKERS.tayza,
                    text: { en: "I sit on the sofa for a moment, letting the fan cool me down.", mm: "ဆိုဖာပေါ်မှာ ခဏထိုင်လိုက်ပြီး ပန်ကာလေကို ခံစားနေလိုက်တယ်။" }
                },
                {
                    speaker: SPEAKERS.bro,
                    text: { en: "Hey, Lazy-za. What are you doing? I'm done cleaning up. Gonna grab breakfast.", mm: "ဟေ့ကောင် ပျင်းတေဇ။ ဘာလုပ်နေတာလဲ။ ငါတော့ ရေချိုးပြီးပြီ။ မနက်စာသွားစားတော့မယ်။" }
                },
                {
                    speaker: SPEAKERS.bro,
                    text: { en: "Mom's gonna yell if you're late for school.", mm: "ကျောင်းနောက်ကျရင် အမေဆူလိမ့်မယ်နော်။" }
                },
                {
                    speaker: SPEAKERS.tayza,
                    text: { en: "Yeah, yeah. I'm coming.", mm: "အေးပါ... လာပါပြီ။" }
                }
            ],
            choices: [
                { text: { en: "Go to kitchen", mm: "မီးဖိုချောင်သို့သွားမည်" }, next: 'breakfast_table' }
            ]
        },

        'breakfast_table': {
            bg: 'dining_room',
            world: 'real',
            location: { en: 'Home - Dining Room', mm: 'အိမ် - ထမင်းစားခန်း' },
            time: '07:30 AM',
            steps: [
                {
                    bg: 'dining_room',
                    audio: 'kitchen',
                    speaker: SPEAKERS.mom,
                    text: { en: "Eat quickly. Mohinga is getting cold.", mm: "မြန်မြန်စား။ မုန့်ဟင်းခါး အေးကုန်တော့မယ်။" }
                },
                {
                    speaker: SPEAKERS.tayza,
                    text: { en: "I eat quickly. The taste of fish soup wakes me up better than coffee.", mm: "ကျွန်တော် မြန်မြန်စားလိုက်တယ်။ ငါးဟင်းရည်အရသာက ကော်ဖီထက်တောင် ပိုပြီးလန်းဆန်းစေတယ်။" }
                },
                {
                    speaker: SPEAKERS.tayza,
                    text: { en: "I'm leaving for school now, Mom!", mm: "အမေ... သားကျောင်းသွားတော့မယ်။" }
                }
            ],
            choices: [
                { text: { en: "Go to School / Shwedagon", mm: "ကျောင်း/ဘုရား သွားမည်" }, next: 'street_monk' }
            ]
        },

        'street_monk': {
            bg: 'downtown',
            world: 'real',
            location: { en: 'Yangon - Streets', mm: 'ရန်ကုန် - လမ်းမပေါ်' },
            time: '08:00 AM',
            steps: [
                {
                    bg: 'downtown',
                    audio: 'city_ambience',
                    speaker: SPEAKERS.tayza,
                    text: { en: "I decide to stop by Shwedagon Pagoda before class. I need some peace of mind for the exam.", mm: "အတန်းမသွားခင် ရွှေတိဂုံဘုရားကို ခဏဝင်ဖို့ ဆုံးဖြတ်လိုက်တယ်။ စာမေးပွဲအတွက် စိတ်ငြိမ်သက်မှု လိုအပ်နေတယ်။" }
                },
                {
                    speaker: SPEAKERS.monk,
                    text: { en: "Young man...", mm: "လူလေး..." }
                },
                {
                    bg: 'downtown', 
                    char: 'monk',
                    speaker: SPEAKERS.monk,
                    text: { en: "The shadow follows the object, but sometimes... the shadow moves on its own.", mm: "အရိပ်ဆိုတာ ဝတ္ထုပစ္စည်းနောက်ကိုလိုက်တယ်... ဒါပေမယ့် တစ်ခါတစ်လေကျရင် အရိပ်က သူ့ဘာသာ ရွေ့လျားတတ်တယ်။" }
                },
                {
                    speaker: SPEAKERS.tayza,
                    text: { en: "Uh... sure, Sayadaw. (What was that about?)", mm: "တင်ပါ့ဘုရား... (ဘာကိုဆိုလိုတာပါလိမ့်...)" }
                }
            ],
            choices: [
                { text: { en: "Go to Shwedagon Pagoda", mm: "ရွှေတိဂုံဘုရားသို့သွားမည်" }, next: 'shwedagon_arrival' }
            ]
        },

        'shwedagon_arrival': {
            bg: 'shwedagon_stairs',
            world: 'real',
            location: { en: 'Shwedagon Pagoda', mm: 'ရွှေတိဂုံဘုရား' },
            time: '08:30 AM',
            audio: 'pagoda_bells',
            unlock: ['shwedagon'],
            steps: [
                {
                    bg: 'shwedagon_stairs',
                    clearChar: true,
                    text: { en: "The southern stairway. Cool tiles under my feet. The smell of flowers and incense.", mm: "တောင်ဘက်မုခ်စောင်းတန်း။ ခြေဖဝါးအောက်က အေးမြတဲ့ ကျောက်ပြားတွေ။ ပန်းနံ့နဲ့ အမွှေးတိုင်နံ့တွေ။" }
                },
                {
                    bg: 'shwedagon',
                    text: { en: "The Great Pagoda towers above, a mountain of gold against the blue sky.", mm: "ရွှေတိဂုံစေတီတော်မြတ်ကြီးက မိုးပြာရောင်ကောင်းကင်အောက်မှာ ရွှေတောင်ကြီးတစ်ခုလို တည်ရှိနေတယ်။" }
                }
            ],
            choices: [
                { text: { en: "Find a corner to pray", mm: "ဆုတောင်းရန်နေရာရှာမည်" }, next: 'shwedagon_pray' }
            ]
        },

        'shwedagon_pray': {
            bg: 'shwedagon',
            world: 'real',
            location: { en: 'Tuesday Corner', mm: 'အင်္ဂါထောင့်' },
            time: '08:45 AM',
            steps: [
                {
                    text: { en: "I kneel at the Tuesday corner. 'Please let me pass the exam. Please let me make my parents proud.'", mm: "အင်္ဂါထောင့်မှာ ဒူးထောက်လိုက်တယ်။ 'စာမေးပွဲအောင်ပါစေ။ မိဘတွေကို ဂုဏ်ယူဝင့်ကြွားနိုင်သူ ဖြစ်ပါစေသား'။" }
                },
                {
                    text: { en: "I close my eyes, chanting silently.", mm: "မျက်လုံးတွေကို မှိတ်ပြီး တိတ်တဆိတ် ဂုဏ်တော်ပွားနေလိုက်တယ်။" }
                },
                {
                    audio: { id: 'ring_drop', loop: false }, /* Assuming audio fallback works */
                    text: { en: "*CLINK*", mm: "*ခလွမ်*" }
                },
                {
                    text: { en: "Ouch! Something hit my head!", mm: "အား! ခေါင်းကို တစ်ခုခု လာမှန်တယ်။" }
                },
                {
                    text: { en: "I look around. Did it fall from the roof?", mm: "ဘေးဘီကို ကြည့်လိုက်တယ်။ ခေါင်မိုးပေါ်က ပြုတ်ကျလာတာလား။" }
                }
            ],
            choices: [
                { text: { en: "Look at the object", mm: "ဘာလဲဆိုတာ ကြည့်လိုက်မည်" }, next: 'ring_incident' }
            ]
        },

        'ring_incident': {
            bg: 'ring_item',
            world: 'real',
            location: { en: 'Tuesday Corner', mm: 'အင်္ဂါထောင့်' },
            time: '08:46 AM',
            steps: [
                {
                    bg: 'ring_item',
                    text: { en: "It's a ring. An old, silver ring with strange engravings. It doesn't look like jewelry someone would just drop.", mm: "လက်စွပ်တစ်ကွင်းပဲ။ ထူးဆန်းတဲ့ အက္ခရာတွေနဲ့ ရှေးဟောင်းငွေလက်စွပ်တစ်ကွင်း။ လွယ်လွယ်ကူကူ ပြုတ်ကျခဲ့မယ့် လက်ဝတ်ရတနာမျိုးနဲ့ မတူဘူး။" }
                },
                {
                    speaker: SPEAKERS.tayza,
                    text: { en: "Weird. Should I leave it here?", mm: "ထူးဆန်းတယ်။ ဒီအတိုင်း ထားခဲ့သင့်လား။" }
                },
                {
                    speaker: SPEAKERS.tayza,
                    text: { en: "But... it feels warm.", mm: "ဒါပေမယ့်... ကိုင်ကြည့်ရတာ နွေးနေတယ်။" }
                }
            ],
            choices: [
                { text: { en: "Keep it in backpack", mm: "လွယ်အိတ်ထဲ ထည့်သိမ်းထားမည်" }, next: 'keep_ring' },
                { text: { en: "Leave it (Force Pick up)", mm: "ထားခဲ့မည် (မရပါ)" }, next: 'keep_ring' } // Forcing narrative for now
            ]
        },

        'keep_ring': {
            bg: 'shwedagon',
            world: 'real',
            location: { en: 'Shwedagon Pagoda', mm: 'ရွှေတိဂုံဘုရား' },
            time: '09:00 AM',
            steps: [
                {
                    text: { en: "I decided to keep it safe for now. Maybe I can find the owner later.", mm: "လောလောဆယ်တော့ လုံခြုံအောင် သိမ်းထားလိုက်မယ်။ နောက်မှ ပိုင်ရှင်ရှာပေးတော့မယ်။" }
                },
                {
                    text: { en: "I leave the pagoda. The city is waiting.", mm: "ဘုရားပေါ်က ပြန်ဆင်းလာခဲ့တယ်။ မြို့ကြီးက စောင့်ကြိုနေတယ်။" }
                }
            ],
            choices: [
                { text: { en: "Go to Downtown", mm: "မြို့ထဲဘက် သွားမည်" }, next: 'downtown_walk' }
            ]
        },

        'downtown_walk': {
            bg: 'downtown',
            world: 'real',
            location: { en: 'Yangon - Downtown', mm: 'ရန်ကုန် - မြို့ထဲ' },
            time: '05:00 PM',
            unlock: ['downtown', 'sule'],
            steps: [
                {
                    bg: 'downtown',
                    audio: 'city_ambience',
                    text: { en: "Time flies. Evening falls on Yangon.", mm: "အချိန်တွေ ကုန်တာမြန်လိုက်တာ။ ရန်ကုန်မှာ ညနေစောင်းနေပြီ။" }
                },
                {
                    text: { en: "The streets are packed. People rushing home, buses honking, the smell of street food frying.", mm: "လမ်းတွေပေါ်မှာ လူတွေပြည့်ကျပ်နေတယ်။ အိမ်ပြန်မယ့်သူတွေ၊ ကားဟွန်းသံတွေ၊ လမ်းဘေးအစားအစာ ကြော်လှော်နံ့တွေ။" }
                },
                {
                    text: { en: "The Yangon River glitters in the distance. This chaos... it's beautiful in its own way.", mm: "ရန်ကုန်မြစ်က အဝေးမှာ တလက်လက်တောက်ပနေတယ်။ ဒီရှုပ်ထွေးမှုတွေက... သူ့နည်းသူ့ဟန်နဲ့တော့ လှပနေတာပါပဲ။" }
                }
            ],
            choices: [
                { text: { en: "Go Home for Dinner", mm: "ညစာစားရန် အိမ်ပြန်မည်" }, next: 'dinner_scene' }
            ]
        },

        'dinner_scene': {
            bg: 'dining_room',
            world: 'real',
            location: { en: 'Home - Dining Room', mm: 'အိမ် - ထမင်းစားခန်း' },
            time: '07:00 PM',
            steps: [
                {
                    bg: 'dining_room',
                    speaker: SPEAKERS.mom,
                    text: { en: "Welcome back, son. Wash your hands. Dinner is ready.", mm: "ပြန်ရောက်ပြီလား သား။ လက်ဆေးလိုက်ဦး။ ညစာရပြီ။" }
                },
                {
                    speaker: SPEAKERS.dad,
                    text: { en: "Tayza. How is the exam preparation?", mm: "တေဇ။ စာမေးပွဲပြင်ဆင်မှု အခြေအနေဘယ်လိုလဲ။" }
                },
                {
                    speaker: SPEAKERS.tayza,
                    text: { en: "This is my father. Strict. Traditional. He loves us, but his expectations are heavy.", mm: "ဒါက ကျွန်တော့်အဖေ။ စည်းကမ်းကြီးတယ်။ ရှေးရိုးဆန်တယ်။ ကျွန်တော်တို့ကို ချစ်ပေမယ့် သူထားတဲ့ မျှော်လင့်ချက်တွေက လေးလံလွန်းတယ်။" }
                },
                {
                    speaker: SPEAKERS.tayza,
                    text: { en: "It's going well, Dad.", mm: "အဆင်ပြေပါတယ် အဖေ။" }
                },
                {
                    speaker: SPEAKERS.dad,
                    text: { en: "Good. Your future depends on you. Don't disappoint us.", mm: "ကောင်းတယ်။ မင်းရဲ့အနာဂတ်က မင်းအပေါ်မှာပဲ မူတည်တယ်။ ငါတို့ကို စိတ်မပျက်စေနဲ့။" }
                },
                {
                    speaker: SPEAKERS.bro,
                    text: { en: "Yeah, he's been trying really hard... at sleeping.", mm: "ဟုတ်တယ် အဖေ။ သူတော်တော် ကြိုးစားနေတာ... အိပ်ဖို့လေ။" }
                },
                {
                    speaker: SPEAKERS.mom,
                    text: { en: "*Taps brother's shoulder* Ko Thiha! Don't tease your little brother. Just eat.", mm: "*ပခုံးကိုပုတ်လျက်* ကိုသီဟ! ညီလေးကို စမနေနဲ့။ ထမင်းပဲစား။" }
                },
                {
                    speaker: SPEAKERS.tayza,
                    text: { en: "I smile faintly. This is normal. This is home.", mm: "ကျွန်တော် ဖျော့တော့စွာ ပြုံးလိုက်တယ်။ ဒါက ပုံမှန်ပါပဲ။ ဒါက အိမ်ပါပဲ။" }
                }
            ],
            choices: [
                { text: { en: "Go to room to study", mm: "အခန်းပြန်ပြီး စာလုပ်မည်" }, next: 'room_night' }
            ]
        },

        'room_night': {
            bg: 'bedroom_night',
            world: 'real',
            location: { en: 'Home - Bedroom', mm: 'အိမ် - အိပ်ခန်း' },
            time: '11:00 PM',
            audio: 'creepy_drone', /* subtle foreshadowing */
            steps: [
                {
                    bg: 'bedroom_night',
                    text: { en: "I study for hours. My eyes are heavy.", mm: "စာလုပ်နေတာ နာရီပေါင်းများစွာ ကြာပြီ။ မျက်ခွံတွေ လေးလံလာတယ်။" }
                },
                {
                    text: { en: "Then I remember the ring.", mm: "ရုတ်တရက် လက်စွပ်ကို သတိရသွားတယ်။" }
                },
                {
                    bg: 'ring_item',
                    text: { en: "I take it out of my bag. Under the desk lamp, it glows softly.", mm: "အိတ်ထဲကနေ ထုတ်လိုက်တယ်။ မီးအိမ်အလင်းရောင်အောက်မှာ လက်စွပ်က မှိန်ဖျဖျ လင်းနေတယ်။" }
                },
                {
                    speaker: SPEAKERS.tayza,
                    text: { en: "Just for a second...", mm: "ခဏလေးပါပဲ..." }
                },
                {
                    text: { en: "I slide it onto my finger. It fits perfectly.", mm: "လက်ချောင်းထဲကို စွပ်ထည့်လိုက်တယ်။ ကွက်တိပဲ။" }
                },
                {
                    bg: 'bedroom_night',
                    text: { en: "A sudden wave of exhaustion hits me. I put my head on the desk.", mm: "ရုတ်တရက် ပင်ပန်းနွမ်းနယ်မှုတွေ ဝင်ရောက်လာတယ်။ စားပွဲခုံပေါ် ခေါင်းမှောက်ချလိုက်မိတယ်။" }
                }
            ],
            choices: [
                { text: { en: "Fall asleep", mm: "အိပ်ပျော်သွားသည်" }, next: 'wakeup_parallel' }
            ]
        },

        'wakeup_parallel': {
            bg: 'parallel_sule',
            world: 'parallel',
            location: { en: '???', mm: '???' },
            time: 'UNKNOWN',
            audio: 'creepy_drone',
            steps: [
                {
                    bg: 'parallel_sule',
                    text: { en: "...", mm: "..." }
                },
                {
                    speaker: SPEAKERS.tayza,
                    text: { en: "Huh? Where...?", mm: "ဟင်... ဘယ်ရောက်နေတာလဲ...?" }
                },
                {
                    text: { en: "I wake up. But not at my desk. I am standing in the middle of the road. Near Sule Pagoda.", mm: "ကျွန်တော် နိုးလာတယ်။ ဒါပေမယ့် စားပွဲခုံမှာ မဟုတ်ဘူး။ လမ်းမလယ်ခေါင်မှာ ရပ်နေမိတာ။ ဆူးလေဘုရားနားမှာ။" }
                },
                {
                    text: { en: "The sky is a wrong shade of blue. The air smells like... rust.", mm: "ကောင်းကင်အရောင်က မှားယွင်းနေတယ်။ လေထုထဲမှာ သံချေးနံ့လိုလို ရနေတယ်။" }
                }
            ],
            choices: [
                { text: { en: "Look around", mm: "ပတ်ဝန်းကျင်ကို ကြည့်မည်" }, next: 'parallel_home_journey' },
                { text: { en: "Go Home immediately", mm: "အိမ်ကိုချက်ချင်းပြန်မည်" }, next: 'parallel_home_journey' }
            ]
        },

        'parallel_home_journey': {
            bg: 'parallel_street',
            world: 'parallel',
            location: { en: 'Downtown', mm: 'မြို့ထဲ' },
            time: 'UNKNOWN',
            steps: [
                {
                    bg: 'parallel_street',
                    text: { en: "I rush towards home. People are walking on the street, but...", mm: "အိမ်ဘက်ကို အမြန်ပြေးလာခဲ့တယ်။ လမ်းပေါ်မှာ လူတွေသွားလာနေကြတယ်၊ ဒါပေမယ့်..." }
                },
                {
                    text: { en: "Their faces. They are blurry. Distorted. Not Burmese. Not human.", mm: "သူတို့မျက်နှာတွေ။ ဝါးနေတယ်။ ရုပ်ပျက်ဆင်းပျက်ဖြစ်နေတယ်။ မြန်မာလူမျိုးတွေမဟုတ်ဘူး။ လူတွေနဲ့မတူဘူး။" }
                },
                {
                    speaker: SPEAKERS.tayza,
                    text: { en: "What is happening? Am I dreaming?", mm: "ဘာတွေဖြစ်နေတာလဲ။ ငါအိမ်မက်မက်နေတာလား။" }
                },
                {
                    text: { en: "I reach my house door. I knock desperately.", mm: "အိမ်ရှေ့ရောက်တော့ တံခါးကို အားကုန်ထုလိုက်တယ်။" }
                },
                {
                    speaker: SPEAKERS.tayza,
                    text: { en: "Mom! Dad! Open the door!", mm: "အမေ! အဖေ! တံခါးဖွင့်ပါဦး!" }
                }
            ],
            choices: [
                { text: { en: "Wait for answer", mm: "တံခါးဖွင့်မည့်သူကို စောင့်မည်" }, next: 'parallel_home_door' }
            ]
        },

        'parallel_home_door': {
            bg: 'home_tayza',
            world: 'parallel',
            location: { en: 'Home', mm: 'Home' },
            time: 'UNKNOWN',
            steps: [
                {
                    audio: 'kitchen',
                    text: { en: "The door creaks open.", mm: "တံခါး ကျွီကနဲ ပွင့်လာတယ်။" }
                },
                {
                    speaker: SPEAKERS.mom,
                    text: { en: "You're late, Tayza. Where have you been?", mm: "နောက်ကျလိုက်တာ တေဇရယ်။ ဘယ်တွေသွားနေတာလဲ။" }
                },
                {
                    text: { en: "The voice is my mother's. The clothes are hers.", mm: "အသံက အမေရဲ့အသံ။ အဝတ်အစားတွေက အမေဝတ်နေကျ။" }
                },
                {
                    bg: 'faceless_mom',
                    char: 'faceless_mom',
                    text: { en: "But when I look up... there is no face. Just smooth skin.", mm: "ဒါပေမယ့် မော့ကြည့်လိုက်တဲ့အခါ... မျက်နှာမရှိဘူး။ ပြောင်ချောနေတဲ့ အရေပြားပဲ ရှိတယ်။" }
                },
                {
                    speaker: SPEAKERS.tayza,
                    text: { en: "AHHHHHH!", mm: "အာားးးးးးး!" }
                }
            ],
            choices: [
                { text: { en: "RUN AWAY", mm: "ထွက်ပြေးမည်" }, type: "danger", next: 'run_away_meet_naychi' }
            ]
        },

        'run_away_meet_naychi': {
            bg: 'parallel_street',
            world: 'parallel',
            location: { en: 'Alleyway', mm: 'လမ်းကြား' },
            time: 'UNKNOWN',
            steps: [
                {
                    clearChar: true,
                    text: { en: "I run blindly into the dark alleyway. My heart is pounding out of my chest.", mm: "မှောင်မဲနေတဲ့ လမ်းကြားထဲကို အတင်းပြေးဝင်လိုက်တယ်။ ရင်ဘတ်ထဲက နှလုံးခုန်သံက အပြင်ရောက်တော့မတတ်ပဲ။" }
                },
                {
                    text: { en: "I bump into someone.", mm: "တစ်ယောက်ယောက်နဲ့ ဝင်တိုက်မိတယ်။" }
                },
                {
                    speaker: SPEAKERS.unknown,
                    text: { en: "Shhh! Keep it down if you want to live.", mm: "ရှူး... အသက်ရှင်ချင်ရင် တိုးတိုးနေ။" }
                },
                {
                    bg: 'parallel_street',
                    char: 'naychi',
                    speaker: SPEAKERS.nay,
                    text: { en: "Welcome to the Echo Yangon. I'm Nay Chi.", mm: "ပဲ့တင်သံရန်ကုန်ကနေ ကြိုဆိုပါတယ်။ ငါ့နာမည် နေခြည်။" }
                }
            ],
            choices: [
                { text: { en: "To Be Continued...", mm: "ဆက်ရန်..." }, next: 'start' }
            ]
        },
    };
    
    // --- BOOTSTRAP ---
    const game = new GameEngine();
    
    document.addEventListener('DOMContentLoaded', () => {
        lucide.createIcons();
    });

    // Keyboard Shortcuts Listener
    document.addEventListener('keydown', (e) => {
        if (e.repeat) return;
        if (game.mapOpen || game.phoneOpen || game.settingsOpen || (e.target && e.target.tagName === 'INPUT')) return;
        
        if (e.code === 'Space') {
            e.preventDefault();
            game.next();
        } else if (e.key.toLowerCase() === 'm') {
            e.preventDefault();
            game.toggleMuteShortcut();
        }
    });
    
    document.addEventListener('contextmenu', event => event.preventDefault());

</script>
    </body>
</html>