<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport"
            content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <title>The Ring Between Two Yangons - Director's Cut</title>
        <script src="https://unpkg.com/lucide@latest"></script>
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

        <style>
        /* --- GOOGLE FONTS --- */
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Lato:wght@300;400;700&family=Noto+Sans+Myanmar:wght@300;400;500;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Special+Elite&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');

        /* --- CSS VARIABLES --- */
        :root {
            /* Theme Colors */
            --bg-real: #fdf6e3;
            --bg-parallel: #0f172a;
            --accent-gold: #eab308;
            --accent-gold-hover: #ca8a04;
            --glass-bg: rgba(10, 10, 10, 0.7);
            --glass-border: rgba(255, 255, 255, 0.1);
            
            /* Palette */
            --black: #000;
            --white: #fff;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            --blue-500: #3b82f6;
            --blue-600: #2563eb;
            --blue-700: #1d4ed8;
            --green-400: #4ade80;
            --green-500: #22c55e;
            --green-600: #16a34a;
            --red-500: #ef4444;
            --red-600: #dc2626;
        }

        /* --- RESET & GLOBAL --- */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            user-select: none;
        }

        body.global-body {
            font-family: 'Lato', 'Noto Sans Myanmar', sans-serif;
            overflow: hidden;
            background-color: #050505;
            color: var(--gray-200);
            height: 100vh;
            width: 100vw;
            position: relative;
            touch-action: manipulation;
            transition: background-color 1s ease, color 1s ease;
        }

        /* Utility States */
        .hidden { display: none !important; }
        .opacity-0 { opacity: 0 !important; }

        /* Typography */
        .font-cinzel { font-family: 'Cinzel', serif; }
        .font-lato { font-family: 'Lato', sans-serif; }
        .font-noto { font-family: 'Noto Sans Myanmar', sans-serif; }
        .font-mono { font-family: monospace; }
        .font-roboto { font-family: 'Roboto', sans-serif; }
        .font-bold { font-weight: 700; }
        .font-medium { font-weight: 500; }
        .text-center { text-align: center; }

        /* Icons */
        .icon-sm { width: 1rem; height: 1rem; }
        .icon-md { width: 1.25rem; height: 1.25rem; }
        .icon-lg { width: 1.5rem; height: 1.5rem; }
        .icon-xl { width: 2rem; height: 2rem; }
        .text-gold { color: var(--accent-gold); }
        .text-gray { color: var(--gray-500); }
        .text-white { color: var(--white); }
        .fill-current { fill: currentColor; }

        /* --- ANIMATIONS --- */
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes pulse-anim { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        @keyframes bounce-anim { 0%, 100% { transform: translateY(-25%); animation-timing-function: cubic-bezier(0.8,0,1,1); } 50% { transform: translateY(0); animation-timing-function: cubic-bezier(0,0,0.2,1); } }
        @keyframes panZoom { 0% { transform: scale(1.0) translate(0, 0); } 50% { transform: scale(1.05) translate(-1%, 1%); } 100% { transform: scale(1.0) translate(0, 0); } }
        @keyframes glitch-anim { 0%, 100% { transform: translate(0) } 20%, 60% { transform: translate(-3px, 3px) } 40% { transform: translate(-3px, -3px) } 80% { transform: translate(3px, -3px) } }
        @keyframes flash-anim { 0% { background-color: white; opacity: 1; } 100% { background-color: transparent; opacity: 0; } }
        @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-10px); } }
        @keyframes bounce-pin { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes slideUpFade { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes shimmer-load { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }

        .animate-spin { animation: spin 1s linear infinite; }
        .animate-pulse { animation: pulse-anim 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        .animate-bounce { animation: bounce-anim 1s infinite; }
        .animate-slide-up { animation: slideUpFade 0.8s backwards; }

        /* --- VISUAL FX ENGINE --- */
        .world-real { filter: sepia(0.15) saturate(1.1) brightness(1.05); transition: filter 3s ease-in-out; }
        .world-parallel { filter: hue-rotate(210deg) saturate(0.4) contrast(1.4) brightness(0.7) drop-shadow(0 0 20px rgba(0,100,255,0.1)); transition: filter 3s ease-in-out; }
        .world-collapse { animation: glitch-anim 0.1s infinite; filter: contrast(1.5) grayscale(1); }
        .world-dream { filter: blur(1px) brightness(1.2) saturate(1.5); transition: filter 3s ease; }
        
        .camera-move { animation: panZoom 60s infinite ease-in-out alternate; }
        .static-cam { animation: none !important; transform: scale(1.0) translate(0, 0) !important; transition: transform 0.5s ease-out; }
        
        .scanlines {
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.1));
            background-size: 100% 3px; position: absolute; inset: 0; pointer-events: none; z-index: 50; opacity: 0.3;
        }

        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: var(--accent-gold); border-radius: 4px; }

        /* --- GAME CONTAINER & LAYERS --- */
        .game-wrapper { position: relative; width: 100%; height: 100%; overflow: hidden; }
        .bg-system-wrap { position: absolute; inset: 0; overflow: hidden; background-color: var(--black); transition: background-color 1s; }
        .camera-rig-layer { position: absolute; inset: 0; width: 100%; height: 100%; filter: brightness(1.1); }
        .bg-layer { position: absolute; inset: 0; width: 100%; height: 100%; background-size: cover; background-position: center; transition: opacity 2s ease-in-out; opacity: 0; z-index: 0; }
        .mood-overlay { position: absolute; inset: 0; background-color: rgba(0,0,0,0.2); mix-blend-mode: overlay; transition: background-color 1s; z-index: 10; }
        .rain-overlay { position: absolute; inset: 0; pointer-events: none; opacity: 0.2; background-size: cover; mix-blend-mode: screen; z-index: 30; background-image: url('https://i.gifer.com/7scx.gif'); }
        .flash-overlay { position: absolute; inset: 0; background-color: var(--white); opacity: 0; pointer-events: none; z-index: 50; }
        
        /* Characters */
        .char-layer-wrap { position: absolute; inset: 0; display: flex; align-items: flex-end; justify-content: center; pointer-events: none; z-index: 20; padding-bottom: 0; transition: transform 0.7s, opacity 0.7s; transform: translateY(2.5rem); opacity: 0; }
        .char-naychi-wrap { position: relative; width: 100%; height: 100%; display: flex; justify-content: center; align-items: flex-end; animation: float 4s ease-in-out infinite; }
        .char-naychi-glow { width: 16rem; height: 600px; background: linear-gradient(to top, rgba(59, 130, 246, 0.2), transparent); filter: blur(24px); }
        .char-naychi-body { position: absolute; bottom: 0; width: 12rem; height: 500px; border: 2px solid rgba(96, 165, 250, 0.3); border-top-left-radius: 9999px; border-top-right-radius: 9999px; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); }
        .char-faceless-wrap { position: relative; width: 100%; height: 100%; display: flex; justify-content: center; align-items: flex-end; }
        .char-faceless-glow { width: 18rem; height: 700px; background: var(--black); filter: blur(12px); }
        .char-faceless-head { position: absolute; top: 10rem; width: 8rem; height: 10rem; background: var(--gray-900); border-radius: 50%; animation: pulse-anim 2s infinite; }
        .char-faceless-mom-wrap { position: relative; width: 100%; height: 100%; display: flex; justify-content: center; align-items: flex-end; }
        .char-faceless-mom-glow { width: 18rem; height: 700px; background: var(--gray-900); filter: blur(4px); }
        .char-faceless-mom-head { position: absolute; top: 8rem; width: 10rem; height: 10rem; background: var(--gray-800); border-radius: 50%; animation: pulse-anim 2s infinite; filter: blur(4px); }
        .char-monk-wrap { position: relative; width: 100%; height: 100%; display: flex; justify-content: center; align-items: flex-end; }
        .char-monk-glow { width: 16rem; height: 600px; background: linear-gradient(to top, rgba(154, 52, 18, 0.8), transparent); }

        /* --- PRELOADER --- */
        .preloader-overlay { position: fixed; inset: 0; z-index: 200; background: #050505; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 1.5rem; transition: opacity 1s; }
        .preloader-items { display: flex; gap: 3rem; margin-bottom: 2.5rem; }
        .preloader-item { display: flex; flex-direction: column; align-items: center; gap: 1rem; transition: transform 0.3s; }
        .preloader-item:hover { transform: scale(1.05); }
        .preloader-img { width: 6rem; height: 6rem; object-fit: cover; border-radius: 50%; border: 1px solid rgba(234, 179, 8, 0.3); box-shadow: 0 0 20px rgba(234, 179, 8, 0.15); }
        .preloader-label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.2em; font-weight: bold; color: var(--gray-500); }
        .preloader-info { max-width: 28rem; margin-bottom: 3rem; }
        .preloader-title { font-size: 1.25rem; font-family: 'Cinzel', serif; font-weight: 700; color: var(--gray-200); letter-spacing: 0.1em; margin-bottom: 0.75rem; text-transform: uppercase; }
        .preloader-desc { color: var(--gray-400); font-size: 0.875rem; line-height: 1.625; font-family: 'Lato', sans-serif; }
        .preloader-bar-bg { width: 16rem; height: 0.25rem; background: var(--gray-900); border-radius: 9999px; overflow: hidden; box-shadow: inset 0 2px 4px rgba(0,0,0,0.6); position: relative; margin-bottom: 1rem; }
        .preloader-bar-fill { height: 100%; width: 0; background: linear-gradient(90deg, rgba(234,179,8,0.5) 0%, rgba(250,204,21,1) 50%, rgba(234,179,8,0.5) 100%); background-size: 200% 100%; animation: shimmer-load 2s infinite linear; box-shadow: 0 0 10px rgba(234,179,8,0.8); transition: width 0.3s; }
        .preloader-status { display: flex; align-items: center; gap: 0.75rem; }
        .preloader-status-text { font-size: 0.75rem; font-family: monospace; color: rgba(234,179,8,0.8); letter-spacing: 0.2em; text-transform: uppercase; }
        .preloader-btn { margin-top: 2.5rem; padding: 0.75rem 2.5rem; background: transparent; border: 1px solid var(--accent-gold); color: var(--accent-gold); font-weight: 700; letter-spacing: 0.2em; text-transform: uppercase; font-size: 0.875rem; border-radius: 0.25rem; cursor: pointer; transition: all 0.3s; box-shadow: 0 0 15px rgba(234,179,8,0.2); }
        .preloader-btn:hover { background: var(--accent-gold); color: var(--black); box-shadow: 0 0 25px rgba(234,179,8,0.5); }

        /* --- UI LAYER (HUD & DIALOGUE) --- */
        .ui-overlay { position: absolute; inset: 0; z-index: 50; display: flex; flex-direction: column; justify-content: space-between; padding: 1rem; pointer-events: none; }
        .ui-top-bar { display: flex; justify-content: space-between; align-items: flex-start; width: 100%; }
        
        .ui-left-panel { display: flex; flex-direction: column; gap: 0.75rem; max-width: 50%; pointer-events: auto; }
        .glass-panel { background: var(--glass-bg); backdrop-filter: blur(16px); border: 1px solid var(--glass-border); box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5); transition: background 0.3s, border-color 0.3s, color 0.3s; }
        .location-tag { color: var(--yellow-400); padding: 0.5rem 1rem; border-left: 4px solid var(--yellow-500); font-family: 'Cinzel', serif; letter-spacing: 0.1em; font-size: 0.875rem; text-transform: uppercase; display: flex; align-items: center; gap: 0.75rem; border-radius: 0 0.5rem 0.5rem 0; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); transition: transform 0.3s; }
        .location-tag:hover { transform: translateX(0.25rem); }
        .location-icon-anim { flex-shrink: 0; animation: pulse-anim 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        .location-text-wrap { overflow: hidden; }
        .location-main-text { display: block; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; filter: drop-shadow(0 4px 3px rgba(0,0,0,0.07)); }
        .location-sub-text { font-size: 10px; color: var(--gray-400); font-family: sans-serif; letter-spacing: normal; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .audio-btn-wrap { display: flex; align-items: center; gap: 0.5rem; }
        
        .ui-right-panel { display: flex; flex-direction: column; align-items: flex-end; gap: 0.75rem; pointer-events: auto; position: relative; }
        .ui-action-bar { padding: 0.5rem; border-radius: 1rem; display: flex; flex-direction: row; flex-wrap: wrap; justify-content: flex-end; gap: 0.5rem; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.1); }
        .action-divider { width: 1px; height: 2rem; background: rgba(255,255,255,0.1); margin: 0 0.25rem; align-self: center; }
        .action-lang-text { font-weight: 700; font-size: 10px; }
        
        /* Modern HUD Buttons */
        .hud-btn { position: relative; display: flex; align-items: center; justify-content: center; width: 3rem; height: 3rem; border-radius: 0.75rem; background: rgba(20, 20, 20, 0.6); border: 1px solid rgba(255, 255, 255, 0.1); color: var(--gray-400); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); overflow: hidden; backdrop-filter: blur(8px); cursor: pointer; }
        .hud-btn::after { content: ''; position: absolute; inset: 0; background: radial-gradient(circle at center, rgba(234, 179, 8, 0.2) 0%, transparent 70%); opacity: 0; transition: opacity 0.3s ease; }
        .hud-btn:hover { background: rgba(234, 179, 8, 0.9); color: var(--black); border-color: var(--yellow-400); transform: translateY(-2px); box-shadow: 0 8px 20px rgba(234, 179, 8, 0.25); }
        .hud-btn:hover::after { opacity: 1; }
        .hud-btn:active { transform: scale(0.95); }
        .hud-btn.active-mode { background: var(--accent-gold); color: var(--black); box-shadow: 0 0 15px rgba(234, 179, 8, 0.4); }
        .hud-btn-circle { border-radius: 9999px; border-color: rgba(255,255,255,0.2) !important; width: 2.5rem; height: 2.5rem; }
        .hud-btn-wide { width: 4rem; }

        /* Tooltips */
        .hud-btn .tooltip { position: absolute; top: 110%; left: 50%; transform: translateX(-50%) translateY(-10px); background: rgba(0,0,0,0.9); color: var(--accent-gold); padding: 0.25rem 0.5rem; font-size: 10px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; border-radius: 0.25rem; opacity: 0; pointer-events: none; transition: all 0.3s ease; white-space: nowrap; border: 1px solid rgba(234, 179, 8, 0.3); z-index: 100;}
        .hud-btn:hover .tooltip { opacity: 1; transform: translateX(-50%) translateY(0); }

        /* Notifications */
        .notification-toast { position: absolute; right: 0; border-left: 4px solid; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); border-radius: 0.375rem 0 0 0.375rem; padding: 0.75rem; display: flex; align-items: center; gap: 0.75rem; width: 16rem; pointer-events: none; z-index: 60; transform: translateX(120%); transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .notification-show { transform: translateX(0%); }
        .notif-unlock { top: 3rem; background: var(--white); border-color: var(--green-500); margin-bottom: 0.5rem; }
        .notif-unlock-icon { background: var(--green-100); padding: 0.375rem; border-radius: 9999px; color: var(--green-600); }
        .notif-unlock-text { font-size: 0.875rem; font-weight: 700; color: var(--gray-800); line-height: 1.25; }
        .notif-currency { top: 7rem; background: var(--gray-900); border-color: var(--yellow-500); }
        .notif-currency-icon { background: var(--gray-800); padding: 0.375rem; border-radius: 9999px; color: var(--yellow-400); }
        .notif-title { font-size: 10px; text-transform: uppercase; font-weight: 700; letter-spacing: 0.05em; color: var(--gray-500); }
        .notif-currency-text { font-size: 0.875rem; font-weight: 700; color: var(--white); line-height: 1.25; font-family: monospace; }
        .currency-positive { color: var(--green-400); text-shadow: 0 0 10px rgba(74, 222, 128, 0.5); }
        .currency-negative { color: var(--red-400); text-shadow: 0 0 10px rgba(248, 113, 113, 0.5); }

        /* Bottom UI (Dialogue & Choices) */
        .ui-bottom-panel { margin-top: auto; width: 100%; max-width: 64rem; margin-left: auto; margin-right: auto; display: flex; flex-direction: column; gap: 0.75rem; pointer-events: auto; }
        .choices-wrap { display: flex; flex-direction: column; gap: 0.5rem; align-items: center; margin-bottom: 0.5rem; transition: all 0.5s; min-height: 40px; max-height: 35vh; overflow-y: auto; padding-right: 0.25rem; pointer-events: auto; }
        .choice-btn { width: 100%; max-width: 48rem; padding: 0.75rem 1rem; text-align: left; border-radius: 0 0.5rem 0.5rem 0; position: relative; overflow: hidden; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(10px); border: none; border-left: 3px solid rgba(255, 255, 255, 0.2); border-bottom: 1px solid rgba(255, 255, 255, 0.05); color: var(--gray-200); cursor: pointer; }
        .choice-btn:active, .choice-btn:hover { transform: translateX(12px); background: linear-gradient(90deg, rgba(234, 179, 8, 0.1), transparent); border-left-color: var(--accent-gold); padding-left: 1.5rem; }
        .choice-btn-inner { position: relative; z-index: 10; display: flex; justify-content: space-between; align-items: center; }
        .choice-btn-text { font-family: 'Noto Sans Myanmar', sans-serif; font-weight: 700; font-size: 0.75rem; }
        .choice-icon-arrow { opacity: 0; transition: opacity 0.3s; color: var(--accent-gold); }
        .choice-btn:hover .choice-icon-arrow { opacity: 1; }

        .dialogue-box { padding: 1.5rem; position: relative; min-height: 10rem; cursor: pointer; transition: all 0.3s; background-color: rgba(10, 10, 10, 0.6); backdrop-filter: blur(20px) saturate(1.8); border-top: 1px solid rgba(255, 255, 255, 0.1); border-left: 1px solid rgba(255, 255, 255, 0.05); border-right: 1px solid rgba(255, 255, 255, 0.05); border-bottom: none; border-radius: 1.5rem; box-shadow: 0 -20px 60px rgba(0,0,0,0.8); pointer-events: auto; }
        .dialogue-box:hover { border-color: rgba(234, 179, 8, 0.3); }
        .speaker-wrapper { position: absolute; top: -0.75rem; left: 1.5rem; z-index: 10; }
        .speaker-box { padding: 0.375rem 1.5rem; font-size: 0.75rem; font-weight: 700; letter-spacing: 0.2em; text-transform: uppercase; transform: skewX(-12deg); box-shadow: 0 5px 20px rgba(0,0,0,0.5); border-left: 4px solid; transition: background-color 0.3s, border-color 0.3s, color 0.3s; color: var(--white); }
        .speaker-text { transform: skewX(12deg); display: inline-block; font-family: 'Noto Sans Myanmar', sans-serif; }
        .dialogue-text-el { font-size: 1.125rem; line-height: 1.625; color: var(--gray-200); font-weight: 500; letter-spacing: 0.025em; font-family: 'Noto Sans Myanmar', sans-serif; position: relative; z-index: 0; margin-top: 0.5rem; filter: drop-shadow(0 4px 3px rgba(0,0,0,0.07)); transition: all 0.3s; margin-bottom: 0; }
        
        .cursor::after { content: 'â–‹'; animation: blink 1s infinite; color: var(--accent-gold); margin-left: 2px;}
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

        .dialogue-next-wrap { position: absolute; bottom: 1rem; right: 1.5rem; color: var(--accent-gold); opacity: 0; transition: opacity 0.3s; }
        .dialogue-next-anim { animation: bounce-anim 1s infinite; display: flex; flex-direction: column; align-items: center; }

        /* Speaker Colors */
        .speaker-unknown { background-color: #451a03; border-color: #a8a29e; }
        .speaker-tayza { background-color: #1e3a8a; border-color: #3b82f6; }
        .speaker-nay { background-color: #581c87; border-color: #a855f7; }
        .speaker-mom { background-color: #9a3412; border-color: #f97316; }
        .speaker-dad { background-color: #7c2d12; border-color: #f97316; }
        .speaker-bro { background-color: #14532d; border-color: #22c55e; }
        .speaker-kyaw { background-color: #115e59; border-color: #14b8a6; }
        .speaker-nurse { background-color: #831843; border-color: #ec4899; }
        .speaker-guard { background-color: #7f1d1d; border-color: #ef4444; }
        .speaker-driver { background-color: #1f2937; border-color: #6b7280; }
        .speaker-monk { background-color: #7c2d12; border-color: #eab308; }
        .speaker-librarian { background-color: #312e81; border-color: #6366f1; }
        .speaker-default { background-color: #334155; border-color: #9ca3af; }

        /* --- MAP MODAL --- */
        .modal-overlay { position: absolute; inset: 0; z-index: 100; background-color: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; padding: 1rem; backdrop-filter: blur(4px); transition: all 0.3s; }
        .map-modal-content { position: relative; width: 100%; max-width: 72rem; height: 85vh; background-color: #f8f9fa; border-radius: 0.75rem; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); font-family: 'Roboto', sans-serif; color: var(--gray-800); border: 4px solid rgba(255,255,255,0.5); display: flex; flex-direction: column; }
        .map-search-bar { position: absolute; top: 1rem; left: 1rem; right: 4rem; height: 3rem; background: var(--white); border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); display: flex; align-items: center; padding: 0 1rem; gap: 0.75rem; z-index: 50; }
        .map-search-text { font-size: 0.875rem; color: var(--gray-700); font-weight: 500; }
        .map-search-icon { color: var(--blue-500); margin-left: auto; }
        .map-controls { position: absolute; bottom: 1.5rem; right: 1rem; display: flex; flex-direction: column; gap: 0.5rem; z-index: 50; }
        .map-control-btn { background: var(--white); padding: 0.5rem; border-radius: 0.25rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); color: var(--gray-600); cursor: pointer; transition: transform 0.1s, color 0.2s; }
        .map-control-btn:active { transform: scale(0.95); }
        .map-control-btn:hover { color: var(--black); }
        .map-close-btn { position: absolute; top: 1rem; right: 1rem; background: var(--white); color: var(--gray-600); padding: 0.5rem; border-radius: 9999px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); z-index: 50; transition: background-color 0.2s; cursor: pointer; border: none; }
        .map-close-btn:hover { background-color: var(--gray-100); }
        
        .map-container-area { width: 100%; height: 100%; position: relative; cursor: grab; overflow: hidden; background-color: #a5d6e0; }
        .map-container-area:active { cursor: grabbing; }
        .map-world-area { position: absolute; inset: 0; width: 100%; height: 100%; transform-origin: center center; will-change: transform; }
        .map-bg-water { position: absolute; inset: 0; background-color: #a5d6e0; opacity: 1; }
        .map-layer { position: absolute; inset: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; }
        .map-layer-roads { z-index: 5; }
        .map-layer-pins { z-index: 10; pointer-events: auto; }
        
        .road-border { stroke: #d1d5db; stroke-width: 8; stroke-linecap: round; stroke-linejoin: round; fill: none; filter: drop-shadow(0 1px 1px rgba(0,0,0,0.1)); }
        .road-line { stroke: #ffffff; stroke-width: 5; stroke-linecap: round; stroke-linejoin: round; fill: none; }

        .map-pin-wrap { position: absolute; display: flex; flex-direction: column; align-items: center; transition: all 0.2s ease; transform: translate(-50%, -100%); }
        .map-pin-wrap:hover { transform: translate(-50%, -100%) scale(1.1); z-index: 100 !important; }
        .map-pin-unlocked { z-index: 20; cursor: pointer; }
        .map-pin-locked { z-index: 10; cursor: not-allowed; filter: grayscale(1); opacity: 0.8; }
        
        .map-pin-player { position: absolute; top: -3rem; z-index: 50; animation: bounce-anim 1s infinite; }
        .map-pin-player-img { width: 2.5rem; height: 2.5rem; border-radius: 50%; border: 2px solid var(--yellow-400); box-shadow: 0 0 15px rgba(250,204,21,0.6); background: var(--white); }
        .map-pin-player-arrow { position: absolute; bottom: -0.25rem; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 6px solid transparent; border-right: 6px solid transparent; border-top: 6px solid var(--yellow-400); }
        
        .map-pin-icon-wrap { position: relative; animation: bounce-pin 2s infinite ease-in-out; }
        .map-pin-shadow { position: absolute; bottom: 0; left: 50%; transform: translateX(-50%) translateY(0.25rem); width: 1.5rem; height: 0.5rem; background: rgba(0,0,0,0.3); border-radius: 50%; filter: blur(2px); }
        .map-pin-icon { width: 2.5rem; height: 2.5rem; object-fit: contain; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1)); }
        .map-pin-locked-icon { opacity: 0.6; }
        .map-pin-locked-badge { position: absolute; top: -0.25rem; right: -0.25rem; background: rgba(220, 38, 38, 0.9); border-radius: 50%; padding: 0.125rem; border: 1px solid var(--white); box-shadow: 0 1px 2px rgba(0,0,0,0.05); z-index: 10; }
        
        .map-pin-tooltip { margin-top: 0.25rem; background: var(--white); color: var(--gray-800); font-size: 10px; padding: 0.25rem 0.5rem; font-weight: 700; border-radius: 0.25rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); opacity: 0; transition: opacity 0.3s; white-space: nowrap; border: 1px solid var(--gray-200); position: relative; z-index: 50; }
        .map-pin-wrap:hover .map-pin-tooltip { opacity: 1; }
        .map-pin-locked-tooltip { background: var(--gray-200); color: var(--gray-500); border-color: var(--gray-300); opacity: 1; }
        .map-bg-tree { position: absolute; width: 1rem; height: 1rem; z-index: 0; opacity: 0.9; }

        /* --- PHONE MODAL --- */
        .phone-modal-container { perspective: 1000px; backdrop-filter: blur(12px); background-color: rgba(0,0,0,0.7); }
        .phone-hardware { position: relative; }
        .phone-power-btn { position: absolute; top: 6rem; right: -0.5rem; width: 0.5rem; height: 3rem; background: var(--gray-700); border-radius: 0 0.5rem 0.5rem 0; cursor: pointer; z-index: 0; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); transition: background-color 0.2s; }
        .phone-power-btn:hover { background: var(--gray-600); }
        .phone-power-btn:active { background: var(--gray-800); }
        .phone-vol-btn-1 { position: absolute; top: 6rem; left: -0.5rem; width: 0.375rem; height: 2rem; background: var(--gray-700); border-radius: 0.5rem 0 0 0.5rem; z-index: 0; }
        .phone-vol-btn-2 { position: absolute; top: 9rem; left: -0.5rem; width: 0.375rem; height: 2rem; background: var(--gray-700); border-radius: 0.5rem 0 0 0.5rem; z-index: 0; }
        
        .phone-screen-container { position: relative; width: 320px; height: 640px; background: var(--gray-900); border-radius: 3rem; border: 8px solid var(--gray-800); box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5), inset 0 0 10px rgba(255,255,255,0.1); overflow: hidden; display: flex; flex-direction: column; z-index: 10; }
        .phone-status-bar { height: 2rem; background: var(--black); width: 100%; display: flex; justify-content: space-between; align-items: center; padding: 0 1.5rem; font-size: 10px; color: var(--white); z-index: 50; }
        .phone-status-icons { display: flex; gap: 0.25rem; }
        .phone-display-area { flex: 1; background: var(--gray-900); overflow: hidden; position: relative; }
        
        .phone-home-screen { width: 100%; height: 100%; position: absolute; inset: 0; background-image: url('../images/items/iphonewallpaper.png'); background-size: cover; background-position: center; padding: 1.5rem; padding-top: 3rem; }
        .phone-app-grid { display: grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap: 1rem; align-content: start; }
        .app-icon-wrap { display: flex; flex-direction: column; align-items: center; gap: 0.25rem; cursor: pointer; transition: transform 0.1s; }
        .app-icon-wrap:active { transform: scale(0.9); filter: brightness(0.8); }
        .app-icon-box { width: 3rem; height: 3rem; border-radius: 1rem; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); position: relative; overflow: hidden; }
        .app-icon-label { font-size: 10px; color: var(--white); font-weight: 500; filter: drop-shadow(0 4px 3px rgba(0,0,0,0.5)); }
        
        .bg-app-phone { background: var(--green-500); }
        .bg-app-msg { background: var(--green-400); }
        .bg-app-photo { background: var(--white); }
        .bg-app-photo-grad { position: absolute; inset: 0; background: linear-gradient(to top right, #fbbf24, #ec4899, #9333ea); opacity: 0.8; }
        .app-photo-icon { position: relative; z-index: 10; color: var(--white); }
        .bg-app-camera { background: var(--gray-400); }
        .bg-app-fb { background: var(--blue-600); }
        .bg-app-yt { background: var(--red-600); }
        .bg-app-spotify { background: #1DB954; }
        .bg-app-kbz { background: var(--blue-700); border: 2px solid rgba(255,255,255,0.2); }
        
        .app-spotify-svg { width: 1.75rem; height: 1.75rem; fill: currentColor; color: var(--white); }
        .app-kbz-text { font-size: 0.75rem; font-weight: 900; color: var(--white); }
        .opacity-80 { opacity: 0.8; }

        .phone-active-app { position: absolute; inset: 0; background: var(--white); transition: transform 0.3s; z-index: 20; display: flex; flex-direction: column; }
        .app-screen-hidden { transform: translateX(100%); }
        .app-screen-active { transform: translateX(0%); }
        
        .app-header-bar { height: 3rem; background: var(--gray-100); border-bottom: 1px solid var(--gray-200); display: flex; align-items: center; padding: 0 1rem; font-weight: 700; color: var(--gray-800); box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05); z-index: 30; position: relative; transition: background-color 0.3s, color 0.3s; }
        .app-back-btn { padding: 0.25rem; margin-left: -0.5rem; border-radius: 9999px; transition: background-color 0.2s; background: transparent; border: none; cursor: pointer; color: var(--blue-500); display: flex; align-items: center; justify-content: center; }
        .app-back-btn:hover { background-color: var(--gray-200); }
        .app-title-text { margin-left: 0.5rem; font-size: 0.875rem; }
        .app-content-area { flex: 1; overflow-y: auto; position: relative; background: var(--white); }
        
        .phone-home-indicator-wrap { position: absolute; bottom: 0.5rem; left: 50%; transform: translateX(-50%); width: 100%; height: 2rem; z-index: 50; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .phone-home-indicator { width: 8rem; height: 0.25rem; background: rgba(255,255,255,0.5); border-radius: 9999px; transition: background-color 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .phone-home-indicator-wrap:hover .phone-home-indicator { background: var(--white); }

        /* Specific App Styles */
        /* Phone App */
        .app-dialer-wrap { height: 100%; display: flex; flex-direction: column; }
        .app-dialer-top { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 1.5rem; }
        .app-dialer-display { font-size: 2.25rem; color: var(--gray-800); font-weight: 300; margin-bottom: 2rem; min-height: 2.5rem; }
        .app-dialer-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; color: var(--gray-800); font-weight: 500; font-size: 1.5rem; }
        .app-dialer-btn { width: 4rem; height: 4rem; border-radius: 50%; background: var(--gray-100); display: flex; align-items: center; justify-content: center; border: none; cursor: pointer; transition: background 0.2s; }
        .app-dialer-btn:hover { background: var(--gray-200); }
        .app-dialer-btn-call { width: 5rem; height: 5rem; background: var(--green-500); color: var(--white); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border: none; cursor: pointer; margin-top: 2rem; }
        .app-dialer-bottom { height: 4rem; border-top: 1px solid var(--gray-200); display: flex; justify-content: space-around; align-items: center; font-size: 0.75rem; color: var(--gray-500); font-weight: 500; background: var(--gray-50); }
        .app-dialer-tab { display: flex; flex-direction: column; align-items: center; gap: 0.25rem; }
        .app-dialer-tab-active { color: var(--blue-500); }
        
        /* Messages App */
        .app-msg-wrap { padding: 1rem; display: flex; flex-direction: column; gap: 1rem; }
        .app-msg-item { display: flex; gap: 0.75rem; align-items: center; border-bottom: 1px solid var(--gray-100); padding-bottom: 0.75rem; }
        .app-msg-avatar { width: 2.5rem; height: 2.5rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; }
        .app-msg-content { flex: 1; min-width: 0; }
        .app-msg-header-row { display: flex; justify-content: space-between; align-items: baseline; }
        .app-msg-name { font-weight: 700; color: var(--gray-800); }
        .app-msg-time { font-size: 0.75rem; color: var(--gray-400); }
        .app-msg-text { font-size: 0.875rem; color: var(--gray-500); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .bg-orange-light { background: #fed7aa; color: #ea580c; }
        .bg-purple-light { background: #e9d5ff; color: #9333ea; }
        .bg-blue-light { background: #bfdbfe; color: #2563eb; }
        .bg-gray-light { background: #e5e7eb; color: #4b5563; }
        
        /* Facebook App */
        .app-fb-wrap { background: var(--gray-200); min-height: 100%; }
        .app-fb-create { background: var(--white); padding: 0.75rem; margin-bottom: 0.5rem; }
        .app-fb-create-row { display: flex; gap: 0.5rem; }
        .app-fb-avatar { width: 2rem; height: 2rem; background: var(--gray-300); border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .app-fb-input { flex: 1; background: var(--gray-100); border-radius: 9999px; padding: 0 0.75rem; display: flex; align-items: center; font-size: 0.875rem; color: var(--gray-500); }
        .app-fb-post { background: var(--white); padding: 0.75rem; margin-bottom: 0.5rem; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .app-fb-post-header { display: flex; gap: 0.5rem; align-items: center; margin-bottom: 0.5rem; }
        .app-fb-post-author { font-size: 0.875rem; font-weight: 700; color: var(--gray-800); }
        .app-fb-post-time { font-size: 0.75rem; color: var(--gray-400); }
        .app-fb-post-text { font-size: 0.875rem; color: var(--gray-800); margin-bottom: 0.5rem; }
        .app-fb-post-img { width: 100%; height: 8rem; background: var(--gray-300); border-radius: 0.25rem; margin-bottom: 0.5rem; background-size: cover; background-position: center; }
        .app-fb-post-img-large { height: 12rem; }
        .app-fb-post-actions { border-top: 1px solid var(--gray-200); padding-top: 0.5rem; display: flex; justify-content: space-between; color: var(--gray-500); font-size: 0.875rem; }
        .app-fb-action-btn { display: flex; align-items: center; gap: 0.25rem; }
        
        /* YouTube App */
        .app-yt-wrap { background: var(--black); color: var(--white); min-height: 100%; }
        .app-yt-post { padding: 0.5rem; border-bottom: 1px solid var(--gray-800); }
        .app-yt-thumb { width: 100%; height: 10rem; background: var(--gray-800); margin-bottom: 0.5rem; background-size: cover; background-position: center; position: relative; }
        .app-yt-duration { position: absolute; bottom: 0.5rem; right: 0.5rem; background: rgba(0,0,0,0.8); font-size: 0.75rem; padding: 0 0.25rem; border-radius: 0.25rem; }
        .app-yt-info { display: flex; gap: 0.5rem; }
        .app-yt-avatar { width: 2rem; height: 2rem; border-radius: 50%; }
        .app-yt-text-wrap { flex: 1; }
        .app-yt-title { font-size: 0.875rem; font-weight: 700; line-height: 1.25; margin-bottom: 0.25rem; }
        .app-yt-meta { font-size: 0.75rem; color: var(--gray-400); }
        
        /* Photos App */
        .app-photo-grid { padding: 0.25rem; display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.25rem; }
        .app-photo-item { aspect-ratio: 1 / 1; background: var(--gray-200); background-size: cover; background-position: center; }
        
        /* Spotify App */
        .app-sp-wrap { height: 100%; display: flex; flex-direction: column; background: linear-gradient(to bottom, var(--gray-900), var(--black)); color: var(--white); position: relative; }
        .app-sp-header { display: flex; justify-content: space-between; align-items: center; padding: 1.5rem 1rem 1rem; z-index: 10; }
        .app-sp-btn-icon { color: var(--white); background: transparent; padding: 0.25rem; border-radius: 50%; border: none; cursor: pointer; transition: background 0.2s; }
        .app-sp-btn-icon:hover { background: rgba(255,255,255,0.1); }
        .app-sp-header-text { font-size: 0.75rem; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; color: var(--gray-300); }
        .app-sp-art-wrap { flex: 1; display: flex; align-items: center; justify-content: center; padding: 1.5rem; z-index: 10; }
        .app-sp-art-box { width: 100%; aspect-ratio: 1 / 1; background: var(--gray-800); box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); border-radius: 0.375rem; overflow: hidden; }
        .app-sp-img { width: 100%; height: 100%; object-fit: cover; }
        .app-sp-controls { padding: 0 1.5rem 2rem; z-index: 10; background: linear-gradient(to top, var(--black), rgba(0,0,0,0.5), transparent); }
        .app-sp-info-row { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 1.5rem; }
        .app-sp-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 0.25rem; }
        .app-sp-artist { color: var(--gray-400); font-size: 0.875rem; }
        .app-sp-progress-wrap { margin-bottom: 0.5rem; }
        .app-sp-progress-bg { width: 100%; height: 0.25rem; background: var(--gray-600); border-radius: 9999px; position: relative; cursor: pointer; }
        .app-sp-progress-fill { position: absolute; left: 0; top: 0; height: 100%; background: var(--white); border-radius: 9999px; width: 0; transition: all 0.3s; }
        .app-sp-progress-thumb { position: absolute; top: -0.25rem; margin-left: -0.375rem; width: 0.75rem; height: 0.75rem; background: var(--white); border-radius: 50%; opacity: 0; transition: opacity 0.2s; left: 0%; }
        .app-sp-progress-bg:hover .app-sp-progress-thumb { opacity: 1; }
        .app-sp-times { display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--gray-400); font-weight: 500; margin-bottom: 1.5rem; }
        .app-sp-playback { display: flex; justify-content: space-between; align-items: center; }
        .app-sp-play-btn { width: 4rem; height: 4rem; background: var(--green-500); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--black); border: none; cursor: pointer; transition: transform 0.2s; box-shadow: 0 10px 15px -3px rgba(34, 197, 94, 0.2); }
        .app-sp-play-btn:hover { transform: scale(1.05); }
        .app-sp-ctrl-btn { color: var(--white); background: transparent; border: none; cursor: pointer; transition: transform 0.2s; }
        .app-sp-ctrl-btn:hover { transform: scale(1.1); }
        .app-sp-ctrl-btn-dim { color: var(--gray-400); transition: color 0.2s; background: transparent; border: none; cursor: pointer; }
        .app-sp-ctrl-btn-dim:hover { color: var(--white); }
        
        /* KBZPay App */
        .app-kbz-wrap { flex: 1; background: var(--gray-100); display: flex; flex-direction: column; align-items: center; padding-top: 1.5rem; position: relative; min-height: 100%; }
        .app-kbz-card { width: 91.666%; background: var(--blue-600); border-radius: 0.75rem; padding: 1.25rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); margin-bottom: 1.5rem; color: var(--white); position: relative; overflow: hidden; }
        .app-kbz-card-deco { position: absolute; right: -1rem; top: -1rem; width: 6rem; height: 6rem; background: rgba(255,255,255,0.1); border-radius: 50%; }
        .app-kbz-label { font-size: 0.75rem; color: #dbeafe; text-transform: uppercase; letter-spacing: 0.1em; }
        .app-kbz-balance-row { display: flex; align-items: baseline; gap: 0.25rem; margin-top: 0.25rem; }
        .app-kbz-balance { font-size: 1.875rem; font-weight: 700; letter-spacing: -0.025em; }
        .app-kbz-currency { font-size: 0.875rem; font-weight: 500; color: #bfdbfe; }
        .app-kbz-actions { display: flex; justify-content: space-between; margin-top: 1rem; }
        .app-kbz-action { display: flex; flex-direction: column; align-items: center; gap: 0.25rem; cursor: pointer; }
        .app-kbz-action-icon { width: 2rem; height: 2rem; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .app-kbz-action-text { font-size: 10px; }
        .app-kbz-history-wrap { width: 91.666%; }
        .app-kbz-history-title { font-size: 0.75rem; color: var(--gray-500); margin-bottom: 0.5rem; text-transform: uppercase; font-weight: 700; padding: 0 0.25rem; }
        .app-kbz-history-list { display: flex; flex-direction: column; gap: 0.5rem; }
        .app-kbz-history-item { background: var(--white); padding: 0.75rem; border-radius: 0.5rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 2px rgba(0,0,0,0.05); border: 1px solid var(--gray-100); }
        .app-kbz-history-left { display: flex; align-items: center; gap: 0.75rem; }
        .app-kbz-history-icon-box { width: 2rem; height: 2rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .app-kbz-history-info { font-size: 0.75rem; }
        .app-kbz-history-type { color: var(--gray-800); font-weight: 700; }
        .app-kbz-history-date { color: var(--gray-500); }
        .app-kbz-history-amount { font-size: 0.75rem; font-family: monospace; font-weight: 700; }
        .text-green-600 { color: var(--green-600); }
        .text-red-600 { color: var(--red-600); }
        .bg-green-100 { background: var(--green-100); }
        .bg-red-100 { background: var(--red-100); }


        /* --- SETTINGS MODAL --- */
        .ios-glass { background: rgba(30, 30, 30, 0.55); backdrop-filter: blur(40px) saturate(200%); border: 1px solid rgba(255, 255, 255, 0.15); box-shadow: 0 40px 80px rgba(0,0,0,0.5), inset 0 1px 1px rgba(255,255,255,0.1); color: rgba(255, 255, 255, 0.9); }
        .settings-modal-content { position: relative; width: 100%; max-width: 42rem; border-radius: 1.5rem; padding: 1.5rem; display: flex; flex-direction: column; gap: 1.5rem; transition: background-color 0.3s, border-color 0.3s, color 0.3s; }
        .settings-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 1rem; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .settings-title { font-size: 1.5rem; font-family: 'Cinzel', serif; font-weight: 700; color: var(--accent-gold); letter-spacing: 0.05em; margin: 0; }
        .ios-close-btn { background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.8); border-radius: 50%; transition: all 0.3s cubic-bezier(0.2, 0, 0, 1); padding: 0.5rem; display: flex; align-items: center; justify-content: center; border: none; cursor: pointer; }
        .ios-close-btn:hover { background: rgba(255,255,255,0.2); color: var(--white); transform: scale(1.1) rotate(90deg); }
        
        .settings-list { display: flex; flex-direction: column; gap: 1.5rem; overflow-y: auto; max-height: 65vh; padding-right: 0.5rem; }
        .settings-row { display: flex; flex-direction: column; justify-content: space-between; gap: 1rem; position: relative; z-index: 10; }
        .settings-label-wrap { display: flex; align-items: center; gap: 0.5rem; position: relative; cursor: help; width: max-content; }
        .settings-label { font-weight: 700; font-size: 1rem; letter-spacing: 0.025em; opacity: 0.9; }
        
        .ios-segmented-control { background: rgba(0, 0, 0, 0.25); border-radius: 1rem; padding: 0.25rem; box-shadow: inset 0 1px 5px rgba(0,0,0,0.3); display: flex; width: 100%; }
        .ios-segment-btn { flex: 1; position: relative; z-index: 1; transition: color 0.4s ease, transform 0.2s cubic-bezier(0.2, 0, 0, 1), background 0.3s; border-radius: 0.75rem; overflow: hidden; color: rgba(255, 255, 255, 0.6); font-weight: 500; padding: 0.5rem 1.25rem; font-size: 0.875rem; border: none; cursor: pointer; background: transparent; }
        .ios-segment-btn::before { content: ''; position: absolute; top: 50%; left: 50%; width: 0; height: 0; background: radial-gradient(circle, rgba(255,255,255,0.15) 0%, transparent 70%); transform: translate(-50%, -50%); border-radius: 50%; opacity: 0; transition: width 0.5s ease-out, height 0.5s ease-out, opacity 0.5s ease-out; z-index: -1; pointer-events: none; }
        .ios-segment-btn:hover:not(.st-btn-active)::before { width: 200%; height: 200%; padding-top: 200%; opacity: 1; }
        .ios-segment-btn.st-btn-active { color: #ffffff; font-weight: 700; background: rgba(255, 255, 255, 0.15); box-shadow: 0 4px 12px rgba(0,0,0,0.2), inset 0 1px 1px rgba(255,255,255,0.1); }
        
        .ios-slider { -webkit-appearance: none; width: 100%; height: 0.5rem; background: rgba(255,255,255,0.2); border-radius: 0.5rem; outline: none; box-shadow: inset 0 1px 3px rgba(0,0,0,0.3); }
        .ios-slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 1.75rem; height: 1.75rem; border-radius: 50%; background: #ffffff; box-shadow: 0 2px 10px rgba(0,0,0,0.3), 0 0 0 1px rgba(0,0,0,0.05); cursor: pointer; transition: transform 0.3s cubic-bezier(0.2, 0, 0, 1), box-shadow 0.3s; }
        .ios-slider::-webkit-slider-thumb:hover { transform: scale(1.15); box-shadow: 0 6px 16px rgba(0,0,0,0.4), 0 0 0 1px rgba(0,0,0,0.05); }
        
        .settings-tooltip { position: absolute; left: 0; top: 100%; margin-top: 0.5rem; width: 12rem; padding: 0.75rem; border-radius: 0.75rem; font-size: 0.75rem; opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 50; background: rgba(20, 20, 20, 0.85); backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 15px 35px rgba(0,0,0,0.5); color: rgba(255,255,255,0.9); }
        .settings-label-wrap:hover .settings-tooltip { opacity: 1; }

        /* Dynamic Settings Overrides */
        body.font-sm .dialogue-text-el { font-size: 0.875rem !important; line-height: 1.5rem !important; }
        body.font-sm .choice-btn-text { font-size: 0.625rem !important; }
        body.font-lg .dialogue-text-el { font-size: 1.5rem !important; line-height: 2.25rem !important; }
        body.font-lg .choice-btn-text { font-size: 1rem !important; }
        
        body.gfx-low .glass-panel, body.gfx-low .dialogue-box { backdrop-filter: none !important; background-color: rgba(15,15,15,0.95) !important; box-shadow: none !important; }
        body.gfx-low .scanlines, body.gfx-low .rain-overlay, body.gfx-low .start-grain { display: none !important; }
        body.gfx-low .camera-move { animation: none !important; transform: scale(1.0) !important; }
        body.gfx-low .world-real { filter: brightness(1.1) !important; }
        body.gfx-low .world-parallel { filter: brightness(0.7) !important; }
        body.gfx-low .world-collapse { animation: none !important; filter: contrast(1.2) grayscale(1) !important; }
        
        body.gfx-med .glass-panel, body.gfx-med .dialogue-box { backdrop-filter: blur(4px) !important; }
        body.gfx-med .camera-move { animation-duration: 120s !important; }

        /* Light Theme */
        body.theme-light { background-color: var(--gray-100); color: var(--gray-800); }
        body.theme-light .start-screen-overlay { background-color: var(--gray-50); }
        body.theme-light .start-gradient { background: linear-gradient(to right, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0.85) 40%, rgba(255,255,255,0.2) 100%); }
        body.theme-light .game-title { -webkit-text-fill-color: var(--gray-900); text-shadow: 0px 4px 10px rgba(255,255,255,0.8); }
        body.theme-light .start-desc-1 { color: var(--gray-700); }
        body.theme-light .start-desc-2 { color: var(--gray-500); }
        body.theme-light .menu-item { color: var(--gray-600); }
        body.theme-light .menu-item:hover { color: var(--gray-900); text-shadow: none; }
        body.theme-light .menu-item.menu-primary { color: var(--accent-gold-hover); }
        body.theme-light .menu-item::before { background: var(--accent-gold-hover); box-shadow: none; }
        
        body.theme-light .glass-panel, body.theme-light .dialogue-box { background: rgba(255, 255, 255, 0.85) !important; border-color: rgba(0, 0, 0, 0.1) !important; box-shadow: 0 10px 40px rgba(0,0,0,0.1) !important; }
        body.theme-light .dialogue-text-el { color: var(--gray-900) !important; text-shadow: none; }
        body.theme-light .choice-btn { background: rgba(0,0,0,0.03); color: var(--gray-800); border-left-color: rgba(0,0,0,0.1); border-bottom-color: rgba(0,0,0,0.05); }
        body.theme-light .choice-btn:hover { background: rgba(234, 179, 8, 0.15); border-left-color: var(--accent-gold-hover); }
        body.theme-light .hud-btn { background: rgba(255,255,255,0.7); color: var(--gray-600); border-color: rgba(0,0,0,0.1); }
        body.theme-light .hud-btn:hover { background: var(--accent-gold-hover); color: var(--white); border-color: var(--accent-gold-hover); }
        body.theme-light .hud-btn.active-mode { background: var(--accent-gold-hover); color: var(--white); }
        body.theme-light .speaker-box { background-color: var(--gray-50); color: var(--accent-gold-hover); border-color: var(--accent-gold-hover); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }

        body.theme-light .ios-glass { background: rgba(250, 250, 250, 0.7); border: 1px solid rgba(0, 0, 0, 0.08); box-shadow: 0 40px 80px rgba(0,0,0,0.15), inset 0 1px 1px rgba(255,255,255,0.8); color: #1c1c1e; }
        body.theme-light .settings-header { border-bottom: 1px solid rgba(0, 0, 0, 0.1); }
        body.theme-light .ios-segmented-control { background: rgba(118, 118, 128, 0.12); box-shadow: inset 0 1px 3px rgba(0,0,0,0.05); }
        body.theme-light .ios-segment-btn { color: rgba(0, 0, 0, 0.6); }
        body.theme-light .ios-segment-btn::before { background: radial-gradient(circle, rgba(0,0,0,0.08) 0%, transparent 70%); }
        body.theme-light .ios-segment-btn.st-btn-active { color: #000000; background: #ffffff; box-shadow: 0 3px 8px rgba(0,0,0,0.12), inset 0 1px 1px rgba(255,255,255,1); }
        body.theme-light .ios-slider { background: rgba(0,0,0,0.1); box-shadow: inset 0 1px 3px rgba(0,0,0,0.1); }
        body.theme-light .ios-slider::-webkit-slider-thumb { box-shadow: 0 2px 8px rgba(0,0,0,0.2), 0 0 0 1px rgba(0,0,0,0.02); }
        body.theme-light .settings-tooltip { background: rgba(255, 255, 255, 0.95); border: 1px solid rgba(0,0,0,0.05); box-shadow: 0 15px 35px rgba(0,0,0,0.15); color: #1c1c1e; }
        body.theme-light .ios-close-btn { background: rgba(0,0,0,0.05); color: rgba(0,0,0,0.6); }
        body.theme-light .ios-close-btn:hover { background: rgba(0,0,0,0.1); color: #000; }

        /* --- START SCREEN (MAIN MENU) --- */
        .start-screen-overlay { position: absolute; inset: 0; z-index: 80; display: flex; background: var(--black); overflow: hidden; transition: background-color 0.3s; }
        .start-video { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; opacity: 1; z-index: 0; }
        .start-grain { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; opacity: 0.05; background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E"); transition: opacity 0.3s; }
        .start-gradient { position: absolute; inset: 0; background: linear-gradient(to right, rgba(0,0,0,0.95), rgba(0,0,0,0.8), rgba(0,0,0,0.3)); z-index: 10; transition: background 0.3s; }
        .start-layout { position: relative; z-index: 20; width: 100%; height: 100%; display: flex; flex-direction: column; padding: 2rem; align-items: center; }
        .start-left-col { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: flex-start; gap: 2rem; max-width: 48rem; width: 100%; }
        
        .edition-badge { display: inline-flex; align-items: center; gap: 0.5rem; border: 1px solid rgba(255,255,255,0.2); padding: 0.5rem 1.5rem; border-radius: 9999px; background: rgba(0,0,0,0.4); backdrop-filter: blur(12px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .edition-dot { width: 0.5rem; height: 0.5rem; border-radius: 9999px; background: var(--accent-gold); animation: pulse-anim 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        .edition-text { color: var(--gray-300); letter-spacing: 0.3em; font-size: 0.625rem; text-transform: uppercase; font-weight: 600; }
        
        .game-title { font-size: 3.75rem; font-weight: 900; background-clip: text; -webkit-background-clip: text; color: transparent; background-image: linear-gradient(to bottom, var(--white), var(--gray-200), var(--gray-500)); filter: drop-shadow(0 25px 25px rgba(0,0,0,0.15)); line-height: 0.9; letter-spacing: -0.05em; margin: 0; }
        .game-subtitle { background-image: linear-gradient(to right, var(--gray-100), var(--gray-400)); transition: color 0.3s; }
        
        .start-desc-wrap { display: flex; flex-direction: column; gap: 1rem; border-left: 2px solid rgba(255,255,255,0.3); padding-left: 1.5rem; }
        .start-desc-1 { color: var(--gray-300); font-size: 1.125rem; font-weight: 300; letter-spacing: 0.025em; opacity: 0.9; max-width: 36rem; transition: color 0.3s; margin: 0; }
        .start-desc-2 { color: var(--gray-500); font-size: 0.875rem; max-width: 36rem; line-height: 1.625; font-family: sans-serif; opacity: 0.8; transition: color 0.3s; margin: 0; }
        
        .start-right-col { width: 100%; display: flex; flex-direction: column; justify-content: center; align-items: flex-start; padding-left: 0; margin-top: 3rem; position: relative; }
        .start-divider { display: none; position: absolute; left: 0; top: 50%; transform: translateY(-50%); width: 1px; height: 60%; background: linear-gradient(to bottom, transparent, rgba(255,255,255,0.2), transparent); }
        .menu-list { display: flex; flex-direction: column; width: 100%; gap: 0.5rem; }
        
        .menu-item { position: relative; padding: 0.875rem 0; font-family: 'Cinzel', serif; font-size: 1.1rem; letter-spacing: 0.15em; color: rgba(255, 255, 255, 0.6); transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); cursor: pointer; width: 100%; text-align: left; display: flex; align-items: center; gap: 1rem; border: none; background: transparent; border-bottom: 1px solid rgba(255, 255, 255, 0.05); }
        .menu-item::before { content: ''; position: absolute; left: 0; bottom: 0; width: 0; height: 1px; background: var(--accent-gold); transition: width 0.4s ease; box-shadow: 0 0 8px var(--accent-gold); }
        .menu-item:hover { color: var(--white); padding-left: 1.25rem; text-shadow: 0 0 15px rgba(234, 179, 8, 0.6); border-bottom-color: transparent; }
        .menu-item:hover::before { width: 100%; }
        .menu-icon-box { opacity: 0; transform: translateX(-10px); transition: all 0.3s ease; color: var(--accent-gold); }
        .menu-item:hover .menu-icon-box { opacity: 1; transform: translateX(0); }
        .menu-primary { font-size: 1.4rem; color: var(--accent-gold); font-weight: 700; margin-bottom: 0.5rem; border-bottom: 1px solid rgba(234, 179, 8, 0.3); }
        .menu-primary:hover { color: var(--white); background: linear-gradient(90deg, rgba(234, 179, 8, 0.15), transparent); }
        .menu-danger { color: var(--red-500); border-bottom-color: rgba(239, 68, 68, 0.2); }
        .menu-danger-icon { color: var(--red-500); }

        /* --- MEDIA QUERIES (Responsive) --- */
        @media (min-width: 768px) {
            .ui-overlay { padding: 2rem; }
            .dialogue-box { padding: 2rem; min-height: 12.5rem; }
            .speaker-wrapper { top: -1rem; left: 2.5rem; }
            .speaker-box { padding: 0.375rem 1.5rem; font-size: 0.875rem; }
            .choice-btn { padding: 1rem; }
            .choice-btn-text { font-size: 0.875rem; }
            .choice-icon-arrow { width: 1rem; height: 1rem; }
            .preloader-title { font-size: 1.5rem; }
            .preloader-desc { font-size: 1rem; }
            .start-layout { flex-direction: row; padding: 4rem; align-items: stretch; }
            .edition-text { font-size: 0.75rem; }
            .game-title { font-size: 6rem; }
            .start-desc-1 { font-size: 1.5rem; }
            .start-desc-2 { font-size: 1rem; }
            .start-right-col { width: 25rem; padding-left: 4rem; margin-top: 0; }
            .start-divider { display: block; }
            .settings-modal-content { padding: 2rem; }
            .settings-row { flex-direction: row; align-items: center; }
            .settings-control-wrap { width: auto; }
            .ios-segment-btn { flex: none; }
            .ios-slider { width: 14rem; }
            .map-search-bar { right: auto; width: 20rem; }
        }
        @media (min-width: 1024px) {
            .game-title { font-size: 9rem; }
            .start-layout { padding: 6rem; }
            .choice-btn-text { font-size: 1rem; }
        }
    </style>
    </head>
    <body class="global-body">

        <!-- Preloader Screen -->
        <div id="preloader-screen" class="preloader-overlay">
            <div class="preloader-items">
                <div class="preloader-item">
                    <img
                        src="https://us.technics.com/cdn/shop/files/EAH-A800_NonTextCarousels_01_2000x2000_aa2eef2b-7bd7-4800-936b-100d796ceb13_1800x.jpg?v=1745873069"
                        alt="Headphones Placeholder" class="preloader-img">
                    <span class="preloader-label">Headphones</span>
                </div>
                <div class="preloader-item">
                    <img
                        src="https://i5.walmartimages.com/asr/b4b7e8fc-06c2-4f40-b607-96ee4ba8fedc.3f076998920d7a5d75b46c2bf84d610e.jpeg"
                        alt="Laptop Placeholder" class="preloader-img">
                    <span class="preloader-label">Laptop</span>
                </div>
            </div>

            <div class="preloader-info">
                <h2 class="preloader-title">Optimal Experience</h2>
                <p class="preloader-desc">For the deepest immersion, please use
                    headphones and play on a laptop or desktop screen.</p>
            </div>

            <div class="preloader-bar-bg">
                <div id="loading-bar-fill" class="preloader-bar-fill"></div>
            </div>

            <div class="preloader-status">
                <i id="loading-spinner" data-lucide="loader-2"
                    class="icon-sm text-gold animate-spin"></i>
                <div id="loading-text"
                    class="preloader-status-text">Initializing... 0%</div>
            </div>

            <button id="start-btn" class="preloader-btn hidden"
                onclick="game.startFromPreloader()">Play</button>
        </div>

        <!-- Main Game Container -->
        <div id="game-container" class="game-wrapper">

            <!-- Background System -->
            <div id="background-wrapper" class="bg-system-wrap">
                <div id="camera-rig" class="camera-rig-layer camera-move">
                    <div id="bg-layer-1" class="bg-layer"></div>
                    <div id="bg-layer-2" class="bg-layer"></div>
                </div>
                <div id="mood-layer" class="mood-overlay"></div>
            </div>

            <!-- Overlays -->
            <div class="scanlines"></div>
            <div id="rain-layer" class="rain-overlay hidden"></div>
            <div id="flash-layer" class="flash-overlay"></div>

            <!-- Character -->
            <div id="character-layer" class="char-layer-wrap"></div>

            <!-- Map Modal -->
            <div id="map-modal" class="modal-overlay hidden opacity-0">
                <div class="map-modal-content">
                    <div class="map-search-bar">
                        <i data-lucide="menu" class="icon-md text-gray"></i>
                        <span class="map-search-text">Yangon, Myanmar</span>
                        <i data-lucide="search"
                            class="icon-md map-search-icon"></i>
                    </div>
                    <div class="map-controls">
                        <div class="map-control-btn" onclick="game.resetZoom()"
                            title="Reset View"><i data-lucide="compass"
                                class="icon-lg"></i></div>
                        <div class="map-control-btn"
                            onclick="game.zoomMap(0.25)"><i data-lucide="plus"
                                class="icon-lg"></i></div>
                        <div class="map-control-btn"
                            onclick="game.zoomMap(-0.25)"><i data-lucide="minus"
                                class="icon-lg"></i></div>
                    </div>
                    <div id="map-container" class="map-container-area">
                        <div id="map-world" class="map-world-area">
                            <div class="map-bg-water"></div>
                            <div id="geo-layer" class="map-layer"></div>
                            <svg id="road-layer"
                                class="map-layer map-layer-roads"
                                xmlns="http://www.w3.org/2000/svg"></svg>
                            <div id="map-pins"
                                class="map-layer map-layer-pins"></div>
                        </div>
                    </div>
                    <button onclick="game.toggleMap()" class="map-close-btn"><i
                            data-lucide="x" class="icon-lg"></i></button>
                </div>
            </div>

            <!-- Phone Modal -->
            <div id="phone-modal"
                class="modal-overlay phone-modal-container hidden opacity-0">
                <div class="phone-hardware">
                    <div class="phone-power-btn" onclick="game.togglePhone()"
                        title="Close Phone"></div>
                    <div class="phone-vol-btn-1"></div>
                    <div class="phone-vol-btn-2"></div>

                    <div class="phone-screen-container">
                        <div class="phone-status-bar">
                            <span>09:41</span>
                            <div class="phone-status-icons">
                                <i data-lucide="signal" class="icon-sm"></i>
                                <i data-lucide="wifi" class="icon-sm"></i>
                                <i data-lucide="battery" class="icon-sm"></i>
                            </div>
                        </div>

                        <div id="phone-display" class="phone-display-area">
                            <div id="phone-home" class="phone-home-screen">
                                <div class="phone-app-grid">
                                    <div onclick="game.openApp('phone')"
                                        class="app-icon-wrap">
                                        <div
                                            class="app-icon-box bg-app-phone"><i
                                                data-lucide="phone"
                                                class="icon-lg text-white"></i></div>
                                        <span
                                            class="app-icon-label">Phone</span>
                                    </div>
                                    <div onclick="game.openApp('messages')"
                                        class="app-icon-wrap">
                                        <div class="app-icon-box bg-app-msg"><i
                                                data-lucide="message-square"
                                                class="icon-lg text-white"></i></div>
                                        <span
                                            class="app-icon-label">Messages</span>
                                    </div>
                                    <div onclick="game.openApp('photos')"
                                        class="app-icon-wrap">
                                        <div class="app-icon-box bg-app-photo">
                                            <div
                                                class="bg-app-photo-grad"></div>
                                            <i data-lucide="image"
                                                class="icon-lg app-photo-icon"></i>
                                        </div>
                                        <span
                                            class="app-icon-label">Photos</span>
                                    </div>
                                    <div class="app-icon-wrap opacity-80">
                                        <div
                                            class="app-icon-box bg-app-camera"><i
                                                data-lucide="camera"
                                                class="icon-lg text-white"></i></div>
                                        <span
                                            class="app-icon-label">Camera</span>
                                    </div>
                                    <div onclick="game.openApp('facebook')"
                                        class="app-icon-wrap">
                                        <div class="app-icon-box bg-app-fb"><i
                                                data-lucide="facebook"
                                                class="icon-lg text-white"></i></div>
                                        <span
                                            class="app-icon-label">Facebook</span>
                                    </div>
                                    <div onclick="game.openApp('youtube')"
                                        class="app-icon-wrap">
                                        <div class="app-icon-box bg-app-yt"><i
                                                data-lucide="youtube"
                                                class="icon-lg text-white"></i></div>
                                        <span
                                            class="app-icon-label">YouTube</span>
                                    </div>
                                    <div onclick="game.openApp('music')"
                                        class="app-icon-wrap">
                                        <div
                                            class="app-icon-box bg-app-spotify">
                                            <svg viewBox="0 0 24 24"
                                                class="app-spotify-svg"><path
                                                    d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141 4.32-1.38 9.841-.719 13.44 1.5.42.24.6.841.301 1.321zm.12-3.36C15.54 8.46 9.06 8.22 5.34 9.36c-.6.18-1.2-.18-1.38-.72-.18-.6.18-1.2.72-1.38 4.26-1.26 11.4-1.02 15.96 1.68.6.359.84 1.14.479 1.74-.359.6-1.14.84-1.74.48z" /></svg>
                                        </div>
                                        <span
                                            class="app-icon-label">Spotify</span>
                                    </div>
                                    <div onclick="game.openApp('kbzpay')"
                                        class="app-icon-wrap">
                                        <div
                                            class="app-icon-box bg-app-kbz"><span
                                                class="app-kbz-text">KBZ</span></div>
                                        <span
                                            class="app-icon-label">KBZPay</span>
                                    </div>
                                </div>
                            </div>

                            <div id="active-app-container"
                                class="phone-active-app app-screen-hidden">
                                <div id="app-header-bar" class="app-header-bar">
                                    <button onclick="game.phoneHome()"
                                        class="app-back-btn"><i
                                            data-lucide="chevron-left"
                                            class="icon-lg"></i></button>
                                    <span id="app-title-text"
                                        class="app-title-text">App Name</span>
                                </div>
                                <div id="app-content-area"
                                    class="app-content-area custom-scroll"></div>
                            </div>
                        </div>

                        <div class="phone-home-indicator-wrap"
                            onclick="game.phoneHome()">
                            <div class="phone-home-indicator"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Modal -->
            <div id="settings-modal" class="modal-overlay hidden opacity-0">
                <div class="settings-modal-content ios-glass transition-colors">
                    <div class="settings-header">
                        <h2 id="st-title" class="settings-title">Settings</h2>
                        <button onclick="game.closeSettings()"
                            class="ios-close-btn"><i data-lucide="x"
                                class="icon-md"></i></button>
                    </div>

                    <div class="settings-list custom-scroll">
                        <!-- Volume -->
                        <div class="settings-row">
                            <div class="settings-label-wrap">
                                <i data-lucide="volume-2"
                                    class="icon-md icon-dim"></i>
                                <span id="st-vol" class="settings-label">Master
                                    Volume</span>
                                <i data-lucide="help-circle"
                                    class="icon-sm icon-dim"></i>
                                <div class="settings-tooltip"><span
                                        id="st-vol-tip">Adjusts the overall game
                                        volume.</span></div>
                            </div>
                            <div class="settings-control-wrap">
                                <input type="range" id="vol-slider" min="0"
                                    max="1" step="0.1" value="1"
                                    oninput="game.setVolume(this.value)"
                                    class="ios-slider">
                            </div>
                        </div>

                        <!-- Theme Music -->
                        <div class="settings-row">
                            <div class="settings-label-wrap">
                                <i data-lucide="music"
                                    class="icon-md icon-dim"></i>
                                <span id="st-tm" class="settings-label">Theme
                                    Music</span>
                                <i data-lucide="help-circle"
                                    class="icon-sm icon-dim"></i>
                                <div class="settings-tooltip"><span
                                        id="st-tm-tip">Toggle the main
                                        background theme song.</span></div>
                            </div>
                            <div class="settings-control-wrap">
                                <div class="ios-segmented-control">
                                    <button onclick="game.setThemeMusic('on')"
                                        data-val="on"
                                        class="ios-segment-btn st-btn-tm st-btn-active"><span
                                            id="st-tm-on">On</span></button>
                                    <button onclick="game.setThemeMusic('off')"
                                        data-val="off"
                                        class="ios-segment-btn st-btn-tm"><span
                                            id="st-tm-off">Off</span></button>
                                </div>
                            </div>
                        </div>

                        <!-- Font Size -->
                        <div class="settings-row">
                            <div class="settings-label-wrap">
                                <i data-lucide="type"
                                    class="icon-md icon-dim"></i>
                                <span id="st-font" class="settings-label">Font
                                    Size</span>
                                <i data-lucide="help-circle"
                                    class="icon-sm icon-dim"></i>
                                <div class="settings-tooltip"><span
                                        id="st-font-tip">Changes the size of the
                                        reading text.</span></div>
                            </div>
                            <div class="settings-control-wrap">
                                <div class="ios-segmented-control">
                                    <button onclick="game.setFontSize('small')"
                                        data-val="small"
                                        class="ios-segment-btn st-btn-font"><span
                                            id="st-font-sm">Small</span></button>
                                    <button onclick="game.setFontSize('medium')"
                                        data-val="medium"
                                        class="ios-segment-btn st-btn-font st-btn-active"><span
                                            id="st-font-md">Medium</span></button>
                                    <button onclick="game.setFontSize('large')"
                                        data-val="large"
                                        class="ios-segment-btn st-btn-font"><span
                                            id="st-font-lg">Large</span></button>
                                </div>
                            </div>
                        </div>

                        <!-- Graphics -->
                        <div class="settings-row">
                            <div class="settings-label-wrap">
                                <i data-lucide="monitor"
                                    class="icon-md icon-dim"></i>
                                <span id="st-gfx"
                                    class="settings-label">Graphics
                                    Quality</span>
                                <i data-lucide="help-circle"
                                    class="icon-sm icon-dim"></i>
                                <div class="settings-tooltip"><span
                                        id="st-gfx-tip">Lowers visual effects
                                        for better performance.</span></div>
                            </div>
                            <div class="settings-control-wrap">
                                <div class="ios-segmented-control">
                                    <button onclick="game.setGraphics('low')"
                                        data-val="low"
                                        class="ios-segment-btn st-btn-gfx"><span
                                            id="st-gfx-low">Low</span></button>
                                    <button onclick="game.setGraphics('medium')"
                                        data-val="medium"
                                        class="ios-segment-btn st-btn-gfx"><span
                                            id="st-gfx-med">Medium</span></button>
                                    <button onclick="game.setGraphics('high')"
                                        data-val="high"
                                        class="ios-segment-btn st-btn-gfx st-btn-active"><span
                                            id="st-gfx-high">High</span></button>
                                </div>
                            </div>
                        </div>

                        <!-- Language -->
                        <div class="settings-row">
                            <div class="settings-label-wrap">
                                <i data-lucide="globe"
                                    class="icon-md icon-dim"></i>
                                <span id="st-lang"
                                    class="settings-label">Language</span>
                                <i data-lucide="help-circle"
                                    class="icon-sm icon-dim"></i>
                                <div class="settings-tooltip"><span
                                        id="st-lang-tip">Switch between English
                                        and Burmese.</span></div>
                            </div>
                            <div class="settings-control-wrap">
                                <div class="ios-segmented-control">
                                    <button onclick="game.setLanguage('en')"
                                        data-val="en"
                                        class="ios-segment-btn st-btn-lang">English</button>
                                    <button onclick="game.setLanguage('mm')"
                                        data-val="mm"
                                        class="ios-segment-btn st-btn-lang st-btn-active">á€™á€¼á€”á€ºá€™á€¬</button>
                                </div>
                            </div>
                        </div>

                        <!-- Theme -->
                        <div class="settings-row">
                            <div class="settings-label-wrap">
                                <i data-lucide="sun-moon"
                                    class="icon-md icon-dim"></i>
                                <span id="st-theme"
                                    class="settings-label">Theme</span>
                                <i data-lucide="help-circle"
                                    class="icon-sm icon-dim"></i>
                                <div class="settings-tooltip"><span
                                        id="st-theme-tip">Toggle between Dark
                                        and Light mode.</span></div>
                            </div>
                            <div class="settings-control-wrap">
                                <div class="ios-segmented-control">
                                    <button onclick="game.setTheme('dark')"
                                        data-val="dark"
                                        class="ios-segment-btn st-btn-theme st-btn-active"><span
                                            id="st-theme-dark">Dark</span></button>
                                    <button onclick="game.setTheme('light')"
                                        data-val="light"
                                        class="ios-segment-btn st-btn-theme"><span
                                            id="st-theme-light">Light</span></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- UI Layer -->
            <div id="ui-layer" class="ui-overlay hidden">
                <div class="ui-top-bar">
                    <!-- Location Info -->
                    <div class="ui-left-panel">
                        <div id="location-tag" class="glass-panel location-tag">
                            <i data-lucide="map-pin"
                                class="icon-sm location-icon-anim"></i>
                            <div class="location-text-wrap">
                                <span id="location-text"
                                    class="location-main-text">YANGON</span>
                                <span id="time-text"
                                    class="location-sub-text">DAY 1 - 08:00
                                    AM</span>
                            </div>
                        </div>
                        <div class="audio-btn-wrap">
                            <button onclick="game.audio.toggle()"
                                class="hud-btn hud-btn-circle"><i
                                    id="audio-icon" data-lucide="volume-2"
                                    class="icon-sm text-gold"></i></button>
                        </div>
                    </div>

                    <!-- Tools -->
                    <div class="ui-right-panel">
                        <!-- Notifications -->
                        <div id="unlock-notification"
                            class="notification-toast notif-unlock">
                            <div class="notif-unlock-icon"><i
                                    data-lucide="map-pin"
                                    class="icon-sm"></i></div>
                            <div>
                                <div class="notif-title">New Location</div>
                                <div id="unlock-text"
                                    class="notif-unlock-text">Home</div>
                            </div>
                        </div>

                        <div id="currency-notification"
                            class="notification-toast notif-currency">
                            <div class="notif-currency-icon"><i
                                    data-lucide="coins"
                                    class="icon-sm"></i></div>
                            <div>
                                <div class="notif-title">Transaction</div>
                                <div id="currency-text"
                                    class="notif-currency-text">0 MMK</div>
                            </div>
                        </div>

                        <!-- Action Bar -->
                        <div class="glass-panel ui-action-bar">
                            <button onclick="game.togglePhone()" class="hud-btn"
                                aria-label="Phone"><i data-lucide="smartphone"
                                    class="icon-md"></i><span
                                    class="tooltip">Phone</span></button>
                            <button onclick="game.toggleMap()" class="hud-btn"
                                aria-label="Map"><i data-lucide="map"
                                    class="icon-md"></i><span
                                    class="tooltip">Map</span></button>
                            <button onclick="game.saveGameManual()"
                                class="hud-btn" aria-label="Save"><i
                                    data-lucide="save" class="icon-md"></i><span
                                    class="tooltip">Save</span></button>
                            <button onclick="game.openSettings()"
                                class="hud-btn" aria-label="Settings"><i
                                    data-lucide="settings"
                                    class="icon-md"></i><span class="tooltip"
                                    id="hud-st-tip">Settings</span></button>

                            <div class="action-divider"></div>

                            <button onclick="game.toggleLang()"
                                class="hud-btn hud-btn-wide"
                                aria-label="Language"><span id="lang-btn"
                                    class="action-lang-text">á€™á€¼á€”á€ºá€™á€¬</span></button>
                            <button onclick="game.toggleAuto()" id="auto-btn"
                                class="hud-btn" aria-label="Auto Play"><i
                                    data-lucide="play-circle"
                                    class="icon-md"></i><span
                                    class="tooltip">Auto</span></button>

                            <div class="action-divider"></div>

                            <button onclick="game.toggleImmersive()"
                                class="hud-btn" aria-label="Immersive Mode"><i
                                    data-lucide="eye" class="icon-md"></i><span
                                    class="tooltip">Hide UI</span></button>
                            <button onclick="game.takeScreenshot()"
                                class="hud-btn" aria-label="Screenshot"><i
                                    data-lucide="camera"
                                    class="icon-md"></i><span
                                    class="tooltip">Snap</span></button>
                            <button onclick="game.toggleFullscreen()"
                                id="fs-btn" class="hud-btn"
                                aria-label="Fullscreen"><i
                                    data-lucide="maximize"
                                    class="icon-md"></i><span
                                    class="tooltip">Full</span></button>
                        </div>
                    </div>
                </div>

                <!-- Dialogue -->
                <div class="ui-bottom-panel">
                    <div id="choices-container"
                        class="choices-wrap custom-scroll"></div>

                    <div id="dialogue-box" class="dialogue-box"
                        onclick="game.next()">
                        <div class="speaker-wrapper">
                            <div id="speaker-box" class="speaker-box hidden">
                                <span id="speaker-name"
                                    class="speaker-text">NAME</span>
                            </div>
                        </div>
                        <p id="dialogue-text" class="dialogue-text-el"></p>
                        <div id="next-indicator" class="dialogue-next-wrap">
                            <div class="dialogue-next-anim"><i
                                    data-lucide="chevron-down"
                                    class="icon-lg"></i></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Start Screen -->
            <div id="start-screen" class="start-screen-overlay">
                <video id="main-menu-video" loop muted playsinline
                    class="start-video">
                    <source src="../videos/herovideo.mp4" type="video/mp4">
                </video>

                <div class="start-grain"></div>
                <div class="start-gradient"></div>

                <div class="start-layout">
                    <div class="start-left-col">
                        <div class="animate-slide-up"
                            style="animation-delay: 0.1s;">
                            <div class="edition-badge">
                                <div class="edition-dot"></div>
                                <div class="edition-text">Enterprise
                                    Edition</div>
                            </div>
                        </div>

                        <div class="animate-slide-up"
                            style="animation-delay: 0.2s;">
                            <h1 class="game-title font-cinzel">
                                THE<br>
                                <span class="game-subtitle">BETWEENS</span>
                            </h1>
                        </div>

                        <div class="start-desc-wrap animate-slide-up"
                            style="animation-delay: 0.3s;">
                            <p class="start-desc-1">Two worlds. One reality.</p>
                            <p class="start-desc-2">Navigate the fractured
                                timelines of Yangon. Uncover the truth hidden in
                                the echoes of the city. Your choices define the
                                reality you wake up in.</p>
                        </div>
                    </div>

                    <div class="start-right-col animate-slide-up"
                        style="animation-delay: 0.5s;">
                        <div class="start-divider"></div>
                        <div class="menu-list">
                            <button onclick="game.init()"
                                class="menu-item menu-primary">
                                <div class="menu-icon-box"><i data-lucide="play"
                                        class="icon-lg fill-current"></i></div>
                                <span id="st-menu-new">NEW GAME</span>
                            </button>
                            <button onclick="game.loadGame()" id="load-btn"
                                class="menu-item hidden">
                                <div class="menu-icon-box"><i
                                        data-lucide="rotate-ccw"
                                        class="icon-md"></i></div>
                                <span id="st-menu-load">RESUME JOURNEY</span>
                            </button>
                            <button
                                onclick="alert('Feature coming in next update')"
                                class="menu-item">
                                <div class="menu-icon-box"><i
                                        data-lucide="image"
                                        class="icon-md"></i></div>
                                <span id="st-menu-gallery">SCENE GALLERY</span>
                            </button>
                            <button onclick="game.openSettings()"
                                class="menu-item">
                                <div class="menu-icon-box"><i
                                        data-lucide="settings"
                                        class="icon-md"></i></div>
                                <span id="st-menu-set">SETTINGS</span>
                            </button>
                            <button
                                onclick="alert('Standard Terms & Conditions Apply')"
                                class="menu-item">
                                <div class="menu-icon-box"><i
                                        data-lucide="file-text"
                                        class="icon-md"></i></div>
                                <span id="st-menu-terms">TERMS AND
                                    CONDITIONS</span>
                            </button>
                            <button onclick="alert('Created by Gemini & User')"
                                class="menu-item">
                                <div class="menu-icon-box"><i
                                        data-lucide="users"
                                        class="icon-md"></i></div>
                                <span id="st-menu-credits">CREDITS</span>
                            </button>
                            <button onclick="location.reload()"
                                class="menu-item menu-danger">
                                <div class="menu-icon-box menu-danger-icon"><i
                                        data-lucide="power"
                                        class="icon-md"></i></div>
                                <span id="st-menu-quit">QUIT</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
    // --- DICTIONARY FOR SETTINGS ---
    const SETTINGS_DICT = {
        title: { en: "Settings", mm: "á€†á€€á€ºá€á€„á€ºá€™á€»á€¬á€¸" },
        ga_vol: { en: "Game Audio Vol", mm: "á€‚á€­á€™á€ºá€¸á€¡á€žá€¶á€¡á€á€­á€¯á€¸á€¡á€€á€»á€šá€º" },
        ga_vol_tip: { en: "Adjusts the volume of game sound effects.", mm: "á€‚á€­á€™á€ºá€¸á€¡á€á€½á€„á€ºá€¸á€¡á€žá€¶á€™á€»á€¬á€¸á á€¡á€á€­á€¯á€¸á€¡á€€á€»á€šá€ºá€€á€­á€¯ á€á€»á€­á€”á€ºá€Šá€¾á€­á€›á€”á€ºá‹" },
        tm_vol: { en: "Theme Music Vol", mm: "á€”á€±á€¬á€€á€ºá€á€¶á€á€±á€¸á€‚á€®á€ á€¡á€á€­á€¯á€¸á€¡á€€á€»á€šá€º" },
        tm_vol_tip: { en: "Adjusts the volume of the main theme song.", mm: "á€•á€„á€ºá€™á€”á€±á€¬á€€á€ºá€á€¶á€á€±á€¸á€‚á€®á€á á€¡á€á€­á€¯á€¸á€¡á€€á€»á€šá€ºá€€á€­á€¯ á€á€»á€­á€”á€ºá€Šá€¾á€­á€›á€”á€ºá‹" },
        ga_state: { en: "Game Scene Audio", mm: "á€‚á€­á€™á€ºá€¸á€”á€±á€¬á€€á€ºá€á€¶á€¡á€žá€¶" },
        ga_state_tip: { en: "Toggle the scene specific sound effects.", mm: "á€‚á€­á€™á€ºá€¸á€¡á€á€½á€„á€ºá€¸á€”á€±á€¬á€€á€ºá€á€¶á€¡á€žá€¶á€™á€»á€¬á€¸á€€á€­á€¯ á€–á€½á€„á€·á€ºá€›á€”á€º á€žá€­á€¯á€·á€™á€Ÿá€¯á€á€º á€•á€­á€á€ºá€›á€”á€ºá‹" },
        ga_on: { en: "On", mm: "á€–á€½á€„á€·á€º" },
        ga_off: { en: "Off", mm: "á€•á€­á€á€º" },
        font_size: { en: "Font Size", mm: "á€…á€¬á€œá€¯á€¶á€¸á€¡á€›á€½á€šá€ºá€¡á€…á€¬á€¸" },
        font_tip: { en: "Changes the size of the reading text.", mm: "á€…á€¬á€–á€á€ºá€›á€™á€Šá€·á€º á€…á€¬á€œá€¯á€¶á€¸á€™á€»á€¬á€¸á á€¡á€›á€½á€šá€ºá€¡á€…á€¬á€¸á€€á€­á€¯ á€•á€¼á€±á€¬á€„á€ºá€¸á€œá€²á€›á€”á€ºá‹" },
        font_sm: { en: "Small", mm: "á€¡á€žá€±á€¸á€…á€¬á€¸" },
        font_md: { en: "Medium", mm: "á€¡á€œá€á€ºá€…á€¬á€¸" },
        font_lg: { en: "Large", mm: "á€¡á€€á€¼á€®á€¸á€…á€¬á€¸" },
        graphics: { en: "Graphics Quality", mm: "á€›á€¯á€•á€ºá€‘á€½á€€á€ºá€¡á€›á€Šá€ºá€¡á€žá€½á€±á€¸" },
        gfx_tip: { en: "Lowers visual effects for better performance.", mm: "á€…á€€á€ºá€¡á€œá€±á€¸á€™á€á€¶á€›á€…á€±á€›á€”á€º á€›á€¯á€•á€ºá€‘á€½á€€á€ºá€¡á€‘á€°á€¸á€•á€¼á€¯á€œá€¯á€•á€ºá€á€»á€€á€ºá€™á€»á€¬á€¸á€€á€­á€¯ á€œá€»á€¾á€±á€¬á€·á€á€»á€›á€”á€ºá‹" },
        gfx_low: { en: "Low", mm: "á€¡á€”á€­á€™á€·á€º" },
        gfx_med: { en: "Medium", mm: "á€¡á€œá€á€º" },
        gfx_high: { en: "High", mm: "á€¡á€™á€¼á€„á€·á€º" },
        language: { en: "Language", mm: "á€˜á€¬á€žá€¬á€…á€€á€¬á€¸" },
        lang_tip: { en: "Switch between English and Burmese.", mm: "á€¡á€„á€ºá€¹á€‚á€œá€­á€•á€ºá€”á€¾á€„á€·á€º á€™á€¼á€”á€ºá€™á€¬á€˜á€¬á€žá€¬á€…á€€á€¬á€¸ á€•á€¼á€±á€¬á€„á€ºá€¸á€œá€²á€›á€”á€ºá‹" },
        theme: { en: "Theme", mm: "á€¡á€žá€½á€„á€ºá€¡á€•á€¼á€„á€º" },
        theme_tip: { en: "Toggle between Dark and Light mode.", mm: "á€¡á€œá€„á€ºá€¸á€”á€¾á€„á€·á€º á€¡á€™á€¾á€±á€¬á€„á€ºá€•á€¯á€¶á€…á€¶ á€•á€¼á€±á€¬á€„á€ºá€¸á€œá€²á€›á€”á€ºá‹" },
        theme_dark: { en: "Dark", mm: "á€¡á€™á€¾á€±á€¬á€„á€º" },
        theme_light: { en: "Light", mm: "á€¡á€œá€„á€ºá€¸" },
        menu_new: { en: "NEW GAME", mm: "á€‚á€­á€™á€ºá€¸á€¡á€žá€…á€ºá€…á€›á€”á€º" },
        menu_load: { en: "RESUME JOURNEY", mm: "á€†á€€á€ºá€œá€€á€ºá€€á€…á€¬á€¸á€›á€”á€º" },
        menu_gallery: { en: "SCENE GALLERY", mm: "á€“á€¬á€á€ºá€•á€¯á€¶á€•á€¼á€á€”á€ºá€¸" },
        menu_set: { en: "SETTINGS", mm: "á€†á€€á€ºá€á€„á€ºá€™á€»á€¬á€¸" },
        menu_terms: { en: "TERMS & CONDITIONS", mm: "á€…á€Šá€ºá€¸á€™á€»á€¥á€ºá€¸á€”á€¾á€„á€ºá€· á€žá€á€ºá€™á€¾á€á€ºá€á€»á€€á€ºá€™á€»á€¬á€¸"},
        menu_credits: { en: "CREDITS", mm: "á€á€›á€€á€ºá€’á€…á€º"},
        menu_quit: { en: "QUIT", mm: "á€‘á€½á€€á€ºá€™á€Šá€º" },
        hud_quit: { en: "Menu", mm: "á€¡á€…á€žá€­á€¯á€·" }
    };

    // --- LOCATION DATABASE ---
    const LOCATIONS = [
        { id: 'imc', type: 'school', terrain: 'land', name: { en: "Info Myanmar College", mm: "Info Myanmar College" }, x: 30, y: 35, scene: 'school_imc' },
        { id: 'naung_gyi', type: 'home', terrain: 'land', name: { en: "Naung Gyi's House", mm: "á€”á€±á€¬á€„á€ºá€€á€¼á€®á€¸ á€¡á€­á€™á€º" }, x: 95, y: 30, scene: 'home_naunggyi' },
        { id: 'home', type: 'home', terrain: 'land', name: { en: "Tayza's House", mm: "á€á€±á€‡ á€¡á€­á€™á€º" }, x: 80, y: 20, scene: 'intro-tayza' },
        { id: 'shwedagon', type: 'shwedagon_pagoda', terrain: 'land', name: { en: "Shwedagon Pagoda", mm: "á€›á€½á€¾á€±á€á€­á€‚á€¯á€¶á€˜á€¯á€›á€¬á€¸" }, x: 40, y: 55, scene: 'shwedagon_arrival' },
        { id: 'kantawgyi', type: 'park', terrain: 'water', name: { en: "Kandawgyi Lake", mm: "á€€á€”á€ºá€á€±á€¬á€ºá€€á€¼á€®á€¸" }, x: 60, y: 62, scene: 'place_kantawgyi' },
        { id: 'inyalake', type: 'park', terrain: 'water', name: { en: "Inya Lake", mm: "á€¡á€„á€ºá€¸á€šá€¬á€¸á€€á€”á€º" }, x: 50, y: 35, scene: 'place_inya' },
        { id: 'mmplaza', type: 'mmplaza', terrain: 'land', name: { en: "Myanmar Plaza", mm: "á€™á€¼á€”á€ºá€™á€¬á€•á€œá€¬á€‡á€¬" }, x: 55, y: 25, scene: 'place_mmplaza' },
        { id: 'junction_city', type: 'mall', terrain: 'land', name: { en: "Junction City", mm: "Junction City" }, x: 43, y: 70, scene: 'mall_jc' },
        { id: 'hmone_gyi', type: 'tea_shop', terrain: 'land', name: { en: "Hmone Gyi Tea Shop", mm: "á€™á€¾á€¯á€”á€ºá€€á€¼á€®á€¸á€œá€€á€ºá€–á€€á€ºá€›á€Šá€ºá€†á€­á€¯á€„á€º" }, x: 20, y: 20, scene: 'tea_hmonegyi' },
        { id: 'sule', type: 'sule_pagoda', terrain: 'land', name: { en: "Sule Pagoda", mm: "á€†á€°á€¸á€œá€±á€˜á€¯á€›á€¬á€¸" }, x: 60, y: 80, scene: 'place_sule' },
        { id: 'downtown', type: 'city', terrain: 'land', name: { en: "Downtown", mm: "á€™á€¼á€­á€¯á€·á€œá€šá€ºá€á€±á€«á€„á€º" }, x: 50, y: 88, scene: 'place_downtown' },
        { id: 'alwan_cafe', type: 'cafe_shop', terrain: 'land', name: { en: "A Lwan CafÃ©", mm: "á€¡á€œá€½á€™á€ºá€¸á€€á€–á€±á€¸" }, x: 70, y: 50, scene: 'cafe_alwan' },
    ];

    const ROADS = [
        ['home', 'naung_gyi'], ['naung_gyi', 'imc'], ['imc', 'shwedagon'],
        ['shwedagon', 'kantawgyi'], ['shwedagon', 'junction_city'], ['junction_city', 'downtown'],
        ['downtown', 'sule'], ['downtown', 'alwan_cafe'], ['sule', 'hmone_gyi'],
        ['home', 'shwedagon'], ['naung_gyi', 'shwedagon'] 
    ];

    // --- ASSETS DATABASE ---
    const ASSETS = {
        bg: {
            downtown: "../images/places/downtown.png",
            sule: "../images/places/sule.png",
            shwedagon: "../images/places/shwedagon.png",
            shwedagon_stairs: "../images/places/shwedagon_stairs.png",
            shwedagon_night: "../images/places/shwedagon_night.png",
            kantawgyi: "../images/places/kantawg.png",
            home_tayza: "../images/places/home_tayza.png",
            alarm: "../images/items/alarm.png",
            sleep_tayza: "../images/person/sleep-tayza.png",
            wakeup_tayza: "../images/person/wakeup-tayza.png",
            oldfan: "../images/items/oldfan.png",
            missedcall: "../images/items/missedcall.png",
            stair: "../images/places/stair.png",
            kitchen: "../images/places/kitchen.png",
            livingroom: "../images/places/livingroom.png",
            bathroom: "../images/places/bathroom.png",
            dining_room: "../images/places/dining_room.png",
            bedroom_night: "../images/places/bedroom_night.png",
            parallel_sule: "../images/places/parallel_sule.png",
            parallel_street: "../images/places/parallel_street.png",
            ring_item: "../images/items/ring.png",
            faceless_mom: "../images/person/faceless_mom.png"
        },
        audio: {
            main_theme: "../audios/main_theme.mp3",
            morning_chant: "../audios/morning_bird.mp3",
            alarm: "../audios/alarm.mp3",
            yawn: "../audios/yawn.mp3",
            oldfan: "../audios/oldfan.mp3",
            stair: "../audios/footstep.mp3",
            kitchen: "../audios/kitchen.mp3",
            water_splash: "../audios/water_splash.mp3",
            pagoda_bells: "../audios/pagoda_bells.mp3",
            city_ambience: "../audios/city_ambience.mp3",
            creepy_drone: "../audios/creepy_drone.mp3"
        },
        icons: {
            home: "../images/places/icon-house.png",
            shwedagon_pagoda: "../images/places/icon-shwedagon-pagoda.png",
            sule_pagoda: "../images/places/icon-sule-pagoda.png",
            tea_shop: "../images/places/icon-tea-shop.png",
            cafe_shop: "../images/places/icon-cafe.png",
            school: "../images/places/icon-info.png",
            mall: "../images/places/icon-mall.png",
            park: "../images/places/icon-kantawg.png",
            city: "../images/places/icon-downtown.png",
            player: "../images/places/icon-current.png", 
            tree: "../images/places/icon-tree.png",
            inyalake: "../images/places/icon-inyalake.png",
            mmplaza: "../images/places/icon-mmplaza.png",
        }
    };

    // --- GAME ENGINE ---
    class GameEngine {
        constructor() {
            this.state = {
                stats: { sanity: 100, trust: 0, life: 50, knowledge: 0 },
                flags: {},
                currency: 0, 
                day: 1,
                sceneId: 'start',
                lang: 'mm',
                settings: {
                    volume: 1.0,
                    themeMusic: 'on',
                    fontSize: 'medium',
                    graphics: 'high',
                    theme: 'dark'
                }
            };
            this.typingSpeed = 20;
            this.isTyping = false;
            this.typingTimer = null; 
            this.autoPlayTimer = null; 
            this.autoPlay = false; 
            this.sceneData = null;
            this.dialogueIndex = 0;
            this.audio = new AudioController();
            
            this.activeLayer = 1; 
            this.currentBgKey = null; 
            this.immersiveMode = false;
            this.mapOpen = false;
            this.phoneOpen = false;
            this.settingsOpen = false;
            this.phoneApp = null;
            
            this.mapZoom = 1; 
            this.panX = 0;
            this.panY = 0;
            this.isDragging = false;
            this.startX = 0;
            this.startY = 0;

            if(localStorage.getItem('ringGameSave_V5')) {
                document.getElementById('load-btn').classList.remove('hidden');
            }
            
            const saveStr = localStorage.getItem('ringGameSave_V5');
            if(saveStr) {
                const parsed = JSON.parse(saveStr);
                if(parsed.settings) {
                    this.state.settings = parsed.settings;
                }
            }
            
            this.applySettings();
            this.renderSettingsText();
            this.initPreloader();
        }

        initPreloader() {
            const allAssets = [];
            
            if (ASSETS.bg) Object.values(ASSETS.bg).forEach(url => allAssets.push({type: 'image', url}));
            if (ASSETS.icons) Object.values(ASSETS.icons).forEach(url => allAssets.push({type: 'image', url}));
            if (ASSETS.audio) Object.values(ASSETS.audio).forEach(url => allAssets.push({type: 'audio', url}));
            allAssets.push({type: 'video', url: '../videos/herovideo.mp4'});

            let loadedCount = 0;
            const totalAssets = allAssets.length;
            const barFill = document.getElementById('loading-bar-fill');
            const loadText = document.getElementById('loading-text');
            const startBtn = document.getElementById('start-btn');
            const loadSpinner = document.getElementById('loading-spinner');

            const playPreloaderAudio = () => {
                if (this.audio && this.audio.themeMusic && this.audio.themeMusic.paused) {
                    this.audio.themeMusic.volume = this.state.settings.volume * 0.4;
                    this.audio.themeMusic.play().catch(e => console.log("Autoplay blocked, waiting for click."));
                }
            };
            
            playPreloaderAudio();
            document.addEventListener('click', playPreloaderAudio, { once: true });

            const updateProgress = () => {
                loadedCount++;
                let percent = Math.floor((loadedCount / totalAssets) * 100);
                if(barFill) barFill.style.width = percent + '%';
                if(loadText) loadText.innerText = `Loading Assets... ${percent}%`;
                
                if (loadedCount >= totalAssets && loadText && loadText.innerText !== "Ready to play") {
                    if(loadText) loadText.innerText = "Ready to play";
                    if(startBtn) startBtn.classList.remove('hidden');
                    if(loadSpinner) loadSpinner.classList.add('hidden');
                }
            };

            if (totalAssets === 0) {
                updateProgress();
                return;
            }

            allAssets.forEach(asset => {
                if (asset.type === 'image') {
                    const img = new Image();
                    img.onload = updateProgress;
                    img.onerror = updateProgress;
                    img.src = asset.url;
                } else if (asset.type === 'audio') {
                    const aud = new Audio();
                    aud.addEventListener('canplaythrough', updateProgress, { once: true });
                    aud.addEventListener('error', updateProgress, { once: true });
                    aud.src = asset.url;
                    aud.load();
                } else if (asset.type === 'video') {
                    const vid = document.createElement('video');
                    vid.addEventListener('canplaythrough', updateProgress, { once: true });
                    vid.addEventListener('error', updateProgress, { once: true });
                    vid.src = asset.url;
                    vid.load();
                }
            });

            setTimeout(() => {
                if (loadedCount < totalAssets) {
                    console.warn("Preloader timeout fallback triggered. Forcing start access.");
                    loadedCount = totalAssets - 1; 
                    updateProgress(); 
                }
            }, 12000); 
        }

        startFromPreloader() {
            const preloader = document.getElementById('preloader-screen');
            if (preloader) {
                preloader.classList.add('opacity-0');
                const bgVideo = document.getElementById('main-menu-video');
                if(bgVideo) bgVideo.play().catch(e => console.log(e));
                setTimeout(() => { preloader.classList.add('hidden'); }, 1000);
            }
        }

        init() {
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('ui-layer').classList.remove('hidden');
            lucide.createIcons();
            this.loadScene('yangon_intro');
            this.setupMapInteractions();
            this.updateCurrency(0);
            this.audio.setThemeMusic(this.state.settings.themeMusic);
        }
        
        setupMapInteractions() {
            const container = document.getElementById('map-container');
            container.addEventListener('mousedown', (e) => this.startDrag(e));
            document.addEventListener('mousemove', (e) => this.drag(e));
            document.addEventListener('mouseup', () => this.endDrag());
            container.addEventListener('touchstart', (e) => this.startDrag(e.touches[0]));
            document.addEventListener('touchmove', (e) => this.drag(e.touches[0]));
            document.addEventListener('touchend', () => this.endDrag());
        }

        startDrag(e) {
            if (!this.mapOpen) return;
            this.isDragging = true;
            this.startX = e.clientX - this.panX;
            this.startY = e.clientY - this.panY;
            document.getElementById('map-container').style.cursor = 'grabbing';
        }

        drag(e) {
            if (!this.isDragging || !this.mapOpen) return;
            e.preventDefault ? e.preventDefault() : null;
            this.panX = e.clientX - this.startX;
            this.panY = e.clientY - this.startY;
            this.updateMapTransform();
        }

        endDrag() {
            this.isDragging = false;
            const container = document.getElementById('map-container');
            if(container) container.style.cursor = 'grab';
        }

        toggleMap() {
            const modal = document.getElementById('map-modal');
            if (this.mapOpen) {
                modal.classList.add('opacity-0');
                setTimeout(() => modal.classList.add('hidden'), 300);
            } else {
                this.renderMap();
                this.mapZoom = 1; this.panX = 0; this.panY = 0; this.updateMapTransform();
                modal.classList.remove('hidden');
                void modal.offsetWidth; 
                modal.classList.remove('opacity-0');
            }
            this.mapOpen = !this.mapOpen;
        }

        togglePhone() {
            const modal = document.getElementById('phone-modal');
            if (this.phoneOpen) {
                modal.classList.add('opacity-0');
                setTimeout(() => { 
                    modal.classList.add('hidden'); 
                    this.phoneHome(); 
                }, 300);
            } else {
                modal.classList.remove('hidden');
                void modal.offsetWidth; 
                modal.classList.remove('opacity-0');
            }
            this.phoneOpen = !this.phoneOpen;
        }

        phoneHome() {
            const activeApp = document.getElementById('active-app-container');
            activeApp.classList.remove('app-screen-active');
            activeApp.classList.add('app-screen-hidden');
            this.phoneApp = null;
        }

        toggleMusic() {
            const audio = document.getElementById('music-player-audio');
            const icon = document.getElementById('music-play-icon');
            if (!audio) return;
            
            if (audio.paused) {
                audio.play();
                icon.parentElement.innerHTML = '<i id="music-play-icon" data-lucide="pause" class="icon-md fill-current"></i>';
                lucide.createIcons();
            } else {
                audio.pause();
                icon.parentElement.innerHTML = '<i id="music-play-icon" data-lucide="play" class="icon-md fill-current"></i>';
                lucide.createIcons();
            }
        }

        updateMusicProgress() {
            const audio = document.getElementById('music-player-audio');
            const progress = document.getElementById('music-progress');
            const thumb = document.getElementById('music-thumb');
            const current = document.getElementById('music-current-time');
            
            if (audio && progress) {
                const percent = (audio.currentTime / audio.duration) * 100;
                progress.style.width = `${percent}%`;
                if(thumb) thumb.style.left = `${percent}%`;
                const mins = Math.floor(audio.currentTime / 60);
                const secs = Math.floor(audio.currentTime % 60);
                current.innerText = `${mins}:${secs < 10 ? '0' : ''}${secs}`;
            }
        }

        initMusicDuration() {
            const audio = document.getElementById('music-player-audio');
            const total = document.getElementById('music-duration');
            if (audio && total) {
                const mins = Math.floor(audio.duration / 60);
                const secs = Math.floor(audio.duration % 60);
                total.innerText = `${mins}:${secs < 10 ? '0' : ''}${secs}`;
            }
        }

        openApp(appName) {
            this.phoneApp = appName;
            const activeApp = document.getElementById('active-app-container');
            const contentArea = document.getElementById('app-content-area');
            const title = document.getElementById('app-title-text');
            const header = document.getElementById('app-header-bar');

            header.style.display = 'flex';
            header.className = "app-header-bar";
            
            let html = '';
            
            if (appName === 'phone') {
                title.innerText = "Phone";
                html = `
                    <div class="app-dialer-wrap">
                        <div class="app-dialer-top">
                             <div class="app-dialer-display"></div>
                             <div class="app-dialer-grid">
                                 <button class="app-dialer-btn">1</button>
                                 <button class="app-dialer-btn">2</button>
                                 <button class="app-dialer-btn">3</button>
                                 <button class="app-dialer-btn">4</button>
                                 <button class="app-dialer-btn">5</button>
                                 <button class="app-dialer-btn">6</button>
                                 <button class="app-dialer-btn">7</button>
                                 <button class="app-dialer-btn">8</button>
                                 <button class="app-dialer-btn">9</button>
                                 <button class="app-dialer-btn app-dialer-btn-txt">*</button>
                                 <button class="app-dialer-btn">0</button>
                                 <button class="app-dialer-btn font-bold">#</button>
                             </div>
                             <button class="app-dialer-btn-call"><i data-lucide="phone" class="icon-xl"></i></button>
                        </div>
                        <div class="app-dialer-bottom">
                             <div class="app-dialer-tab app-dialer-tab-active"><i data-lucide="grid" class="icon-md"></i>Keypad</div>
                             <div class="app-dialer-tab"><i data-lucide="clock" class="icon-md"></i>Recents</div>
                             <div class="app-dialer-tab"><i data-lucide="users" class="icon-md"></i>Contacts</div>
                        </div>
                    </div>
                `;
            } else if (appName === 'messages') {
                title.innerText = "Messages";
                html = `
                    <div class="app-msg-wrap">
                        <div class="app-msg-item">
                            <div class="app-msg-avatar bg-orange-light">M</div>
                            <div class="app-msg-content">
                                <div class="app-msg-header-row"><span class="app-msg-name">Mom</span> <span class="app-msg-time">14m ago</span></div>
                                <div class="app-msg-text">Please come home early today...</div>
                            </div>
                        </div>
                        <div class="app-msg-item">
                            <div class="app-msg-avatar bg-purple-light">N</div>
                            <div class="app-msg-content">
                                <div class="app-msg-header-row"><span class="app-msg-name">Nay Chi</span> <span class="app-msg-time">Yesterday</span></div>
                                <div class="app-msg-text">Are you free this weekend?</div>
                            </div>
                        </div>
                        <div class="app-msg-item">
                            <div class="app-msg-avatar bg-blue-light">K</div>
                            <div class="app-msg-content">
                                <div class="app-msg-header-row"><span class="app-msg-name">Kyaw Gyi</span> <span class="app-msg-time">2d ago</span></div>
                                <div class="app-msg-text">Bro, check the group chat.</div>
                            </div>
                        </div>
                        <div class="app-msg-item opacity-80">
                            <div class="app-msg-avatar bg-gray-light">O</div>
                            <div class="app-msg-content">
                                <div class="app-msg-header-row"><span class="app-msg-name">Ooredoo</span> <span class="app-msg-time">1w ago</span></div>
                                <div class="app-msg-text">Your package expires soon.</div>
                            </div>
                        </div>
                    </div>
                `;
            } else if (appName === 'facebook') {
                title.innerText = "Facebook";
                header.style.background = "var(--blue-600)";
                header.style.color = "var(--white)";
                html = `
                    <div class="app-fb-wrap">
                        <div class="app-fb-create">
                             <div class="app-fb-create-row">
                                 <div class="app-fb-avatar"></div>
                                 <div class="app-fb-input">What's on your mind?</div>
                             </div>
                        </div>
                        <div class="app-fb-post">
                            <div class="app-fb-post-header">
                                <div class="app-fb-avatar bg-red-100"><i data-lucide="newspaper" class="icon-sm text-red-600"></i></div>
                                <div>
                                    <div class="app-fb-post-author">Yangon News</div>
                                    <div class="app-fb-post-time">2 hrs ago</div>
                                </div>
                            </div>
                            <div class="app-fb-post-text">Heavy rain expected in downtown Yangon this evening. Please drive safely.</div>
                            <div class="app-fb-post-img" style="background-image: url('https://images.unsplash.com/photo-1515347619252-60a6bf4fffce?q=80&w=600&auto=format&fit=crop')"></div>
                            <div class="app-fb-post-actions">
                                <span class="app-fb-action-btn"><i data-lucide="thumbs-up" class="icon-sm"></i> Like</span>
                                <span class="app-fb-action-btn"><i data-lucide="message-circle" class="icon-sm"></i> Comment</span>
                                <span class="app-fb-action-btn"><i data-lucide="share" class="icon-sm"></i> Share</span>
                            </div>
                        </div>
                        <div class="app-fb-post">
                            <div class="app-fb-post-header">
                                <div class="app-fb-avatar bg-purple-light">N</div>
                                <div>
                                    <div class="app-fb-post-author">Nay Chi updated her profile picture.</div>
                                    <div class="app-fb-post-time">5 hrs ago</div>
                                </div>
                            </div>
                            <div class="app-fb-post-img app-fb-post-img-large" style="background-image: url('https://images.unsplash.com/photo-1534528741775-53994a69daeb?q=80&w=600&auto=format&fit=crop')"></div>
                             <div class="app-fb-post-actions">
                                <span class="app-fb-action-btn"><i data-lucide="thumbs-up" class="icon-sm"></i> 142</span>
                                <span class="app-fb-action-btn"><i data-lucide="message-circle" class="icon-sm"></i> 12</span>
                            </div>
                        </div>
                    </div>
                `;
            } else if (appName === 'youtube') {
                title.innerText = "YouTube";
                html = `
                    <div class="app-yt-wrap">
                        <div class="app-yt-post">
                             <div class="app-yt-thumb" style="background-image: url('https://images.unsplash.com/photo-1492684223066-81342ee5ff30?q=80&w=600&auto=format&fit=crop')">
                                 <div class="app-yt-duration">10:24</div>
                             </div>
                             <div class="app-yt-info">
                                 <div class="app-yt-avatar bg-blue-500"></div>
                                 <div class="app-yt-text-wrap">
                                     <div class="app-yt-title">Walking in Yangon 4K - Downtown Rain</div>
                                     <div class="app-yt-meta">Myanmar Walks â€¢ 24K views â€¢ 1 day ago</div>
                                 </div>
                             </div>
                        </div>
                        <div class="app-yt-post">
                             <div class="app-yt-thumb" style="background-image: url('https://images.unsplash.com/photo-1511671782779-c97d3d27a1d4?q=80&w=600&auto=format&fit=crop')">
                                  <div class="app-yt-duration">3:45</div>
                             </div>
                             <div class="app-yt-info">
                                 <div class="app-yt-avatar bg-red-500"></div>
                                 <div class="app-yt-text-wrap">
                                     <div class="app-yt-title">Lofi Myanmar Beats to Study To</div>
                                     <div class="app-yt-meta">Lofi Girl â€¢ 1.2M views â€¢ 1 month ago</div>
                                 </div>
                             </div>
                        </div>
                    </div>
                `;
            } else if (appName === 'photos') {
                title.innerText = "Photos";
                html = `
                    <div class="app-photo-grid">
                        <div class="app-photo-item" style="background-image: url('https://images.unsplash.com/photo-1572508589584-94d778209071?q=80&w=200&auto=format&fit=crop')"></div>
                        <div class="app-photo-item" style="background-image: url('https://images.unsplash.com/photo-1627993436034-71f496738923?q=80&w=200&auto=format&fit=crop')"></div>
                        <div class="app-photo-item" style="background-image: url('https://images.unsplash.com/photo-1605218427368-35b0185e33d0?q=80&w=200&auto=format&fit=crop')"></div>
                        <div class="app-photo-item" style="background-image: url('https://images.unsplash.com/photo-1550684848-fac1c5b4e853?q=80&w=200&auto=format&fit=crop')"></div>
                        <div class="app-photo-item" style="background-image: url('https://images.unsplash.com/photo-1596556554483-2079c6131496?q=80&w=200&auto=format&fit=crop')"></div>
                        <div class="app-photo-item" style="background-image: url('https://images.unsplash.com/photo-1589308078059-be1415eab4c3?q=80&w=200&auto=format&fit=crop')"></div>
                    </div>
                `;
            } else if (appName === 'music') {
                title.innerText = "Spotify"; 
                header.style.display = 'none';
                html = `
                    <div class="app-sp-wrap">
                         <div class="app-sp-header">
                            <button onclick="game.phoneHome()" class="app-sp-btn-icon"><i data-lucide="chevron-down" class="icon-lg"></i></button>
                            <span class="app-sp-header-text">Now Playing</span>
                            <button class="app-sp-btn-icon"><i data-lucide="more-horizontal" class="icon-lg"></i></button>
                         </div>
                         <div class="app-sp-art-wrap">
                            <div class="app-sp-art-box">
                                <img src="../images/items/song.png" class="app-sp-img" onerror="this.src='https://images.unsplash.com/photo-1614613535308-eb5fbd3d2c17?q=80&w=400'">
                            </div>
                         </div>
                         <div class="app-sp-controls">
                             <div class="app-sp-info-row">
                                 <div>
                                     <div class="app-sp-title">Tejano Blue</div>
                                     <div class="app-sp-artist">Cigarettes After Sex</div>
                                 </div>
                                 <button class="app-sp-btn-icon text-green-600"><i data-lucide="heart" class="icon-lg fill-current"></i></button>
                             </div>
                             <div class="app-sp-progress-wrap">
                                 <div class="app-sp-progress-bg">
                                     <div id="music-progress" class="app-sp-progress-fill"></div>
                                     <div id="music-thumb" class="app-sp-progress-thumb"></div>
                                 </div>
                             </div>
                             <div class="app-sp-times">
                                 <span id="music-current-time">0:00</span>
                                 <span id="music-duration">0:00</span>
                             </div>
                             <div class="app-sp-playback">
                                 <button class="app-sp-ctrl-btn-dim"><i data-lucide="shuffle" class="icon-md"></i></button>
                                 <button class="app-sp-ctrl-btn"><i data-lucide="skip-back" class="icon-xl fill-current"></i></button>
                                 <button onclick="game.toggleMusic()" class="app-sp-play-btn">
                                     <i id="music-play-icon" data-lucide="play" class="icon-lg fill-current"></i>
                                 </button>
                                 <button class="app-sp-ctrl-btn"><i data-lucide="skip-forward" class="icon-xl fill-current"></i></button>
                                 <button class="app-sp-ctrl-btn-dim"><i data-lucide="repeat" class="icon-md"></i></button>
                             </div>
                         </div>
                         <audio id="music-player-audio" src="../audios/tejano-blue.mp3" ontimeupdate="game.updateMusicProgress()" onloadedmetadata="game.initMusicDuration()"></audio>
                    </div>
                `;
            } else if (appName === 'kbzpay') {
                title.innerText = "KBZPay";
                header.style.background = "var(--blue-700)";
                header.style.color = "var(--white)";
                html = `
                    <div class="app-kbz-wrap">
                        <div class="app-kbz-card">
                            <div class="app-kbz-card-deco"></div>
                            <span class="app-kbz-label">Total Balance</span>
                            <div class="app-kbz-balance-row">
                                <span class="app-kbz-balance" id="kbz-balance">${this.state.currency.toLocaleString()}</span>
                                <span class="app-kbz-currency">MMK</span>
                            </div>
                            <div class="app-kbz-actions">
                                <div class="app-kbz-action"><div class="app-kbz-action-icon"><i data-lucide="arrow-up" class="icon-sm"></i></div><span class="app-kbz-action-text">Transfer</span></div>
                                <div class="app-kbz-action"><div class="app-kbz-action-icon"><i data-lucide="arrow-down" class="icon-sm"></i></div><span class="app-kbz-action-text">Cash In</span></div>
                                <div class="app-kbz-action"><div class="app-kbz-action-icon"><i data-lucide="qr-code" class="icon-sm"></i></div><span class="app-kbz-action-text">Scan</span></div>
                                <div class="app-kbz-action"><div class="app-kbz-action-icon"><i data-lucide="clock" class="icon-sm"></i></div><span class="app-kbz-action-text">History</span></div>
                            </div>
                        </div>
                        <div class="app-kbz-history-wrap">
                            <div class="app-kbz-history-title">Recent Activity</div>
                            <div class="app-kbz-history-list" id="kbz-history"></div>
                        </div>
                    </div>
                `;
            }

            contentArea.innerHTML = html;
            activeApp.classList.remove('app-screen-hidden');
            activeApp.classList.add('app-screen-active');
            
            if (appName === 'kbzpay') {
                this.renderKBZHistory();
            }
            lucide.createIcons();
        }

        updateCurrency(amount) {
            if (amount === 0 && this.state.currency === 0) {
                 const bal = document.getElementById('kbz-balance');
                 if(bal) bal.innerText = "0";
                 return;
            }

            this.state.currency += amount;
            
            const bal = document.getElementById('kbz-balance');
            if(bal) bal.innerText = this.state.currency.toLocaleString();

            if (amount !== 0) {
                const notif = document.getElementById('currency-notification');
                const text = document.getElementById('currency-text');
                const sign = amount > 0 ? '+' : '';
                
                text.innerText = `${sign}${amount.toLocaleString()} MMK`;
                text.className = `notif-currency-text ${amount > 0 ? 'currency-positive' : 'currency-negative'}`;
                
                notif.classList.add('notification-show');
                setTimeout(() => { notif.classList.remove('notification-show'); }, 3000);

                if (!this.state.history) this.state.history = [];
                this.state.history.unshift({ amount: amount, date: 'Today' });
                if (this.state.history.length > 5) this.state.history.pop();
                
                if (this.phoneApp === 'kbzpay') {
                    this.renderKBZHistory();
                }
            }
        }
        
        renderKBZHistory() {
            const historyContainer = document.getElementById('kbz-history');
            if (!historyContainer) return;
            
            if (!this.state.history || this.state.history.length === 0) {
                 historyContainer.innerHTML = '<div class="text-center font-mono text-gray-400 py-4">No transactions yet</div>';
                 return;
            }

            historyContainer.innerHTML = '';
            this.state.history.forEach(item => {
                const div = document.createElement('div');
                div.className = "app-kbz-history-item";
                const isPos = item.amount > 0;
                div.innerHTML = `
                    <div class="app-kbz-history-left">
                        <div class="app-kbz-history-icon-box ${isPos ? 'bg-green-100' : 'bg-red-100'}">
                            <i data-lucide="${isPos ? 'arrow-down-left' : 'arrow-up-right'}" class="icon-sm ${isPos ? 'text-green-600' : 'text-red-600'}"></i>
                        </div>
                        <div class="app-kbz-history-info">
                            <div class="app-kbz-history-type">${isPos ? 'Received' : 'Payment'}</div>
                            <div class="app-kbz-history-date">${item.date}</div>
                        </div>
                    </div>
                    <span class="app-kbz-history-amount ${isPos ? 'text-green-600' : 'text-red-600'}">${isPos ? '+' : ''}${item.amount.toLocaleString()} MMK</span>
                `;
                historyContainer.appendChild(div);
            });
            lucide.createIcons();
        }

        zoomMap(delta) {
            this.mapZoom = Math.max(0.25, Math.min(6, this.mapZoom + delta));
            this.updateMapTransform();
        }

        resetZoom() {
            this.mapZoom = 1;
            this.panX = 0;
            this.panY = 0;
            this.updateMapTransform();
        }

        updateMapTransform() {
            const world = document.getElementById('map-world');
            if (world) {
                world.style.transform = `translate(${this.panX}px, ${this.panY}px) scale(${this.mapZoom})`;
            }
        }

        renderMap() {
            const container = document.getElementById('map-pins');
            const geoContainer = document.getElementById('geo-layer');
            const roadLayer = document.getElementById('road-layer');
            
            container.innerHTML = '';
            geoContainer.innerHTML = '';
            roadLayer.innerHTML = '';

            const currentLoc = LOCATIONS.find(l => l.scene === this.state.sceneId);

            geoContainer.innerHTML = `
                <svg width="100%" height="100%" viewBox="0 0 100 100" preserveAspectRatio="none">
                    <defs>
                        <filter id="land-glow" x="-20%" y="-20%" width="140%" height="140%">
                            <feGaussianBlur stdDeviation="1" result="blur"/>
                            <feComposite in="SourceGraphic" in2="blur" operator="over"/>
                        </filter>
                    </defs>
                    <path d="M -10 0 L 110 0 L 110 60 Q 90 55 80 70 L 70 85 L 60 92 L 50 95 L 40 92 L 30 85 L 20 70 Q 10 55 -10 60 Z" fill="#F0F2F5" stroke="#E5E7EB" stroke-width="0.5" filter="url(#land-glow)"/>
                    <path d="M -10 100 L 45 100 L 35 110 L -10 110 Z" fill="#E8EAED" />
                    <path d="M 65 100 L 110 100 L 110 110 L 75 110 Z" fill="#E8EAED" />
                    <path d="M 40 25 Q 45 20 50 25 T 60 30 Q 55 40 45 35 T 40 25 Z" fill="#A5D6E0" stroke="#8AC0D0" stroke-width="0.5" />
                    <path d="M 52 55 Q 58 52 62 55 T 65 62 Q 60 65 55 62 T 52 55 Z" fill="#A5D6E0" stroke="#8AC0D0" stroke-width="0.5" />
                </svg>
            `;

            ROADS.forEach(([startId, endId]) => {
                const start = LOCATIONS.find(l => l.id === startId);
                const end = LOCATIONS.find(l => l.id === endId);
                if (start && end) {
                    const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                    const midX = (start.x + end.x) / 2;
                    const midY = (start.y + end.y) / 2;
                    const offset = 5; 
                    const cpX = midX + (start.y > end.y ? offset : -offset); 
                    const cpY = midY + (start.x < end.x ? offset : -offset);

                    const d = `M ${start.x} ${start.y} Q ${cpX} ${cpY} ${end.x} ${end.y}`;
                    path.setAttribute("d", d);
                    path.setAttribute("class", "road-border");
                    roadLayer.appendChild(path);
                    
                    const pathLine = document.createElementNS("http://www.w3.org/2000/svg", "path");
                    pathLine.setAttribute("d", d);
                    pathLine.setAttribute("class", "road-line");
                    roadLayer.appendChild(pathLine);
                }
            });

            LOCATIONS.forEach(loc => {
                const isUnlocked = this.state.flags[`${loc.id}_unlocked`];
                const isCurrent = currentLoc && currentLoc.id === loc.id;
                
                const pin = document.createElement('div');
                pin.className = `map-pin-wrap ${isUnlocked ? 'map-pin-unlocked' : 'map-pin-locked'}`;
                pin.style.left = `${loc.x}%`;
                pin.style.top = `${loc.y}%`;

                const iconUrl = ASSETS.icons[loc.type] || ASSETS.icons.home;

                if (loc.terrain === 'land') {
                     for(let i=0; i<5; i++) {
                         const tree = document.createElement('img');
                         tree.src = ASSETS.icons.tree;
                         tree.className = 'map-bg-tree';
                         const tx = (Math.random() * 8) - 4; 
                         const ty = (Math.random() * 6);
                         tree.style.left = `${loc.x + tx}%`;
                         tree.style.top = `${loc.y + ty}%`;
                         container.appendChild(tree);
                     }
                }

                const playerHtml = isCurrent ? `
                    <div class="map-pin-player">
                        <img src="${ASSETS.icons.player}" class="map-pin-player-img">
                        <div class="map-pin-player-arrow"></div>
                    </div>
                ` : '';

                if (isUnlocked) {
                    pin.onclick = (e) => { e.stopPropagation(); this.travelTo(loc); };
                    pin.innerHTML = `
                        ${playerHtml}
                        <div class="map-pin-icon-wrap">
                            <div class="map-pin-shadow"></div>
                            <img src="${iconUrl}" class="map-pin-icon" alt="${loc.name.en}">
                        </div>
                        <div class="map-pin-tooltip">
                            ${loc.name[this.state.lang] || loc.name.en}
                        </div>
                    `;
                } else {
                    pin.innerHTML = `
                        <div style="position:relative;">
                            <img src="${iconUrl}" class="map-pin-icon map-pin-locked-icon" alt="${loc.name.en}">
                            <div class="map-pin-locked-badge"><i data-lucide="lock" class="icon-sm text-white"></i></div>
                        </div>
                        <div class="map-pin-tooltip map-pin-locked-tooltip">
                            ${loc.name[this.state.lang] || loc.name.en}
                        </div>
                    `;
                }
                
                container.appendChild(pin);
            });
            
            this.updateMapTransform();
            lucide.createIcons();
        }

        travelTo(loc) {
            if(this.isDragging) return;
            this.toggleMap();
            if (SCENES[loc.scene]) {
                this.loadScene(loc.scene);
            } else {
                alert(`Development Mode: Scene for ${loc.name.en} is not yet implemented.`);
            }
        }

        showUnlockNotification(locId) {
            const loc = LOCATIONS.find(l => l.id === locId);
            if (!loc) return;
            
            const notif = document.getElementById('unlock-notification');
            const text = document.getElementById('unlock-text');
            
            text.innerText = loc.name[this.state.lang] || loc.name.en;
            notif.classList.add('notification-show');
            setTimeout(() => { notif.classList.remove('notification-show'); }, 4000);
        }

        toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => { console.log(`Error: ${err.message}`); });
            } else {
                if (document.exitFullscreen) { document.exitFullscreen(); }
            }
        }
        
        toggleImmersive() {
            this.immersiveMode = !this.immersiveMode;
            const ui = document.getElementById('ui-layer');
            const cam = document.getElementById('camera-rig');
            
            if (this.immersiveMode) {
                if (document.documentElement.requestFullscreen) {
                    document.documentElement.requestFullscreen().catch(err => console.log(err));
                }
                ui.classList.add('hidden');
                cam.classList.add('static-cam');
                
                const exitHandler = (e) => {
                    e.stopPropagation();
                    this.toggleImmersive();
                    document.removeEventListener('click', exitHandler, true);
                };
                setTimeout(() => { document.addEventListener('click', exitHandler, true); }, 50);
                
            } else {
                if (document.exitFullscreen && document.fullscreenElement) {
                    document.exitFullscreen().catch(err => console.log(err));
                }
                ui.classList.remove('hidden');
                cam.classList.remove('static-cam');
            }
        }

        takeScreenshot() {
            const ui = document.getElementById('ui-layer');
            const cam = document.getElementById('camera-rig');
            const container = document.getElementById('game-container');

            ui.classList.add('hidden');
            cam.classList.add('static-cam');

            setTimeout(() => {
                html2canvas(container, { scale: 2, useCORS: true, backgroundColor: null }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `yangon_scene_${Date.now()}.png`;
                    link.href = canvas.toDataURL();
                    link.click();
                    ui.classList.remove('hidden');
                    if (!this.immersiveMode) cam.classList.remove('static-cam');
                }).catch(err => {
                    console.error("Screenshot failed:", err);
                    ui.classList.remove('hidden');
                    if (!this.immersiveMode) cam.classList.remove('static-cam');
                });
            }, 100);
        }

        saveGameManual() {
            localStorage.setItem('ringGameSave_V5', JSON.stringify(this.state));
            const btn = document.querySelector('button[onclick="game.saveGameManual()"]');
            if (btn) {
                const originalHTML = btn.innerHTML;
                btn.innerHTML = '<i data-lucide="check" class="icon-md text-green-400"></i>';
                lucide.createIcons();
                setTimeout(() => { btn.innerHTML = originalHTML; lucide.createIcons(); }, 1000);
            }
        }

        loadGame() {
            const save = localStorage.getItem('ringGameSave_V5');
            if (save) {
                this.state = JSON.parse(save);
                if (this.state.currency === undefined) this.state.currency = 0;
                if (!this.state.settings) this.state.settings = { volume: 1.0, themeMusic: 'on', fontSize: 'medium', graphics: 'high', theme: 'dark' };
                
                this.applySettings();
                document.getElementById('start-screen').classList.add('hidden');
                document.getElementById('ui-layer').classList.remove('hidden');
                this.loadScene(this.state.sceneId);
                this.updateCurrency(0); 
                this.audio.setThemeMusic(this.state.settings.themeMusic);
            }
        }

        toggleLang() {
            this.setLanguage(this.state.lang === 'mm' ? 'en' : 'mm');
        }
        
        toggleAuto() {
            this.autoPlay = !this.autoPlay;
            const btn = document.getElementById('auto-btn');
            if (this.autoPlay) {
                btn.classList.add('active-mode');
                if (!this.isTyping && !this.isLastStep()) this.next();
            } else {
                btn.classList.remove('active-mode');
                if (this.autoPlayTimer) clearTimeout(this.autoPlayTimer);
            }
            lucide.createIcons();
        }

        // --- GLOBAL SETTINGS FUNCTIONS ---
        openSettings() {
            const modal = document.getElementById('settings-modal');
            this.renderSettingsText();
            this.syncSettingsUI();
            modal.classList.remove('hidden');
            void modal.offsetWidth; 
            modal.classList.remove('opacity-0');
            this.settingsOpen = true;
            lucide.createIcons();
        }

        closeSettings() {
            const modal = document.getElementById('settings-modal');
            modal.classList.add('opacity-0');
            setTimeout(() => { modal.classList.add('hidden'); }, 300);
            this.settingsOpen = false;
            this.saveGameManual(); 
        }

        applySettings() {
            this.setVolume(this.state.settings.volume, false);
            this.setThemeMusic(this.state.settings.themeMusic || 'on', false);
            this.setFontSize(this.state.settings.fontSize, false);
            this.setGraphics(this.state.settings.graphics, false);
            this.setTheme(this.state.settings.theme, false);
            this.syncSettingsUI();
        }

        syncSettingsUI() {
            document.getElementById('vol-slider').value = this.state.settings.volume;
            this.updateBtnGroup('tm', this.state.settings.themeMusic || 'on');
            this.updateBtnGroup('font', this.state.settings.fontSize);
            this.updateBtnGroup('gfx', this.state.settings.graphics);
            this.updateBtnGroup('lang', this.state.lang);
            this.updateBtnGroup('theme', this.state.settings.theme);
        }

        updateBtnGroup(group, val) {
            const btns = document.querySelectorAll(`.st-btn-${group}`);
            btns.forEach(btn => {
                if (btn.dataset.val === val) {
                    btn.classList.add('st-btn-active');
                } else {
                    btn.classList.remove('st-btn-active');
                }
            });
        }

        renderSettingsText() {
            const lang = this.state.lang;
            document.getElementById('lang-btn').innerText = lang === 'mm' ? "á€™á€¼á€”á€ºá€™á€¬" : "EN";
            
            const updateText = (id, key) => {
                const el = document.getElementById(id);
                if (el && SETTINGS_DICT[key]) el.innerText = SETTINGS_DICT[key][lang];
            };

            updateText('st-menu-new', 'menu_new');
            updateText('st-menu-load', 'menu_load');
            updateText('st-menu-gallery', 'menu_gallery');
            updateText('st-menu-set', 'menu_set');
            updateText('st-menu-quit', 'menu_quit');
            updateText('st-menu-credits', 'menu_credits');
            updateText('st-menu-terms', 'menu_terms');
            updateText('hud-st-tip', 'menu_set');
            updateText('st-title', 'title');
            updateText('st-vol', 'volume');
            updateText('st-vol-tip', 'vol_tip');
            updateText('st-tm', 'theme_music');
            updateText('st-tm-tip', 'tm_tip');
            updateText('st-tm-on', 'tm_on');
            updateText('st-tm-off', 'tm_off');
            updateText('st-font', 'font_size');
            updateText('st-font-tip', 'font_tip');
            updateText('st-font-sm', 'font_sm');
            updateText('st-font-md', 'font_md');
            updateText('st-font-lg', 'font_lg');
            updateText('st-gfx', 'graphics');
            updateText('st-gfx-tip', 'gfx_tip');
            updateText('st-gfx-low', 'gfx_low');
            updateText('st-gfx-med', 'gfx_med');
            updateText('st-gfx-high', 'gfx_high');
            updateText('st-lang', 'language');
            updateText('st-lang-tip', 'lang_tip');
            updateText('st-theme', 'theme');
            updateText('st-theme-tip', 'theme_tip');
            updateText('st-theme-dark', 'theme_dark');
            updateText('st-theme-light', 'theme_light');
        }

        setVolume(val, sync = true) {
            this.state.settings.volume = parseFloat(val);
            this.audio.setVolume(this.state.settings.volume);
            if(sync) this.syncSettingsUI();
        }

        setThemeMusic(state, sync = true) {
            this.state.settings.themeMusic = state;
            this.audio.setThemeMusic(state);
            if(sync) this.syncSettingsUI();
        }

        setFontSize(size, sync = true) {
            this.state.settings.fontSize = size;
            document.body.classList.remove('font-sm', 'font-lg');
            if (size === 'small') document.body.classList.add('font-sm');
            if (size === 'large') document.body.classList.add('font-lg');
            if(sync) this.syncSettingsUI();
        }

        setGraphics(level, sync = true) {
            this.state.settings.graphics = level;
            document.body.classList.remove('gfx-low', 'gfx-med');
            if (level === 'low') document.body.classList.add('gfx-low');
            if (level === 'medium') document.body.classList.add('gfx-med');
            if(sync) this.syncSettingsUI();
        }

        setTheme(mode, sync = true) {
            this.state.settings.theme = mode;
            document.body.classList.remove('theme-light');
            if (mode === 'light') {
                document.body.classList.add('theme-light');
            }
            if(sync) this.syncSettingsUI();
        }

        setLanguage(lang) {
            this.state.lang = lang;
            this.renderSettingsText();
            this.syncSettingsUI();
            if (!this.isTyping && this.sceneData) this.renderStep(true);
        }

        changeBackground(bgKey, darken) {
            const url = ASSETS.bg[bgKey];
            if (!url) return;
            if (this.currentBgKey === bgKey) return;

            if (!this.activeLayer) this.activeLayer = 1;
            const nextLayerIdx = this.activeLayer === 1 ? 2 : 1;
            const currentEl = document.getElementById(`bg-layer-${this.activeLayer}`);
            const nextEl = document.getElementById(`bg-layer-${nextLayerIdx}`);
            const targetOpacity = darken ? '0.3' : '0.6';

            nextEl.style.backgroundImage = `url('${url}')`;
            nextEl.style.opacity = targetOpacity;
            currentEl.style.opacity = '0';

            this.activeLayer = nextLayerIdx;
            this.currentBgKey = bgKey; 
        }

        handleAudio(audioData) {
            if (!audioData) return;
            const id = typeof audioData === 'string' ? audioData : audioData.id;
            const loop = typeof audioData === 'string' ? true : (audioData.loop !== undefined ? audioData.loop : true);
            this.audio.play(id, loop);
        }

        loadScene(id) {
            this.state.sceneId = id;
            this.sceneData = SCENES[id];
            this.dialogueIndex = 0;

            this.changeBackground(this.sceneData.bg, this.sceneData.darken);
            this.handleAudio(this.sceneData.audio);

            const baseClasses = "global-body";
            const settingsClasses = [];
            if(this.state.settings.fontSize === 'small') settingsClasses.push('font-sm');
            if(this.state.settings.fontSize === 'large') settingsClasses.push('font-lg');
            if(this.state.settings.graphics === 'low') settingsClasses.push('gfx-low');
            if(this.state.settings.graphics === 'medium') settingsClasses.push('gfx-med');
            if(this.state.settings.theme === 'light') settingsClasses.push('theme-light');
            
            document.body.className = `${baseClasses} ${settingsClasses.join(' ')}`;
            
            if (this.sceneData.world) document.body.classList.add(`world-${this.sceneData.world}`);

            if (this.sceneData.location) {
                document.getElementById('location-text').innerText = this.sceneData.location.en; 
                document.getElementById('time-text').innerText = `DAY ${this.state.day} - ${this.sceneData.time || 'UNKNOWN'}`;
            }

            this.renderStep();
            this.saveGameManual();
        }

        renderStep(instant = false) {
            if (this.typingTimer) clearTimeout(this.typingTimer);
            if (this.autoPlayTimer) clearTimeout(this.autoPlayTimer);

            const step = this.sceneData.steps[this.dialogueIndex];
            if (!step) return;

            if (step.unlock) {
                const locationsToUnlock = Array.isArray(step.unlock) ? step.unlock : [step.unlock];
                locationsToUnlock.forEach(locId => {
                    if (!this.state.flags[`${locId}_unlocked`]) {
                        this.state.flags[`${locId}_unlocked`] = true;
                        this.showUnlockNotification(locId);
                    }
                });
            }

            if (step.currency) this.updateCurrency(step.currency);
            if (step.bg) this.changeBackground(step.bg, this.sceneData.darken);
            if (step.audio) this.handleAudio(step.audio);

            const speakerBox = document.getElementById('speaker-box');
            const speakerName = document.getElementById('speaker-name');
            const spk = step.speaker ? (step.speaker[this.state.lang] || step.speaker.en) : null;
            
            if (spk) {
                speakerBox.classList.remove('hidden');
                speakerName.innerText = spk;
                const spkColorClass = step.speaker.color || 'speaker-default';
                speakerBox.className = `speaker-box ${spkColorClass}`;
            } else {
                speakerBox.classList.add('hidden');
            }

            const charLayer = document.getElementById('character-layer');
            if (step.char) {
                charLayer.innerHTML = this.getCharHTML(step.char);
                charLayer.classList.remove('opacity-0');
                charLayer.style.transform = 'translateY(0)';
            } else if (step.clearChar) {
                charLayer.classList.add('opacity-0');
                charLayer.style.transform = 'translateY(2.5rem)';
            }

            const textBox = document.getElementById('dialogue-text');
            const text = step.text[this.state.lang] || step.text.en;
            const choicesDiv = document.getElementById('choices-container');
            const nextInd = document.getElementById('next-indicator');

            choicesDiv.innerHTML = '';
            nextInd.style.opacity = '0';

            if (instant) {
                textBox.innerText = text;
                this.isTyping = false;
                textBox.classList.remove('cursor');
                if (this.isLastStep()) {
                    this.renderChoices();
                    if(this.autoPlayTimer) clearTimeout(this.autoPlayTimer); 
                } else {
                    nextInd.style.opacity = '1';
                    if (this.autoPlay) {
                        const delay = 1500 + (text.length * 50);
                        this.autoPlayTimer = setTimeout(() => this.next(), delay);
                    }
                }
                return;
            }

            textBox.innerText = '';
            textBox.classList.add('cursor');
            this.isTyping = true;
            let i = 0;

            const tick = () => {
                if (!this.isTyping) return; 
                if (i < text.length) {
                    textBox.innerText += text.charAt(i);
                    i++;
                    this.typingTimer = setTimeout(tick, this.typingSpeed);
                } else {
                    this.isTyping = false;
                    textBox.classList.remove('cursor');
                    if (this.isLastStep()) {
                        this.renderChoices();
                        if(this.autoPlayTimer) clearTimeout(this.autoPlayTimer); 
                    } else {
                        nextInd.style.opacity = '1';
                        if (this.autoPlay) {
                            const delay = 1500 + (text.length * 50);
                            this.autoPlayTimer = setTimeout(() => this.next(), delay);
                        }
                    }
                }
            };
            tick();
        }

        isLastStep() {
            return this.dialogueIndex === this.sceneData.steps.length - 1 && this.sceneData.choices;
        }

        renderChoices() {
            const container = document.getElementById('choices-container');
            container.innerHTML = '';

            this.sceneData.choices.forEach(c => {
                if (c.req && !c.req(this.state)) return; 

                const btn = document.createElement('button');
                btn.className = "choice-btn";
                const txt = c.text[this.state.lang] || c.text.en;
                
                btn.innerHTML = `
                    <div class="choice-btn-inner">
                        <span class="choice-btn-text">${txt}</span>
                        ${c.type === 'danger' ? '<i data-lucide="alert-triangle" class="icon-sm text-red-600"></i>' : '<i data-lucide="arrow-right" class="icon-sm choice-icon-arrow"></i>'}
                    </div>
                `;

                if (c.type === 'danger') btn.style.borderLeftColor = 'var(--red-500)';

                btn.onclick = (e) => {
                    e.stopPropagation();
                    this.makeChoice(c);
                };
                container.appendChild(btn);
            });
            lucide.createIcons();
        }

        next() {
            if (this.isTyping) {
                this.renderStep(true);
                return;
            }
            if (document.getElementById('choices-container').children.length > 0) return;

            if (this.dialogueIndex < this.sceneData.steps.length - 1) {
                this.dialogueIndex++;
                this.renderStep();
            } else if (this.sceneData.nextScene) {
                this.loadScene(this.sceneData.nextScene);
            }
        }

        makeChoice(choice) {
            if (choice.unlock) {
                const locationsToUnlock = Array.isArray(choice.unlock) ? choice.unlock : [choice.unlock];
                locationsToUnlock.forEach(locId => {
                    if (!this.state.flags[`${locId}_unlocked`]) {
                         this.state.flags[`${locId}_unlocked`] = true;
                         this.showUnlockNotification(locId);
                    }
                });
            }

            if (choice.currency) this.updateCurrency(choice.currency);

            if (choice.effect) {
                for (const [k, v] of Object.entries(choice.effect)) {
                    this.state.stats[k] = Math.max(0, Math.min(100, this.state.stats[k] + v));
                }
            }
            if (choice.flag) this.state.flags[choice.flag] = true;
            if (choice.next) this.loadScene(choice.next);
        }

        flashEffect() {
            const flash = document.getElementById('flash-layer');
            flash.style.animation = 'none';
            flash.offsetHeight; 
            flash.style.animation = 'flash-anim 0.5s ease-out';
        }

        getCharHTML(type) {
            const maps = {
                naychi: `<div class="char-naychi-wrap"><div class="char-naychi-glow"></div><div class="char-naychi-body"></div></div>`,
                faceless: `<div class="char-faceless-wrap"><div class="char-faceless-glow"></div><div class="char-faceless-head"></div></div>`,
                faceless_mom: `<div class="char-faceless-mom-wrap"><div class="char-faceless-mom-glow"></div><div class="char-faceless-mom-head"></div></div>`,
                monk: `<div class="char-monk-wrap"><div class="char-monk-glow"></div></div>`
            };
            return maps[type] || '';
        }
    }

    class AudioController {
        constructor() { 
            this.active = true; 
            this.current = null; 
            this.volume = 1.0;
            this.themeActive = true;
            this.themeMusic = new Audio(ASSETS.audio.main_theme || "../audios/theme.mp3");
            this.themeMusic.loop = true;
        } 
        
        setVolume(v) {
            this.volume = v;
            if(this.bgMusic) this.bgMusic.volume = this.volume;
            if(this.themeMusic) this.themeMusic.volume = this.volume * 0.4;
        }

        setThemeMusic(state) {
            this.themeActive = (state === 'on');
            if (this.themeActive && this.active) {
                this.themeMusic.play().catch(e => console.log("Audio autoplay blocked by browser"));
            } else {
                this.themeMusic.pause();
            }
        }

        toggle() {
            this.active = !this.active;
            const icon = document.getElementById('audio-icon');
            if (this.active) {
                icon.setAttribute('data-lucide', 'volume-2');
                icon.classList.add('text-gold'); 
                if(this.current && this.bgMusic) this.bgMusic.play().catch(e => console.log("Audio autoplay blocked"));
                if(this.themeActive && this.themeMusic) this.themeMusic.play().catch(e => console.log("Audio autoplay blocked"));
            } else {
                icon.setAttribute('data-lucide', 'volume-x');
                icon.classList.remove('text-gold');
                if(this.bgMusic) this.bgMusic.pause();
                if(this.themeMusic) this.themeMusic.pause();
            }
            lucide.createIcons();
        }
        
        play(id, loop = true) {
            if (!this.bgMusic) this.bgMusic = new Audio();
            this.bgMusic.loop = loop;
            this.bgMusic.volume = this.volume;
            
            if (this.current !== id) {
                 this.bgMusic.src = ASSETS.audio[id];
                 this.current = id;
                 if (this.active) this.bgMusic.play().catch(e => console.log("Audio autoplay blocked"));
            } else {
                 if (this.active && this.bgMusic.paused) {
                     this.bgMusic.currentTime = 0;
                     this.bgMusic.play().catch(e => console.log("Audio autoplay blocked"));
                 }
            }
        }
    }

    const SPEAKERS = {
        unknown: { en: "???", mm: "???", color: "speaker-unknown" },
        tayza: { en: "Tayza", mm: "á€á€±á€‡", color: "speaker-tayza" },
        nay: { en: "Nay Chi", mm: "á€”á€±á€á€¼á€Šá€º", color: "speaker-nay" },
        mom: { en: "Mother", mm: "á€¡á€™á€±", color: "speaker-mom" },
        dad: { en: "Father", mm: "á€¡á€–á€±", color: "speaker-dad" },
        bro: { en: "Ko Thiha", mm: "á€€á€­á€¯á€žá€®á€Ÿ", color: "speaker-bro" },
        kyaw: { en: "Kyaw Gyi", mm: "á€€á€»á€±á€¬á€ºá€€á€¼á€®á€¸", color: "speaker-kyaw" },
        nurse: { en: "Nurse", mm: "á€žá€°á€”á€¬á€•á€¼á€¯", color: "speaker-nurse" },
        guard: { en: "The Guardian", mm: "á€¡á€…á€±á€¬á€„á€·á€º", color: "speaker-guard" },
        driver: { en: "YBS Driver", mm: "á€€á€¬á€¸á€†á€›á€¬", color: "speaker-driver" },
        monk: { en: "Sayadaw", mm: "á€†á€›á€¬á€á€±á€¬á€º", color: "speaker-monk" },
        librarian: { en: "Librarian", mm: "á€…á€¬á€€á€¼á€Šá€·á€ºá€á€­á€¯á€€á€ºá€™á€¾á€°á€¸", color: "speaker-librarian" }
    };

    const SCENES = {
        'yangon_intro': {
            bg: 'downtown',
            world: 'real',
            audio: 'morning_chant',
            location: { en: 'Yangon - CityView', mm: 'á€›á€”á€ºá€€á€¯á€”á€º - á€™á€¼á€­á€¯á€·á€¡á€œá€¾' },
            time: '07:00 AM',
            steps: [
            {
                bg: 'downtown',
                text: {
                    en: "Morning light spills over Yangon Downtown, brushing colonial buildings and narrow streets with gold. Shops awaken, tea scents drift, and buses begin their slow dance along waking roads. The city hums with quiet stories beneath the sun.",
                    mm: "á€™á€”á€€á€ºá€á€„á€ºá€¸á€”á€±á€›á€±á€¬á€„á€ºá€€ á€›á€”á€ºá€€á€¯á€”á€ºá€™á€¼á€­á€¯á€·á€œá€šá€ºá€•á€±á€«á€ºá€€á€­á€¯ á€á€–á€¼á€Šá€ºá€¸á€–á€¼á€Šá€ºá€¸ á€œá€„á€ºá€¸á€œá€¬á€•á€¼á€®á€¸ á€Ÿá€±á€¬á€„á€ºá€¸á€”á€½á€™á€ºá€¸á€”á€±á€žá€±á€¬á€€á€­á€¯á€œá€­á€¯á€”á€®á€¡á€†á€±á€¬á€€á€ºá€¡á€¦á€¸á€á€½á€±áŠ á€œá€™á€ºá€¸á€€á€»á€‰á€ºá€¸á€€á€»á€‰á€ºá€¸á€œá€±á€¸á€á€½á€±á€€á€­á€¯ á€›á€±á€¬á€„á€ºá€…á€¯á€¶á€¡á€œá€„á€ºá€¸á€”á€²á€· á€œá€„á€ºá€¸á€…á€±á€•á€«á€á€šá€ºá‹ á€†á€­á€¯á€„á€ºá€á€½á€± á€á€–á€¼á€Šá€ºá€¸á€–á€¼á€Šá€ºá€¸á€–á€½á€„á€·á€ºá€œá€¬á€€á€¼á€•á€¼á€®á€¸ á€œá€€á€ºá€–á€€á€ºá€›á€Šá€ºá€”á€¶á€·á€œá€±á€¸á€á€½á€±á€œá€Šá€ºá€¸ á€œá€±á€‘á€²á€™á€¾á€¬ á€•á€»á€¶á€·á€”á€¾á€¶á€·á€œá€¬á€•á€«á€•á€¼á€®á‹ á€˜á€á€ºá€…á€ºá€€á€¬á€¸á€á€½á€±á€€á€œá€Šá€ºá€¸ á€œá€™á€ºá€¸á€™á€•á€±á€«á€ºá€™á€¾á€¬ á€á€–á€¼á€Šá€ºá€¸á€–á€¼á€Šá€ºá€¸ á€…á€á€„á€ºá€œá€¾á€¯á€•á€ºá€›á€¾á€¬á€¸á€œá€¬á€•á€¼á€®á€¸ á€™á€¼á€­á€¯á€·á€á€±á€¬á€ºá€‘á€² á€”á€±á€›á€±á€¬á€„á€ºá€¡á€±á€¬á€€á€ºá€™á€¾á€¬ á€œá€°á€á€­á€¯á€„á€ºá€¸á€€á€­á€¯á€šá€ºá€•á€­á€¯á€„á€ºá€‡á€¬á€á€ºá€œá€™á€ºá€¸á€á€½á€±á€”á€²á€· á€á€­á€á€ºá€á€†á€­á€á€º á€…á€á€„á€ºá€œá€¬á€•á€«á€•á€¼á€®á‹"
                }
            },
            {
                bg: 'sule',
                text: {
                    en: "At the heart of the city, Sule Pagoda stands serene amid flowing traffic. Monks walk with calm steps, office workers hurry by. Its golden spire catches sunlight, quietly witnessing the passing day.",
                    mm: "á€™á€¼á€­á€¯á€·á€›á€²á€·á€¡á€œá€šá€ºá€—á€Ÿá€­á€¯á€™á€¾á€¬ á€†á€°á€¸á€œá€±á€˜á€¯á€›á€¬á€¸á€€ á€œá€™á€ºá€¸á€œá€¾á€Šá€·á€ºá€€á€¬á€¸á€á€½á€±á€€á€¼á€¬á€¸á€™á€¾á€¬á€•á€² á€á€­á€á€ºá€†á€­á€á€ºá€¡á€±á€¸á€á€»á€™á€ºá€¸á€…á€½á€¬ á€á€Šá€ºá€›á€¾á€­á€”á€±á€•á€¼á€®á€¸ á€”á€±á€›á€±á€¬á€„á€ºá€¡á€±á€¬á€€á€ºá€™á€¾á€¬ á€›á€½á€¾á€±á€›á€±á€¬á€„á€ºá€á€±á€¬á€€á€ºá€•á€œá€„á€ºá€¸á€œá€€á€ºá€”á€±á€•á€«á€á€šá€ºá‹ á€žá€¶á€ƒá€¬á€á€±á€¬á€ºá€á€½á€±á€€ á€á€Šá€ºá€„á€¼á€­á€™á€ºá€á€²á€· á€á€¼á€±á€œá€¾á€™á€ºá€¸á€á€½á€±á€”á€²á€· á€œá€™á€ºá€¸á€œá€»á€¾á€±á€¬á€€á€ºá€”á€±á€€á€¼á€•á€¼á€®á€¸ á€›á€¯á€¶á€¸á€žá€½á€¬á€¸á€á€”á€ºá€‘á€™á€ºá€¸á€á€½á€±á€€á€œá€Šá€ºá€¸ á€¡á€œá€¯á€•á€ºá€¡á€á€½á€€á€º á€¡á€™á€¼á€”á€ºá€œá€¾á€¯á€•á€ºá€›á€¾á€¬á€¸á€”á€±á€€á€¼á€•á€«á€•á€¼á€®á‹ á€™á€¼á€­á€¯á€·á€›á€²á€·á€¡á€žá€¶á€œá€¾á€­á€¯á€„á€ºá€¸á€á€½á€±á€€á€¼á€¬á€¸á€™á€¾á€¬á€•á€„á€º á€˜á€¯á€›á€¬á€¸á€€ á€á€­á€á€ºá€á€†á€­á€á€º á€”á€±á€·á€žá€…á€ºá€á€…á€ºá€”á€±á€·á€€á€­á€¯ á€…á€±á€¬á€„á€·á€ºá€€á€¼á€Šá€·á€ºá€”á€±á€žá€œá€­á€¯ á€–á€¼á€…á€ºá€”á€±á€•á€«á€á€šá€ºá‹"
                }
            },
            {
                bg: 'shwedagon',
                text: {
                    en: "On the hill, Shwedagon Pagoda glimmers under the sun. Incense drifts, prayers float, and the city below seems to pause, held in a gentle, timeless moment.",
                    mm: "á€á€±á€¬á€„á€ºá€•á€±á€«á€ºá€™á€¾á€¬ á€›á€½á€¾á€±á€á€­á€‚á€¯á€¶á€˜á€¯á€›á€¬á€¸á€€ á€”á€±á€›á€±á€¬á€„á€ºá€¡á€±á€¬á€€á€ºá€™á€¾á€¬ á€á€±á€¬á€€á€ºá€•á€œá€„á€ºá€¸á€œá€€á€ºá€”á€±á€•á€¼á€®á€¸ á€›á€½á€¾á€±á€›á€±á€¬á€„á€ºá€á€¶á€á€­á€¯á€„á€ºá€¸á€á€½á€±á€€ á€™á€»á€€á€ºá€…á€­á€‘á€² á€‘á€„á€ºá€Ÿá€•á€ºá€…á€±á€•á€«á€á€šá€ºá‹ á€¡á€™á€½á€¾á€±á€¸á€”á€¶á€·á€žá€„á€ºá€¸á€žá€„á€ºá€¸á€œá€±á€¸á€á€½á€± á€œá€±á€‘á€²á€™á€¾á€¬ á€•á€»á€¶á€·á€”á€¾á€¶á€·á€”á€±á€•á€¼á€®á€¸ á€†á€¯á€á€±á€¬á€„á€ºá€¸á€žá€¶á€á€½á€±á€€á€œá€Šá€ºá€¸ á€á€­á€á€ºá€á€†á€­á€á€º á€œá€±á€•á€¼á€±á€¡á€±á€¸á€”á€²á€·á€¡á€á€° á€•á€±á€«á€ºá€œá€½á€„á€ºá€”á€±á€•á€«á€á€šá€ºá‹ á€¡á€±á€¬á€€á€ºá€˜á€€á€ºá€™á€¼á€­á€¯á€·á€á€±á€¬á€ºá€€á€á€±á€¬á€· á€á€á€á€¬ á€„á€¼á€­á€™á€ºá€žá€€á€ºá€žá€œá€­á€¯ á€–á€¼á€…á€ºá€”á€±á€•á€¼á€®á€¸ á€¡á€á€»á€­á€”á€ºá€á€…á€ºá€á€ á€›á€•á€ºá€á€”á€ºá€·á€žá€½á€¬á€¸á€žá€œá€­á€¯ á€¡á€±á€¸á€á€»á€™á€ºá€¸á€™á€¾á€¯á€á€…á€ºá€á€¯á€”á€²á€· á€–á€¯á€¶á€¸á€œá€½á€¾á€™á€ºá€¸á€”á€±á€•á€«á€á€šá€ºá‹"
                }
            },
            {
                bg: 'kantawgyi',
                text: {
                    en: "By Kandawgyi Lake, water mirrors clouds and rooftops. The Karaweik floats gently, footsteps fade along the wooden path, and a soft breeze carries distant city sounds. Peace lingers quietly beneath the open sky.",
                    mm: "á€€á€”á€ºá€á€±á€¬á€ºá€€á€¼á€®á€¸á€€á€”á€ºá€˜á€±á€¸á€™á€¾á€¬ á€›á€±á€•á€¼á€„á€ºá€€ á€™á€­á€¯á€¸á€á€­á€™á€ºá€á€½á€±á€”á€²á€· á€¡á€†á€±á€¬á€€á€ºá€¡á€¦á€¸á€á€½á€±á€€á€­á€¯ á€•á€¼á€”á€ºá€œá€Šá€ºá€‘á€„á€ºá€Ÿá€•á€ºá€…á€±á€•á€¼á€®á€¸ á€œá€±á€•á€¼á€±á€¡á€±á€¸á€œá€±á€¸á€”á€²á€·á€¡á€á€° á€á€­á€á€ºá€†á€­á€á€ºá€…á€½á€¬ á€œá€¾á€¯á€•á€ºá€›á€¾á€¬á€¸á€”á€±á€•á€«á€á€šá€ºá‹ á€€á€›á€á€­á€€á€ºá€›á€±á€šá€¬á€‰á€ºá€€ á€›á€±á€•á€¼á€„á€ºá€•á€±á€«á€ºá€™á€¾á€¬ á€„á€¼á€­á€™á€ºá€žá€€á€ºá€…á€½á€¬ á€œá€½á€„á€·á€ºá€™á€»á€±á€¬á€”á€±á€•á€¼á€®á€¸ á€žá€…á€ºá€žá€¬á€¸á€œá€™á€ºá€¸á€œá€±á€¸á€•á€±á€«á€ºá€™á€¾á€¬ á€œá€™á€ºá€¸á€œá€»á€¾á€±á€¬á€€á€ºá€žá€¶á€á€½á€±áŠ á€™á€¼á€­á€¯á€·á€›á€²á€·á€¡á€žá€¶á€á€±á€¸á€á€±á€¸á€œá€±á€¸á€á€½á€± á€œá€±á€•á€¼á€±á€¡á€±á€¸á€”á€²á€·á€¡á€á€° á€€á€¼á€¬á€¸á€”á€±á€›á€•á€¼á€®á€¸ á€¡á€±á€¸á€á€»á€™á€ºá€¸á€™á€¾á€¯á€á€…á€ºá€á€¯á€€á€á€±á€¬á€· á€™á€­á€¯á€¸á€€á€±á€¬á€„á€ºá€¸á€€á€„á€ºá€¡á€±á€¬á€€á€ºá€™á€¾á€¬ á€á€­á€á€ºá€á€†á€­á€á€º á€†á€€á€ºá€œá€€á€ºá€›á€¾á€­á€”á€±á€•á€«á€á€šá€ºá‹"
                }
            }
            
                        
        ],
        choices: [
            { text: { en: "Continue", mm: "á€›á€¾á€±á€·á€†á€€á€ºá€™á€Šá€º" }, next: 'alarm' },
        ]
        },
        
    };

    // --- BOOTSTRAP ---
    const game = new GameEngine();
    
    document.addEventListener('DOMContentLoaded', () => {
        lucide.createIcons();
    });
    
    document.addEventListener('contextmenu', event => event.preventDefault());

</script>
    </body>
</html>